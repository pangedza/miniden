MiniDeN — Telegram-бот и веб-магазин
====================================

Архитектура проекта
-------------------
- Telegram-бот (`bot.py`): точка входа, проверка подписки, стартовый экран и главное меню с WebApp-кнопками, мини-CRM для админов.
- Backend (`webapi.py`): FastAPI-приложение `webapi:app`, обслуживает авторизацию, каталог, корзину, заказы, избранное, промокоды и админку.
  - Для корректной работы эндпоинтов, принимающих form-data (`UploadFile`, `Form`), требуется установленный пакет `python-multipart`.
  - Пакет включён в `requirements.txt` и ставится вместе с остальными зависимостями командой: `pip install -r requirements.txt`.
- PostgreSQL: единая база данных для бота, WebApp и сайта (строка подключения `DATABASE_URL`).
- WebApp: HTML/JS-фронтенд магазина, корзины, профиля и админки, получает данные только через `webapi:app`.
- Legacy shim (`main.py`): прокидывает `app` из `webapi.py` для обратной совместимости; в продакшене запускать `uvicorn webapi:app`.

Структура проекта
-----------------
- `bot.py` — точка входа Telegram-бота.
- `webapi.py` — основной backend (FastAPI).
- `main.py` — shim для совместимости (импортирует `webapi.app`).
- `config.py` — загрузка настроек из `.env`.
- `database.py` — подключение к PostgreSQL (SQLAlchemy).
- `models.py` — общие ORM-модели.
- `handlers/` — актуальные роутеры бота (`start.py`, `webapp.py`, админская CRM в `admin.py`).
- `services/` — бизнес-логика (пользователи, товары, корзина, заказы, промокоды и пр.).
- `webapp/` — статические HTML/JS-страницы витрины, профиля и админки.
- `docs/legacy-data/` — сохранённые JSON-файлы старой версии каталога (`products_baskets.json`, `products_courses.json`).
- `api/routers/` — legacy-эндпоинты, оставлены только как архив.
- `examples/example_openai.py` — пример использования OpenAI API (не часть продакшн-кода).

Правила репозитория
-------------------
- `.env` НЕ хранится в git и управляется вручную. Codex его НЕ изменяет.
- `.gitignore` НЕ изменяется Codex'ом — он управляется вручную.
- `deploy.sh` и `.env.example` также ведутся вручную и не меняются автоматическими задачами.

Аккаунты и авторизация
----------------------
- В браузере используется связка:
  - `/api/auth/telegram-login` для входа через Telegram Login Widget;
  - cookie `tg_user_id` для фиксации сессии;
  - `/api/auth/session` для проверки текущего пользователя;
  - `/api/auth/logout` для выхода и очистки cookie.
- В Telegram WebApp авторизация идёт через `/api/auth/telegram` (initData). Браузер и WebApp получают один и тот же формат профиля пользователя.

Профиль
-------
- На странице профиля отображается Telegram ID пользователя — он берётся из базы и недоступен для ручного редактирования.
- Имя и телефон можно менять в профиле: изменения отправляются в backend и сохраняются в базе. Эти данные используются при оформлении заказов.
- В БД хранится только текстовое поле `avatar_url` с путём до файла аватара (например, `/media/users/<telegram_id>/avatar.jpg`). Бинарные файлы аватаров в репозитории отсутствуют — владелец проекта загружает их вручную на сервер (например, `/opt/miniden/media/...`).
- В профиле WebApp аватар отображается кругом с CSS: если `avatar_url` задан и файл существует на сервере, он подставляется как фон; если `avatar_url` пустой, показываются инициалы пользователя в цветном кружке без использования файлов-заглушек.

Управление каталогом в админке
------------------------------
- В админке (/admin.html) доступно полноценное управление двумя разделами: «Товары» (корзинки и сопутствующие товары) и «Мастер-классы».
- Карточка товара/курса включает имя, цену, описание, ссылку на фото, категорию и набор ссылок:
  - detail_url (подробности/лендинг),
  - wb_url, ozon_url, yandex_url, avito_url (маркетплейсы),
  - masterclass_url (основная ссылка на онлайн-курс или урок, если связан).
- Все ссылки сохраняются в БД (колонки wb_url/ozon_url/yandex_url/avito_url/masterclass_url добавляются при инициализации БД) и доступны в API, чтобы фронтенд выводил кнопки переходов.
- В админке можно создавать и редактировать товары/курсы с переключением активного состояния, обновлением цены, описаний, фото и ссылок, а также менять категорию.
- Левое боковое меню позволяет переключаться между разделами «Заказы», «Товары», «Мастер-классы», «Промокоды» и «Статистика».

Фото товаров и курсов
---------------------
- Изображения товаров и онлайн-курсов загружаются через админку: админ выбирает файл на устройстве, фронтенд отправляет его на `/api/admin/upload-image`.
- Backend сохраняет файл в `/opt/miniden/media/products/` или `/opt/miniden/media/courses/`, генерирует уникальное имя и возвращает `image_url` вида `/media/products/<uuid>.jpg`.
- Админка автоматически подставляет возвращённый `image_url` в карточку и показывает превью; поле можно отредактировать вручную при необходимости.
- В базе хранится только строка `image_url`; бинарные файлы изображений не коммитятся в git и создаются только на сервере во время работы backend.

Структура директорий медиа
--------------------------
Директории создаются автоматически при старте backend:

```
/opt/miniden/media/
├── users/         # аватары пользователей
├── products/      # изображения товаров
├── courses/       # изображения онлайн-курсов
└── tmp/
    ├── products/  # временные загрузки товаров
    └── courses/   # временные загрузки курсов
```

- В репозиторий НЕ добавлены никакие бинарные изображения.
- Разрешено использовать пустой файл `.gitkeep` для сохранения директории в Git, если структура каталогов должна быть видимой в проекте.

Кнопка «Админка»
---------------
- Ссылка на `/admin.html` показывается в шапке сайта только для пользователей с флагом `is_admin = true`.
- Для всех остальных посетителей кнопка скрыта и остаётся недоступной без авторизации администратора.

Каталог и корзина на сайте
--------------------------
- `/products.html` (товары) и `/masterclasses.html` (мастер-классы) доступны всем пользователям, даже без авторизации — карточки грузятся напрямую из `/api/products`.
- Каталог товаров и мастер-классов доступен гостям: даже если `/api/auth/session` отвечает 401, страницы каталога всё равно запрашивают категории (`/api/categories`) и карточки (`/api/products`).
- Авторизация через Telegram нужна только для сохранения корзины в базе и оформления заказа с привязкой к профилю.
- Неавторизованные пользователи могут добавлять позиции в «гостевую» корзину: данные хранятся в браузерном `localStorage` и показываются на `/cart.html`.
- Для авторизованных пользователей корзина и оформление работают через серверные эндпоинты `/api/cart/*` и `/api/checkout`.
- При попытке оформить заказ без авторизации страница корзины сообщает о необходимости входа и перенаправляет на `/index.html` (Telegram Login).
- После авторизации содержимое гостевой корзины автоматически переносится на сервер и связывается с Telegram ID пользователя.
- Бесплатные мастер-классы по-прежнему открываются сразу (кнопка «Перейти к мастер-классу»), платные добавляются в корзину и оплачиваются как товары.

Обновление статики WebApp
-------------------------
- Все HTML-страницы WebApp подключают локальные js/css-файлы с параметром версии (`?v=20241201`), чтобы браузеры (особенно Яндекс.Браузер и мобильные) не держали устаревший кэш.
- При любых изменениях фронтенда (JS/CSS) обновляйте номер версии во всех HTML-файлах WebApp на одно и то же значение, чтобы пользователи сразу получили свежую статику без ручной очистки кэша.
- Если используется service worker, обновляйте его имя/версию вместе с параметром `?v=...`, чтобы предыдущие кэши автоматически инвалидировались и не мешали загрузке новых файлов.

Доступ к онлайн-курсам
----------------------
- Бесплатные мастер-классы (цена 0) становятся доступными пользователю сразу после оформления заказа.
- Платные мастер-классы открываются только после перевода связанного заказа администратором в статус «оплачен» через админский API/интерфейс.
- В профиле пользователя выводится список доступных курсов с кнопками перехода по masterclass_url; оплаченные отмечаются как «Оплаченный доступ», бесплатные — как «Бесплатный».
- В разделе «Мои заказы» для позиций типа course отображается ссылка на мастер-класс, если доступ открыт; иначе показывается текст «Ссылка появится после оплаты».

Профиль пользователя
--------------------
- На странице профиля есть блок «Мои мастер-классы», который берёт данные из поля `courses` профиля (`/api/auth/session` или `/api/auth/telegram`).
- Бесплатные курсы попадают туда автоматически, платные появляются после оплаты заказа и перевода его в статус «оплачен».
- Раздел «Мои заказы» для позиций типа course показывает подсказку «Ссылка появится после оплаты» до смены статуса; после оплаты переходы доступны через список «Мои мастер-классы».

База данных
-----------
Backend и бот работают от одной PostgreSQL-базы (`DATABASE_URL`). Таблицы создаются через `database.init_db()`, а сервисы из `services/` используют общие модели из `models.py`.

Запуск в продакшене
--------------------
- Backend: `uvicorn webapi:app --host 0.0.0.0 --port 8000`.
- Бот: `python -m bot` (aiogram 3, настройки из `config.py`, инициализация БД через `init_db()`).

Systemd и nginx
---------------
- Рекомендуется настроить два systemd-unit'а: один для бота (exec=`/usr/bin/python -m bot`) и один для backend'а (exec=`/usr/bin/uvicorn webapi:app --host 0.0.0.0 --port 8000`), оба с автоперезапуском и загрузкой переменных окружения из `/etc/miniden.env`.
- Nginx проксирует HTTPS-трафик на backend: `location /api/ { proxy_pass http://127.0.0.1:8000; proxy_set_header X-Real-IP $remote_addr; }`. Статику WebApp можно раздавать напрямую (root в директорию `webapp/`).
- Скрипт `deploy.sh` не изменяется и остаётся как есть.

Legacy
------
- Старые API-роутеры лежат в `api/routers/` и помечены как архивные.
- Исторические seed-файлы перенесены в `docs/legacy-data/`; PostgreSQL — единственный источник данных в продакшене.
- `.env`, `.gitignore` и `deploy.sh` не изменяются автоматически и поддерживаются вручную владельцем проекта.

Файлы под ручным управлением
----------------------------
- `.env`, `.env.example`, `.gitignore` и `deploy.sh` изменяются только владельцем проекта вручную и не должны правиться автоматизированными задачами.
