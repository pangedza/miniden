MiniDeN — Telegram-бот и веб-магазин
====================================

Архитектура проекта
-------------------
- Telegram-бот (`bot.py`): точка входа, проверка подписки, стартовый экран и главное меню с WebApp-кнопками, мини-CRM для админов.
- Backend (`webapi.py`): FastAPI-приложение `webapi:app`, обслуживает авторизацию, каталог, корзину, заказы, избранное, промокоды и админку.
- PostgreSQL: единая база данных для бота, WebApp и сайта (строка подключения `DATABASE_URL`).
- WebApp: HTML/JS-фронтенд магазина, корзины, профиля и админки, получает данные только через `webapi:app`.
- Legacy shim (`main.py`): прокидывает `app` из `webapi.py` для обратной совместимости; в продакшене запускать `uvicorn webapi:app`.

Структура проекта
-----------------
- `bot.py` — точка входа Telegram-бота.
- `webapi.py` — основной backend (FastAPI).
- `main.py` — shim для совместимости (импортирует `webapi.app`).
- `config.py` — загрузка настроек из `.env`.
- `database.py` — подключение к PostgreSQL (SQLAlchemy).
- `models.py` — общие ORM-модели.
- `handlers/` — актуальные роутеры бота (`start.py`, `webapp.py`, админская CRM в `admin.py`).
- `services/` — бизнес-логика (пользователи, товары, корзина, заказы, промокоды и пр.).
- `webapp/` — статические HTML/JS-страницы витрины, профиля и админки.
- `docs/legacy-data/` — сохранённые JSON-файлы старой версии каталога (`products_baskets.json`, `products_courses.json`).
- `api/routers/` — legacy-эндпоинты, оставлены только как архив.
- `examples/example_openai.py` — пример использования OpenAI API (не часть продакшн-кода).

Правила репозитория
-------------------
- `.env` НЕ хранится в git и управляется вручную. Codex его НЕ изменяет.
- `.gitignore` НЕ изменяется Codex'ом — он управляется вручную.
- `deploy.sh` и `.env.example` также ведутся вручную и не меняются автоматическими задачами.

Аккаунты и авторизация
----------------------
- В браузере используется связка:
  - `/api/auth/telegram-login` для входа через Telegram Login Widget;
  - cookie `tg_user_id` для фиксации сессии;
  - `/api/auth/session` для проверки текущего пользователя;
  - `/api/auth/logout` для выхода и очистки cookie.
- В Telegram WebApp авторизация идёт через `/api/auth/telegram` (initData). Браузер и WebApp получают один и тот же формат профиля пользователя.

Профиль
-------
- На странице профиля отображается Telegram ID пользователя — он берётся из базы и недоступен для ручного редактирования.
- Имя и телефон можно менять в профиле: изменения отправляются в backend и сохраняются в базе. Эти данные используются при оформлении заказов.

Управление каталогом в админке
------------------------------
- В админке (/admin.html) доступно полноценное управление двумя разделами: «Товары» (корзинки и сопутствующие товары) и «Мастер-классы».
- Карточка товара/курса включает имя, цену, описание, ссылку на фото, категорию и набор ссылок:
  - detail_url (подробности/лендинг),
  - wb_url, ozon_url, yandex_url, avito_url (маркетплейсы),
  - masterclass_url (основная ссылка на онлайн-курс или урок, если связан).
- Все ссылки сохраняются в БД (колонки wb_url/ozon_url/yandex_url/avito_url/masterclass_url добавляются при инициализации БД) и доступны в API, чтобы фронтенд выводил кнопки переходов.
- В админке можно создавать и редактировать товары/курсы с переключением активного состояния, обновлением цены, описаний, фото и ссылок, а также менять категорию.
- Левое боковое меню позволяет переключаться между разделами «Заказы», «Товары», «Мастер-классы», «Промокоды» и «Статистика».

Доступ к онлайн-курсам
----------------------
- Бесплатные мастер-классы (цена 0) становятся доступными пользователю сразу после оформления заказа.
- Платные мастер-классы открываются только после перевода связанного заказа администратором в статус «оплачен» через админский API/интерфейс.
- В профиле пользователя выводится список доступных курсов с кнопками перехода по masterclass_url; оплаченные отмечаются как «Оплаченный доступ», бесплатные — как «Бесплатный».
- В разделе «Мои заказы» для позиций типа course отображается ссылка на мастер-класс, если доступ открыт; иначе показывается текст «Ссылка появится после оплаты».

База данных
-----------
Backend и бот работают от одной PostgreSQL-базы (`DATABASE_URL`). Таблицы создаются через `database.init_db()`, а сервисы из `services/` используют общие модели из `models.py`.

Запуск в продакшене
--------------------
- Backend: `uvicorn webapi:app --host 0.0.0.0 --port 8000`.
- Бот: `python -m bot` (aiogram 3, настройки из `config.py`, инициализация БД через `init_db()`).

Systemd и nginx
---------------
- Рекомендуется настроить два systemd-unit'а: один для бота (exec=`/usr/bin/python -m bot`) и один для backend'а (exec=`/usr/bin/uvicorn webapi:app --host 0.0.0.0 --port 8000`), оба с автоперезапуском и загрузкой переменных окружения из `/etc/miniden.env`.
- Nginx проксирует HTTPS-трафик на backend: `location /api/ { proxy_pass http://127.0.0.1:8000; proxy_set_header X-Real-IP $remote_addr; }`. Статику WebApp можно раздавать напрямую (root в директорию `webapp/`).
- Скрипт `deploy.sh` не изменяется и остаётся как есть.

Legacy
------
- Старые API-роутеры лежат в `api/routers/` и помечены как архивные.
- Исторические seed-файлы перенесены в `docs/legacy-data/`; PostgreSQL — единственный источник данных в продакшене.
- `.env`, `.gitignore` и `deploy.sh` не изменяются автоматически и поддерживаются вручную владельцем проекта.
