<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>{% if node %}Редактирование узла{% else %}Новый узел{% endif %}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 16px; background: #f5f5f5; }
        header { display: flex; gap: 12px; margin-bottom: 16px; }
        form { background: #fff; padding: 16px; border: 1px solid #cbd5e1; border-radius: 6px; max-width: 900px; }
        label { display: block; margin-top: 12px; font-weight: bold; }
        input[type="text"], input[type="number"], textarea, select { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; }
        textarea { min-height: 140px; }
        .actions { margin-top: 16px; display: flex; gap: 8px; }
        .button { padding: 8px 12px; border: none; background: #2563eb; color: #fff; border-radius: 4px; text-decoration: none; cursor: pointer; }
        .error { color: #dc2626; margin-top: 8px; }
        .hint { color: #475569; font-size: 13px; margin-top: 4px; }
        .card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 12px; margin-top: 12px; }
        .row { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; }
        .checkbox { display: flex; align-items: center; gap: 8px; margin-top: 12px; }
        .action-card { border: 1px solid #cbd5e1; padding: 12px; border-radius: 6px; background: #fff; margin-top: 10px; }
        .action-header { display: flex; justify-content: space-between; align-items: center; gap: 8px; }
        .action-controls { display: flex; gap: 6px; }
        .action-controls button { padding: 6px 8px; }
        .muted { color: #475569; font-size: 13px; }
        .action-fields { margin-top: 10px; }
        .action-fields .row { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        .help-icon { display:inline-flex; align-items:center; justify-content:center; width:18px; height:18px; border-radius:50%; background:#e0f2fe; color:#0f172a; font-size:12px; cursor:help; margin-left:6px; }
        .pill { display:inline-block; padding:4px 8px; border-radius:12px; background:#e0f2fe; color:#0f172a; font-size:12px; }
        .danger { background:#fef2f2; border:1px solid #fecdd3; color:#b91c1c; padding:10px; border-radius:8px; margin-top:10px; }
        .upload-modal { position:fixed; inset:0; background:rgba(0,0,0,0.35); display:none; align-items:center; justify-content:center; }
        .upload-modal .modal-content { background:#fff; padding:16px; border-radius:10px; width:420px; max-width:90%; box-shadow:0 10px 30px rgba(0,0,0,0.2); }
        .flex { display:flex; gap:8px; align-items:center; }
        .chips { display:flex; gap:6px; flex-wrap:wrap; margin-top:6px; }
    </style>
</head>
<body>
<header>
    <a href="/adminbot/nodes" class="button">Назад к списку</a>
    <a href="/adminbot/templates" class="button">Шаблоны</a>
    <a href="/adminbot/menu-buttons" class="button">Меню</a>
    <a href="/adminbot/triggers" class="button" title="Триггеры — с чего бот начинает">Триггеры</a>
    <a href="/adminbot/media" class="button" title="Загрузка картинок для узлов">Медиа</a>
    <a href="/adminbot/runtime" class="button" title="Работа бота — обновление версии сценария">Работа бота</a>
    <a href="/adminbot/logs" class="button" title="Логи помогут проверить ход сценария">Логи</a>
    <a href="/adminbot/logout" class="button" style="background:#dc2626;">Выйти</a>
</header>
<h2>{% if node %}Редактирование: {{ node.code }}{% else %}Новый узел{% endif %}</h2>
<div id="server_errors" class="error" style="display:{% if error %}block{% else %}none{% endif %};">
    {% if error is iterable and error is not string %}
        {% for item in error %}<div>{{ item }}</div>{% endfor %}
    {% elif error %}
        <div>{{ error }}</div>
    {% endif %}
</div>
<div id="client_errors" class="error" style="display:none;"></div>
{% set ref_nodes = references.nodes if references else [] %}
{% set ref_buttons = references.buttons if references else [] %}
{% set ref_triggers = references.triggers if references else [] %}
{% if node %}
<div class="card" style="border-color:#fed7aa; background:#fff7ed;">
    <h3>Связи узла</h3>
    <div class="muted">Если удалить узел, переходы и кнопки ниже будут очищены или выключены.</div>
    <div class="chips">
        <span class="pill">Узлы ссылаются: {{ ref_nodes|length }}</span>
        <span class="pill">Кнопок: {{ ref_buttons|length }}</span>
        <span class="pill">Триггеров: {{ ref_triggers|length }}</span>
    </div>
    {% if ref_nodes %}
        <div class="muted">Узлы: {% for ref in ref_nodes %}{{ ref.code }}{% if not loop.last %}, {% endif %}{% endfor %}</div>
    {% endif %}
    {% if ref_buttons %}
        <div class="muted">Кнопки: {% for btn in ref_buttons %}{{ btn.title }} ({{ btn.node.code if btn.node else 'узел?' }}){% if not loop.last %}, {% endif %}{% endfor %}</div>
    {% endif %}
    {% if ref_triggers %}
        <div class="muted">Триггеры: {% for trig in ref_triggers %}{{ trig.trigger_type }} {{ trig.trigger_value or '—' }}{% if not loop.last %}, {% endif %}{% endfor %}</div>
    {% endif %}
</div>
{% endif %}
{% set cond_config = node.config_json if node and node.config_json else {} %}
{% set sub_payload = cond_config.get('condition_payload', {}) if cond_config else {} %}
<form method="post" action="{% if node %}/adminbot/nodes/{{ node.id }}/edit{% else %}/adminbot/nodes/new{% endif %}">
    <label>Код узла <span class="help-icon" title="Уникальный код шага (латиница/цифры/_). Например: MAIN_MENU">?</span></label>
    <input type="text" name="code" value="{{ node.code if node else '' }}" {% if node %}readonly{% endif %} data-lock-required="true">

    <div class="row">
        <div>
            <label>Название для себя <span class="help-icon" title="Свободное название, видно только вам. Помогает понять, что делает узел.">?</span></label>
            <input type="text" name="title" value="{{ node.title if node else '' }}" placeholder="Например: Приветствие" data-lock-required="true">
        </div>
        <div>
            <label>Тип узла <span class="help-icon" title="Определяет, что бот делает на этом шаге: сообщение, ожидание ответа, проверка условия или действие">?</span></label>
            <select name="node_type" id="node_type_select">
                <option value="MESSAGE" {% if node is none or node.node_type == 'MESSAGE' %}selected{% endif %}>Сообщение — бот просто отправит текст</option>
                <option value="INPUT" {% if node and node.node_type == 'INPUT' %}selected{% endif %}>Ожидание ввода — бот ждёт ответ</option>
                <option value="CONDITION" {% if node and node.node_type == 'CONDITION' %}selected{% endif %}>Условие (если/иначе) — проверка и переход</option>
                <option value="ACTION" {% if node and node.node_type == 'ACTION' %}selected{% endif %}>Действие — выполнить задачу и идти дальше</option>
            </select>
            <div class="hint">Подсказка: выберите поведение узла.</div>
        </div>
    </div>

    <div id="message_section" class="card">
        <h3>Сообщение</h3>
        <label>Текст сообщения <span class="help-icon" title="Что бот отправит пользователю. Можно подставлять {{переменные}}.">?</span></label>
        <textarea name="message_text" data-section="message" placeholder="Например: Привет, {{name}}! Чем помочь?">{{ node.message_text if node else '' }}</textarea>
        <div class="hint">Можно использовать переменные: {{'{{'}}name{{'}}'}}, {{'{{'}}phone{{'}}'}}.</div>

        <div class="row">
            <div>
                <label>Режим форматирования <span class="help-icon" title="Как обрабатывать текст: HTML или Markdown. Оставьте по умолчанию, если не уверены.">?</span></label>
                <input type="text" name="parse_mode" data-section="message" value="{{ node.parse_mode if node else 'HTML' }}" placeholder="Например: HTML">
            </div>
            <div>
                <label>Изображение (URL) <span class="help-icon" title="Ссылка на картинку, которую бот пришлёт вместе с текстом.">?</span></label>
                <div class="flex">
                    <input type="text" name="image_url" id="image_url_input" data-section="message" value="{{ node.image_url if node else '' }}" placeholder="https://example.com/image.jpg" style="flex:1;">
                    <button type="button" class="button" id="open_upload_modal" style="background:#0ea5e9;">Загрузить</button>
                    <button type="button" class="button" id="copy_image_url_btn" title="Скопировать значение поля">Скопировать</button>
                </div>
                <div class="hint">Можно вставить внешний URL или загрузить файл через админку (кнопка «Загрузить»).</div>
            </div>
        </div>

        <div class="checkbox">
            <input type="checkbox" id="is_enabled" name="is_enabled" data-section="message" {% if node is none or node.is_enabled %}checked{% endif %}>
            <label for="is_enabled" style="margin:0; font-weight:normal;">Включен</label>
        </div>
        <div class="checkbox">
            <input type="checkbox" id="clear_chat" name="clear_chat" {% if node and node.clear_chat %}checked{% endif %}>
            <label for="clear_chat" style="margin:0; font-weight:normal;">Очищать чат перед показом узла</label>
        </div>
        <div class="hint">Если включено, бот попробует удалить предыдущие сообщения перед отправкой этого экрана.</div>
    </div>

    <div id="input_settings" class="card" style="display:none;">
        <h3>Настройки ввода</h3>
        <div class="row">
            <div>
                <label>Тип ввода <span class="help-icon" title="Что ожидаем от пользователя: текст, число, телефон или контакт">?</span></label>
                <select name="input_type" id="input_type_select">
                    <option value="" disabled {% if node is none or not node.input_type %}selected{% endif %}>Выберите</option>
                    <option value="TEXT" {% if node and node.input_type == 'TEXT' %}selected{% endif %}>Текст</option>
                    <option value="NUMBER" {% if node and node.input_type == 'NUMBER' %}selected{% endif %}>Число</option>
                    <option value="PHONE_TEXT" {% if node and node.input_type == 'PHONE_TEXT' %}selected{% endif %}>Телефон (текст)</option>
                    <option value="CONTACT" {% if node and node.input_type == 'CONTACT' %}selected{% endif %}>Контакт Telegram</option>
                </select>
            </div>
            <div>
                <label>Сохранить в переменную <span class="help-icon" title="Имя, под которым ответ сохранится и будет доступен в следующих узлах.">?</span></label>
                <input type="text" name="input_var_key" value="{{ node.input_var_key if node else '' }}" placeholder="Например: phone или name">
                <div class="hint">Ключ переменной (латиница, цифры, underscore).</div>
            </div>
        </div>

        <div class="row">
            <div class="checkbox">
                <input type="checkbox" id="input_required" name="input_required" {% if node is none or node.input_required %}checked{% endif %}>
                <label for="input_required" style="margin:0; font-weight:normal;">Обязательно</label>
            </div>
            <div>
                <label>Минимальная длина ответа <span class="help-icon" title="Сколько символов минимум должен написать пользователь. Оставьте пустым, если не важно.">?</span></label>
                <input type="number" name="input_min_len" value="{{ node.input_min_len if node and node.input_min_len is not none else '' }}" placeholder="Например: 2 символа для имени">
            </div>
        </div>

        <label>Текст ошибки <span class="help-icon" title="Сообщение, которое увидит пользователь, если ответ не подходит.">?</span></label>
        <textarea name="input_error_text" placeholder="Пожалуйста, введите корректное значение.">{{ node.input_error_text if node else '' }}</textarea>

        <div class="row">
            <div>
                <label>Переход при успехе (код узла) <span class="help-icon" title="Куда отправить пользователя, если ответ подходит">?</span></label>
                <input type="text" name="next_node_code_success" value="{{ node.next_node_code_success if node else '' }}" placeholder="Например: MAIN_MENU">
            </div>
            <div>
                <label>Переход при отмене (код узла) <span class="help-icon" title="Если пользователь нажмёт отмену или не даст контакт">?</span></label>
                <input type="text" name="next_node_code_cancel" value="{{ node.next_node_code_cancel if node else '' }}" placeholder="Например: MAIN_MENU">
            </div>
        </div>
    </div>

    <div id="action_settings" class="card" style="display:none;">
        <h3>Действия узла</h3>
        <div class="hint">Действия выполняются по порядку сверху вниз. Подходит для уведомлений, записи данных или переходов.</div>
        <div class="hint" style="color:#b45309;">Можно сохранить узел без действий — тогда он просто перейдёт к следующему шагу (если указан).</div>
        <div id="actions_container"></div>
        <div style="margin-top:10px;">
            <button type="button" class="button" id="add_action_btn" style="background:#0ea5e9;">Добавить действие</button>
        </div>
        <div style="margin-top:14px;">
            <label>Переход после выполнения (код узла) <span class="help-icon" title="Если в действиях нет своего перехода — сюда попадёт пользователь">?</span></label>
            <input type="text" name="next_node_code" value="{{ node.next_node_code if node else '' }}" placeholder="Код узла (если не указан — сценарий завершится)">
            <div class="hint">Опционально. Используется, если в действиях нет переходов.</div>
        </div>
    </div>

    <div id="condition_settings" class="card" style="display:none;">
        <h3>Настройка условия</h3>
        <div class="row">
            <div>
                <label>Тип условия</label>
                <select name="condition_type" id="condition_type_select">
                    {% set cond_type = cond_config.get('condition_type', 'LEGACY') if cond_config else 'LEGACY' %}
                    <option value="LEGACY" {% if cond_type == 'LEGACY' %}selected{% endif %}>Проверка переменной</option>
                    <option value="CHECK_SUBSCRIPTION" {% if cond_type == 'CHECK_SUBSCRIPTION' %}selected{% endif %}>Проверка подписки</option>
                </select>
                <div class="hint">Выберите, что проверяет этот узел.</div>
            </div>
        </div>

        <div id="condition_legacy_fields">
            <div class="row">
                <div>
                    <label>Переменная <span class="help-icon" title="Что проверяем: берётся из ранее сохранённых переменных пользователя">?</span></label>
                    <input type="text" name="cond_var_key" id="cond_var_key_input" value="{{ node.cond_var_key if node else '' }}" placeholder="Например: phone">
                    <div class="hint">Берётся из user_vars (переменные пользователя).</div>
                </div>
                <div>
                    <label>Оператор <span class="help-icon" title="Как сравниваем: равно, содержит, больше и т.д.">?</span></label>
                    <select name="cond_operator" id="cond_operator_select">
                        <option value="" disabled {% if node is none or not node.cond_operator %}selected{% endif %}>Выберите</option>
                        <option value="EXISTS" {% if node and node.cond_operator == 'EXISTS' %}selected{% endif %}>Существует</option>
                        <option value="NOT_EXISTS" {% if node and node.cond_operator == 'NOT_EXISTS' %}selected{% endif %}>Не существует</option>
                        <option value="EQ" {% if node and node.cond_operator == 'EQ' %}selected{% endif %}>Равно</option>
                        <option value="NEQ" {% if node and node.cond_operator == 'NEQ' %}selected{% endif %}>Не равно</option>
                        <option value="CONTAINS" {% if node and node.cond_operator == 'CONTAINS' %}selected{% endif %}>Содержит</option>
                        <option value="STARTS_WITH" {% if node and node.cond_operator == 'STARTS_WITH' %}selected{% endif %}>Начинается с</option>
                        <option value="ENDS_WITH" {% if node and node.cond_operator == 'ENDS_WITH' %}selected{% endif %}>Заканчивается на</option>
                        <option value="GT" {% if node and node.cond_operator == 'GT' %}selected{% endif %}>Больше (число)</option>
                        <option value="GTE" {% if node and node.cond_operator == 'GTE' %}selected{% endif %}>Больше или равно (число)</option>
                        <option value="LT" {% if node and node.cond_operator == 'LT' %}selected{% endif %}>Меньше (число)</option>
                        <option value="LTE" {% if node and node.cond_operator == 'LTE' %}selected{% endif %}>Меньше или равно (число)</option>
                    </select>
                </div>
            </div>

            <label>Значение <span class="help-icon" title="С чем сравниваем. Для операторов 'Существует/Не существует' можно оставить пустым.">?</span></label>
            <input type="text" name="cond_value" id="cond_value_input" value="{{ node.cond_value if node else '' }}" placeholder="Например: +7">
            <div class="hint">Не нужно для «Существует/Не существует».</div>

            <div class="row">
                <div>
                    <label>Переход если TRUE (код узла) <span class="help-icon" title="Куда вести пользователя, если условие выполнено">?</span></label>
                    <input type="text" name="next_node_code_true" id="next_node_code_true_input" value="{{ node.next_node_code_true if node else '' }}" placeholder="Например: MAIN_MENU">
                </div>
                <div>
                    <label>Переход если FALSE (код узла) <span class="help-icon" title="Куда вести, если условие не сработало">?</span></label>
                    <input type="text" name="next_node_code_false" id="next_node_code_false_input" value="{{ node.next_node_code_false if node else '' }}" placeholder="Например: ASK_PHONE">
                </div>
            </div>

            <div class="hint">Узел не отправляет сообщение. Он сразу переводит по TRUE/FALSE.</div>
        </div>

        <div id="condition_subscription_fields" style="display:none;">
            <div class="row">
                <div>
                    <label>Каналы для проверки <span class="help-icon" title="По одному на строку. Например: @my_channel">?</span></label>
                    <textarea name="cond_sub_channels" placeholder="@my_channel&#10;@second_channel">{{ '\n'.join(sub_payload.get('channels', [])) if sub_payload else '' }}</textarea>
                    <div class="hint">Бот проверит подписку на каждый канал через getChatMember.</div>
                </div>
                <div>
                    <label>Ссылка на канал <span class="help-icon" title="Куда ведёт кнопка «Подписаться». Если оставить пустой — возьмём ссылку по первому каналу.">?</span></label>
                    <input type="text" name="cond_sub_subscribe_url" value="{{ sub_payload.get('subscribe_url', '') if sub_payload else '' }}" placeholder="https://t.me/my_channel">
                    <div class="hint">Можно оставить пустым для автосборки ссылки.</div>
                </div>
            </div>

            <div class="row">
                <div>
                    <label>Узел при успехе</label>
                    <input type="text" name="cond_sub_on_success" value="{{ sub_payload.get('on_success_node', '') if sub_payload else '' }}" placeholder="Например: MAIN_MENU">
                </div>
                <div>
                    <label>Узел при провале</label>
                    <input type="text" name="cond_sub_on_fail" value="{{ sub_payload.get('on_fail_node', '') if sub_payload else '' }}" placeholder="Обычно сам узел проверки">
                </div>
            </div>

            <label>Текст при провале</label>
            <textarea name="cond_sub_fail_message" placeholder="Подпишитесь на канал и нажмите «Проверить подписку».">{{ sub_payload.get('fail_message', '') if sub_payload else '' }}</textarea>

            <div class="row">
                <div>
                    <label>Текст кнопки проверки</label>
                    <input type="text" name="cond_sub_check_button_text" value="{{ sub_payload.get('check_button_text', 'Проверить подписку') if sub_payload else 'Проверить подписку' }}" placeholder="Проверить подписку">
                </div>
                <div>
                    <label>Текст кнопки подписки</label>
                    <input type="text" name="cond_sub_subscribe_button_text" value="{{ sub_payload.get('subscribe_button_text', 'Подписаться') if sub_payload else 'Подписаться' }}" placeholder="Подписаться">
                </div>
            </div>

            <div class="hint">Узел отправит сообщение с кнопками «Подписаться» и «Проверить подписку». Переходы берутся из полей выше.</div>
        </div>
    </div>

    <div class="hint" style="margin-top:14px;">Совет: сначала создайте узлы типа «Сообщение» и «Ожидание ввода», затем добавьте триггеры, чтобы бот знал, с чего начать.</div>

    <div class="actions">
        <button type="submit" class="button">Сохранить</button>
        <a href="/adminbot/nodes" class="button" style="background:#6b7280;">Назад</a>
    </div>
</form>

{% if node %}
<div class="card danger">
    <h3>Удалить узел</h3>
    <div class="muted">Удаление очистит кнопки, действия и отключит триггеры, которые ведут на этот узел. Переходы в других узлах будут очищены.</div>
    <form method="post" action="/adminbot/nodes/{{ node.id }}/delete" id="delete_node_form" style="margin-top:10px;">
        <button type="submit" class="button" style="background:#dc2626;">Удалить узел</button>
    </form>
</div>
{% endif %}

<div class="upload-modal" id="upload_modal">
    <div class="modal-content">
        <h3>Загрузка картинки</h3>
        <p class="muted">Допустимые форматы: jpg, png, webp. Размер до 5 МБ. После загрузки ссылка автоматически подставится в поле.</p>
        <input type="file" id="upload_input" accept="image/jpeg,image/png,image/webp" style="margin:10px 0; width:100%;">
        <div class="actions">
            <button type="button" class="button" id="start_upload_btn">Загрузить</button>
            <button type="button" class="button" id="close_upload_modal" style="background:#6b7280;">Закрыть</button>
        </div>
        <div id="upload_hint" class="muted" style="margin-top:6px;"></div>
    </div>
</div>

<script type="application/json" id="initial_actions_data">{{ actions_json|default([])|tojson }}</script>

<script>
    const form = document.querySelector('form');
    const nodeTypeSelect = document.getElementById('node_type_select');
    const messageSection = document.getElementById('message_section');
    const inputSettings = document.getElementById('input_settings');
    const conditionSettings = document.getElementById('condition_settings');
    const conditionTypeSelect = document.getElementById('condition_type_select');
    const conditionLegacyFields = document.getElementById('condition_legacy_fields');
    const conditionSubscriptionFields = document.getElementById('condition_subscription_fields');
    const actionSettings = document.getElementById('action_settings');
    const condVarKeyInput = document.getElementById('cond_var_key_input');
    const condOperatorSelect = document.getElementById('cond_operator_select');
    const condValueInput = document.getElementById('cond_value_input');
    const nextNodeTrueInput = document.getElementById('next_node_code_true_input');
    const nextNodeFalseInput = document.getElementById('next_node_code_false_input');
    const actionsContainer = document.getElementById('actions_container');
    const addActionBtn = document.getElementById('add_action_btn');
    const actionsDataElement = document.getElementById('initial_actions_data');
    const inputMinLenInput = document.querySelector('input[name="input_min_len"]');
    const uploadModal = document.getElementById('upload_modal');
    const openUploadBtn = document.getElementById('open_upload_modal');
    const closeUploadBtn = document.getElementById('close_upload_modal');
    const startUploadBtn = document.getElementById('start_upload_btn');
    const uploadInput = document.getElementById('upload_input');
    const uploadHint = document.getElementById('upload_hint');
    const imageUrlInput = document.getElementById('image_url_input');
    const copyImageBtn = document.getElementById('copy_image_url_btn');
    const deleteForm = document.getElementById('delete_node_form');

    const FIELDS_BY_TYPE = {
        SET_VAR: ['var', 'value'],
        CLEAR_VAR: ['var'],
        INCREMENT_VAR: ['var', 'step'],
        DECREMENT_VAR: ['var', 'step'],
        ADD_TAG: ['tag'],
        REMOVE_TAG: ['tag'],
        SEND_MESSAGE: ['text'],
        SEND_ADMIN_MESSAGE: ['text'],
        GOTO_NODE: ['node'],
        GOTO_MAIN: [],
        STOP_FLOW: [],
        REQUEST_CONTACT: ['text'],
        REQUEST_LOCATION: ['text'],
    };

    const ACTION_OPTIONS = [
        { value: 'SET_VAR', label: 'Установить переменную' },
        { value: 'CLEAR_VAR', label: 'Очистить переменную' },
        { value: 'INCREMENT_VAR', label: 'Увеличить значение' },
        { value: 'DECREMENT_VAR', label: 'Уменьшить значение' },
        { value: 'ADD_TAG', label: 'Добавить тег пользователю' },
        { value: 'REMOVE_TAG', label: 'Удалить тег у пользователя' },
        { value: 'SEND_MESSAGE', label: 'Отправить сообщение пользователю' },
        { value: 'SEND_ADMIN_MESSAGE', label: 'Уведомить администратора' },
        { value: 'GOTO_NODE', label: 'Перейти в узел' },
        { value: 'GOTO_MAIN', label: 'Перейти в главное меню' },
        { value: 'STOP_FLOW', label: 'Остановить сценарий' },
        { value: 'REQUEST_CONTACT', label: 'Запросить контакт' },
        { value: 'REQUEST_LOCATION', label: 'Запросить геолокацию' },
    ];
    const UNKNOWN_ACTION_LABEL = 'Удалено или недоступно';

    function setSectionEnabled(section, enabled, clearValues = false) {
        if (!section) return;
        section.style.display = enabled ? 'block' : 'none';
        section.querySelectorAll('input, select, textarea').forEach((el) => {
            if (!el.dataset.keepEnabled) {
                el.disabled = !enabled;
            }
            if (!enabled) {
                el.required = false;
            }
            if (clearValues && !enabled && !el.dataset.keepValue) {
                if (el.type === 'checkbox') {
                    el.checked = false;
                } else {
                    el.value = '';
                }
            }
        });
    }

    function toggleConditionTypeFields() {
        if (!conditionTypeSelect) {
            return;
        }
        const type = (conditionTypeSelect.value || 'LEGACY').toUpperCase();
        if (conditionLegacyFields) {
            setSectionEnabled(conditionLegacyFields, type === 'LEGACY', true);
        }
        if (conditionSubscriptionFields) {
            setSectionEnabled(conditionSubscriptionFields, type === 'CHECK_SUBSCRIPTION', true);
        }
    }

    const REQUIRED_BY_TYPE = {
        MESSAGE: ['message_text'],
        INPUT: ['input_type', 'input_var_key', 'next_node_code_success'],
        CONDITION: ['cond_var_key', 'cond_operator', 'next_node_code_true', 'next_node_code_false'],
        ACTION: [],
    };

    const REQUIRED_FOR_SUBSCRIPTION = ['cond_sub_channels', 'cond_sub_on_success', 'cond_sub_on_fail'];

    function resetRequired() {
        form.querySelectorAll('input, select, textarea').forEach((el) => {
            if (el.dataset.lockRequired) {
                el.required = true;
            } else {
                el.required = false;
            }
        });
    }

    function isFieldVisible(field) {
        if (!field) return false;
        if (field.disabled) return false;
        const style = getComputedStyle(field);
        if (style.display === 'none' || style.visibility === 'hidden') {
            return false;
        }
        return !!(field.offsetParent || field.getClientRects().length);
    }

    function markRequired(names = []) {
        names.forEach((name) => {
            const field = form.elements[name];
            if (field && isFieldVisible(field)) {
                field.required = true;
            }
        });
    }

    function clearHiddenRequired() {
        form.querySelectorAll('[required]').forEach((el) => {
            if (el.disabled || !isFieldVisible(el)) {
                el.required = false;
            }
        });
    }

    function syncConditionValueRequirement(activeType) {
        if (!condOperatorSelect || !condValueInput) {
            return;
        }
        const operator = (condOperatorSelect.value || '').toUpperCase();
        const needsValue = activeType === 'CONDITION' && !['EXISTS', 'NOT_EXISTS'].includes(operator);
        condValueInput.required = needsValue;
        condValueInput.disabled = activeType !== 'CONDITION' || !needsValue;
        if (!needsValue) {
            condValueInput.value = '';
        }
    }

    function ensureDefaultNumbers(activeType) {
        if (activeType === 'INPUT' && inputMinLenInput && !inputMinLenInput.value.trim()) {
            inputMinLenInput.value = '0';
        }
        if (activeType !== 'INPUT' && inputMinLenInput) {
            inputMinLenInput.value = '';
        }
    }

    function syncFormByType() {
        const type = (nodeTypeSelect.value || 'MESSAGE').toUpperCase();

        resetRequired();
        toggleConditionTypeFields();

        setSectionEnabled(inputSettings, type === 'INPUT', true);
        setSectionEnabled(conditionSettings, type === 'CONDITION', true);
        setSectionEnabled(actionSettings, type === 'ACTION', true);

        if (messageSection) {
            setSectionEnabled(messageSection, true, false);
        }

        markRequired(REQUIRED_BY_TYPE[type] || []);

        if (type === 'CONDITION' && conditionTypeSelect && conditionTypeSelect.value === 'CHECK_SUBSCRIPTION') {
            markRequired(REQUIRED_FOR_SUBSCRIPTION);
        }

        syncConditionValueRequirement(type);
        ensureDefaultNumbers(type);
        clearHiddenRequired();
    }

    function showClientErrors(errors) {
        const errorBox = document.getElementById('client_errors');
        if (!errorBox) return;
        if (!errors.length) {
            errorBox.style.display = 'none';
            errorBox.innerHTML = '';
            return;
        }
        errorBox.innerHTML = errors.map((item) => `<div>${item}</div>`).join('');
        errorBox.style.display = 'block';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function validateFormBeforeSubmit() {
        const type = (nodeTypeSelect.value || 'MESSAGE').toUpperCase();
        const errors = [];
        const codeValue = (form.elements['code']?.value || '').trim();
        const titleValue = (form.elements['title']?.value || '').trim();

        if (!codeValue) {
            errors.push('Укажите код узла (пример: MAIN_MENU).');
        }
        if (!titleValue) {
            errors.push('Заполните название узла.');
        }

        if (type === 'INPUT') {
            const inputTypeValue = (form.elements['input_type']?.value || '').trim();
            const varKeyValue = (form.elements['input_var_key']?.value || '').trim();
            const successNodeValue = (form.elements['next_node_code_success']?.value || '').trim();

            if (!inputTypeValue) {
                errors.push('Выберите тип ввода.');
            }
            if (!varKeyValue) {
                errors.push('Укажите ключ переменной для сохранения ответа.');
            }
            if (!successNodeValue) {
                errors.push('Добавьте переход при успешном вводе.');
            }
        }

        if (type === 'CONDITION') {
            const condType = (conditionTypeSelect?.value || 'LEGACY').toUpperCase();
            if (condType === 'CHECK_SUBSCRIPTION') {
                const channels = (form.elements['cond_sub_channels']?.value || '').trim();
                if (!channels) {
                    errors.push('Добавьте хотя бы один канал для проверки подписки.');
                }
            } else {
                const condVar = (form.elements['cond_var_key']?.value || '').trim();
                const condOperator = (form.elements['cond_operator']?.value || '').trim();
                const condTrue = (form.elements['next_node_code_true']?.value || '').trim();
                const condFalse = (form.elements['next_node_code_false']?.value || '').trim();
                if (!condVar || !condOperator || !condTrue || !condFalse) {
                    errors.push('Заполните все обязательные поля для узла «Условие».');
                }
            }
        }

        showClientErrors(errors);
        return !errors.length;
    }

    function escapeHtml(value) {
        return (value || '').toString()
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }

    function updateActionFields(card) {
        const type = (card.querySelector('.action-type')?.value || '').toUpperCase();
        const allowed = FIELDS_BY_TYPE[type] || [];
        card.querySelectorAll('[data-field]').forEach((field) => {
            field.style.display = allowed.includes(field.dataset.field) ? 'block' : 'none';
        });
    }

    function syncSortOrders() {
        const cards = actionsContainer.querySelectorAll('.action-card');
        cards.forEach((card, index) => {
            const sortInput = card.querySelector('.action-sort');
            if (sortInput) {
                sortInput.value = index;
            }
        });
    }

    function attachActionHandlers(card) {
        const typeSelect = card.querySelector('.action-type');
        const enabledToggle = card.querySelector('.action-enabled-toggle');
        const enabledValue = card.querySelector('.action-enabled-value');
        const removeBtn = card.querySelector('.remove-action');
        const moveUpBtn = card.querySelector('.move-up');
        const moveDownBtn = card.querySelector('.move-down');

        if (typeSelect) {
            typeSelect.addEventListener('change', () => updateActionFields(card));
        }
        if (enabledToggle && enabledValue) {
            enabledToggle.addEventListener('change', () => {
                enabledValue.value = enabledToggle.checked ? '1' : '0';
            });
        }
        if (removeBtn) {
            removeBtn.addEventListener('click', () => {
                card.remove();
                syncSortOrders();
            });
        }
        if (moveUpBtn) {
            moveUpBtn.addEventListener('click', () => {
                const prev = card.previousElementSibling;
                if (prev) {
                    actionsContainer.insertBefore(card, prev);
                    syncSortOrders();
                }
            });
        }
        if (moveDownBtn) {
            moveDownBtn.addEventListener('click', () => {
                const next = card.nextElementSibling;
                if (next) {
                    actionsContainer.insertBefore(next, card);
                    syncSortOrders();
                }
            });
        }

        updateActionFields(card);
    }

    function buildActionCard(data = {}) {
        const payload = data.action_payload || data.payload || {};
        const index = actionsContainer.querySelectorAll('.action-card').length;
        const selectedType = (data.action_type || data.actionType || 'SET_VAR').toUpperCase();
        const options = [...ACTION_OPTIONS];
        if (selectedType && !options.some((opt) => opt.value === selectedType)) {
            options.push({ value: selectedType, label: `${UNKNOWN_ACTION_LABEL} (${selectedType})` });
        }
        const html = `
            <div class="action-card">
                <div class="action-header">
                    <div style="flex:1;">
                        <label>Тип действия</label>
                        <select name="action_type" class="action-type">
                            ${options.map((opt) => `<option value="${opt.value}" ${opt.value === selectedType ? 'selected' : ''}>${opt.label}</option>`).join('')}
                        </select>
                        <input type="number" name="action_sort" class="action-sort" value="${index}" style="display:none;">
                        <input type="hidden" name="action_enabled" class="action-enabled-value" value="${data.is_enabled === false ? '0' : '1'}">
                        <div class="checkbox">
                            <input type="checkbox" class="action-enabled-toggle" ${data.is_enabled === false ? '' : 'checked'}>
                            <label style="margin:0; font-weight:normal;">Включено</label>
                        </div>
                    </div>
                    <div class="action-controls">
                        <button type="button" class="button move-up" title="Вверх">↑</button>
                        <button type="button" class="button move-down" title="Вниз">↓</button>
                        <button type="button" class="button remove-action" style="background:#dc2626;">Удалить</button>
                    </div>
                </div>
                <div class="action-fields">
                    <div class="row">
                        <div data-field="var">
                            <label>Ключ переменной</label>
                            <input type="text" name="action_var_key" value="${escapeHtml(payload.key || '')}" placeholder="например: name">
                        </div>
                        <div data-field="value">
                            <label>Значение</label>
                            <input type="text" name="action_value" value="${escapeHtml(payload.value || '')}" placeholder="строка или шаблон {{var}}">
                        </div>
                        <div data-field="step">
                            <label>Шаг изменения (число)</label>
                            <input type="number" name="action_step" value="${escapeHtml(payload.step || '')}" placeholder="по умолчанию 1">
                        </div>
                        <div data-field="tag">
                            <label>Тег</label>
                            <input type="text" name="action_tag" value="${escapeHtml(payload.tag || '')}" placeholder="например: lead">
                        </div>
                        <div data-field="node">
                            <label>Код узла для перехода</label>
                            <input type="text" name="action_node_code" value="${escapeHtml(payload.node_code || '')}" placeholder="MAIN_MENU">
                        </div>
                    </div>
                    <div data-field="text" style="margin-top:10px;">
                        <label>Текст</label>
                        <textarea name="action_text" placeholder="Текст сообщения или запроса">${escapeHtml(payload.text || '')}</textarea>
                        <div class="hint">Поддерживаются переменные {{var}}, {{telegram_id}}, {{username}}.</div>
                    </div>
                </div>
            </div>
        `;

        const wrapper = document.createElement('div');
        wrapper.innerHTML = html.trim();
        const card = wrapper.firstElementChild;
        actionsContainer.appendChild(card);
        attachActionHandlers(card);
    }

    function initActions() {
        let initialActions = [];
        if (!actionsDataElement) {
            return;
        }
        try {
            initialActions = JSON.parse(actionsDataElement.textContent || '[]');
        } catch (e) {
            initialActions = [];
        }

        if (initialActions.length) {
            initialActions.sort((a, b) => (a.sort_order || a.sortOrder || 0) - (b.sort_order || b.sortOrder || 0));
            initialActions.forEach((action) => buildActionCard(action));
        }

        if (!initialActions.length) {
            // пустой список — можно добавить вручную
        }
    }

    if (addActionBtn) {
        addActionBtn.addEventListener('click', () => {
            buildActionCard({});
            syncSortOrders();
        });
    }

    nodeTypeSelect.addEventListener('change', syncFormByType);
    if (condOperatorSelect) {
        condOperatorSelect.addEventListener('change', () => syncFormByType());
    }
    if (conditionTypeSelect) {
        conditionTypeSelect.addEventListener('change', () => syncFormByType());
    }

    function cleanEmptyNumbers(targetForm, activeType) {
        const numericInputs = targetForm.querySelectorAll('input[type="number"]');
        numericInputs.forEach((input) => {
            if (input.disabled) {
                return;
            }
            const value = (input.value || '').toString().trim();
            if (input.name === 'input_min_len') {
                if (activeType !== 'INPUT') {
                    input.disabled = true;
                    input.value = '';
                    return;
                }
                if (value === '') {
                    input.value = '0';
                }
                return;
            }
            if (value === '') {
                input.disabled = true;
            }
        });
    }

    function toggleUploadModal(show) {
        if (!uploadModal) return;
        uploadModal.style.display = show ? 'flex' : 'none';
        if (show && uploadInput) {
            uploadInput.value = '';
        }
        if (uploadHint) {
            uploadHint.textContent = '';
        }
    }

    async function uploadImage() {
        if (!uploadInput || !uploadInput.files.length) {
            if (uploadHint) uploadHint.textContent = 'Выберите файл изображения.';
            return;
        }
        const file = uploadInput.files[0];
        const formData = new FormData();
        formData.append('file', file);
        uploadHint.textContent = 'Загружаем...';
        try {
            const response = await fetch('/adminbot/media/upload', { method: 'POST', body: formData });
            const data = await response.json();
            if (!response.ok) {
                uploadHint.textContent = data.error || 'Не удалось загрузить изображение.';
                return;
            }
            if (imageUrlInput) {
                imageUrlInput.value = data.url;
            }
            uploadHint.textContent = 'Готово! Ссылка подставлена.';
            toggleUploadModal(false);
        } catch (err) {
            uploadHint.textContent = 'Ошибка загрузки: ' + err;
        }
    }

    function copyImageUrl() {
        if (!imageUrlInput) return;
        const value = imageUrlInput.value || '';
        if (!value) {
            alert('Поле пустое: загрузите изображение или вставьте ссылку.');
            return;
        }
        navigator.clipboard.writeText(value).then(() => {
            alert('URL скопирован.');
        }).catch(() => {
            imageUrlInput.select();
        });
    }

    if (form) {
        form.addEventListener('submit', (event) => {
            syncFormByType();
            const activeType = (nodeTypeSelect.value || 'MESSAGE').toUpperCase();
            const isValid = validateFormBeforeSubmit();
            if (!isValid) {
                event.preventDefault();
                return;
            }
            cleanEmptyNumbers(form, activeType);
            clearHiddenRequired();
        });
    }

    if (openUploadBtn) {
        openUploadBtn.addEventListener('click', () => toggleUploadModal(true));
    }
    if (closeUploadBtn) {
        closeUploadBtn.addEventListener('click', () => toggleUploadModal(false));
    }
    if (startUploadBtn) {
        startUploadBtn.addEventListener('click', uploadImage);
    }
    if (uploadModal) {
        uploadModal.addEventListener('click', (event) => {
            if (event.target === uploadModal) {
                toggleUploadModal(false);
            }
        });
    }
    if (copyImageBtn) {
        copyImageBtn.addEventListener('click', copyImageUrl);
    }

    if (deleteForm) {
        const refCounts = { nodes: {{ ref_nodes|length if node else 0 }}, buttons: {{ ref_buttons|length if node else 0 }}, triggers: {{ ref_triggers|length if node else 0 }} };
        deleteForm.addEventListener('submit', (event) => {
            const warning = `Вы точно хотите удалить узел? Будут очищены переходы (${refCounts.nodes}), кнопки (${refCounts.buttons}) и отключены триггеры (${refCounts.triggers}).`;
            if (!confirm(warning)) {
                event.preventDefault();
            }
        });
    }

    initActions();
    syncSortOrders();
    syncFormByType();
</script>
</body>
</html>
