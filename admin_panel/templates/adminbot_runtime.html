<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–†–∞–±–æ—Ç–∞ –±–æ—Ç–∞</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 16px; background: #f5f5f5; }
        header { display: flex; gap: 12px; margin-bottom: 16px; }
        .card { background: #fff; padding: 16px; border: 1px solid #cbd5e1; border-radius: 6px; max-width: 600px; }
        .button { padding: 8px 12px; border: none; background: #2563eb; color: #fff; border-radius: 4px; text-decoration: none; cursor: pointer; }
        .muted { color: #475569; font-size: 14px; }
        .log-box { background: #0f172a; color: #e2e8f0; padding: 12px; border-radius: 6px; max-height: 260px; overflow: auto; white-space: pre-wrap; font-family: "SFMono-Regular", Consolas, "Liberation Mono", monospace; font-size: 13px; }
    </style>
</head>
<body>
<header>
    <a href="/adminbot" class="button">–ì–ª–∞–≤–Ω–∞—è</a>
    <a href="/adminbot/templates" class="button">–®–∞–±–ª–æ–Ω—ã</a>
    <a href="/adminbot/nodes" class="button">–£–∑–ª—ã</a>
    <a href="/adminbot/triggers" class="button">–¢—Ä–∏–≥–≥–µ—Ä—ã</a>
    <a href="/adminbot/media" class="button">–ú–µ–¥–∏–∞</a>
    <a href="/adminbot/runtime" class="button" style="background:#0ea5e9;">–†–∞–±–æ—Ç–∞ –±–æ—Ç–∞</a>
    <a href="/adminbot/logs" class="button">–õ–æ–≥–∏</a>
    <a href="/adminbot/logout" class="button" style="background:#dc2626;">–í—ã–π—Ç–∏</a>
</header>
<div class="card">
    <h2>–†–∞–±–æ—Ç–∞ –±–æ—Ç–∞</h2>
    <p>–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è —Å—Ü–µ–Ω–∞—Ä–∏—è: <strong>{{ runtime.config_version }}</strong></p>
    <p class="muted">–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤–µ—Ä—Å–∏–∏ –±–æ—Ç –æ–±–Ω–æ–≤–∏—Ç –∫—ç—à –º–µ–Ω—é. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.</p>
    <form method="post" action="/adminbot/runtime">
        <input type="hidden" name="action" value="bump">
        <button type="submit" class="button" title="–ù–∞–∂–º–∏—Ç–µ, –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏ —É–∑–ª—ã –∏–ª–∏ —Ç—Ä–∏–≥–≥–µ—Ä—ã, —á—Ç–æ–±—ã –±–æ—Ç –ø–æ–¥—Ö–≤–∞—Ç–∏–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è">–û–±–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞</button>
    </form>
    <p class="muted" style="margin-top:10px;">–ï—Å–ª–∏ –±–æ—Ç –≤–µ–¥—ë—Ç —Å–µ–±—è –∫–∞–∫ —Ä–∞–Ω—å—à–µ, —É–≤–µ–ª–∏—á—å—Ç–µ –Ω–æ–º–µ—Ä –≤–µ—Ä—Å–∏–∏ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–û–±–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞¬ª.</p>
</div>

<div class="card" style="margin-top:16px;">
    <h2>–°—Ç–∞—Ä—Ç–æ–≤—ã–π —É–∑–µ–ª (/start)</h2>
    <p class="muted">–£–∫–∞–∂–∏—Ç–µ –∫–æ–¥ —É–∑–ª–∞, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–ª–∂–µ–Ω –æ—Ç–∫—Ä—ã–≤–∞—Ç—å—Å—è –ø–æ –∫–æ–º–∞–Ω–¥–µ /start. –ù–∞–ø—Ä–∏–º–µ—Ä: <code>MAIN_MENU</code> –∏–ª–∏ <code>SUBSCRIPTION_CHECK</code>.</p>
    <form method="post" action="/adminbot/runtime" style="margin-top:12px; display:flex; gap:8px; align-items:flex-end;">
        <input type="hidden" name="action" value="update_start">
        <div style="flex:1;">
            <label for="start_node_code" style="display:block; font-weight:bold;">–ö–æ–¥ —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ —É–∑–ª–∞</label>
            <input type="text" id="start_node_code" name="start_node_code" value="{{ runtime.start_node_code or 'MAIN_MENU' }}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: SUBSCRIPTION_CHECK" style="width:100%; padding:8px; border:1px solid #cbd5e1; border-radius:4px;">
            <div class="muted" style="margin-top:6px;">–ß—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ–¥–ø–∏—Å–∫–∏, —Å–æ–∑–¥–∞–π—Ç–µ —É–∑–µ–ª-—É—Å–ª–æ–≤–∏–µ <strong>SUBSCRIPTION_CHECK</strong> –∏ —É–∫–∞–∂–∏—Ç–µ –µ–≥–æ –∑–¥–µ—Å—å.</div>
        </div>
        <button type="submit" class="button" style="height:42px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </form>
</div>

<div class="card" style="margin-top:16px;">
    <h2>Deploy –ø—Ä–æ–µ–∫—Ç–∞</h2>
    <p class="muted">Deploy –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ systemd-—é–Ω–∏—Ç <code>miniden-deploy.service</code> (root ‚Üí <code>/opt/miniden/deploy.sh</code>).</p>
    <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-top:8px;">
        <button type="button" id="deploy-run" class="button">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å Deploy</button>
        <button type="button" id="deploy-status" class="button" style="background:#475569;">üìÑ –°—Ç–∞—Ç—É—Å (systemd)</button>
        <span id="deploy-running" class="muted"></span>
    </div>
    <div id="deploy-meta" class="muted" style="margin-top:8px;">–í—ã–≤–æ–¥ <code>systemctl status miniden-deploy.service</code> –ø–æ—è–≤–∏—Ç—Å—è –Ω–∏–∂–µ.</div>
    <pre id="deploy-log" class="log-box" style="margin-top:12px;">–°—Ç–∞—Ç—É—Å –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω.</pre>
</div>

<script>
    (() => {
        const runButton = document.getElementById('deploy-run');
        const statusButton = document.getElementById('deploy-status');
        const meta = document.getElementById('deploy-meta');
        const runningLabel = document.getElementById('deploy-running');
        const logBox = document.getElementById('deploy-log');

        let refreshTimer = null;

        function scheduleRefresh(isRunning) {
            if (refreshTimer) {
                clearTimeout(refreshTimer);
            }
            refreshTimer = null;
            if (isRunning) {
                refreshTimer = setTimeout(() => fetchStatus(false), 8000);
            }
        }

        function renderStatus(data) {
            const running = Boolean(data?.running);
            const pidText = data?.pid ? `PID ${data.pid}` : 'PID –Ω–µ –Ω–∞–π–¥–µ–Ω';
            const activeState = data?.active_state || 'unknown';
            const result = data?.result || 'unknown';
            const statusOutput = data?.status_output || '–°—Ç–∞—Ç—É—Å systemd –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.';

            runningLabel.textContent = running ? '–°—Ç–∞—Ç—É—Å: –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è' : '–°—Ç–∞—Ç—É—Å: –Ω–µ –∑–∞–ø—É—â–µ–Ω';
            meta.textContent = `systemd: ${activeState} / ${result} (${pidText})`;

            logBox.textContent = statusOutput;

            scheduleRefresh(running);
        }

        async function fetchStatus(showToast = true) {
            try {
                const response = await fetch('/admin/deploy/status');
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å');
                }
                const payload = await response.json();
                renderStatus(payload);
                if (showToast) {
                    alert(`–°—Ç–∞—Ç—É—Å: ${payload.running ? '–∏–¥—ë—Ç' : '–Ω–µ—Ç'}${payload.pid ? ` (pid ${payload.pid})` : ''}`);
                }
            } catch (error) {
                scheduleRefresh(false);
                meta.textContent = `–û—à–∏–±–∫–∞: ${error?.message || error}`;
            }
        }

        async function runDeploy() {
            try {
                const response = await fetch('/admin/deploy/run', { method: 'POST' });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å deploy');
                }

                const payload = await response.json();

                if (payload.status === 'already_running') {
                    alert(`‚è≥ Deploy —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è (pid ${payload.pid || '–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'})`);
                } else if (payload.status === 'started') {
                    alert(`‚úÖ Deploy –∑–∞–ø—É—â–µ–Ω (pid ${payload.pid || '–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'})`);
                }

                renderStatus(payload);
            } catch (error) {
                scheduleRefresh(false);
                alert(`–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: ${error?.message || error}`);
            }
        }

        runButton?.addEventListener('click', (event) => {
            event.preventDefault();
            runDeploy();
        });

        statusButton?.addEventListener('click', (event) => {
            event.preventDefault();
            fetchStatus(true);
        });

        fetchStatus(false);
    })();
</script>
</body>
</html>
