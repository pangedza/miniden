<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Применение шаблона</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 16px; background: #f8fafc; }
        header { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }
        a.button, button { padding: 6px 10px; background: #2563eb; color: #fff; text-decoration: none; border: none; border-radius: 4px; cursor: pointer; }
        .muted { color: #475569; font-size: 14px; }
        .section { background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 14px; margin-bottom: 14px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 8px; border: 1px solid #e5e7eb; text-align: left; }
        th { background: #f1f5f9; }
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 12px; background: #e0f2fe; color: #0369a1; }
        .success { background: #ecfdf3; border: 1px solid #bbf7d0; padding: 10px; border-radius: 6px; color: #166534; }
        .error { background: #fef2f2; border: 1px solid #fecaca; padding: 10px; border-radius: 6px; color: #b91c1c; }
        .actions { display: flex; gap: 10px; align-items: center; margin-top: 10px; flex-wrap: wrap; }
        .card { background:#f8fafc; border:1px dashed #cbd5e1; padding:10px; border-radius:6px; margin-top:8px; }
    </style>
</head>
<body>
<header>
    <a href="/adminbot" class="button">Главная</a>
    <a href="/adminbot/builder" class="button" style="background:#0ea5e9;">Сборка бота</a>
    <a href="/adminbot/integrity" class="button">Проверка целостности</a>
    <a href="/adminbot/templates" class="button" style="background:#0ea5e9;">Шаблоны</a>
    <a href="/adminbot/nodes" class="button">Узлы</a>
    <a href="/adminbot/triggers" class="button">Триггеры</a>
    <a href="/adminbot/automations" class="button">Автоматизации</a>
    <a href="/adminbot/media" class="button">Медиа</a>
    <a href="/adminbot/runtime" class="button">Работа бота</a>
    <a href="/adminbot/logs" class="button">Логи</a>
    <a href="/adminbot/logout" class="button" style="background:#dc2626;">Выйти</a>
</header>
<h2>{{ template.title }}</h2>
<div class="muted">Код шаблона: {{ template.code }}</div>
{% if template.description %}<p>{{ template.description }}</p>{% endif %}
<div class="section">
    <h3>Preview + подтверждение изменений</h3>
    <div class="muted">При совпадениях мы ничего не перезаписываем. Если нужно заменить, отметьте чекбокс.</div>
    <form method="post" action="/adminbot/templates/{{ template.code }}/apply">
        {% set conflicts = preview_nodes|selectattr('conflict')|list %}
        {% set button_conflicts = (preview_buttons or [])|selectattr('conflict')|list %}
        {% set preset_conflicts = (preview_presets or [])|selectattr('conflict')|list %}
        {% set automation_conflicts = (preview_automations or [])|selectattr('conflict')|list %}

        {% if conflicts or button_conflicts or preset_conflicts or automation_conflicts %}
        <div class="card" style="margin-top:10px;">
            <strong>Совпадения (по умолчанию не трогаем)</strong>
            <div class="muted" style="margin-top:6px;">Отметьте, чтобы заменить существующие данные.</div>
            {% for node in conflicts %}
            <label style="display:block; margin-top:6px;">
                <input type="checkbox" name="replace_items" value="{{ node.replace_key }}" {% if replace_items and node.replace_key in replace_items %}checked{% endif %}>
                Заменить узел: {{ node.title }} ({{ node.new_code }})
            </label>
            {% endfor %}
            {% for btn in button_conflicts %}
            <label style="display:block; margin-top:6px;">
                <input type="checkbox" name="replace_items" value="{{ btn.replace_key }}" {% if replace_items and btn.replace_key in replace_items %}checked{% endif %}>
                Заменить кнопку: {{ btn.title }} (узел {{ btn.node_code }})
            </label>
            {% endfor %}
            {% for preset in preset_conflicts %}
            <label style="display:block; margin-top:6px;">
                <input type="checkbox" name="replace_items" value="{{ preset.replace_key }}" {% if replace_items and preset.replace_key in replace_items %}checked{% endif %}>
                Заменить пресет: {{ preset.title }}
            </label>
            {% endfor %}
            {% for automation in automation_conflicts %}
            <label style="display:block; margin-top:6px;">
                <input type="checkbox" name="replace_items" value="{{ automation.replace_key }}" {% if replace_items and automation.replace_key in replace_items %}checked{% endif %}>
                Заменить автоматизацию: {{ automation.title }}
            </label>
            {% endfor %}
        </div>
        {% else %}
        <div class="muted" style="margin-top:8px;">Совпадений нет — всё будет создано как новое.</div>
        {% endif %}

        <div class="actions" style="margin-top:12px;">
            <button type="submit">Применить шаблон</button>
            <a href="/adminbot/nodes" class="button" style="background:#0ea5e9;">Открыть узлы</a>
        </div>
    </form>
    {% if applied and result %}
    <div class="success" style="margin-top:10px;">
        Шаблон применён. Создано узлов: {{ result.nodes|length }}, кнопок: {{ result.buttons_created or 0 }}, действий: {{ result.actions_created or 0 }}, триггеров: {{ result.triggers|length }}.
    </div>
    {% endif %}
    {% if error %}
    <div class="error" style="margin-top:10px;">{{ error }}</div>
    {% endif %}
</div>
<div class="section">
    <h3>Узлы</h3>
    <table>
        <thead>
        <tr>
            <th>Исходный код</th>
            <th>Новый код</th>
            <th>Название</th>
            <th>Тип</th>
            <th>Переходы</th>
            <th>Кнопок</th>
            <th>Действий</th>
            <th>Действие</th>
        </tr>
        </thead>
        <tbody>
        {% for node in preview_nodes %}
        <tr>
            <td>{{ node.code }}</td>
            <td><span class="badge">{{ node.new_code }}</span></td>
            <td>{{ node.title }}</td>
            <td>{{ node.node_type }}</td>
            <td class="muted">
                {% if node.next_success %}Успех → {{ node.next_success }}<br>{% endif %}
                {% if node.next_cancel %}Отмена → {{ node.next_cancel }}<br>{% endif %}
                {% if node.next_node %}Следующий → {{ node.next_node }}{% endif %}
            </td>
            <td>{{ node.buttons|length }}</td>
            <td>{{ node.actions|length }}</td>
            <td>{% if node.action == 'replace' %}♻️ заменить{% elif node.action == 'skip' %}⏭ пропустить{% else %}➕ создать{% endif %}</td>
        </tr>
        {% else %}
        <tr><td colspan="8">В шаблоне нет узлов</td></tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% if preview_buttons %}
<div class="section">
    <h3>Кнопки</h3>
    <table>
        <thead>
        <tr>
            <th>Узел</th>
            <th>Название</th>
            <th>Действие</th>
        </tr>
        </thead>
        <tbody>
        {% for btn in preview_buttons %}
        <tr>
            <td>{{ btn.node_code }}</td>
            <td>{{ btn.title }}</td>
            <td>{% if btn.action == 'replace' %}♻️ заменить{% elif btn.action == 'skip' %}⏭ пропустить{% else %}➕ создать{% endif %}</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}
{% if preview_presets %}
<div class="section">
    <h3>Пресеты кнопок</h3>
    <table>
        <thead>
        <tr>
            <th>Название</th>
            <th>Scope</th>
            <th>Действие</th>
        </tr>
        </thead>
        <tbody>
        {% for preset in preview_presets %}
        <tr>
            <td>{{ preset.title }}</td>
            <td>{{ preset.scope }}</td>
            <td>{% if preset.action == 'replace' %}♻️ заменить{% elif preset.action == 'skip' %}⏭ пропустить{% else %}➕ создать{% endif %}</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}
{% if preview_automations %}
<div class="section">
    <h3>Автоматизации</h3>
    <table>
        <thead>
        <tr>
            <th>Название</th>
            <th>Триггер</th>
            <th>Действие</th>
        </tr>
        </thead>
        <tbody>
        {% for automation in preview_automations %}
        <tr>
            <td>{{ automation.title }}</td>
            <td>{{ automation.trigger_type }}</td>
            <td>{% if automation.action == 'replace' %}♻️ заменить{% elif automation.action == 'skip' %}⏭ пропустить{% else %}➕ создать{% endif %}</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}
<div class="section">
    <h3>Триггеры</h3>
    <table>
        <thead>
        <tr>
            <th>Тип</th>
            <th>Значение</th>
            <th>Режим</th>
            <th>Целевой узел</th>
        </tr>
        </thead>
        <tbody>
        {% for trigger in preview_triggers %}
        <tr>
            <td>{{ trigger.trigger_type }}</td>
            <td>{{ trigger.trigger_value or '—' }}</td>
            <td>{{ trigger.match_mode }}</td>
            <td>{{ trigger.target_node_code }}</td>
        </tr>
        {% else %}
        <tr><td colspan="4">Триггеры не заданы</td></tr>
        {% endfor %}
        </tbody>
    </table>
</div>
</body>
</html>
