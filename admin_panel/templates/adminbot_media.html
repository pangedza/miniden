<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Медиа AdminBot</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 16px; background: #f5f5f5; }
        header { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }
        a.button, button { padding: 6px 10px; background: #2563eb; color: #fff; text-decoration: none; border: none; border-radius: 4px; cursor: pointer; }
        .card { background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 14px; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.04); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px; border: 1px solid #e5e7eb; text-align: left; }
        th { background: #f1f5f9; }
        .muted { color: #475569; font-size: 13px; }
        .actions { display: flex; gap: 8px; align-items: center; }
    </style>
</head>
<body>
<header>
    <a href="/adminbot" class="button">Главная</a>
    <a href="/adminbot/templates" class="button">Шаблоны</a>
    <a href="/adminbot/nodes" class="button">Узлы</a>
    <a href="/adminbot/triggers" class="button">Триггеры</a>
    <a href="/adminbot/media" class="button" style="background:#0ea5e9;">Медиа</a>
    <a href="/adminbot/runtime" class="button">Работа бота</a>
    <a href="/adminbot/logs" class="button">Логи</a>
    <a href="/adminbot/logout" class="button" style="background:#dc2626;">Выйти</a>
</header>

<h2>Медиафайлы</h2>
<div class="muted">Загрузите изображение (jpg, png, webp) до 5 МБ. После загрузки появится готовый URL, который можно вставить в узел.</div>

<div class="card">
    <form id="upload_form">
        <label for="upload_file">Выберите файл</label><br>
        <input type="file" id="upload_file" name="file" accept="image/jpeg,image/png,image/webp" required>
        <div class="actions" style="margin-top:10px;">
            <button type="submit">Загрузить</button>
            <span id="upload_status" class="muted"></span>
        </div>
    </form>
</div>

<div class="card">
    <h3>Загруженные файлы</h3>
    <table>
        <thead>
        <tr>
            <th>Имя файла</th>
            <th>Размер</th>
            <th>URL</th>
            <th>Действия</th>
        </tr>
        </thead>
        <tbody>
        {% for file in files %}
        <tr>
            <td>{{ file.name }}</td>
            <td>{{ (file.size / 1024)|round(1) }} КБ</td>
            <td><input type="text" value="{{ file.url }}" readonly style="width:100%;" onclick="this.select();"></td>
            <td>
                <div class="actions">
                    <button type="button" onclick="copyUrl('{{ file.url }}')">Скопировать</button>
                    <form method="post" action="/adminbot/media/delete" onsubmit="return confirm('Удалить файл?');">
                        <input type="hidden" name="filename" value="{{ file.name }}">
                        <button type="submit" style="background:#dc2626;">Удалить</button>
                    </form>
                </div>
            </td>
        </tr>
        {% else %}
        <tr><td colspan="4" class="muted">Файлы ещё не загружены.</td></tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<script>
    async function copyUrl(url) {
        try {
            await navigator.clipboard.writeText(url);
            alert('URL скопирован: ' + url);
        } catch (e) {
            prompt('Скопируйте вручную:', url);
        }
    }

    const form = document.getElementById('upload_form');
    const statusEl = document.getElementById('upload_status');
    form.addEventListener('submit', async (evt) => {
        evt.preventDefault();
        statusEl.textContent = 'Загружаем...';
        const fileInput = document.getElementById('upload_file');
        const file = fileInput.files[0];
        if (!file) {
            statusEl.textContent = 'Выберите файл';
            return;
        }
        const formData = new FormData();
        formData.append('file', file);
        const response = await fetch('/adminbot/media/upload', { method: 'POST', body: formData });
        const data = await response.json();
        if (!response.ok) {
            statusEl.textContent = data.error || 'Не удалось загрузить файл';
            return;
        }
        statusEl.textContent = 'Готово: ' + data.url;
        copyUrl(data.url);
        setTimeout(() => window.location.reload(), 500);
    });
</script>
</body>
</html>
