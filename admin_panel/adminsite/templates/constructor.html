{% extends "base_adminsite.html" %}
{% block title %}AdminSite Конструктор{% endblock %}
{% block head_extra %}
    <link rel="stylesheet" href="{{ url_for('static', path='adminsite/constructor.css') }}">
{% endblock %}
{% block content %}
<div id="constructor-status-bar"></div>
<div class="page-actions" style="justify-content: space-between; align-items:flex-start; gap:16px;">
    <div>
        <h1>Категории, элементы и WebApp кнопка</h1>
        <p class="muted">Управляйте категориями и элементами витрины. Используйте вкладку «WebApp кнопка», чтобы настроить действие красной кнопки.</p>
    </div>
    <div class="notice" style="max-width: 360px;">
        <div class="badge-list">
            <span class="tag">Категории</span>
            <span class="tag">Товары</span>
            <span class="tag">Мастер-классы</span>
            <span class="tag">WebApp</span>
        </div>
        <p style="margin-top:10px;">Все изменения сохраняются через API AdminSite без перезагрузки страницы.</p>
    </div>
</div>

<div id="global-status" class="status"></div>

<div class="tabs" id="constructor-tabs"></div>

<div id="constructor-panels"></div>

<section class="panel" id="panel-webapp">
    <div class="card">
        <div class="table-top">
            <div>
                <h3 style="margin:0;">WebApp кнопка</h3>
                <p class="muted">Настройка действия красной кнопки WebApp.</p>
            </div>
            <div class="badge-list">
                <span class="tag">action_label</span>
                <span class="tag">scope</span>
                <span class="tag">type</span>
            </div>
        </div>
        <div class="status" id="status-webapp"></div>
        <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:14px;">
            <div class="card" style="padding:14px;">
                <form id="webapp-form">
                    <label>Текст кнопки
                        <input type="text" name="action_label" id="webapp-label" placeholder="Например, Открыть витрину" required />
                    </label>
                    <label>Scope
                        <select name="scope" id="webapp-scope">
                            <option value="global">global</option>
                            <option value="category">category</option>
                        </select>
                    </label>
                    <div class="form-row">
                        <label>Type
                            <select name="type" id="webapp-type">
                                <option value="product">product — витрина товаров</option>
                                <option value="course">course — витрина мастер-классов</option>
                            </select>
                        </label>
                        <label id="webapp-category-wrapper">Category
                            <select name="category_id" id="webapp-category"></select>
                        </label>
                    </div>
                    <div class="form-row">
                        <div>
                            <label>Минимум выбранных
                                <input type="number" name="min_selected" id="webapp-min-selected" min="0" value="1" />
                            </label>
                        </div>
                        <div style="display:flex; align-items:center; gap:8px; margin-top:26px;">
                            <input type="checkbox" id="webapp-enabled" />
                            <label for="webapp-enabled" class="muted">action_enabled</label>
                        </div>
                    </div>
                    <div class="actions" style="margin-top:18px; gap:8px;">
                        <button class="btn-secondary" id="webapp-reload" type="button">Обновить</button>
                        <button class="btn-primary" type="submit">Сохранить</button>
                    </div>
                </form>
            </div>
            <div class="card" style="padding:14px;">
                <h4 style="margin-top:0;">Подсказки</h4>
                <p class="muted">Тип действия и категория влияют на то, что откроется по кнопке. Если категория не указана, используется корневая страница витрины.</p>
                <div class="divider"></div>
                <p class="muted">Флаг <b>action_enabled</b> отключает кнопку без удаления настроек.</p>
            </div>
        </div>
    </div>
</section>

<section class="panel" id="panel-homepage">
    <div class="card">
        <div class="table-top">
            <div>
                <h3 style="margin:0;">Главная страница</h3>
                <p class="muted">Визуальный редактор блоков для витрины AdminSite. Контент остаётся неизменным при смене шаблона.</p>
            </div>
            <div class="badge-list">
                <span class="tag">HeroBlock</span>
                <span class="tag">CardsBlock</span>
                <span class="tag">TextBlock</span>
                <span class="tag">SocialBlock</span>
            </div>
        </div>
        <div class="status" id="status-homepage"></div>
        <div class="homepage-top">
            <div class="template-picker" id="homepage-template">
                <div class="template-card" data-template="baskets">
                    <div class="template-preview baskets"></div>
                    <div>
                        <div class="template-title">Baskets</div>
                        <p class="muted">Тёплая палитра и плавные карточки.</p>
                    </div>
                </div>
                <div class="template-card" data-template="electronics">
                    <div class="template-preview electronics"></div>
                    <div>
                        <div class="template-title">Electronics</div>
                        <p class="muted">Контрастная тема и чёткие края.</p>
                    </div>
                </div>
                <div class="template-card" data-template="services">
                    <div class="template-preview services"></div>
                    <div>
                        <div class="template-title">Services</div>
                        <p class="muted">Нейтральная тема по умолчанию.</p>
                    </div>
                </div>
            </div>
        <div class="homepage-actions">
            <a class="btn-secondary" href="/?debug=1" target="_blank" rel="noopener" id="homepage-preview">Предпросмотр</a>
            <button class="btn-primary" type="button" id="homepage-save">Сохранить</button>
        </div>
    </div>

    <div class="homepage-layout">
        <div class="card" id="homepage-diagnostics" style="margin-bottom:16px;">
            <div class="card-header" style="gap:8px; align-items:center;">
                <h4 style="margin:0;">Диагностика</h4>
                <span class="tag" id="homepage-diagnostic-save">—</span>
                <span class="tag" id="homepage-diagnostic-public">Публичный: —</span>
            </div>
            <div class="muted" style="margin-bottom:8px;">Проверка доступности данных после сохранения.</div>
            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:8px;">
                <div class="diag-row"><strong>Источник</strong><div id="homepage-diagnostic-source">/api/adminsite/pages/home</div></div>
                <div class="diag-row"><strong>Публично</strong><div id="homepage-diagnostic-public-url">/api/site/home</div></div>
                <div class="diag-row"><strong>Page key</strong><div id="homepage-diagnostic-page">home</div></div>
                <div class="diag-row"><strong>Версия</strong><div id="homepage-diagnostic-version">—</div></div>
            </div>
        </div>
        <div class="card block-list-card">
            <div class="card-header">
                <h4 style="margin:0;">Блоки страницы</h4>
                <div class="actions" style="margin:0;">
                    <button class="btn-secondary" type="button" id="homepage-add-block">+ Добавить блок</button>
                    <button class="btn-primary" type="button" id="homepage-preset">Портфолио-пресет</button>
                    <button class="btn-ghost" type="button" id="homepage-reset">Сбросить</button>
                </div>
            </div>
                <p class="muted" style="margin-top:4px;">Перетащите блоки вверх/вниз или редактируйте содержимое справа.</p>
                <div id="homepage-blocks-list" class="block-list"></div>
                <div class="developer-toggle">
                    <label class="switch">
                        <input type="checkbox" id="homepage-dev-toggle" />
                        <span class="slider"></span>
                    </label>
                    <div>
                        <div class="template-title">Режим разработчика</div>
                        <p class="muted" style="margin:0;">Показать/скрыть JSON конфигурацию.</p>
                    </div>
                </div>
                <div id="homepage-devtools" class="devtools" hidden>
                    <p class="muted" style="margin:0 0 8px;">Измените JSON вручную или вставьте существующую конфигурацию. Сохранение поднимает валидные данные в визуальный редактор.</p>
                    <textarea id="homepage-blocks" rows="14" style="width:100%; resize:vertical; font-family: monospace;"></textarea>
                    <div class="actions" style="margin-top:12px; gap:8px;">
                        <button class="btn-secondary" type="button" id="homepage-dev-apply">Применить JSON</button>
                        <button class="btn-ghost" type="button" id="homepage-dev-hide">Скрыть</button>
                    </div>
                    <div class="status" id="homepage-dev-status"></div>
                </div>
            </div>
            <div class="card block-editor-card">
                <div class="card-header" style="align-items:center;">
                    <div>
                        <h4 style="margin:0;" id="homepage-editor-title">Редактор блока</h4>
                        <p class="muted" id="homepage-editor-subtitle" style="margin:4px 0 0;">Выберите блок слева, чтобы отредактировать.</p>
                    </div>
                    <div class="badge-list" id="homepage-block-meta"></div>
                </div>
                <div id="homepage-block-editor" class="block-editor"></div>
            </div>
        </div>
    </div>
</section>

<section class="panel" id="panel-media">
    <div class="card">
        <div class="table-top">
            <div>
                <h3 style="margin:0;">Медиа-библиотека</h3>
                <p class="muted">Загружайте изображения и копируйте URL. Подключено к тем же файлам, что использует AdminBot.</p>
            </div>
            <div class="badge-list">
                <span class="tag">upload</span>
                <span class="tag">preview</span>
                <span class="tag">copy URL</span>
            </div>
        </div>
        <div class="status" id="status-media"></div>
        <div class="media-grid">
            <div class="card upload-card">
                <h4 style="margin-top:0;">Загрузка файла</h4>
                <p class="muted" style="margin-top:-4px;">jpg, png или webp до 5 МБ</p>
                <label class="file-input">Выберите файл
                    <input type="file" id="media-upload-input" accept="image/jpeg,image/png,image/webp" />
                </label>
                <div class="actions" style="margin-top:12px;">
                    <button class="btn-primary" type="button" id="media-upload-btn">Загрузить</button>
                    <button class="btn-ghost" type="button" id="media-refresh">Обновить</button>
                </div>
                <div class="status" id="media-upload-status"></div>
            </div>
            <div class="card list-card">
                <div class="card-header" style="gap:12px;">
                    <h4 style="margin:0;">Файлы</h4>
                    <input type="search" id="media-search" placeholder="Поиск по имени" />
                </div>
                <div id="media-list" class="media-list"></div>
            </div>
        </div>
    </div>
</section>
{% endblock %}
{% block scripts %}
    <script type="module" src="{{ url_for('static', path='adminsite/constructor.js') }}"></script>
{% endblock %}
