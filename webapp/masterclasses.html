<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MiniDeN — Мастер-классы</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="css/theme.css?v=20241217" />

</head>
<body data-theme="purple" class="page-masterclasses">
  <header class="top-nav">
    <div class="brand">MiniDeN<span>уютные корзинки и мастер-классы</span></div>
    <div class="header-actions">
      <div class="theme-switcher">
        <label for="theme-select">Тема</label>
        <select id="theme-select">
          <option value="purple">Фиолетовая</option>
          <option value="dark">Тёмная</option>
          <option value="light">Светлая</option>
          <option value="cream">Сливочная</option>
        </select>
      </div>
      <button class="menu-toggle" aria-label="Открыть меню">☰</button>
    </div>
    <nav class="nav-links app-sidebar">
      <a href="index.html">Главная</a>
      <a href="products.html">Товары</a>
      <a href="masterclasses.html" class="active">Мастер-классы</a>
      <a href="cart.html">Корзина</a>
      <a href="profile.html">Профиль</a>
      <a href="admin.html" id="admin-link" style="display:none;">Админка</a>
    </nav>
  </header>

  <div class="app-sidebar-overlay"></div>
  <div id="toast-container"></div>

  <main>
    <h1>Мастер-классы</h1>

    <div class="tabs" id="tabs"></div>
    <div class="catalog-grid courses-grid" id="cards"></div>
    <div class="note" id="note"></div>
  </main>

  <div id="course-modal" class="course-modal hidden" aria-hidden="true">
    <div class="course-modal__backdrop" id="course-modal-backdrop"></div>
    <div class="course-modal__content" role="dialog" aria-modal="true">
      <button class="course-modal__close" type="button" id="course-modal-close" aria-label="Закрыть">×</button>
      <div class="course-modal__media">
        <button class="course-modal__nav course-modal__nav--prev" type="button" id="course-modal-prev" aria-label="Предыдущее изображение">‹</button>
        <img id="course-modal-image" alt="" />
        <div id="course-modal-placeholder" style="display:none; color: var(--muted); padding: 12px; text-align:center;">Нет изображения</div>
        <button class="course-modal__nav course-modal__nav--next" type="button" id="course-modal-next" aria-label="Следующее изображение">›</button>
      </div>
      <div class="course-modal__info">
        <h3 id="course-modal-title" style="margin:0;"></h3>
        <div class="meta" id="course-modal-meta"></div>
        <p class="course-modal__description" id="course-modal-description"></p>
        <div class="course-modal__price-row">
          <div class="course-modal__price" id="course-modal-price"></div>
        </div>
        <div class="course-modal__actions" id="course-modal-actions"></div>
      </div>
    </div>
  </div>

  <script src="js/app.js?v=20241217"></script>
  <script src="js/api.js?v=20241217"></script>
  <script>
    const adminLink = document.getElementById('admin-link');
    const tabsEl = document.getElementById('tabs');
    const cardsEl = document.getElementById('cards');
    const noteEl = document.getElementById('note');
    const courseModal = document.getElementById('course-modal');
    const courseModalClose = document.getElementById('course-modal-close');
    const courseModalBackdrop = document.getElementById('course-modal-backdrop');
    const courseModalImage = document.getElementById('course-modal-image');
    const courseModalPlaceholder = document.getElementById('course-modal-placeholder');
    const courseModalPrev = document.getElementById('course-modal-prev');
    const courseModalNext = document.getElementById('course-modal-next');
    const courseModalTitle = document.getElementById('course-modal-title');
    const courseModalMeta = document.getElementById('course-modal-meta');
    const courseModalDescription = document.getElementById('course-modal-description');
    const courseModalPrice = document.getElementById('course-modal-price');
    const courseModalActions = document.getElementById('course-modal-actions');

    let profile = null;
    let categories = [];
    let courses = [];
    let active = null;
    let courseMap = new Map();
    let currentCourse = null;
    let courseModalIndex = 0;

    const isTelegramWebApp = Boolean(window.Telegram?.WebApp);
    if (isTelegramWebApp && window.Telegram?.WebApp?.ready) {
      window.Telegram.WebApp.ready();
    }

    const metaBySlug = {
      paid: 'Доступ навсегда + материалы',
      free: 'Пробные уроки и мини-гайды',
    };

    function formatPrice(value) {
      const num = Number(value) || 0;
      if (num === 0) return 'Бесплатно';
      return `${num.toLocaleString('ru-RU')} ₽`;
    }

    function truncateText(text, limit = 160) {
      if (!text) return '';
      return text.length > limit ? `${text.slice(0, limit)}…` : text;
    }

    function shortDescription(item) {
      if (item?.short_description) return item.short_description;
      const fallback = item?.description ? truncateText(item.description, 140) : '';
      return fallback || 'Описание появится позже.';
    }

    function normalizeImages(item, extraFields = []) {
      const urls = [];
      const pushUrl = (value) => {
        if (!value) return;
        if (typeof value === 'string') {
          urls.push(value);
          return;
        }
        if (typeof value === 'object') {
          const maybe = value.image_url || value.url || value.path;
          if (maybe) urls.push(maybe);
        }
      };

      pushUrl(item.image_url || item.image);
      (Array.isArray(item.images) ? item.images : []).forEach(pushUrl);
      (extraFields || []).forEach((field) => {
        const value = item[field];
        if (Array.isArray(value)) value.forEach(pushUrl);
      });

      const unique = Array.from(new Set(urls.filter(Boolean)));
      item.images = unique;
      return item;
    }

    function updateAdminLinkVisibility() {
      if (!adminLink) return;
      adminLink.style.display = profile?.is_admin ? '' : 'none';
    }

    function courseLink(item) {
      return item.masterclass_url || item.detail_url || null;
    }

    function updateActiveTabClasses() {
      const buttons = tabsEl?.querySelectorAll('.tab');
      if (!buttons?.length) return;

      buttons.forEach((btn) => {
        const slug = btn.dataset.slug || null;
        const isAll = slug === '';
        const isActive = active ? slug === active : isAll;
        btn.classList.toggle('active', isActive);
      });
    }

    function renderTabs() {
      if (!tabsEl) return;
      tabsEl.innerHTML = '';

      const allBtn = document.createElement('button');
      allBtn.type = 'button';
      allBtn.className = 'tab';
      allBtn.dataset.slug = '';
      allBtn.textContent = 'Все';
      allBtn.addEventListener('click', () => {
        active = null;
        updateActiveTabClasses();
        loadCourses();
      });
      tabsEl.appendChild(allBtn);

      (categories || []).forEach((cat) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'tab';
        btn.dataset.slug = cat.slug;
        btn.textContent = cat.name;
        btn.addEventListener('click', () => {
          active = cat.slug;
          updateActiveTabClasses();
          loadCourses();
        });
        tabsEl.appendChild(btn);
      });

      updateActiveTabClasses();
    }

    function renderCards() {
      cardsEl.innerHTML = '';

      if (!courses.length) {
        noteEl.textContent = 'Нет курсов для выбранной категории.';
        return;
      }

      noteEl.textContent = '';

      courses.forEach((item) => {
        const card = document.createElement('article');
        card.className = 'catalog-card course-card';

        const cover = document.createElement('div');
        cover.className = 'course-card__image-wrapper catalog-card-image';
        const coverImage = document.createElement('img');
        coverImage.className = 'course-card__image';
        const coverPlaceholder = document.createElement('div');
        coverPlaceholder.className = 'course-card__placeholder';
        coverPlaceholder.textContent = item.category_name || 'Мастер-классы';
        cover.append(coverImage, coverPlaceholder);

        const images = item.images && item.images.length ? item.images : [];
        let currentImageIndex = 0;

        const prevBtn = document.createElement('button');
        prevBtn.type = 'button';
        prevBtn.className = 'course-card__nav course-card__nav--prev';
        prevBtn.textContent = '‹';

        const nextBtn = document.createElement('button');
        nextBtn.type = 'button';
        nextBtn.className = 'course-card__nav course-card__nav--next';
        nextBtn.textContent = '›';

        if (images.length > 1) {
          cover.append(prevBtn, nextBtn);
        }

        const updateCardImage = () => {
          if (images.length) {
            currentImageIndex = (currentImageIndex + images.length) % images.length;
            coverImage.src = images[currentImageIndex];
            coverImage.style.display = 'block';
            coverPlaceholder.style.display = 'none';
          } else {
            coverImage.removeAttribute('src');
            coverImage.style.display = 'none';
            coverPlaceholder.style.display = 'flex';
          }

          const showNav = images.length > 1;
          prevBtn.style.display = showNav ? '' : 'none';
          nextBtn.style.display = showNav ? '' : 'none';
        };

        prevBtn.addEventListener('click', () => {
          if (!images.length) return;
          currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
          updateCardImage();
        });

        nextBtn.addEventListener('click', () => {
          if (!images.length) return;
          currentImageIndex = (currentImageIndex + 1) % images.length;
          updateCardImage();
        });

        updateCardImage();

        const body = document.createElement('div');
        body.className = 'catalog-card-body course-card-body';

        const title = document.createElement('h3');
        title.className = 'catalog-card-title';
        title.textContent = item.name;

        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.textContent = metaBySlug[item.category_slug] || '';

        const desc = document.createElement('p');
        desc.className = 'catalog-card-description course-card__short-desc';
        desc.textContent = shortDescription(item);

        const footer = document.createElement('div');
        footer.className = 'course-card__footer';

        const price = document.createElement('div');
        price.className = 'price';
        price.textContent = formatPrice(item.price);

        const hasAccess = profile?.courses?.some((c) => c.id === item.id) ?? false;
        const linkHref = courseLink(item);

        const actions = document.createElement('div');
        actions.className = 'catalog-card-actions';

        const buttonsRow = document.createElement('div');
        buttonsRow.className = 'course-card__buttons';

        const detailsBtn = document.createElement('button');
        detailsBtn.type = 'button';
        detailsBtn.className = 'btn secondary';
        detailsBtn.textContent = 'Подробнее';
        detailsBtn.addEventListener('click', () => openCourseModal(item.id, currentImageIndex));

        if (Number(item.price || 0) === 0 || hasAccess) {
          const openBtn = document.createElement('a');
          openBtn.className = 'btn';
          openBtn.textContent = 'Перейти к мастер-классу';
          openBtn.style.textAlign = 'center';
          openBtn.href = linkHref || '#';
          openBtn.target = linkHref ? '_blank' : '';
          openBtn.rel = linkHref ? 'noopener' : '';
          openBtn.addEventListener('click', (e) => {
            if (!linkHref) {
              e.preventDefault();
              alert('Ссылка появится позже.');
            }
          });
          buttonsRow.append(detailsBtn, openBtn);
        } else {
          const addBtn = document.createElement('button');
          addBtn.type = 'button';
          addBtn.className = 'btn';
          addBtn.textContent = 'Добавить в корзину';
          addBtn.addEventListener('click', () => handleAddToCart(item));

          const note = document.createElement('div');
          note.style.color = 'var(--muted)';
          note.textContent = profile ? 'Доступ появится после оплаты' : 'Войдите и оплатите, чтобы открыть уроки';

          buttonsRow.append(detailsBtn, addBtn);
          actions.appendChild(note);
        }

        footer.append(price);
        actions.append(footer, buttonsRow);

        body.append(title, meta, desc, actions);
        card.append(cover, body);
        cardsEl.appendChild(card);
      });
    }

    async function loadCategories() {
      try {
        categories = await apiGet('/categories', { type: 'course' });
        if (!active) {
          active = categories?.[0]?.slug ?? null;
        }
        renderTabs();
      } catch (e) {
        noteEl.textContent = 'Не удалось загрузить категории. Попробуйте обновить страницу.';
      }
    }

    async function loadCourses() {
      try {
        const params = { type: 'course' };
        if (active) params.category_slug = active;
        courses = (await apiGet('/products', params)).map((item) => normalizeImages(item, ['masterclass_images']));
        courseMap = new Map(courses.map((c) => [c.id, c]));
        renderCards();
      } catch (e) {
        noteEl.textContent = 'Не удалось загрузить курсы. Попробуйте обновить страницу.';
        cardsEl.innerHTML = '';
      }
    }

    function closeCourseModal() {
      if (!courseModal) return;
      courseModal.classList.add('hidden');
      courseModal.setAttribute('aria-hidden', 'true');
      currentCourse = null;
      courseModalIndex = 0;
      if (courseModalActions) courseModalActions.innerHTML = '';
    }

    function setCourseModalImage() {
      if (!courseModalImage) return;
      const images = currentCourse?.images || [];

      if (images.length) {
        courseModalIndex = (courseModalIndex + images.length) % images.length;
        courseModalImage.src = images[courseModalIndex];
        courseModalImage.style.display = 'block';
        courseModalPlaceholder.style.display = 'none';
      } else {
        courseModalImage.removeAttribute('src');
        courseModalImage.style.display = 'none';
        courseModalPlaceholder.style.display = 'block';
      }

      const showNav = images.length > 1;
      [courseModalPrev, courseModalNext].forEach((btn) => {
        if (btn) btn.style.display = showNav ? '' : 'none';
      });
    }

    function openCourseModal(courseId, startIndex = 0) {
      if (!courseModal) return;
      const item = courseMap.get(courseId);
      if (!item) return;
      currentCourse = item;
      courseModalIndex = Math.max(0, Math.min(startIndex || 0, (item.images?.length || 1) - 1));

      setCourseModalImage();

      courseModalTitle.textContent = item.name || 'Мастер-класс';
      courseModalMeta.textContent = metaBySlug[item.category_slug] || '';
      courseModalDescription.textContent = item.description || item.short_description || 'Описание появится позже.';
      courseModalPrice.textContent = formatPrice(item.price);

      if (courseModalActions) {
        courseModalActions.innerHTML = '';
        const detailsAccess = profile?.courses?.some((c) => c.id === item.id) ?? false;
        const linkHref = courseLink(item);
        if (Number(item.price || 0) === 0 || detailsAccess) {
          const openBtn = document.createElement('a');
          openBtn.className = 'btn';
          openBtn.textContent = 'Открыть урок';
          openBtn.href = linkHref || '#';
          openBtn.target = linkHref ? '_blank' : '';
          openBtn.rel = linkHref ? 'noopener' : '';
          openBtn.addEventListener('click', (e) => {
            if (!linkHref) {
              e.preventDefault();
              alert('Ссылка появится позже.');
            }
          });
          courseModalActions.appendChild(openBtn);
        } else {
          const addBtn = document.createElement('button');
          addBtn.type = 'button';
          addBtn.className = 'btn';
          addBtn.textContent = 'Добавить в корзину';
          addBtn.addEventListener('click', () => handleAddToCart(item));

          const infoBtn = document.createElement('button');
          infoBtn.type = 'button';
          infoBtn.className = 'btn secondary';
          infoBtn.textContent = 'Закрыть';
          infoBtn.addEventListener('click', closeCourseModal);

          courseModalActions.append(addBtn, infoBtn);
        }
      }

      courseModal.classList.remove('hidden');
      courseModal.setAttribute('aria-hidden', 'false');
    }

    [courseModalPrev, courseModalNext].forEach((btn, index) => {
      btn?.addEventListener('click', () => {
        const images = currentCourse?.images || [];
        if (!images.length) return;
        const step = index === 0 ? -1 : 1;
        courseModalIndex = (courseModalIndex + step + images.length) % images.length;
        setCourseModalImage();
      });
    });

    [courseModalClose, courseModalBackdrop].forEach((el) => {
      el?.addEventListener('click', closeCourseModal);
    });

    async function handleAddToCart(course) {
      const currentProfile = await getCurrentUserProfile();

      try {
        if (currentProfile?.telegram_id) {
          await apiPost('/cart/add', { user_id: currentProfile.telegram_id, product_id: course.id, qty: 1, type: 'course' });
          showToast('Курс добавлен в корзину');
        } else {
          addToGuestCart(course.id, 'course', 1);
          showToast('Курс добавлен в корзину. Оформить заказ можно после входа через Telegram.');
        }
      } catch (e) {
        showToast('Не удалось добавить курс. Попробуйте ещё раз.');
      }
    }

    async function loadMasterclassesCategoriesAndItems(currentProfile) {
      profile = currentProfile;
      updateAdminLinkVisibility();

      await loadCategories();
      await loadCourses();

      if (!profile) {
        noteEl.textContent = 'Каталог доступен в режиме просмотра. Чтобы оформить заказ, войдите через Telegram.';
      }
    }

    async function initMasterclassesPage() {
      const currentProfile = await getCurrentUserProfile();
      await loadMasterclassesCategoriesAndItems(currentProfile);
    }

    initMasterclassesPage().catch(console.error);
  </script>
</body>
</html>
