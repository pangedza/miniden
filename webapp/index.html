<!-- Обновляйте номер версии (?v=20241205) в ссылках на js/css после любых правок фронтенда, чтобы сбрасывать кэш в браузерах. -->
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MiniDeN — уютные корзинки и мастер-классы</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="css/theme.css?v=20250610" />
  <link rel="stylesheet" href="css/support_widget.css?v=20250610" />
</head>
<body data-theme="lifestyle" class="page-index">
  <header class="top-nav">
    <div class="brand">MiniDeN<span>уютные корзинки и мастер-классы</span></div>
    <div class="header-actions">
      <div class="theme-switcher">
        <label for="theme-select">Тема</label>
        <select id="theme-select">
          <option value="lifestyle">Lifestyle</option>
          <option value="purple">Фиолетовая</option>
          <option value="dark">Тёмная</option>
          <option value="light">Светлая</option>
          <option value="cream">Сливочная</option>
        </select>
      </div>
      <button class="menu-toggle" aria-label="Открыть меню">☰</button>
    </div>
    <nav class="nav-links app-sidebar">
      <div class="sidebar-brand">
        <strong>Miniden</strong>
        <span>уют, семья, вязание</span>
      </div>
      <a href="index.html" class="active">Главная</a>
      <a href="products.html">Товары</a>
      <a href="masterclasses.html">Мастер-классы</a>
      <a href="cart.html">Корзина</a>
      <a href="profile.html">Профиль</a>
      <a href="admin.html" id="admin-link" style="display:none;">Админка</a>
    </nav>
  </header>

  <div class="app-sidebar-overlay"></div>
  <div id="toast-container"></div>

  <main>
    <section class="lifestyle-hero reveal">
      <div class="hero-body">
        <span class="hero-eyebrow">Miniden • домашнее вязание</span>
        <h1 class="hero-title">Дом, который вяжется руками</h1>
        <p class="hero-subtitle">Мини-истории о корзинках, детских комнатах и спокойных вечерах. Всё, что делаю, — про уют, семью и обучение без спешки.</p>
        <div class="hero-cta">
          <a class="btn secondary" href="#story">Узнать историю</a>
        </div>
      </div>
      <div class="hero-visual hover-lift">
        <img
          src="https://images.unsplash.com/photo-1513542789411-b6a5d4f31634?auto=format&fit=crop&w=1400&q=80"
          data-fallback="https://images.unsplash.com/photo-1513542789411-b6a5d4f31634?auto=format&fit=crop&w=1400&q=80"
          alt="Уютный дом и вязание"
        />
      </div>
    </section>

    <section class="visual-grid reveal" aria-label="Темы MiniDeN">
      <a class="visual-tile hover-lift" href="#story" id="tile-home-kids">
        <img
          src="https://images.unsplash.com/photo-1526481280695-3c687fd643ed?auto=format&fit=crop&w=1400&q=80"
          data-fallback="https://images.unsplash.com/photo-1526481280695-3c687fd643ed?auto=format&fit=crop&w=1400&q=80"
          alt="Дом и дети"
        />
        <span>Дом и дети</span>
      </a>
      <a class="visual-tile hover-lift" href="#process" id="tile-process">
        <img
          src="https://images.unsplash.com/photo-1520975682031-a1a4f852cddf?auto=format&fit=crop&w=1400&q=80"
          data-fallback="https://images.unsplash.com/photo-1520975682031-a1a4f852cddf?auto=format&fit=crop&w=1400&q=80"
          alt="Процесс вязания"
        />
        <span>Процесс</span>
      </a>
      <a class="visual-tile hover-lift" href="products.html" id="tile-baskets">
        <img
          src="https://images.unsplash.com/photo-1526481280695-3c687fd643ed?auto=format&fit=crop&w=1400&q=80"
          data-fallback="https://images.unsplash.com/photo-1526481280695-3c687fd643ed?auto=format&fit=crop&w=1400&q=80"
          alt="Мои корзинки"
        />
        <span>Мои корзинки</span>
      </a>
      <a class="visual-tile hover-lift" href="masterclasses.html" id="tile-learning">
        <img
          src="https://images.unsplash.com/photo-1519681393784-d120267933ba?auto=format&fit=crop&w=1400&q=80"
          data-fallback="https://images.unsplash.com/photo-1519681393784-d120267933ba?auto=format&fit=crop&w=1400&q=80"
          alt="Обучение вязанию"
        />
        <span>Обучение</span>
      </a>
    </section>

    <section class="story-strip reveal" id="story">
      <div class="story-avatar">
        <img
          src="https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=400&q=80"
          data-fallback="https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=400&q=80"
          alt="Миниден"
        />
      </div>
      <div>
        <strong>Немного обо мне</strong>
        <p>Я вяжу дома. Учу так, как училась сама: без спешки, в тишине и с акцентом на уютные вещи для семьи.</p>
      </div>
    </section>

    <section class="info-panel reveal" id="process">
      <h2>Процесс</h2>
      <p class="muted">От выбора пряжи до упаковки — всё делаю сама, небольшими партиями и с вниманием к мелочам. Так изделия получаются тёплыми и долгими в носке.</p>
    </section>

    <section class="cta-card reveal hover-lift" id="shop-entry">
      <div>
        <h3>Корзинки и наборы</h3>
        <p>Небольшие вещи, которые собирают дом воедино: органайзеры, подарочные композиции и акценты для детских комнат.</p>
        <a class="btn" href="products.html">Перейти в каталог</a>
      </div>
      <div class="cta-card__media">
        <img
          src="https://images.unsplash.com/photo-1545239351-1141bd82e8a6?auto=format&fit=crop&w=1200&q=80"
          data-fallback="https://images.unsplash.com/photo-1545239351-1141bd82e8a6?auto=format&fit=crop&w=1200&q=80"
          alt="Вязаные корзинки"
        />
      </div>
    </section>

    <section class="cta-card cta-card--reverse reveal hover-lift" id="learning-entry">
      <div class="cta-card__media">
        <img
          src="https://images.unsplash.com/photo-1512436991641-6745cdb1723f?auto=format&fit=crop&w=1200&q=80"
          data-fallback="https://images.unsplash.com/photo-1512436991641-6745cdb1723f?auto=format&fit=crop&w=1200&q=80"
          alt="Процесс обучения вязанию"
        />
      </div>
      <div>
        <h3>Мастер-классы</h3>
        <p>Для тех, кто хочет начать и дойти до результата. Простые шаги, поддержка и вдохновение, чтобы связать своё первое изделие.</p>
        <a class="btn secondary" href="masterclasses.html">Смотреть обучение</a>
      </div>
    </section>

    <section class="section reveal" id="home-posts" style="display:none;">
      <h2>Новости и идеи</h2>
      <div class="home-posts-grid" id="home-posts-grid"></div>
      <div class="muted" id="home-posts-empty" style="display:none;">Скоро здесь появятся новости</div>
    </section>

    <section class="section reveal" id="telegram-login-section">
      <h2>Вход через Telegram</h2>
      <p>
        Чтобы синхронизировать корзину и профиль с ботом MiniDeN, войдите через Telegram. После успешного входа вы будете перенаправлены в профиль (profile.html), где увидите ваши заказы, корзину и курсы.
      </p>
      <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
        <button class="btn" id="btn-login-telegram" type="button">Войти через Telegram</button>
      </div>
    </section>

    <section class="section reveal" id="auth-status" style="display: none;">
      <h2>Вы уже вошли</h2>
      <p id="auth-username" class="muted"></p>
      <div class="hero-cta">
        <a class="btn" href="/profile.html">Перейти в профиль</a>
        <button class="btn secondary" type="button" id="switch-user-btn">Сменить пользователя</button>
      </div>
    </section>
  </main>

  <footer class="reveal">
    <div>
      Готовы помочь в Telegram:
      <a id="bot-link-footer" href="https://t.me/BotMiniden_bot" target="_blank" rel="noopener">бот MiniDeN</a>
    </div>
    <div>
      Новости и вдохновение:
      <a id="channel-link-footer" href="https://t.me/petelka_za_petelko" target="_blank" rel="noopener">Telegram-канал</a>
    </div>
    <div>Мы в соцсетях: <a href="https://www.instagram.com/balabanova_knit?igsh=MWhuMWFnOG8zejl6dQ==">Instagram*</a> • <a href="https://vk.com/club233836469">VK</a></div>
  </footer>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="js/app.js?v=20250610"></script>
  <script src="js/api.js?v=20250610"></script>
  <script src="js/home_page.js?v=20250610"></script>
  <script src="js/support_widget.js?v=20250610" defer></script>
  <script>
    const loginSection = document.getElementById('telegram-login-section');
    const authStatus = document.getElementById('auth-status');
    const authUsername = document.getElementById('auth-username');
    const switchUserBtn = document.getElementById('switch-user-btn');
    const adminLink = document.getElementById('admin-link');
    const loginButton = document.getElementById('btn-login-telegram');
    const loginButtonDefaultText = loginButton?.textContent || 'Войти через Telegram';

    function updateAdminLinkVisibility(profile) {
      if (!adminLink) return;
      adminLink.style.display = profile?.is_admin ? 'inline-block' : 'none';
    }

    async function logout() {
      try {
        await fetch('/api/auth/logout', { method: 'POST' });
      } catch (e) {
        console.warn('Failed to call logout', e);
      } finally {
        window.location.reload();
      }
    }

    switchUserBtn?.addEventListener('click', logout);

    async function loadSession() {
      try {
        const user = await getCurrentUserProfile();
        updateAdminLinkVisibility(user);

        if (user) {
          loginSection?.style.setProperty('display', 'none');
          authStatus?.style.setProperty('display', 'block');
          const displayName = user.full_name || (user.telegram_username ? '@' + user.telegram_username : user.telegram_id);
          authUsername.textContent = `Вы вошли как ${displayName}`;
        } else {
          loginSection?.style.setProperty('display', 'block');
          authStatus?.style.setProperty('display', 'none');
          if (loginButton) {
            loginButton.style.setProperty('display', 'inline-flex');
            loginButton.textContent = isTelegramWebApp ? 'Повторить авторизацию' : loginButtonDefaultText;
          }
        }
      } catch (e) {
        console.error('Failed to load auth status', e);
        updateAdminLinkVisibility(null);
        loginSection?.style.setProperty('display', 'block');
        authStatus?.style.setProperty('display', 'none');
      }
    }

    loginButton?.addEventListener('click', async () => {
      if (isTelegramWebApp) {
        loginButton.disabled = true;
        try {
          await loadSession();
        } finally {
          loginButton.disabled = false;
        }
        return;
      }

      startTelegramOAuthFlow();
    });

    async function bootstrapAuth() {
      await processTelegramAuthFromUrl().catch((error) => {
        console.error('Telegram auth via browser failed', error);
        showToast(error?.message || 'Не удалось авторизоваться через Telegram');
      });

      await loadSession();
    }

    bootstrapAuth();
  </script>
</body>
</html>
