<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MiniDeN — Товары</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="css/theme.css?v=20241216" />

</head>
<body data-theme="purple" class="page-products">
  <header class="top-nav">
    <div class="brand">MiniDeN<span>уютные корзинки и мастер-классы</span></div>
    <div class="header-actions">
      <div class="theme-switcher">
        <label for="theme-select">Тема</label>
        <select id="theme-select">
          <option value="purple">Фиолетовая</option>
          <option value="dark">Тёмная</option>
          <option value="light">Светлая</option>
          <option value="cream">Сливочная</option>
        </select>
      </div>
      <button class="menu-toggle" aria-label="Открыть меню">☰</button>
    </div>
    <nav class="nav-links app-sidebar">
      <a href="index.html">Главная</a>
      <a href="products.html" class="active">Товары</a>
      <a href="masterclasses.html">Мастер-классы</a>
      <a href="cart.html">Корзина</a>
      <a href="profile.html">Профиль</a>
      <a href="admin.html" id="admin-link" style="display:none;">Админка</a>
    </nav>
  </header>

  <div class="app-sidebar-overlay"></div>
  <div id="toast-container"></div>

  <main>
    <h1>Товары</h1>

    <div class="tabs" id="tabs"></div>
    <div class="catalog-grid products-grid" id="cards"></div>
    <div class="note" id="note"></div>
  </main>

    <div id="product-modal" class="product-modal hidden" aria-hidden="true">
    <div class="product-modal__backdrop" id="product-modal-backdrop"></div>
    <div class="product-modal__content" role="dialog" aria-modal="true">
      <button class="product-modal__close" type="button" id="product-modal-close" aria-label="Закрыть">×</button>
      <div class="product-modal__media" id="product-modal-media">
        <button class="product-modal__nav product-modal__nav--prev" type="button" id="product-modal-prev" aria-label="Предыдущее изображение">‹</button>
        <img id="product-modal-image" alt="" />
        <div id="product-modal-placeholder" style="display:none; color: var(--muted); padding: 12px; text-align:center;">Нет изображения</div>
        <button class="product-modal__nav product-modal__nav--next" type="button" id="product-modal-next" aria-label="Следующее изображение">›</button>
      </div>
      <div class="product-modal__info">
        <h3 id="product-modal-title" style="margin:0;"></h3>
        <p class="product-modal__description" id="product-modal-description"></p>
        <div class="product-modal__price-row">
          <div class="product-modal__price" id="product-modal-price"></div>
        </div>
        <div class="product-modal__actions">
          <button class="btn" type="button" id="product-modal-add">Добавить в корзину</button>
          <button class="btn secondary" type="button" id="product-modal-close-btn">Закрыть</button>
        </div>

        <section class="product-reviews" id="product-reviews-section">
          <div class="product-reviews__header">
            <h4 style="margin: 0;">Отзывы</h4>
            <div class="product-reviews__summary" id="product-reviews-summary">Пока нет отзывов, будьте первым!</div>
          </div>

          <div class="product-reviews__list" id="product-reviews-list"></div>
          <button class="btn secondary" type="button" id="product-reviews-more" style="display:none;">Показать ещё</button>

          <div class="product-reviews__login-hint" id="product-reviews-login-hint" style="display:none;">
            Чтобы оставить отзыв, войдите через Telegram. После авторизации вернитесь к карточке товара.
          </div>

          <div class="product-reviews__form" id="product-reviews-form" style="display:none;">
            <h5 style="margin: 0;">Оставить отзыв</h5>

            <div class="review-form__field">
              <label for="review-rating-stars">Ваша оценка</label>
              <div class="rating-stars" id="review-rating-stars" role="radiogroup" aria-label="Ваша оценка">
                <button type="button" class="rating-stars__item" data-value="1" aria-label="1 звезда">★</button>
                <button type="button" class="rating-stars__item" data-value="2" aria-label="2 звезды">★</button>
                <button type="button" class="rating-stars__item" data-value="3" aria-label="3 звезды">★</button>
                <button type="button" class="rating-stars__item" data-value="4" aria-label="4 звезды">★</button>
                <button type="button" class="rating-stars__item" data-value="5" aria-label="5 звезд">★</button>
              </div>
              <div class="form-error" id="review-rating-error" aria-live="polite"></div>
            </div>

            <div class="review-form__field">
              <label for="review-text">Ваш отзыв</label>
              <textarea id="review-text" placeholder="Расскажите, что понравилось или что можно улучшить"></textarea>
              <div class="form-error" id="review-text-error" aria-live="polite"></div>
            </div>

            <div class="review-form__field">
              <label for="review-photos">Загрузить фото (до 3 шт)</label>
              <input type="file" id="review-photos" accept="image/*" multiple />
              <div class="review-photos-preview" id="review-photos-preview"></div>
            </div>

            <div class="review-form__actions">
              <button class="btn" type="button" id="review-submit">Отправить отзыв</button>
              <div class="muted">Ваш отзыв отправится на модерацию. Мы покажем его после одобрения.</div>
            </div>

            <div class="form-error" id="review-form-status" aria-live="polite"></div>
          </div>
        </section>
      </div>
    </div>
    </div>

    <div id="review-photo-modal" class="review-photo-modal hidden" aria-hidden="true">
      <div class="review-photo-modal__backdrop" id="review-photo-modal-backdrop"></div>
      <div class="review-photo-modal__content" role="dialog" aria-modal="true" aria-label="Фото отзыва">
        <button class="review-photo-modal__close" type="button" id="review-photo-modal-close" aria-label="Закрыть">×</button>
        <img class="review-photo-modal__image" id="review-photo-modal-image" src="" alt="" />
      </div>
    </div>

    <script src="js/app.js?v=20241216"></script>
    <script src="js/api.js?v=20241216"></script>
  <script>
    const adminLink = document.getElementById('admin-link');
    const tabsEl = document.getElementById('tabs');
    const cardsEl = document.getElementById('cards');
    const noteEl = document.getElementById('note');
    const productModal = document.getElementById('product-modal');
    const productModalClose = document.getElementById('product-modal-close');
    const productModalCloseBtn = document.getElementById('product-modal-close-btn');
    const productModalBackdrop = document.getElementById('product-modal-backdrop');
    const productModalTitle = document.getElementById('product-modal-title');
    const productModalDescription = document.getElementById('product-modal-description');
    const productModalPrice = document.getElementById('product-modal-price');
    const productModalAdd = document.getElementById('product-modal-add');
      const productModalImage = document.getElementById('product-modal-image');
      const productModalPlaceholder = document.getElementById('product-modal-placeholder');
      const productModalPrev = document.getElementById('product-modal-prev');
      const productModalNext = document.getElementById('product-modal-next');
      const reviewPhotoModal = document.getElementById('review-photo-modal');
      const reviewPhotoModalBackdrop = document.getElementById('review-photo-modal-backdrop');
      const reviewPhotoModalClose = document.getElementById('review-photo-modal-close');
      const reviewPhotoModalImage = document.getElementById('review-photo-modal-image');

      const productReviewsSection = document.getElementById('product-reviews-section');
      const productReviewsSummary = document.getElementById('product-reviews-summary');
    const productReviewsList = document.getElementById('product-reviews-list');
    const productReviewsMoreBtn = document.getElementById('product-reviews-more');
    const productReviewsForm = document.getElementById('product-reviews-form');
    const productReviewsLoginHint = document.getElementById('product-reviews-login-hint');
    const reviewRatingStars = document.getElementById('review-rating-stars');
    const reviewRatingError = document.getElementById('review-rating-error');
    const reviewTextInput = document.getElementById('review-text');
    const reviewTextError = document.getElementById('review-text-error');
    const reviewPhotosInput = document.getElementById('review-photos');
    const reviewPhotosPreview = document.getElementById('review-photos-preview');
    const reviewSubmitBtn = document.getElementById('review-submit');
    const reviewFormStatus = document.getElementById('review-form-status');

    const REVIEWS_INITIAL_LIMIT = 5;
    let selectedReviewRating = 0;
    let selectedReviewFiles = [];
    const productReviewsCache = new Map();

    let profile = null;
    let categories = [];
    let products = [];
    let active = null;
    let productMap = new Map();
    let currentProduct = null;
    let productModalIndex = 0;

    const isTelegramWebApp = Boolean(window.Telegram?.WebApp);
    if (isTelegramWebApp && window.Telegram?.WebApp?.ready) {
      window.Telegram.WebApp.ready();
    }

    function formatPrice(value) {
      const num = Number(value) || 0;
      if (num === 0) return 'Бесплатно';
      return `${num.toLocaleString('ru-RU')} ₽`;
    }

    function truncateText(text, limit = 160) {
      if (!text) return '';
      return text.length > limit ? `${text.slice(0, limit)}…` : text;
    }

    function shortDescription(item) {
      if (item?.short_description) return item.short_description;
      const fallback = item?.description ? truncateText(item.description, 140) : '';
      return fallback || 'Описание появится позже.';
    }

    function normalizeImages(item, extraFields = []) {
      const urls = [];
      const pushUrl = (value) => {
        if (!value) return;
        if (typeof value === 'string') {
          urls.push(value);
          return;
        }
        if (typeof value === 'object') {
          const maybe = value.image_url || value.url || value.path;
          if (maybe) urls.push(maybe);
        }
      };

      pushUrl(item.image_url || item.image);
      (Array.isArray(item.images) ? item.images : []).forEach(pushUrl);
      (extraFields || []).forEach((field) => {
        const value = item[field];
        if (Array.isArray(value)) value.forEach(pushUrl);
      });

      const unique = Array.from(new Set(urls.filter(Boolean)));
      item.images = unique;
      return item;
    }

    function formatReviewDate(value) {
      if (!value) return '';
      const date = new Date(value);
      return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' });
    }

    function getReviewWord(count) {
      const abs = Math.abs(count) % 100;
      const last = abs % 10;
      if (abs > 10 && abs < 20) return 'отзывов';
      if (last > 1 && last < 5) return 'отзыва';
      if (last === 1) return 'отзыв';
      return 'отзывов';
    }

    function getReviewState(productId) {
      if (!productReviewsCache.has(productId)) {
        productReviewsCache.set(productId, {
          items: [],
          rating: { average_rating: 0, reviews_count: 0 },
          visibleCount: REVIEWS_INITIAL_LIMIT,
        });
      }
      return productReviewsCache.get(productId);
    }

    function starsFromRating(value) {
      const rating = Math.max(0, Math.min(5, Number(value) || 0));
      return `${'★'.repeat(Math.round(rating))}${'☆'.repeat(5 - Math.round(rating))}`;
    }

    function computeRatingFromReviews(items) {
      if (!items?.length) return { average_rating: 0, reviews_count: 0 };
      const total = items.reduce((sum, item) => sum + (Number(item.rating) || 0), 0);
      const avg = total / items.length;
      return { average_rating: Math.round(avg * 10) / 10, reviews_count: items.length };
    }

      function formatRating(value) {
        const num = Number(value) || 0;
        return (Math.round(num * 10) / 10).toFixed(1);
      }

      function openReviewPhotoModal(url, altText = 'Фото отзыва') {
        if (!reviewPhotoModal || !reviewPhotoModalImage) return;
        reviewPhotoModalImage.src = url;
        reviewPhotoModalImage.alt = altText;
        reviewPhotoModal.classList.remove('hidden');
        reviewPhotoModal.setAttribute('aria-hidden', 'false');
      }

      function closeReviewPhotoModal() {
        if (!reviewPhotoModal) return;
        reviewPhotoModal.classList.add('hidden');
        reviewPhotoModal.setAttribute('aria-hidden', 'true');
        if (reviewPhotoModalImage) {
          reviewPhotoModalImage.src = '';
          reviewPhotoModalImage.alt = '';
        }
      }

      function updateAdminLinkVisibility() {
        if (!adminLink) return;
        adminLink.style.display = profile?.is_admin ? '' : 'none';
      }

    function renderTabs() {
      if (!tabsEl) return;
      tabsEl.innerHTML = '';

      const allBtn = document.createElement('button');
      allBtn.type = 'button';
      allBtn.className = `tab${active === null ? ' active' : ''}`;
      allBtn.textContent = 'Все';
      allBtn.addEventListener('click', () => {
        active = null;
        loadProducts();
      });
      tabsEl.appendChild(allBtn);

      (categories || []).forEach((cat) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = `tab${active === cat.slug ? ' active' : ''}`;
        btn.textContent = cat.name;
        btn.addEventListener('click', () => {
          active = cat.slug;
          loadProducts();
        });
        tabsEl.appendChild(btn);
      });
    }

    function createMarketLinks(item) {
      const links = document.createElement('div');
      links.className = 'market-links';

      const marketplaces = [
        { key: 'wb_url', label: 'WB' },
        { key: 'ozon_url', label: 'Ozon' },
        { key: 'yandex_url', label: 'Яндекс' },
        { key: 'avito_url', label: 'Авито' },
      ];

      marketplaces.forEach(({ key, label }) => {
        if (!item[key]) return;
        const link = document.createElement('a');
        link.href = item[key];
        link.target = '_blank';
        link.rel = 'noopener';
        link.textContent = label;
        link.className = 'btn secondary';
        link.style.width = 'auto';
        links.appendChild(link);
      });

      return links;
    }

    function renderCards() {
      cardsEl.innerHTML = '';

      if (!products.length) {
        noteEl.textContent = 'Нет товаров для выбранной категории.';
        return;
      }

      noteEl.textContent = '';

      products.forEach((item) => {
        const card = document.createElement('article');
        card.className = 'catalog-card product-card';

        const cover = document.createElement('div');
        cover.className = 'product-card__image-wrapper catalog-card-image';
        const coverImage = document.createElement('img');
        coverImage.className = 'product-card__image';
        const coverPlaceholder = document.createElement('div');
        coverPlaceholder.className = 'product-card__placeholder';
        coverPlaceholder.textContent = item.category_name || 'Товары';
        cover.append(coverImage, coverPlaceholder);

        const images = item.images && item.images.length ? item.images : [];
        let currentImageIndex = 0;

        const prevBtn = document.createElement('button');
        prevBtn.type = 'button';
        prevBtn.className = 'product-card__nav product-card__nav--prev';
        prevBtn.textContent = '‹';

        const nextBtn = document.createElement('button');
        nextBtn.type = 'button';
        nextBtn.className = 'product-card__nav product-card__nav--next';
        nextBtn.textContent = '›';

        if (images.length > 1) {
          cover.append(prevBtn, nextBtn);
        }

        const updateCardImage = () => {
          if (images.length) {
            currentImageIndex = (currentImageIndex + images.length) % images.length;
            coverImage.src = images[currentImageIndex];
            coverImage.style.display = 'block';
            coverPlaceholder.style.display = 'none';
          } else {
            coverImage.removeAttribute('src');
            coverImage.style.display = 'none';
            coverPlaceholder.style.display = 'flex';
          }

          const showNav = images.length > 1;
          prevBtn.style.display = showNav ? '' : 'none';
          nextBtn.style.display = showNav ? '' : 'none';
        };

        prevBtn.addEventListener('click', () => {
          if (!images.length) return;
          currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
          updateCardImage();
        });

        nextBtn.addEventListener('click', () => {
          if (!images.length) return;
          currentImageIndex = (currentImageIndex + 1) % images.length;
          updateCardImage();
        });

        updateCardImage();

        const body = document.createElement('div');
        body.className = 'catalog-card-body product-card__body';

        const title = document.createElement('h3');
        title.className = 'product-card__title catalog-card-title';
        title.textContent = item.name;

        const priceRow = document.createElement('div');
        priceRow.className = 'product-card__price-row';

        const price = document.createElement('div');
        price.className = 'product-card__price price';
        price.textContent = formatPrice(item.price);
        priceRow.appendChild(price);

        const marketLinks = createMarketLinks(item);

        const actions = document.createElement('div');
        actions.className = 'product-card__actions';

        const detailsBtn = document.createElement('button');
        detailsBtn.type = 'button';
        detailsBtn.className = 'btn secondary';
        detailsBtn.textContent = 'Подробнее';
        detailsBtn.addEventListener('click', () => openProductModal(item.id, currentImageIndex));

        actions.appendChild(detailsBtn);

        body.append(title, priceRow);
        if (marketLinks.childElementCount) {
          marketLinks.classList.add('product-card__market-links');
          body.appendChild(marketLinks);
        }
        body.appendChild(actions);

        card.append(cover, body);
        cardsEl.appendChild(card);
      });
    }

    async function loadCategories() {
      try {
        categories = await apiGet('/categories', { type: 'basket' });
        if (!active) {
          active = categories?.[0]?.slug ?? null;
        }
        renderTabs();
      } catch (e) {
        noteEl.textContent = 'Не удалось загрузить категории. Попробуйте обновить страницу.';
      }
    }

    async function loadProducts() {
      try {
        const params = { type: 'basket' };
        if (active) params.category_slug = active;
        products = (await apiGet('/products', params)).map((item) => normalizeImages(item, ['product_images']));
        productMap = new Map(products.map((p) => [p.id, p]));
        renderTabs();
        renderCards();
      } catch (e) {
        noteEl.textContent = 'Не удалось загрузить товары. Попробуйте обновить страницу.';
        cardsEl.innerHTML = '';
      }
    }

    function closeProductModal() {
      if (!productModal) return;
      productModal.classList.add('hidden');
      productModal.setAttribute('aria-hidden', 'true');
      currentProduct = null;
      productModalIndex = 0;
    }

    function setProductModalImage() {
      if (!productModalImage) return;
      const images = currentProduct?.images || [];

      if (images.length) {
        productModalIndex = (productModalIndex + images.length) % images.length;
        productModalImage.src = images[productModalIndex];
        productModalImage.style.display = 'block';
        productModalPlaceholder.style.display = 'none';
      } else {
        productModalImage.removeAttribute('src');
        productModalImage.style.display = 'none';
        productModalPlaceholder.style.display = 'block';
      }

      const showNav = images.length > 1;
      [productModalPrev, productModalNext].forEach((btn) => {
        if (btn) btn.style.display = showNav ? '' : 'none';
      });
    }

    function openProductModal(productId, startIndex = 0) {
      if (!productModal) return;
      const item = productMap.get(productId);
      if (!item) return;
      currentProduct = item;
      productModalIndex = Math.max(0, Math.min(startIndex || 0, (item.images?.length || 1) - 1));

      resetReviewForm();
      updateReviewFormVisibility();
      if (productReviewsSection) {
        showReviewsPlaceholder('Загружаем отзывы...');
        renderRatingSummary(item.id);
        renderReviewsList(item.id);
        loadProductReviews(item.id);
      }
      setProductModalImage();

      productModalTitle.textContent = item.name || 'Товар';
      productModalDescription.textContent = item.description || item.short_description || 'Описание появится позже.';
      productModalPrice.textContent = formatPrice(item.price);

      if (productModalAdd) {
        productModalAdd.onclick = () => handleAddToCart(item);
      }

      productModal.classList.remove('hidden');
      productModal.setAttribute('aria-hidden', 'false');
    }

      [productModalPrev, productModalNext].forEach((btn, index) => {
        btn?.addEventListener('click', () => {
          const images = currentProduct?.images || [];
          if (!images.length) return;
          const step = index === 0 ? -1 : 1;
          productModalIndex = (productModalIndex + step + images.length) % images.length;
          setProductModalImage();
        });
      });

      [productModalClose, productModalCloseBtn, productModalBackdrop].forEach((el) => {
        el?.addEventListener('click', closeProductModal);
      });

      [reviewPhotoModalClose, reviewPhotoModalBackdrop].forEach((el) => {
        el?.addEventListener('click', closeReviewPhotoModal);
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && !reviewPhotoModal?.classList.contains('hidden')) {
          closeReviewPhotoModal();
        }
      });

      productReviewsList?.addEventListener('click', (event) => {
        const target = event.target instanceof HTMLElement ? event.target.closest('.review-photo-thumb') : null;
        if (!target) return;
        const fullUrl = target.dataset.fullUrl || target.getAttribute('src');
        if (!fullUrl) return;
        const altText = target.getAttribute('alt') || 'Фото отзыва';
        openReviewPhotoModal(fullUrl, altText);
      });

      reviewRatingStars?.addEventListener('click', (event) => {
        const target = event.target.closest('.rating-stars__item');
        if (!target) return;
        selectedReviewRating = Number(target.dataset.value) || 0;
      renderRatingSelection();
      if (reviewRatingError) reviewRatingError.textContent = '';
    });

    productReviewsMoreBtn?.addEventListener('click', () => {
      if (!currentProduct) return;
      const state = getReviewState(currentProduct.id);
      state.visibleCount = Math.min(state.items.length, (state.visibleCount || REVIEWS_INITIAL_LIMIT) + REVIEWS_INITIAL_LIMIT);
      renderReviewsList(currentProduct.id);
    });

    reviewSubmitBtn?.addEventListener('click', handleReviewSubmit);
    reviewPhotosInput?.addEventListener('change', handleReviewFilesChange);

    async function handleAddToCart(product) {
      const currentProfile = await getCurrentUserProfile();

      try {
        if (currentProfile?.telegram_id) {
          await apiPost('/cart/add', { user_id: currentProfile.telegram_id, product_id: product.id, qty: 1, type: 'basket' });
          showToast('Товар добавлен в корзину');
        } else {
          addToGuestCart(product.id, 'basket', 1);
          showToast('Товар добавлен в корзину. Чтобы оформить заказ и сохранить корзину, войдите через Telegram.');
        }
      } catch (e) {
        showToast('Не удалось добавить товар в корзину. Попробуйте ещё раз.');
      }
    }

    function renderRatingSelection() {
      if (!reviewRatingStars) return;
      reviewRatingStars.querySelectorAll('.rating-stars__item').forEach((btn) => {
        const value = Number(btn.dataset.value) || 0;
        const isActive = value <= selectedReviewRating;
        btn.classList.toggle('is-active', isActive);
        btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      });
    }

    function resetReviewFormErrors() {
      if (reviewRatingError) reviewRatingError.textContent = '';
      if (reviewTextError) reviewTextError.textContent = '';
      if (reviewFormStatus) reviewFormStatus.textContent = '';
    }

    function resetReviewForm() {
      selectedReviewRating = 0;
      selectedReviewFiles = [];
      if (reviewTextInput) reviewTextInput.value = '';
      if (reviewPhotosInput) reviewPhotosInput.value = '';
      resetReviewFormErrors();
      renderReviewPhotosPreview();
      renderRatingSelection();
    }

    function renderReviewPhotosPreview() {
      if (!reviewPhotosPreview) return;
      reviewPhotosPreview.innerHTML = '';
      if (!selectedReviewFiles.length) return;

      selectedReviewFiles.forEach((file, idx) => {
        const holder = document.createElement('div');
        holder.className = 'review-photo-chip';
        holder.setAttribute('title', file.name || `Фото ${idx + 1}`);

        const reader = new FileReader();
        reader.onload = () => {
          const img = document.createElement('img');
          img.src = reader.result;
          img.alt = file.name || `Фото ${idx + 1}`;
          holder.appendChild(img);
        };
        reader.readAsDataURL(file);
        reviewPhotosPreview.appendChild(holder);
      });
    }

    function updateReviewFormVisibility() {
      const isAuthorized = Boolean(profile?.telegram_id);
      if (productReviewsForm) {
        productReviewsForm.style.display = isAuthorized ? 'grid' : 'none';
      }
      if (productReviewsLoginHint) {
        productReviewsLoginHint.style.display = isAuthorized ? 'none' : 'block';
      }
    }

    function renderRatingSummary(productId) {
      if (!productReviewsSummary) return;
      const state = getReviewState(productId);
      const count = state.rating?.reviews_count ?? state.items.length;
      if (!count) {
        productReviewsSummary.textContent = 'Пока нет отзывов, будьте первым!';
        return;
      }
      const avg = formatRating(state.rating?.average_rating ?? 0);
      productReviewsSummary.textContent = `⭐ ${avg} (${count} ${getReviewWord(count)})`;
    }

    function createReviewCard(review) {
      const card = document.createElement('article');
      card.className = 'review-card';

      const header = document.createElement('div');
      header.className = 'review-card__header';

      const author = document.createElement('div');
      author.className = 'review-card__author';
      author.textContent = review.user_name || 'Покупатель';

      const rating = document.createElement('div');
      rating.className = 'review-card__rating';
      rating.textContent = `${starsFromRating(review.rating)} ${review.rating || ''}`.trim();

      const date = document.createElement('div');
      date.className = 'review-card__date';
      date.textContent = formatReviewDate(review.created_at);

      header.append(author, rating, date);

        const text = document.createElement('p');
        text.className = 'review-card__text';
        text.textContent = review.text || '';

        card.append(header, text);
        
        const photos = review.photos || review.photos_json || [];
        if (photos.length) {
          const photoRow = document.createElement('div');
          photoRow.className = 'review-card__photos review-photos';
          photos.forEach((url, idx) => {
            const img = document.createElement('img');
            img.src = url;
            img.alt = `Фото отзыва ${idx + 1}`;
            img.className = 'review-photo-thumb';
            img.loading = 'lazy';
            img.dataset.fullUrl = url;
            photoRow.appendChild(img);
          });
          card.appendChild(photoRow);
        }

      return card;
    }

    function renderReviewsList(productId) {
      if (!productReviewsList) return;
      const state = getReviewState(productId);
      const visible = Math.max(state.visibleCount || REVIEWS_INITIAL_LIMIT, REVIEWS_INITIAL_LIMIT);
      productReviewsList.innerHTML = '';

      if (!state.items.length) {
        const empty = document.createElement('div');
        empty.className = 'muted';
        empty.textContent = 'Отзывов пока нет. Будьте первым!';
        productReviewsList.appendChild(empty);
        if (productReviewsMoreBtn) productReviewsMoreBtn.style.display = 'none';
        return;
      }

      state.items.slice(0, visible).forEach((review) => {
        productReviewsList.appendChild(createReviewCard(review));
      });

      const hasMore = state.items.length > visible;
      if (productReviewsMoreBtn) {
        productReviewsMoreBtn.style.display = hasMore ? '' : 'none';
        productReviewsMoreBtn.textContent = 'Показать ещё';
      }
    }

    function showReviewsPlaceholder(message = 'Загружаем отзывы...') {
      if (productReviewsList) {
        productReviewsList.innerHTML = '';
        if (message) {
          const placeholder = document.createElement('div');
          placeholder.className = 'muted';
          placeholder.textContent = message;
          productReviewsList.appendChild(placeholder);
        }
      }
      if (productReviewsMoreBtn) productReviewsMoreBtn.style.display = 'none';
    }

    async function loadProductReviews(productId) {
      if (!productId || !productReviewsSection) return;
      const state = getReviewState(productId);
      state.visibleCount = REVIEWS_INITIAL_LIMIT;
      renderRatingSummary(productId);
      showReviewsPlaceholder();

      try {
        const [ratingResponse, reviewsResponse] = await Promise.all([
          apiGet(`/products/${productId}/rating`).catch(() => null),
          apiGet(`/products/${productId}/reviews`, { page: 1, limit: 20 }).catch(() => ({ items: [] })),
        ]);

        state.items = (reviewsResponse?.items || []).filter((item) => !item.is_deleted);
        state.rating = ratingResponse || computeRatingFromReviews(state.items);

        renderRatingSummary(productId);
        renderReviewsList(productId);
      } catch (e) {
        renderRatingSummary(productId);
        showReviewsPlaceholder('Не удалось загрузить отзывы. Попробуйте обновить страницу.');
      }
    }

    async function handleReviewSubmit() {
      if (!currentProduct) return;
      if (!profile?.telegram_id) {
        if (reviewFormStatus) reviewFormStatus.textContent = 'Чтобы оставить отзыв, войдите через Telegram.';
        updateReviewFormVisibility();
        return;
      }

      resetReviewFormErrors();
      const ratingValue = Number(selectedReviewRating) || 0;
      const textValue = (reviewTextInput?.value || '').trim();
      let hasError = false;

      if (!ratingValue || ratingValue < 1 || ratingValue > 5) {
        reviewRatingError.textContent = 'Поставьте оценку от 1 до 5.';
        hasError = true;
      }

      if (!textValue) {
        reviewTextError.textContent = 'Напишите пару слов об опыте использования.';
        hasError = true;
      }

      if (hasError) return;

      if (reviewSubmitBtn) {
        reviewSubmitBtn.disabled = true;
        reviewSubmitBtn.textContent = 'Отправляем...';
      }

      try {
        const payload = { rating: ratingValue, text: textValue };
        // TODO: проверять наличие оплаченных заказов с товаром на бэкенде
        const res = await apiPost(`/products/${currentProduct.id}/reviews`, payload);
        const reviewId = res?.review_id;

        if (reviewId && selectedReviewFiles.length) {
          for (const file of selectedReviewFiles.slice(0, 3)) {
            const formData = new FormData();
            formData.append('file', file);
            const uploadRes = await fetch(`/api/reviews/${reviewId}/photos`, { method: 'POST', body: formData });
            if (!uploadRes.ok) {
              throw new Error('Не удалось загрузить фото отзыва.');
            }
          }
        }

        showToast('Спасибо! Ваш отзыв отправлен на модерацию.');
        resetReviewForm();
      } catch (e) {
        if (reviewFormStatus) {
          if (e?.status === 401) {
            reviewFormStatus.textContent = 'Сессия истекла. Войдите через Telegram и попробуйте ещё раз.';
          } else {
            reviewFormStatus.textContent = e?.message || 'Не удалось отправить отзыв. Попробуйте позже.';
          }
        }
      } finally {
        if (reviewSubmitBtn) {
          reviewSubmitBtn.disabled = false;
          reviewSubmitBtn.textContent = 'Отправить отзыв';
        }
      }
    }

    function handleReviewFilesChange(event) {
      const files = Array.from(event.target?.files || []).filter((file) => file?.type?.startsWith('image/'));
      if (files.length > 3) {
        showToast('Можно загрузить не более 3 фото к отзыву.');
      }
      selectedReviewFiles = files.slice(0, 3);
      renderReviewPhotosPreview();
    }

    async function loadProductCategoriesAndItems(currentProfile) {
      profile = currentProfile;
      updateAdminLinkVisibility();

      await loadCategories();
      await loadProducts();

      if (!profile) {
        noteEl.textContent = 'Каталог доступен для просмотра. Чтобы оформить заказ, войдите через Telegram.';
      }
    }

    async function initProductsPage() {
      const currentProfile = await getCurrentUserProfile();
      await loadProductCategoriesAndItems(currentProfile);
    }

    initProductsPage().catch(console.error);
  </script>
</body>
</html>
