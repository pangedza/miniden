<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MiniDeN — Корзина</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <link rel="icon" id="site-favicon" href="/favicon.ico" />
  <link rel="stylesheet" id="theme-stylesheet" href="css/theme.css" />
  <link rel="stylesheet" href="css/support_widget.css?v=20250605" />

</head>
<body class="page-cart">
  <header class="site-header">
    <div class="site-container header-inner">
      <div class="brand" data-branding-block>
        <div class="brand__logo-wrapper brand__logo-placeholder" aria-hidden="true">
          <img data-branding-logo class="brand__logo" alt="Логотип MiniDeN" />
        </div>
        <div class="brand__text">
          <div class="brand__title" data-branding-title data-branding-default="MiniDeN">MiniDeN</div>
          <span data-branding-tagline class="muted">меню и витрина</span>
        </div>
      </div>
      <div class="header-actions">
        <button class="menu-toggle" aria-label="Открыть категории">Категории</button>
        <a class="btn cart-button" href="/cart.html">Корзина</a>
      </div>
    </div>
  </header>

  <div class="site-container site-layout">
    <aside class="site-sidebar app-sidebar">
      <div class="sidebar-head">
        <div class="brand brand--inline" data-branding-block>
          <div class="brand__logo-wrapper brand__logo-placeholder" aria-hidden="true">
            <img data-branding-logo class="brand__logo" alt="Логотип MiniDeN" />
          </div>
          <div class="brand__text">
            <div class="brand__title" data-branding-title data-branding-default="Miniden">Miniden</div>
            <span data-branding-tagline class="muted">меню и витрина</span>
          </div>
        </div>
        <button class="menu-close" aria-label="Закрыть меню">✕</button>
      </div>
      <div class="sidebar-section">
        <a href="/" class="category-link">Главная</a>
        <a href="/cart.html" class="category-link is-active">Корзина</a>
        <a href="/adminsite" id="admin-link" style="display:none;">Админка</a>
      </div>
    </aside>

    <main class="site-content">
      <div class="cart-header">
        <h1>Корзина</h1>
        <p class="muted">Здесь отображаются товары и мастер-классы из вашей корзины.</p>
      </div>

      <div class="note" id="note"></div>
      <div class="note" id="cart-debug" style="display:none;"></div>

      <table class="cart-table" aria-label="Корзина">
        <thead>
          <tr>
            <th>Товар</th>
            <th>Категория</th>
            <th>Цена</th>
            <th>Кол-во</th>
            <th>Сумма</th>
          </tr>
        </thead>
        <tbody id="cart-body"></tbody>
      </table>

      <div class="total-card" id="cart-panel" style="display:none;">
        <div class="total-row"><span>Итого</span><span id="cart-total">0 ₽</span></div>
        <div class="promo-row" id="promo-info" style="display:none; color: var(--muted); font-weight:600;">
          <div>
            <div id="promo-label"></div>
            <div id="promo-scope" style="font-size:13px; color: var(--muted);"></div>
          </div>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <strong id="promo-discount" style="color: var(--accent);"></strong>
            <button class="btn secondary" type="button" id="remove-promo">Удалить промокод</button>
          </div>
        </div>
        <div class="input-row">
          <input type="text" placeholder="Промокод" id="promo-code" />
          <button class="btn secondary" type="button" id="apply-promo">Применить</button>
        </div>
        <div class="input-row">
          <input type="text" placeholder="Ваше имя" id="customer-name" />
          <input type="text" placeholder="Телефон или ник" id="customer-contact" />
        </div>
        <div class="input-row">
          <textarea id="customer-comment" placeholder="Комментарий к заказу (необязательно)"></textarea>
        </div>
        <div class="input-row">
          <button class="btn secondary" type="button" id="clear-cart">Очистить корзину</button>
          <button class="btn" type="button" id="checkout">Оформить заказ</button>
        </div>
        <div class="input-row">
          <button class="btn" type="button" id="checkout-bot-inline">Оформить в боте</button>
          <div class="muted" id="checkout-bot-inline-hint" style="display:none;">Доступно только в Telegram</div>
        </div>
      </div>
    </main>
  </div>

  <div class="checkout-modal-overlay" id="checkout-modal-overlay"></div>
  <div class="checkout-modal" id="checkout-modal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="checkout-modal-title">
    <div class="checkout-modal__header">
      <h2 id="checkout-modal-title">Оформление заказа</h2>
      <button class="checkout-modal__close" type="button" id="checkout-modal-close" aria-label="Закрыть">✕</button>
    </div>
    <div class="checkout-modal__body">
      <p class="muted">Выберите способ оформления</p>
      <div class="checkout-modal__actions">
        <a class="btn secondary" id="checkout-contact-admin" href="#" target="_blank" rel="noopener">Связаться с админом</a>
        <button class="btn" type="button" id="checkout-bot">Оформить в боте</button>
      </div>
      <div class="checkout-modal__hint muted" id="checkout-bot-hint">Доступно только в Telegram</div>
    </div>
  </div>

  <div class="app-sidebar-overlay"></div>
  <div id="toast-container"></div>

  <script src="js/app.js?v=20251218"></script>
  <script src="js/api.js?v=20250605"></script>
  <script src="js/app_shell.js?v=20251220"></script>
  <script>
    const DEBUG_CART = false;
    const DEBUG_CART_STORAGE_KEYS = {
      bottomBar: ['miniden_guest_cart'],
      cartPage: ['miniden_guest_cart'],
    };

    const adminLink = document.getElementById('admin-link');
    const noteEl = document.getElementById('note');
    const debugEl = document.getElementById('cart-debug');
    const tbody = document.getElementById('cart-body');
    const totalEl = document.getElementById('cart-total');
    const promoInfoEl = document.getElementById('promo-info');
    const promoLabelEl = document.getElementById('promo-label');
    const promoScopeEl = document.getElementById('promo-scope');
    const promoDiscountEl = document.getElementById('promo-discount');
    const removePromoBtn = document.getElementById('remove-promo');
    const promoInput = document.getElementById('promo-code');
    const applyPromoBtn = document.getElementById('apply-promo');
    const clearBtn = document.getElementById('clear-cart');
    const checkoutBtn = document.getElementById('checkout');
    const cartPanel = document.getElementById('cart-panel');
    const nameInput = document.getElementById('customer-name');
    const contactInput = document.getElementById('customer-contact');
    const commentInput = document.getElementById('customer-comment');
    const checkoutModal = document.getElementById('checkout-modal');
    const checkoutModalOverlay = document.getElementById('checkout-modal-overlay');
    const checkoutModalClose = document.getElementById('checkout-modal-close');
    const checkoutContactBtn = document.getElementById('checkout-contact-admin');
    const checkoutBotBtn = document.getElementById('checkout-bot');
    const checkoutBotHint = document.getElementById('checkout-bot-hint');
    const checkoutBotInlineBtn = document.getElementById('checkout-bot-inline');
    const checkoutBotInlineHint = document.getElementById('checkout-bot-inline-hint');

    const isTelegram = !!window.Telegram?.WebApp;
    let profile = null;
    let telegramUserId = null;
    if (isTelegram && window.Telegram?.WebApp?.ready) {
      window.Telegram.WebApp.ready();
    }
    let currentCart = { items: [], total: 0 };
    let appliedPromo = null;
    let discountAmount = 0;
    let finalTotal = 0;
    let adminContactUrl = null;
    let lastCartError = null;

    function resolveTelegramUserId() {
      return window.Telegram?.WebApp?.initDataUnsafe?.user?.id || null;
    }

    function setAdminContactUrl(url) {
      if (!checkoutContactBtn) return;
      if (!url) return;
      checkoutContactBtn.href = url;
    }

    async function resolveAdminContactUrl() {
      const fallbackUrl = 'https://t.me/your_admin_username'; // TODO: заменить на реальный контакт админа
      try {
        const settings = await apiGet('/public/site-settings');
        const social = settings?.social_links || {};
        const contacts = settings?.contacts || {};
        const candidate =
          social.telegram ||
          social.Telegram ||
          contacts.telegram ||
          contacts.Telegram ||
          contacts.tg ||
          contacts.TG;
        adminContactUrl = candidate || fallbackUrl;
      } catch (error) {
        console.warn('Failed to load site settings for admin contact', error);
        adminContactUrl = fallbackUrl;
      }
      setAdminContactUrl(adminContactUrl);
    }

    function updateTelegramCheckoutAvailability() {
      const isAvailable = isTelegram;
      if (checkoutBotBtn) {
        checkoutBotBtn.style.display = isAvailable ? '' : 'none';
      }
      if (checkoutBotHint) {
        checkoutBotHint.style.display = isAvailable ? 'none' : 'none';
      }
      if (checkoutBotInlineBtn) {
        checkoutBotInlineBtn.style.display = isAvailable ? '' : 'none';
      }
      if (checkoutBotInlineHint) {
        checkoutBotInlineHint.style.display = isAvailable ? 'none' : 'none';
      }
      if (checkoutContactBtn) {
        checkoutContactBtn.style.display = isAvailable ? '' : '';
      }
    }

    function openCheckoutModal() {
      if (!checkoutModal || !checkoutModalOverlay) return;
      checkoutModal.classList.add('is-visible');
      checkoutModalOverlay.classList.add('is-visible');
      checkoutModal.setAttribute('aria-hidden', 'false');
      document.body.classList.add('modal-open');
    }

    function closeCheckoutModal() {
      if (!checkoutModal || !checkoutModalOverlay) return;
      checkoutModal.classList.remove('is-visible');
      checkoutModalOverlay.classList.remove('is-visible');
      checkoutModal.setAttribute('aria-hidden', 'true');
      document.body.classList.remove('modal-open');
    }

    function isItemEligibleForPromo(item, promo) {
      if (!promo) return false;

      const type = item.type || 'basket';
      const productId = Number(item.product_id);
      const categoryId = item.category_id !== undefined ? Number(item.category_id) : null;

      if (Array.isArray(promo.eligible_items) && promo.eligible_items.length) {
        return promo.eligible_items.some(
          (eligible) => Number(eligible.product_id) === productId && (eligible.type || 'basket') === type
        );
      }

      switch (promo.scope) {
        case 'all':
          return true;
        case 'basket':
          return type === 'basket';
        case 'course':
          return type === 'course';
        case 'product':
          return promo.target_id !== undefined && Number(promo.target_id) === productId;
        case 'category':
          return promo.target_id !== undefined && type === 'basket' && categoryId !== null && Number(promo.target_id) === categoryId;
        default:
          return false;
      }
    }

    function calculateItemSums(items, promo, totalBeforeDiscount, totalAfterDiscount) {
      const entries = (items || []).map((item) => {
        const price = Number(item.price) || 0;
        const qty = Number(item.qty) || 0;
        const originalSum = price * qty;
        return {
          originalSum,
          discountedSum: null,
          eligible: Boolean(promo && isItemEligibleForPromo(item, promo)),
        };
      });

      const fallbackTotal = entries.reduce((sum, entry) => sum + entry.originalSum, 0);
      const baseTotal = Number.isFinite(totalBeforeDiscount) && totalBeforeDiscount > 0 ? totalBeforeDiscount : fallbackTotal;
      const desiredTotal = promo
        ? Number.isFinite(totalAfterDiscount) && totalAfterDiscount > 0
          ? totalAfterDiscount
          : baseTotal
        : baseTotal;

      if (!promo) {
        return entries;
      }

      const promoDiscountValue = Math.max(Number(promo.discount_amount ?? discountAmount ?? 0) || 0, 0);
      const discountFromTotals = Math.max(baseTotal - desiredTotal, 0);
      const totalDiscount = Math.max(promoDiscountValue, discountFromTotals);

      const eligibleIndexes = entries
        .map((entry, index) => (entry.eligible && entry.originalSum > 0 ? index : -1))
        .filter((index) => index >= 0);
      const eligibleTotal = eligibleIndexes.reduce((sum, index) => sum + entries[index].originalSum, 0);

      if (!totalDiscount || !eligibleIndexes.length || eligibleTotal <= 0) {
        return entries;
      }

      const discountPool = Math.min(totalDiscount, eligibleTotal);
      let distributed = 0;

      eligibleIndexes.forEach((index) => {
        const entry = entries[index];
        const share = Math.round((entry.originalSum / eligibleTotal) * discountPool);
        entry.discountedSum = Math.max(entry.originalSum - share, 0);
        distributed += share;
      });

      const shareDiff = discountPool - distributed;
      if (shareDiff !== 0) {
        const adjustIndex = eligibleIndexes[eligibleIndexes.length - 1];
        const entry = entries[adjustIndex];
        const adjusted = Math.max(Math.min((entry.discountedSum ?? entry.originalSum) - shareDiff, entry.originalSum), 0);
        entry.discountedSum = adjusted;
      }

      const intermediateTotal = entries.reduce((sum, entry) => sum + (entry.discountedSum ?? entry.originalSum), 0);
      const totalDiff = desiredTotal - intermediateTotal;
      if (totalDiff !== 0) {
        const adjustIndex = eligibleIndexes.length ? eligibleIndexes[eligibleIndexes.length - 1] : entries.length - 1;
        if (adjustIndex >= 0) {
          const entry = entries[adjustIndex];
          const baseValue = entry.discountedSum ?? entry.originalSum;
          const adjustedValue = Math.max(Math.min(baseValue + totalDiff, entry.originalSum), 0);
          entry.discountedSum = adjustedValue < entry.originalSum ? adjustedValue : null;
        }
      }

      return entries.map((entry) => {
        if (entry.discountedSum === null || entry.discountedSum === undefined || entry.discountedSum >= entry.originalSum) {
          return { ...entry, discountedSum: null };
        }
        return entry;
      });
    }

    function updateAdminLinkVisibility() {
      if (!adminLink) return;
      adminLink.style.display = profile?.is_admin ? '' : 'none';
    }

    function formatPrice(value) {
      const num = Number(value) || 0;
      return `${num.toLocaleString('ru-RU')} ₽`;
    }

    function renderEmpty(message) {
      tbody.innerHTML = '';
      const row = document.createElement('tr');
      const cell = document.createElement('td');
      cell.colSpan = 5;
      cell.textContent = message;
      cell.style.color = 'var(--muted)';
      row.appendChild(cell);
      tbody.appendChild(row);
      totalEl.textContent = '0 ₽';
      cartPanel.style.display = 'none';
      updateDebugPanel(currentCart, lastCartError);
    }

    function renderStorageDebug(keys, title) {
      if (!Array.isArray(keys) || !keys.length) return '';
      const items = keys
        .map((key) => {
          const raw = localStorage.getItem(key);
          const length = raw ? raw.length : 0;
          const status = raw ? `${length} chars` : 'нет данных';
          return `<li><strong>${key}</strong>: ${status}</li>`;
        })
        .join('');
      return `<div><strong>${title}</strong><ul>${items}</ul></div>`;
    }

    function updateDebugPanel(cart, errorMessage = null) {
      if (!DEBUG_CART || !debugEl) return;
      const items = cart?.items || [];
      const count = items.reduce((sum, item) => sum + (Number(item.qty) || 0), 0);
      const total = Number(cart?.total || 0);
      const url = `${window.location.pathname}${window.location.search}${window.location.hash}`;
      const storageBottom = renderStorageDebug(DEBUG_CART_STORAGE_KEYS.bottomBar, 'localStorage (нижняя панель)');
      const storageCart = renderStorageDebug(DEBUG_CART_STORAGE_KEYS.cartPage, 'localStorage (страница корзины)');
      const errorLine = errorMessage ? `<div style="color: var(--accent);"><strong>Ошибка:</strong> ${errorMessage}</div>` : '';
      debugEl.innerHTML = `
        <div><strong>DEBUG_CART</strong></div>
        <div><strong>URL:</strong> ${url}</div>
        <div><strong>items.length:</strong> ${items.length}</div>
        <div><strong>count:</strong> ${count}</div>
        <div><strong>total:</strong> ${Number.isFinite(total) ? total : 0}</div>
        ${errorLine}
        ${storageBottom}
        ${storageCart}
      `;
      debugEl.style.display = 'block';
    }

    function renderCart(cart) {
      currentCart = cart;
      lastCartError = null;
      tbody.innerHTML = '';

      if (!cart.items?.length) {
        renderEmpty('Корзина пуста');
        return;
      }

      cartPanel.style.display = 'grid';

      const activePromo = appliedPromo;
      const baseTotal = Number(cart.total || 0) || cart.items.reduce((sum, item) => {
        const price = Number(item.price) || 0;
        const qty = Number(item.qty) || 0;
        return sum + price * qty;
      }, 0);
      const totalToShow = appliedPromo ? Number(finalTotal || baseTotal) || baseTotal : baseTotal;
      const itemSums = calculateItemSums(cart.items, activePromo, baseTotal, totalToShow);

      cart.items.forEach((item, index) => {
        const row = document.createElement('tr');

        const nameCell = document.createElement('td');
        nameCell.textContent = item.name;

        const categoryCell = document.createElement('td');
        const badge = document.createElement('span');
        badge.className = 'badge';
        const typeLabel = item.type === 'course' ? 'Мастер-класс' : 'Товар';
        badge.textContent = typeLabel;
        categoryCell.appendChild(badge);

        const priceCell = document.createElement('td');
        priceCell.textContent = formatPrice(item.price);

        const qtyCell = document.createElement('td');
        const controls = document.createElement('div');
        controls.className = 'qty-controls';
        const minus = document.createElement('button');
        minus.className = 'qty-btn';
        minus.textContent = '−';
        minus.addEventListener('click', () => updateQty(item.product_id, item.qty - 1, item.type));
        const qty = document.createElement('span');
        qty.textContent = item.qty;
        const plus = document.createElement('button');
        plus.className = 'qty-btn';
        plus.textContent = '+';
        plus.addEventListener('click', () => updateQty(item.product_id, item.qty + 1, item.type));
        controls.append(minus, qty, plus);
        qtyCell.appendChild(controls);

        const sumCell = document.createElement('td');
        const { originalSum, discountedSum } = itemSums[index];
        if (discountedSum !== null && discountedSum < originalSum) {
          const originalEl = document.createElement('span');
          originalEl.className = 'price-original';
          originalEl.textContent = formatPrice(originalSum);

          const discountedEl = document.createElement('span');
          discountedEl.className = 'price-discounted';
          discountedEl.textContent = formatPrice(discountedSum);

          sumCell.append(originalEl, discountedEl);
        } else {
          sumCell.textContent = formatPrice(originalSum);
        }

        row.append(nameCell, categoryCell, priceCell, qtyCell, sumCell);
        tbody.appendChild(row);
      });

      totalEl.textContent = formatPrice(totalToShow || 0);
      if (appliedPromo) {
        promoInfoEl.style.display = 'flex';
        const promoLabel = appliedPromo?.code || '';
        promoLabelEl.textContent = promoLabel ? `Промокод ${promoLabel}` : 'Промокод';
        const appliedDiscount = Number(appliedPromo.discount_amount ?? discountAmount ?? 0);
        promoScopeEl.textContent = appliedDiscount ? `Скидка применена, экономия ${formatPrice(appliedDiscount)}` : '';
        promoDiscountEl.textContent = appliedDiscount ? `-${formatPrice(appliedDiscount)}` : '';
      } else {
        promoInfoEl.style.display = 'none';
        promoLabelEl.textContent = '';
        promoScopeEl.textContent = '';
        promoDiscountEl.textContent = '';
        discountAmount = 0;
        finalTotal = cart.total || 0;
      }
      updateDebugPanel(cart);
    }

    async function loadCartFromServer() {
      try {
        noteEl.textContent = '';
        lastCartError = null;
        const cart = await apiGet('/cart');
        currentCart = cart;
        if (!appliedPromo) {
          discountAmount = 0;
          finalTotal = cart.total || 0;
        }
        renderCart(cart);
        noteEl.textContent = '';
      } catch (e) {
        noteEl.textContent = 'Не удалось загрузить корзину. Попробуйте обновить страницу.';
        lastCartError = 'Ошибка загрузки корзины';
        renderEmpty('Ошибка загрузки корзины');
      }
    }

    async function loadCart() {
      await loadCartFromServer();
    }

    async function updateQty(productId, qty, type) {
      try {
        await apiPost('/cart/update', { product_id: productId, qty, type: type || 'basket' });
        appliedPromo = null;
        await loadCart();
      } catch (e) {
        showToast('Не удалось обновить количество. Попробуйте ещё раз.');
      }
    }

    async function clearCart() {
      try {
        await apiPost('/cart/clear');
        appliedPromo = null;
        await loadCart();
      } catch (e) {
        showToast('Не удалось очистить корзину. Попробуйте ещё раз.');
      }
    }

    async function applyPromo() {
      const code = (promoInput.value || '').trim();
      if (!code) {
        showToast('Введите промокод');
        return;
      }

      try {
        const result = await apiPost('/cart/apply-promocode', { code });
        appliedPromo = result;
        discountAmount = Number(result.discount_amount || 0);
        finalTotal = Number(result.final_total || currentCart.total || 0);
        currentCart = { ...currentCart, total: result.cart_total ?? currentCart.total };
        renderCart(currentCart);
        showToast('Промокод применён');
      } catch (e) {
        appliedPromo = null;
        discountAmount = 0;
        finalTotal = currentCart.total || 0;
        showToast('Промокод не подошёл.');
        renderCart(currentCart);
      }
    }

    function removePromo() {
      appliedPromo = null;
      discountAmount = 0;
      finalTotal = currentCart.total || 0;
      promoInput.value = '';
      renderCart(currentCart);
    }

    async function loadUserProfile() {
      try {
        profile = await getCurrentUserProfile();
        updateAdminLinkVisibility();
        if (profile?.full_name && nameInput && !nameInput.value) {
          nameInput.value = profile.full_name;
        }
        const contactValue = profile?.phone || (profile?.telegram_username ? `@${profile.telegram_username}` : '');
        if (contactValue && contactInput && !contactInput.value) {
          contactInput.value = contactValue;
        }
      } catch (e) {
        console.error('Failed to load profile', e);
        profile = null;
      }
    }

    async function updateProfileIfNeeded(customerName, contact) {
      if (!profile?.telegram_id) return;

      const updates = {};
      if (!profile.full_name && customerName) {
        updates.full_name = customerName;
      }
      if (!profile.phone && contact) {
        updates.phone = contact;
      }

      if (!Object.keys(updates).length) return;

      try {
        const res = await fetch('/api/profile/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updates),
        });
        const data = await res.json();
        if (data?.ok && data.user) {
          profile = data.user;
        }
      } catch (e) {
        console.error('Failed to update profile before checkout', e);
      }
    }

    async function checkout() {
      const userId = profile?.telegram_id || telegramUserId || null;
      if (!userId) {
        showToast('Оформление через бота доступно в Telegram.');
        return;
      }

      const customerName = nameInput.value.trim();
      const contact = contactInput.value.trim();
      const comment = commentInput.value.trim();
      const promocode = (appliedPromo?.code || (promoInput.value || '').trim()) || null;

      if (!customerName || !contact) {
        showToast('Укажите имя и способ связи.');
        return;
      }

      try {
        await updateProfileIfNeeded(customerName, contact);
        const result = await apiPost('/checkout', {
          user_id: userId,
          user_name: profile?.telegram_username,
          customer_name: customerName,
          contact,
          comment: comment || null,
          promocode,
        });
        showToast(`Заказ оформлен! Номер заказа: ${result.order_id}. Итог: ${formatPrice(result.total)}`);
        appliedPromo = null;
        discountAmount = 0;
        finalTotal = 0;
        promoInput.value = '';
        nameInput.value = '';
        contactInput.value = '';
        commentInput.value = '';
        await loadCart();
      } catch (e) {
        if (e?.status === 401) {
          showToast('Оформление через бота доступно в Telegram.');
          return;
        }
        showToast(e?.message || 'Не удалось оформить заказ. Попробуйте ещё раз.');
      }
    }

    function getCartTotalForPayload() {
      const items = currentCart.items || [];
      const fallbackTotal = items.reduce((sum, item) => {
        const price = Number(item.price) || 0;
        const qty = Number(item.qty) || 0;
        return sum + price * qty;
      }, 0);
      const baseTotal = Number(currentCart.total || 0) || fallbackTotal;
      const promoTotal = Number.isFinite(Number(finalTotal)) ? Number(finalTotal) : baseTotal;
      return appliedPromo ? promoTotal : baseTotal;
    }

    function buildWebAppOrderPayload() {
      return {
        type: 'webapp_order',
        cart: {
          items: currentCart.items || [],
          total: getCartTotalForPayload(),
          currency: 'RUB',
        },
      };
    }

    function notifyBotCheckoutSent() {
      const message = 'Заказ отправлен в бот. Вернитесь в чат.';
      if (typeof showToast === 'function') {
        showToast(message);
        return;
      }
      alert(message);
    }

    function sendCartToTelegramBot() {
      const tg = window.Telegram?.WebApp;
      const isTg = Boolean(tg);
      if (!isTg) {
        showToast('Доступно только в Telegram');
        return;
      }
      if (!currentCart.items?.length) {
        showToast('Корзина пуста');
        return;
      }
      const payload = buildWebAppOrderPayload();
      tg.sendData(JSON.stringify(payload));
      try {
        tg.close?.();
      } catch (error) {
        console.warn('Failed to close Telegram WebApp', error);
      }
      notifyBotCheckoutSent();
    }

    applyPromoBtn.addEventListener('click', applyPromo);
    removePromoBtn?.addEventListener('click', removePromo);
    clearBtn.addEventListener('click', clearCart);
    checkoutBtn.addEventListener('click', openCheckoutModal);
    checkoutModalClose?.addEventListener('click', closeCheckoutModal);
    checkoutModalOverlay?.addEventListener('click', closeCheckoutModal);
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') closeCheckoutModal();
    });
    checkoutBotBtn?.addEventListener('click', sendCartToTelegramBot);
    checkoutBotInlineBtn?.addEventListener('click', sendCartToTelegramBot);

    async function initCartPage() {
      telegramUserId = resolveTelegramUserId();
      await resolveAdminContactUrl();
      await loadUserProfile();
      await loadCart();
      updateTelegramCheckoutAvailability();
    }

    initCartPage();
  </script>
  <script src="js/support_widget.js?v=20250605" defer></script>
</body>
</html>
