<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MiniDeN — Корзина</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/webapp/css/support_widget.css" />
  <link rel="stylesheet" href="css/theme.css?v=20250521" />

</head>
<body data-theme="purple" class="page-cart">
  <header class="top-nav">
    <div class="brand">MiniDeN<span>уютные корзинки и мастер-классы</span></div>
    <div class="header-actions">
      <div class="theme-switcher">
        <label for="theme-select">Тема</label>
        <select id="theme-select">
          <option value="purple">Фиолетовая</option>
          <option value="dark">Тёмная</option>
          <option value="light">Светлая</option>
          <option value="cream">Сливочная</option>
        </select>
      </div>
      <button class="menu-toggle" aria-label="Открыть меню">☰</button>
    </div>
    <nav class="nav-links app-sidebar">
      <a href="index.html">Главная</a>
      <a href="products.html">Товары</a>
      <a href="masterclasses.html">Мастер-классы</a>
      <a href="cart.html" class="active">Корзина</a>
      <a href="profile.html">Профиль</a>
      <a href="admin.html" id="admin-link" style="display:none;">Админка</a>
    </nav>
  </header>

  <div class="app-sidebar-overlay"></div>
  <div id="toast-container"></div>

  <main>
    <h1>Корзина</h1>
    <p>Здесь отображаются товары и мастер-классы из вашего Telegram-аккаунта.</p>

    <div class="note" id="note"></div>

    <table class="cart-table" aria-label="Корзина">
      <thead>
        <tr>
          <th>Товар</th>
          <th>Категория</th>
          <th>Цена</th>
          <th>Кол-во</th>
          <th>Сумма</th>
        </tr>
      </thead>
      <tbody id="cart-body"></tbody>
    </table>

    <div class="total-card" id="cart-panel" style="display:none;">
      <div class="total-row"><span>Итого</span><span id="cart-total">0 ₽</span></div>
      <div class="promo-row" id="promo-info" style="display:none; color: var(--muted); font-weight:600;">
        <div>
          <div id="promo-label"></div>
          <div id="promo-scope" style="font-size:13px; color: var(--muted);"></div>
        </div>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <strong id="promo-discount" style="color: var(--accent);"></strong>
          <button class="btn secondary" type="button" id="remove-promo">Удалить промокод</button>
        </div>
      </div>
      <div class="input-row">
        <input type="text" placeholder="Промокод" id="promo-code" />
        <button class="btn secondary" type="button" id="apply-promo">Применить</button>
      </div>
      <div class="input-row">
        <input type="text" placeholder="Ваше имя" id="customer-name" />
        <input type="text" placeholder="Телефон или ник" id="customer-contact" />
      </div>
      <div class="input-row">
        <textarea id="customer-comment" placeholder="Комментарий к заказу (необязательно)"></textarea>
      </div>
      <div class="input-row">
        <button class="btn secondary" type="button" id="clear-cart">Очистить корзину</button>
        <button class="btn" type="button" id="checkout">Оформить заказ</button>
      </div>
    </div>
  </main>

  <script src="js/app.js?v=20250521"></script>
  <script src="js/api.js?v=20250521"></script>
  <script>
    const adminLink = document.getElementById('admin-link');
    const noteEl = document.getElementById('note');
    const tbody = document.getElementById('cart-body');
    const totalEl = document.getElementById('cart-total');
    const promoInfoEl = document.getElementById('promo-info');
    const promoLabelEl = document.getElementById('promo-label');
    const promoScopeEl = document.getElementById('promo-scope');
    const promoDiscountEl = document.getElementById('promo-discount');
    const removePromoBtn = document.getElementById('remove-promo');
    const promoInput = document.getElementById('promo-code');
    const applyPromoBtn = document.getElementById('apply-promo');
    const clearBtn = document.getElementById('clear-cart');
    const checkoutBtn = document.getElementById('checkout');
    const cartPanel = document.getElementById('cart-panel');
    const nameInput = document.getElementById('customer-name');
    const contactInput = document.getElementById('customer-contact');
    const commentInput = document.getElementById('customer-comment');

    let profile = null;
    if (isTelegramWebApp && window.Telegram?.WebApp?.ready) {
      window.Telegram.WebApp.ready();
    }
    let currentCart = { items: [], total: 0 };
    let appliedPromo = null;
    let discountAmount = 0;
    let finalTotal = 0;

    function isItemEligibleForPromo(item, promo) {
      if (!promo) return false;

      const type = item.type || 'basket';
      const productId = Number(item.product_id);
      const categoryId = item.category_id !== undefined ? Number(item.category_id) : null;

      if (Array.isArray(promo.eligible_items) && promo.eligible_items.length) {
        return promo.eligible_items.some(
          (eligible) => Number(eligible.product_id) === productId && (eligible.type || 'basket') === type
        );
      }

      switch (promo.scope) {
        case 'all':
          return true;
        case 'basket':
          return type === 'basket';
        case 'course':
          return type === 'course';
        case 'product':
          return promo.target_id !== undefined && Number(promo.target_id) === productId;
        case 'category':
          return promo.target_id !== undefined && type === 'basket' && categoryId !== null && Number(promo.target_id) === categoryId;
        default:
          return false;
      }
    }

    function calculateItemSums(items, promo, totalBeforeDiscount, totalAfterDiscount) {
      const entries = (items || []).map((item) => {
        const price = Number(item.price) || 0;
        const qty = Number(item.qty) || 0;
        const originalSum = price * qty;
        return {
          originalSum,
          discountedSum: null,
          eligible: Boolean(promo && isItemEligibleForPromo(item, promo)),
        };
      });

      const fallbackTotal = entries.reduce((sum, entry) => sum + entry.originalSum, 0);
      const baseTotal = Number.isFinite(totalBeforeDiscount) && totalBeforeDiscount > 0 ? totalBeforeDiscount : fallbackTotal;
      const desiredTotal = promo
        ? Number.isFinite(totalAfterDiscount) && totalAfterDiscount > 0
          ? totalAfterDiscount
          : baseTotal
        : baseTotal;

      if (!promo) {
        return entries;
      }

      const promoDiscountValue = Math.max(Number(promo.discount_amount ?? discountAmount ?? 0) || 0, 0);
      const discountFromTotals = Math.max(baseTotal - desiredTotal, 0);
      const totalDiscount = Math.max(promoDiscountValue, discountFromTotals);

      const eligibleIndexes = entries
        .map((entry, index) => (entry.eligible && entry.originalSum > 0 ? index : -1))
        .filter((index) => index >= 0);
      const eligibleTotal = eligibleIndexes.reduce((sum, index) => sum + entries[index].originalSum, 0);

      if (!totalDiscount || !eligibleIndexes.length || eligibleTotal <= 0) {
        return entries;
      }

      const discountPool = Math.min(totalDiscount, eligibleTotal);
      let distributed = 0;

      eligibleIndexes.forEach((index) => {
        const entry = entries[index];
        const share = Math.round((entry.originalSum / eligibleTotal) * discountPool);
        entry.discountedSum = Math.max(entry.originalSum - share, 0);
        distributed += share;
      });

      const shareDiff = discountPool - distributed;
      if (shareDiff !== 0) {
        const adjustIndex = eligibleIndexes[eligibleIndexes.length - 1];
        const entry = entries[adjustIndex];
        const adjusted = Math.max(Math.min((entry.discountedSum ?? entry.originalSum) - shareDiff, entry.originalSum), 0);
        entry.discountedSum = adjusted;
      }

      const intermediateTotal = entries.reduce((sum, entry) => sum + (entry.discountedSum ?? entry.originalSum), 0);
      const totalDiff = desiredTotal - intermediateTotal;
      if (totalDiff !== 0) {
        const adjustIndex = eligibleIndexes.length ? eligibleIndexes[eligibleIndexes.length - 1] : entries.length - 1;
        if (adjustIndex >= 0) {
          const entry = entries[adjustIndex];
          const baseValue = entry.discountedSum ?? entry.originalSum;
          const adjustedValue = Math.max(Math.min(baseValue + totalDiff, entry.originalSum), 0);
          entry.discountedSum = adjustedValue < entry.originalSum ? adjustedValue : null;
        }
      }

      return entries.map((entry) => {
        if (entry.discountedSum === null || entry.discountedSum === undefined || entry.discountedSum >= entry.originalSum) {
          return { ...entry, discountedSum: null };
        }
        return entry;
      });
    }

    function updateAdminLinkVisibility() {
      if (!adminLink) return;
      adminLink.style.display = profile?.is_admin ? '' : 'none';
    }

    function formatPrice(value) {
      const num = Number(value) || 0;
      return `${num.toLocaleString('ru-RU')} ₽`;
    }

    function renderEmpty(message) {
      tbody.innerHTML = '';
      const row = document.createElement('tr');
      const cell = document.createElement('td');
      cell.colSpan = 5;
      cell.textContent = message;
      cell.style.color = 'var(--muted)';
      row.appendChild(cell);
      tbody.appendChild(row);
      totalEl.textContent = '0 ₽';
      cartPanel.style.display = 'none';
    }

    function renderCart(cart) {
      currentCart = cart;
      tbody.innerHTML = '';

      if (!cart.items?.length) {
        renderEmpty('Корзина пуста');
        return;
      }

      cartPanel.style.display = 'grid';

      const activePromo = appliedPromo;
      const baseTotal = Number(cart.total || 0) || cart.items.reduce((sum, item) => {
        const price = Number(item.price) || 0;
        const qty = Number(item.qty) || 0;
        return sum + price * qty;
      }, 0);
      const totalToShow = appliedPromo ? Number(finalTotal || baseTotal) || baseTotal : baseTotal;
      const itemSums = calculateItemSums(cart.items, activePromo, baseTotal, totalToShow);

      cart.items.forEach((item, index) => {
        const row = document.createElement('tr');

        const nameCell = document.createElement('td');
        nameCell.textContent = item.name;

        const categoryCell = document.createElement('td');
        const badge = document.createElement('span');
        badge.className = 'badge';
        const typeLabel = item.type === 'course' ? 'Мастер-класс' : 'Товар';
        badge.textContent = typeLabel;
        categoryCell.appendChild(badge);

        const priceCell = document.createElement('td');
        priceCell.textContent = formatPrice(item.price);

        const qtyCell = document.createElement('td');
        const controls = document.createElement('div');
        controls.className = 'qty-controls';
        const minus = document.createElement('button');
        minus.className = 'qty-btn';
        minus.textContent = '−';
        minus.addEventListener('click', () => updateQty(item.product_id, item.qty - 1, item.type));
        const qty = document.createElement('span');
        qty.textContent = item.qty;
        const plus = document.createElement('button');
        plus.className = 'qty-btn';
        plus.textContent = '+';
        plus.addEventListener('click', () => updateQty(item.product_id, item.qty + 1, item.type));
        controls.append(minus, qty, plus);
        qtyCell.appendChild(controls);

        const sumCell = document.createElement('td');
        const { originalSum, discountedSum } = itemSums[index];
        if (discountedSum !== null && discountedSum < originalSum) {
          const originalEl = document.createElement('span');
          originalEl.className = 'price-original';
          originalEl.textContent = formatPrice(originalSum);

          const discountedEl = document.createElement('span');
          discountedEl.className = 'price-discounted';
          discountedEl.textContent = formatPrice(discountedSum);

          sumCell.append(originalEl, discountedEl);
        } else {
          sumCell.textContent = formatPrice(originalSum);
        }

        row.append(nameCell, categoryCell, priceCell, qtyCell, sumCell);
        tbody.appendChild(row);
      });

      totalEl.textContent = formatPrice(totalToShow || 0);
      if (appliedPromo) {
        promoInfoEl.style.display = 'flex';
        const promoLabel = appliedPromo?.code || '';
        promoLabelEl.textContent = promoLabel ? `Промокод ${promoLabel}` : 'Промокод';
        const appliedDiscount = Number(appliedPromo.discount_amount ?? discountAmount ?? 0);
        promoScopeEl.textContent = appliedDiscount ? `Скидка применена, экономия ${formatPrice(appliedDiscount)}` : '';
        promoDiscountEl.textContent = appliedDiscount ? `-${formatPrice(appliedDiscount)}` : '';
      } else {
        promoInfoEl.style.display = 'none';
        promoLabelEl.textContent = '';
        promoScopeEl.textContent = '';
        promoDiscountEl.textContent = '';
        discountAmount = 0;
        finalTotal = cart.total || 0;
      }
    }

    async function loadCartFromServer() {
      try {
        noteEl.textContent = '';
        await syncGuestCartToServer(profile);
        const cart = await apiGet('/cart', { user_id: profile.telegram_id });
        currentCart = cart;
        if (!appliedPromo) {
          discountAmount = 0;
          finalTotal = cart.total || 0;
        }
        renderCart(cart);
      } catch (e) {
        noteEl.textContent = 'Не удалось загрузить корзину. Попробуйте обновить страницу.';
        renderEmpty('Ошибка загрузки корзины');
      }
    }

    async function loadGuestCartView() {
      const items = loadGuestCart();
      if (!items.length) {
        noteEl.textContent = 'Чтобы оформить заказ и сохранить корзину, войдите через Telegram на главной странице.';
        renderEmpty('Корзина пуста. Добавьте товары на страницах каталога.');
        return;
      }

      const types = Array.from(new Set(items.map((item) => item.type || 'basket')));
      const productMaps = {};

      for (const type of types) {
        try {
          const products = await apiGet('/products', { type });
          productMaps[type] = Object.fromEntries(products.map((p) => [Number(p.id), p]));
        } catch (e) {
          productMaps[type] = {};
        }
      }

      const enriched = items.map((item) => {
        const map = productMaps[item.type || 'basket'] || {};
        const product = map[Number(item.product_id)] || {};
        const price = Number(product.price || 0);
        return {
          product_id: item.product_id,
          type: item.type || 'basket',
          qty: item.qty || 1,
          name: product.name || `Товар #${item.product_id}`,
          price,
        };
      });

      const total = enriched.reduce((acc, item) => acc + (Number(item.price) || 0) * (Number(item.qty) || 0), 0);
      currentCart = { items: enriched, total };
      cartPanel.style.display = 'grid';
      appliedPromo = null;
      discountAmount = 0;
      finalTotal = total;
      noteEl.textContent = 'Для оформления заказа войдите через Telegram. После входа корзина сохранится.';
      renderCart(currentCart);
    }

    async function loadCart() {
      if (profile?.telegram_id) {
        await loadCartFromServer();
      } else {
        await loadGuestCartView();
      }
    }

    async function updateQty(productId, qty, type) {
      if (profile?.telegram_id) {
        try {
          await apiPost('/cart/update', { user_id: profile.telegram_id, product_id: productId, qty, type: type || 'basket' });
          appliedPromo = null;
          await loadCart();
        } catch (e) {
          showToast('Не удалось обновить количество. Попробуйте ещё раз.');
        }
        return;
      }

      const items = loadGuestCart();
      const updated = items
        .map((item) => {
          if (item.product_id === productId && item.type === type) {
            return { ...item, qty };
          }
          return item;
        })
        .filter((item) => (item.product_id === productId && item.type === type ? qty > 0 : true));
      saveGuestCart(updated);
      await loadGuestCartView();
    }

    async function clearCart() {
      if (profile?.telegram_id) {
        try {
          await apiPost('/cart/clear', { user_id: profile.telegram_id });
          appliedPromo = null;
          await loadCart();
        } catch (e) {
          showToast('Не удалось очистить корзину. Попробуйте ещё раз.');
        }
        return;
      }

      clearGuestCart();
      appliedPromo = null;
      discountAmount = 0;
      finalTotal = 0;
      await loadGuestCartView();
    }

    async function applyPromo() {
      if (!profile?.telegram_id) {
        showToast('Промокод можно применить после входа через Telegram.');
        setTimeout(() => {
          window.location.href = '/index.html';
        }, 1200);
        return;
      }

      const code = (promoInput.value || '').trim();
      if (!code) {
        showToast('Введите промокод');
        return;
      }

      try {
        const result = await apiPost('/cart/apply-promocode', { user_id: profile.telegram_id, code });
        appliedPromo = result;
        discountAmount = Number(result.discount_amount || 0);
        finalTotal = Number(result.final_total || currentCart.total || 0);
        currentCart = { ...currentCart, total: result.cart_total ?? currentCart.total };
        renderCart(currentCart);
        showToast('Промокод применён');
      } catch (e) {
        appliedPromo = null;
        discountAmount = 0;
        finalTotal = currentCart.total || 0;
        showToast('Промокод не подошёл.');
        renderCart(currentCart);
      }
    }

    function removePromo() {
      appliedPromo = null;
      discountAmount = 0;
      finalTotal = currentCart.total || 0;
      promoInput.value = '';
      renderCart(currentCart);
    }

    async function loadUserProfile() {
      try {
        profile = await getCurrentUserProfile();
        updateAdminLinkVisibility();
        if (profile?.full_name && nameInput && !nameInput.value) {
          nameInput.value = profile.full_name;
        }
        const contactValue = profile?.phone || (profile?.telegram_username ? `@${profile.telegram_username}` : '');
        if (contactValue && contactInput && !contactInput.value) {
          contactInput.value = contactValue;
        }
      } catch (e) {
        console.error('Failed to load profile', e);
        profile = null;
      }
    }

    async function updateProfileIfNeeded(customerName, contact) {
      if (!profile?.telegram_id) return;

      const updates = {};
      if (!profile.full_name && customerName) {
        updates.full_name = customerName;
      }
      if (!profile.phone && contact) {
        updates.phone = contact;
      }

      if (!Object.keys(updates).length) return;

      try {
        const res = await fetch('/api/profile/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updates),
        });
        const data = await res.json();
        if (data?.ok && data.user) {
          profile = data.user;
        }
      } catch (e) {
        console.error('Failed to update profile before checkout', e);
      }
    }

    async function checkout() {
      if (!profile?.telegram_id) {
        showToast('Чтобы оформить заказ и сохранить корзину, войдите через Telegram.');
        setTimeout(() => {
          window.location.href = '/index.html';
        }, 1200);
        return;
      }

      const customerName = nameInput.value.trim();
      const contact = contactInput.value.trim();
      const comment = commentInput.value.trim();
      const promocode = (appliedPromo?.code || (promoInput.value || '').trim()) || null;

      if (!customerName || !contact) {
        showToast('Укажите имя и способ связи.');
        return;
      }

      try {
        await updateProfileIfNeeded(customerName, contact);
        const result = await apiPost('/checkout', {
          user_id: profile.telegram_id,
          user_name: profile.telegram_username,
          customer_name: customerName,
          contact,
          comment: comment || null,
          promocode,
        });
        showToast(`Заказ оформлен! Номер заказа: ${result.order_id}. Итог: ${formatPrice(result.total)}`);
        appliedPromo = null;
        discountAmount = 0;
        finalTotal = 0;
        promoInput.value = '';
        nameInput.value = '';
        contactInput.value = '';
        commentInput.value = '';
        await loadCart();
      } catch (e) {
        if (e?.status === 401) {
          showToast('Требуется авторизация через Telegram.');
          setTimeout(() => {
            window.location.href = '/index.html';
          }, 1200);
          return;
        }
        showToast(e?.message || 'Не удалось оформить заказ. Попробуйте ещё раз.');
      }
    }

    applyPromoBtn.addEventListener('click', applyPromo);
    removePromoBtn?.addEventListener('click', removePromo);
    clearBtn.addEventListener('click', clearCart);
    checkoutBtn.addEventListener('click', checkout);

    async function initCartPage() {
      await loadUserProfile();
      await loadCart();
    }

    initCartPage();
  </script>
  <script src="/webapp/js/support_widget.js" defer></script>
</body>
</html>
