<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MiniDeN — Корзина</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      color-scheme: light;
      --bg: #0b0c10;
      --card: rgba(255, 255, 255, 0.06);
      --text: #f6f7fb;
      --muted: #c7c9d3;
      --accent: #ffb800;
      --accent-2: #7bd8ff;
      --shadow: 0 14px 50px rgba(0, 0, 0, 0.35);
      --nav: rgba(17, 17, 19, 0.82);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 10% 20%, rgba(255, 184, 0, 0.06), transparent 35%),
        radial-gradient(circle at 80% 10%, rgba(123, 216, 255, 0.08), transparent 30%),
        radial-gradient(circle at 60% 80%, rgba(255, 184, 0, 0.05), transparent 32%),
        #0b0c10;
      color: var(--text);
      min-height: 100vh;
      padding: 0 18px 48px;
    }

    .top-nav { position: sticky; top: 0; z-index: 20; background: var(--nav); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255, 255, 255, 0.06); display: flex; align-items: center; justify-content: space-between; padding: 14px 12px; margin: 0 -18px; }
    .brand { display: flex; flex-direction: column; gap: 2px; font-weight: 800; letter-spacing: -0.02em; }
    .brand span { color: var(--muted); font-size: 13px; font-weight: 600; letter-spacing: normal; }
    .nav-links { display: flex; gap: 12px; align-items: center; }
    .nav-links a { color: var(--muted); text-decoration: none; font-weight: 600; padding: 10px 12px; border-radius: 12px; transition: background 0.15s ease, color 0.15s ease; }
    .nav-links a:hover { color: var(--text); background: rgba(255, 255, 255, 0.06); }
    .nav-links a.active { color: var(--text); background: linear-gradient(135deg, rgba(255, 184, 0, 0.18), rgba(123, 216, 255, 0.14)); }
    .menu-toggle { display: none; background: transparent; border: 1px solid rgba(255, 255, 255, 0.12); color: var(--text); border-radius: 12px; padding: 10px 12px; cursor: pointer; }

    main { max-width: 1000px; margin: 0 auto; padding-top: 28px; }
    h1 { margin: 12px 0 8px; letter-spacing: -0.02em; }
    p { color: var(--muted); }

    .cart-table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    .cart-table th, .cart-table td { padding: 12px 10px; text-align: left; }
    .cart-table th { color: var(--muted); font-weight: 700; border-bottom: 1px solid rgba(255, 255, 255, 0.08); }
    .cart-table td { border-bottom: 1px solid rgba(255, 255, 255, 0.04); color: var(--text); }

    .badge { padding: 6px 10px; border-radius: 10px; background: rgba(255, 255, 255, 0.06); color: var(--muted); font-size: 13px; }
    .qty-controls { display: inline-flex; gap: 6px; align-items: center; }
    .qty-btn { padding: 4px 10px; border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.12); background: rgba(255, 255, 255, 0.08); color: var(--text); cursor: pointer; }

    .total-card { background: var(--card); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 16px; padding: 16px; box-shadow: var(--shadow); margin-top: 18px; display: grid; gap: 10px; }
    .total-row { display: flex; justify-content: space-between; font-weight: 800; font-size: 18px; }
    .input-row { display: flex; gap: 10px; flex-wrap: wrap; }
    input[type="text"], textarea { flex: 1; min-width: 180px; padding: 12px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.12); background: rgba(255, 255, 255, 0.06); color: var(--text); }
    textarea { min-height: 80px; resize: vertical; }
    .btn { cursor: pointer; border: none; border-radius: 12px; padding: 12px 14px; background: linear-gradient(135deg, #ffb800, #ff8f3f); color: #0b0c10; font-weight: 700; font-size: 15px; box-shadow: 0 10px 30px rgba(255, 184, 0, 0.25); transition: transform 0.1s ease, box-shadow 0.1s ease; }
    .btn.secondary { background: rgba(255, 255, 255, 0.08); color: var(--text); border: 1px solid rgba(255, 255, 255, 0.12); box-shadow: none; }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 12px 32px rgba(255, 184, 0, 0.35); }

    .section { margin-top: 18px; }

    @media (max-width: 780px) {
      .nav-links { display: none; }
      .nav-links.open { display: flex; flex-direction: column; align-items: flex-start; width: 100%; margin-top: 10px; }
      .top-nav { flex-wrap: wrap; }
      .menu-toggle { display: inline-flex; }
    }
  </style>
</head>
<body>
  <header class="top-nav">
    <div class="brand">MiniDeN<span>уютные корзинки и мастер-классы</span></div>
    <button class="menu-toggle" aria-label="Открыть меню">☰</button>
    <nav class="nav-links open">
      <a href="index.html">Главная</a>
      <a href="products.html">Товары</a>
      <a href="masterclasses.html">Мастер-классы</a>
      <a href="cart.html" class="active">Корзина</a>
      <a href="profile.html">Профиль</a>
      <a href="admin.html" id="admin-link">Админка</a>
    </nav>
  </header>

  <main>
    <h1>Корзина</h1>
    <p>Здесь отображаются товары и мастер-классы из вашего Telegram-аккаунта.</p>

    <div class="note" id="note"></div>

    <table class="cart-table" aria-label="Корзина">
      <thead>
        <tr>
          <th>Товар</th>
          <th>Категория</th>
          <th>Цена</th>
          <th>Кол-во</th>
          <th>Сумма</th>
        </tr>
      </thead>
      <tbody id="cart-body"></tbody>
    </table>

    <div class="total-card" id="cart-panel" style="display:none;">
      <div class="total-row"><span>Итого</span><span id="cart-total">0 ₽</span></div>
      <div class="total-row" id="promo-info" style="display:none; color: var(--muted); font-weight:600;"></div>
      <div class="input-row">
        <input type="text" placeholder="Промокод" id="promo-code" />
        <button class="btn secondary" type="button" id="apply-promo">Применить</button>
      </div>
      <div class="input-row">
        <input type="text" placeholder="Ваше имя" id="customer-name" />
        <input type="text" placeholder="Телефон или ник" id="customer-contact" />
      </div>
      <div class="input-row">
        <textarea id="customer-comment" placeholder="Комментарий к заказу (необязательно)"></textarea>
      </div>
      <div class="input-row">
        <button class="btn secondary" type="button" id="clear-cart">Очистить корзину</button>
        <button class="btn" type="button" id="checkout">Оформить заказ</button>
      </div>
    </div>
  </main>

  <section class="section" id="unauthorized" style="display:none; text-align:center;">
    <h2>Вы не авторизованы</h2>
    <p>Вы не авторизованы. Войдите через Telegram. После входа откройте <a href="index.html">главную страницу</a> и вернитесь сюда.</p>
    <a class="btn" href="/index.html">Войти через Telegram</a>
  </section>

  <script src="js/api.js"></script>
  <script>
    const toggle = document.querySelector('.menu-toggle');
    const nav = document.querySelector('.nav-links');
    toggle?.addEventListener('click', () => nav?.classList.toggle('open'));

    const adminLink = document.getElementById('admin-link');
    const noteEl = document.getElementById('note');
    const tbody = document.getElementById('cart-body');
    const totalEl = document.getElementById('cart-total');
    const promoInfoEl = document.getElementById('promo-info');
    const promoInput = document.getElementById('promo-code');
    const applyPromoBtn = document.getElementById('apply-promo');
    const clearBtn = document.getElementById('clear-cart');
    const checkoutBtn = document.getElementById('checkout');
    const unauthorizedBlock = document.getElementById('unauthorized');
    const cartPanel = document.getElementById('cart-panel');
    const nameInput = document.getElementById('customer-name');
    const contactInput = document.getElementById('customer-contact');
    const commentInput = document.getElementById('customer-comment');

    let currentUser = null;
    const isTelegramWebApp = Boolean(window.Telegram?.WebApp);
    if (isTelegramWebApp && window.Telegram?.WebApp?.ready) {
      window.Telegram.WebApp.ready();
    }
    let currentCart = { items: [], total: 0 };
    let appliedPromo = null;
    let discountAmount = 0;
    let finalTotal = 0;

    function showUnauthorized(message) {
      tbody.innerHTML = '';
      if (noteEl) noteEl.textContent = message || '';
      if (unauthorizedBlock) unauthorizedBlock.style.display = 'block';
      if (cartPanel) cartPanel.style.display = 'none';
    }

    async function loadCurrentUser() {
      try {
        if (isTelegramWebApp && window.Telegram?.WebApp?.initData) {
          const profile = await apiPost('/auth/telegram', { initData: window.Telegram.WebApp.initData });
          return profile?.ok ? profile : null;
        }
        const res = await fetch('/api/auth/session');
        if (res.status === 401 || res.status === 404) {
          return null;
        }
        const data = await handleResponse(res);
        return data?.ok ? data : null;
      } catch (e) {
        if (e?.status === 401 || e?.status === 404) return null;
        console.error('Не удалось получить пользователя', e);
        return null;
      }
    }

    function updateAdminLinkVisibility() {
      if (!adminLink) return;
      adminLink.style.display = currentUser?.is_admin ? '' : 'none';
    }

    function formatPrice(value) {
      const num = Number(value) || 0;
      return `${num.toLocaleString('ru-RU')} ₽`;
    }

    function renderEmpty(message) {
      tbody.innerHTML = '';
      const row = document.createElement('tr');
      const cell = document.createElement('td');
      cell.colSpan = 5;
      cell.textContent = message;
      cell.style.color = 'var(--muted)';
      row.appendChild(cell);
      tbody.appendChild(row);
      totalEl.textContent = '0 ₽';
      cartPanel.style.display = 'none';
    }

    function renderCart(cart) {
      currentCart = cart;
      tbody.innerHTML = '';

      if (!cart.items?.length) {
        renderEmpty('Корзина пуста');
        return;
      }

      cartPanel.style.display = 'grid';

      cart.items.forEach((item) => {
        const row = document.createElement('tr');

        const nameCell = document.createElement('td');
        nameCell.textContent = item.name;

        const categoryCell = document.createElement('td');
        const badge = document.createElement('span');
        badge.className = 'badge';
        badge.textContent = item.category_name || (item.type === 'course' ? 'Курс' : 'Товар');
        categoryCell.appendChild(badge);

        const priceCell = document.createElement('td');
        priceCell.textContent = formatPrice(item.price);

        const qtyCell = document.createElement('td');
        const controls = document.createElement('div');
        controls.className = 'qty-controls';
        const minus = document.createElement('button');
        minus.className = 'qty-btn';
        minus.textContent = '−';
        minus.addEventListener('click', () => updateQty(item.product_id, item.qty - 1, item.type));
        const qty = document.createElement('span');
        qty.textContent = item.qty;
        const plus = document.createElement('button');
        plus.className = 'qty-btn';
        plus.textContent = '+';
        plus.addEventListener('click', () => updateQty(item.product_id, item.qty + 1, item.type));
        controls.append(minus, qty, plus);
        qtyCell.appendChild(controls);

        const sumCell = document.createElement('td');
        sumCell.textContent = formatPrice(item.price * item.qty);

        row.append(nameCell, categoryCell, priceCell, qtyCell, sumCell);
        tbody.appendChild(row);
      });

      const totalToShow = appliedPromo ? finalTotal : cart.total;
      totalEl.textContent = formatPrice(totalToShow || 0);
      if (appliedPromo) {
        promoInfoEl.style.display = 'flex';
        promoInfoEl.textContent = `Скидка по промокоду ${appliedPromo}: -${formatPrice(discountAmount)}`;
      } else {
        promoInfoEl.style.display = 'none';
        promoInfoEl.textContent = '';
        discountAmount = 0;
        finalTotal = cart.total || 0;
      }
    }

    async function loadCart() {
      if (!currentUser) {
        showUnauthorized('Вы не авторизованы. Войдите через Telegram.');
        renderEmpty('Нет данных — пользователь не авторизован');
        return;
      }

      try {
        noteEl.textContent = '';
        const cart = await apiGet('/cart', { user_id: currentUser.telegram_id });
        renderCart(cart);
      } catch (e) {
        noteEl.textContent = 'Не удалось загрузить корзину. Попробуйте обновить страницу.';
        renderEmpty('Ошибка загрузки корзины');
      }
    }

    async function updateQty(productId, qty, type) {
      if (!currentUser) return;

      try {
        await apiPost('/cart/update', { user_id: currentUser.telegram_id, product_id: productId, qty, type: type || 'basket' });
        appliedPromo = null;
        await loadCart();
      } catch (e) {
        alert('Не удалось обновить количество. Попробуйте ещё раз.');
      }
    }

    async function clearCart() {
      if (!currentUser) return;
      try {
        await apiPost('/cart/clear', { user_id: currentUser.telegram_id });
        appliedPromo = null;
        await loadCart();
      } catch (e) {
        alert('Не удалось очистить корзину. Попробуйте ещё раз.');
      }
    }

    async function applyPromo() {
      if (!currentUser) {
        alert('Промокод можно применить только после входа через Telegram.');
        return;
      }

      const code = (promoInput.value || '').trim();
      if (!code) {
        alert('Введите промокод');
        return;
      }

      try {
        const result = await apiPost('/promocode/validate', { telegram_id: currentUser.telegram_id, code, total: currentCart.total || 0 });
        appliedPromo = result.code;
        discountAmount = result.discount_amount || 0;
        finalTotal = result.final_total || currentCart.total || 0;
        renderCart(currentCart);
      } catch (e) {
        appliedPromo = null;
        discountAmount = 0;
        finalTotal = currentCart.total || 0;
        alert('Промокод не подошёл.');
        renderCart(currentCart);
      }
    }

    async function checkout() {
      if (!currentUser) {
        alert('Авторизуйтесь через Telegram, чтобы оформить заказ.');
        return;
      }

      const customerName = nameInput.value.trim();
      const contact = contactInput.value.trim();
      const comment = commentInput.value.trim();
      const promocode = appliedPromo || (promoInput.value || '').trim() || null;

      if (!customerName || !contact) {
        alert('Укажите имя и способ связи.');
        return;
      }

      try {
        const result = await apiPost('/checkout', {
          user_id: currentUser.telegram_id,
          user_name: currentUser.telegram_username,
          customer_name: customerName,
          contact,
          comment: comment || null,
          promocode,
        });
        alert(`Заказ оформлен! Номер заказа: ${result.order_id}. Итог: ${formatPrice(result.total)}`);
        appliedPromo = null;
        discountAmount = 0;
        finalTotal = 0;
        promoInput.value = '';
        nameInput.value = '';
        contactInput.value = '';
        commentInput.value = '';
        await loadCart();
      } catch (e) {
        alert(e?.message || 'Не удалось оформить заказ. Попробуйте ещё раз.');
      }
    }

    applyPromoBtn.addEventListener('click', applyPromo);
    clearBtn.addEventListener('click', clearCart);
    checkoutBtn.addEventListener('click', checkout);

    async function initApp() {
      try {
        currentUser = await loadCurrentUser();
        updateAdminLinkVisibility();
        if (!currentUser) {
          showUnauthorized('Вы не авторизованы. Войдите через Telegram.');
          return;
        }
        if (unauthorizedBlock) {
          unauthorizedBlock.style.display = 'none';
        }
        await loadCart();
      } catch (e) {
        console.error(e);
      }
    }

    initApp();
  </script>
</body>
</html>
