<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MiniDeN — Корзина</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      color-scheme: light;
      --bg: #0b0c10;
      --card: rgba(255, 255, 255, 0.06);
      --text: #f6f7fb;
      --muted: #c7c9d3;
      --accent: #ffb800;
      --accent-2: #7bd8ff;
      --shadow: 0 14px 50px rgba(0, 0, 0, 0.35);
      --nav: rgba(17, 17, 19, 0.82);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 10% 20%, rgba(255, 184, 0, 0.06), transparent 35%),
        radial-gradient(circle at 80% 10%, rgba(123, 216, 255, 0.08), transparent 30%),
        radial-gradient(circle at 60% 80%, rgba(255, 184, 0, 0.05), transparent 32%),
        #0b0c10;
      color: var(--text);
      min-height: 100vh;
      padding: 0 18px 48px;
    }

    .top-nav { position: sticky; top: 0; z-index: 20; background: var(--nav); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255, 255, 255, 0.06); display: flex; align-items: center; justify-content: space-between; padding: 14px 12px; margin: 0 -18px; }
    .brand { display: flex; flex-direction: column; gap: 2px; font-weight: 800; letter-spacing: -0.02em; }
    .brand span { color: var(--muted); font-size: 13px; font-weight: 600; letter-spacing: normal; }
    .nav-links { display: flex; gap: 12px; align-items: center; }
    .nav-links a { color: var(--muted); text-decoration: none; font-weight: 600; padding: 10px 12px; border-radius: 12px; transition: background 0.15s ease, color 0.15s ease; }
    .nav-links a:hover { color: var(--text); background: rgba(255, 255, 255, 0.06); }
    .nav-links a.active { color: var(--text); background: linear-gradient(135deg, rgba(255, 184, 0, 0.18), rgba(123, 216, 255, 0.14)); }
    .menu-toggle { display: none; background: transparent; border: 1px solid rgba(255, 255, 255, 0.12); color: var(--text); border-radius: 12px; padding: 10px 12px; cursor: pointer; }

    main { max-width: 1000px; margin: 0 auto; padding-top: 28px; }
    h1 { margin: 12px 0 8px; letter-spacing: -0.02em; }
    p { color: var(--muted); }

    .cart-table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    .cart-table th, .cart-table td { padding: 12px 10px; text-align: left; }
    .cart-table th { color: var(--muted); font-weight: 700; border-bottom: 1px solid rgba(255, 255, 255, 0.08); }
    .cart-table td { border-bottom: 1px solid rgba(255, 255, 255, 0.04); color: var(--text); }

    .badge { padding: 6px 10px; border-radius: 10px; background: rgba(255, 255, 255, 0.06); color: var(--muted); font-size: 13px; }
    .qty-controls { display: inline-flex; gap: 6px; align-items: center; }
    .qty-btn { padding: 4px 10px; border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.12); background: rgba(255, 255, 255, 0.08); color: var(--text); cursor: pointer; }

    .total-card { background: var(--card); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 16px; padding: 16px; box-shadow: var(--shadow); margin-top: 18px; display: grid; gap: 10px; }
    .total-row { display: flex; justify-content: space-between; font-weight: 800; font-size: 18px; }
    .input-row { display: flex; gap: 10px; flex-wrap: wrap; }
    input[type="text"] { flex: 1; min-width: 180px; padding: 12px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.12); background: rgba(255, 255, 255, 0.06); color: var(--text); }
    .btn { cursor: pointer; border: none; border-radius: 12px; padding: 12px 14px; background: linear-gradient(135deg, #ffb800, #ff8f3f); color: #0b0c10; font-weight: 700; font-size: 15px; box-shadow: 0 10px 30px rgba(255, 184, 0, 0.25); transition: transform 0.1s ease, box-shadow 0.1s ease; }
    .btn.secondary { background: rgba(255, 255, 255, 0.08); color: var(--text); border: 1px solid rgba(255, 255, 255, 0.12); box-shadow: none; }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 12px 32px rgba(255, 184, 0, 0.35); }

    @media (max-width: 780px) {
      .nav-links { display: none; }
      .nav-links.open { display: flex; flex-direction: column; align-items: flex-start; width: 100%; margin-top: 10px; }
      .top-nav { flex-wrap: wrap; }
      .menu-toggle { display: inline-flex; }
    }
  </style>
</head>
<body>
  <header class="top-nav">
    <div class="brand">MiniDeN<span>уютные корзинки и мастер-классы</span></div>
    <button class="menu-toggle" aria-label="Открыть меню">☰</button>
    <nav class="nav-links open">
      <a href="index.html">Главная</a>
      <a href="products.html">Товары</a>
      <a href="masterclasses.html">Мастер-классы</a>
      <a href="cart.html" class="active">Корзина</a>
      <a href="profile.html">Профиль</a>
      <a href="admin.html" id="admin-link">Админка</a>
    </nav>
  </header>

  <main>
    <h1>Корзина</h1>
    <p>Здесь отображаются товары и мастер-классы из вашего Telegram-аккаунта.</p>

    <div class="note" id="note"></div>

    <table class="cart-table" aria-label="Корзина">
      <thead>
        <tr>
          <th>Товар</th>
          <th>Категория</th>
          <th>Цена</th>
          <th>Кол-во</th>
          <th>Сумма</th>
        </tr>
      </thead>
      <tbody id="cart-body"></tbody>
    </table>

    <div class="total-card">
      <div class="total-row"><span>Итого</span><span id="cart-total">0 ₽</span></div>
      <div class="total-row" id="promo-info" style="display:none; color: var(--muted); font-weight:600;"></div>
      <div class="input-row">
        <input type="text" placeholder="Промокод" id="promo-code" />
        <button class="btn secondary" type="button" id="apply-promo">Применить</button>
      </div>
      <div class="input-row">
        <button class="btn secondary" type="button" id="clear-cart">Очистить корзину</button>
        <button class="btn" type="button" id="checkout">Перейти к оформлению в Telegram</button>
      </div>
    </div>
  </main>

  <section class="section" id="login-hint" style="display: none; text-align: center;">
    <h2>Вы не авторизованы</h2>
    <p>
      Чтобы увидеть вашу корзину и оформить заказ, войдите через Telegram.
      Сначала откройте главную страницу и нажмите кнопку входа.
    </p>
    <p>
      <a href="index.html" class="btn">Перейти на главную для входа</a>
    </p>
  </section>

  <script>
    const toggle = document.querySelector('.menu-toggle');
    const nav = document.querySelector('.nav-links');
    toggle?.addEventListener('click', () => nav?.classList.toggle('open'));

    const tg = window.Telegram?.WebApp;
    const API_BASE = "/api";

    let userId = null;
    let username = null;
    let isAdmin = false;
    const adminLink = document.getElementById('admin-link');
    let currentCart = { items: [], total: 0 };
    let appliedPromo = null;
    let discountAmount = 0;
    let finalTotal = 0;

    const noteEl = document.getElementById('note');
    const loginHint = document.getElementById('login-hint');
    const tbody = document.getElementById('cart-body');
    const totalEl = document.getElementById('cart-total');
    const promoInfoEl = document.getElementById('promo-info');
    const promoInput = document.getElementById('promo-code');
    const applyPromoBtn = document.getElementById('apply-promo');
    const clearBtn = document.getElementById('clear-cart');
    const checkoutBtn = document.getElementById('checkout');

    function showLoginHint(message) {
      if (loginHint) {
        loginHint.style.display = 'block';
      }
      if (noteEl && message) {
        noteEl.textContent = message;
      }
    }

    function updateAdminLinkVisibility() {
      if (!adminLink) return;
      adminLink.style.display = isAdmin ? '' : 'none';
    }

    updateAdminLinkVisibility();

    function formatPrice(value) {
      const num = Number(value) || 0;
      return `${num.toLocaleString('ru-RU')} ₽`;
    }

    async function fetchJson(url, options) {
      const res = await fetch(url, options);
      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || 'Ошибка API');
      }
      return res.json();
    }

    async function authorize() {
      const initData = tg?.initData || tg?.initDataUnsafe?.query_id ? tg.initData : null;
      if (!initData) {
        userId = null;
        username = null;
        isAdmin = false;
        if (noteEl) {
          noteEl.innerHTML =
            'Корзина привязана к вашему Telegram-профилю. ' +
            'Откройте эту страницу из ' +
            '<a href="https://t.me/miniden_bot" target="_blank" rel="noopener">Telegram-бота MiniDeN</a>, ' +
            'а затем вернитесь и обновите страницу.';
        }
        updateAdminLinkVisibility();
        return;
      }

      try {
        const data = await fetchJson(`${API_BASE}/auth/telegram`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ initData }),
        });
        userId = data.telegram_id;
        username = data.username;
        isAdmin = Boolean(data.is_admin);
        updateAdminLinkVisibility();
        if (loginHint) loginHint.style.display = 'none';
        if (noteEl) noteEl.textContent = '';
      } catch (e) {
        console.warn('WebApp auth failed, показываем пустую корзину', e);
        userId = null;
        username = null;
        isAdmin = false;
        if (noteEl) {
          noteEl.innerHTML =
            'Не удалось получить данные Telegram. ' +
            'Откройте корзину через ' +
            '<a href="https://t.me/miniden_bot" target="_blank" rel="noopener">бот MiniDeN</a>.';
        }
        updateAdminLinkVisibility();
      }
    }

    function renderEmpty(message) {
      tbody.innerHTML = '';
      const row = document.createElement('tr');
      const cell = document.createElement('td');
      cell.colSpan = 5;
      cell.textContent = message;
      cell.style.color = 'var(--muted)';
      row.appendChild(cell);
      tbody.appendChild(row);
      totalEl.textContent = '0 ₽';
    }

    function renderCart(cart) {
      currentCart = cart;
      tbody.innerHTML = '';

      if (!cart.items?.length) {
        renderEmpty('Корзина пуста');
        return;
      }

      cart.items.forEach((item) => {
        const row = document.createElement('tr');

        const nameCell = document.createElement('td');
        nameCell.textContent = item.name;

        const categoryCell = document.createElement('td');
        const badge = document.createElement('span');
        badge.className = 'badge';
        badge.textContent = item.category_name || 'Каталог';
        categoryCell.appendChild(badge);

        const priceCell = document.createElement('td');
        priceCell.textContent = formatPrice(item.price);

        const qtyCell = document.createElement('td');
        const controls = document.createElement('div');
        controls.className = 'qty-controls';
        const minus = document.createElement('button');
        minus.className = 'qty-btn';
        minus.textContent = '−';
        minus.addEventListener('click', () => updateQty(item.product_id, item.qty - 1));
        const qty = document.createElement('span');
        qty.textContent = item.qty;
        const plus = document.createElement('button');
        plus.className = 'qty-btn';
        plus.textContent = '+';
        plus.addEventListener('click', () => updateQty(item.product_id, item.qty + 1));
        controls.append(minus, qty, plus);
        qtyCell.appendChild(controls);

        const sumCell = document.createElement('td');
        sumCell.textContent = formatPrice(item.price * item.qty);

        row.append(nameCell, categoryCell, priceCell, qtyCell, sumCell);
        tbody.appendChild(row);
      });

      const totalToShow = appliedPromo ? finalTotal : cart.total;
      totalEl.textContent = formatPrice(totalToShow || 0);
      if (appliedPromo) {
        promoInfoEl.style.display = 'flex';
        promoInfoEl.textContent = `Скидка по промокоду ${appliedPromo}: -${formatPrice(discountAmount)}`;
      } else {
        promoInfoEl.style.display = 'none';
        promoInfoEl.textContent = '';
        discountAmount = 0;
        finalTotal = cart.total || 0;
      }
    }

    async function loadCart() {
      if (!userId) {
        showLoginHint('Чтобы видеть содержимое корзины, откройте эту страницу из Telegram-бота MiniDeN.');
        renderEmpty('Нет данных — нет Telegram user_id');
        return;
      }

      try {
        noteEl.textContent = '';
        const params = new URLSearchParams({ user_id: userId });
        const cart = await fetchJson(`${API_BASE}/cart?${params.toString()}`);
        renderCart(cart);
      } catch (e) {
        noteEl.textContent = 'Не удалось загрузить корзину. Попробуйте обновить страницу.';
        renderEmpty('Ошибка загрузки корзины');
      }
    }

    async function updateQty(productId, qty) {
      if (!userId) return;

      try {
        await fetchJson(`${API_BASE}/cart/update`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: userId, product_id: productId, qty }),
        });
        appliedPromo = null;
        await loadCart();
      } catch (e) {
        alert('Не удалось обновить количество. Попробуйте ещё раз.');
      }
    }

    async function clearCart() {
      if (!userId) return;
      try {
        await fetchJson(`${API_BASE}/cart/clear`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: userId }),
        });
        appliedPromo = null;
        await loadCart();
      } catch (e) {
        alert('Не удалось очистить корзину. Попробуйте ещё раз.');
      }
    }

    async function applyPromo() {
      if (!userId) {
        alert('Промокод можно применить только из Telegram.');
        return;
      }

      const code = (promoInput.value || '').trim();
      if (!code) {
        alert('Введите промокод');
        return;
      }

      try {
        const result = await fetchJson(`${API_BASE}/promocode/validate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ telegram_id: userId, code, total: currentCart.total || 0 }),
        });
        appliedPromo = result.code;
        discountAmount = result.discount_amount || 0;
        finalTotal = result.final_total || currentCart.total || 0;
        renderCart(currentCart);
      } catch (e) {
        appliedPromo = null;
        discountAmount = 0;
        finalTotal = currentCart.total || 0;
        alert('Промокод не подошёл.');
        renderCart(currentCart);
      }
    }

    function checkout() {
      if (tg) {
        tg.sendData(
          JSON.stringify({
            action: 'checkout',
            total: currentCart.total || 0,
            final_total: appliedPromo ? finalTotal : currentCart.total || 0,
            promocode_code: appliedPromo,
            discount_amount: appliedPromo ? discountAmount : 0,
          })
        );
        tg.close();
      } else {
        alert('Вернитесь в Telegram-бот для оформления заказа.');
      }
    }

    applyPromoBtn.addEventListener('click', applyPromo);
    clearBtn.addEventListener('click', clearCart);
    checkoutBtn.addEventListener('click', checkout);

    async function initApp() {
      try {
        await authorize();
        await loadCart();
      } catch (e) {
        console.error(e);
      }
    }

    initApp();
  </script>
</body>
</html>
