<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MiniDeN ‚Äî –ü—Ä–æ—Ñ–∏–ª—å</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      color-scheme: light;
      --bg: #0b0c10;
      --card: rgba(255, 255, 255, 0.06);
      --text: #f6f7fb;
      --muted: #c7c9d3;
      --accent: #ffb800;
      --accent-2: #7bd8ff;
      --shadow: 0 14px 50px rgba(0, 0, 0, 0.35);
      --nav: rgba(17, 17, 19, 0.82);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 10% 20%, rgba(255, 184, 0, 0.06), transparent 35%),
        radial-gradient(circle at 80% 10%, rgba(123, 216, 255, 0.08), transparent 30%),
        radial-gradient(circle at 60% 80%, rgba(255, 184, 0, 0.05), transparent 32%),
        #0b0c10;
      color: var(--text);
      min-height: 100vh;
      padding: 0 18px 48px;
    }

    .top-nav { position: sticky; top: 0; z-index: 20; background: var(--nav); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255, 255, 255, 0.06); display: flex; align-items: center; justify-content: space-between; padding: 14px 12px; margin: 0 -18px; }
    .brand { display: flex; flex-direction: column; gap: 2px; font-weight: 800; letter-spacing: -0.02em; }
    .brand span { color: var(--muted); font-size: 13px; font-weight: 600; letter-spacing: normal; }
    .nav-links { display: flex; gap: 12px; align-items: center; }
    .nav-links a { color: var(--muted); text-decoration: none; font-weight: 600; padding: 10px 12px; border-radius: 12px; transition: background 0.15s ease, color 0.15s ease; }
    .nav-links a:hover { color: var(--text); background: rgba(255, 255, 255, 0.06); }
    .nav-links a.active { color: var(--text); background: linear-gradient(135deg, rgba(255, 184, 0, 0.18), rgba(123, 216, 255, 0.14)); }
    .menu-toggle { display: none; background: transparent; border: 1px solid rgba(255, 255, 255, 0.12); color: var(--text); border-radius: 12px; padding: 10px 12px; cursor: pointer; }

    main { max-width: 1000px; margin: 0 auto; padding-top: 28px; }
    h1 { margin: 12px 0 8px; letter-spacing: -0.02em; }
    p { color: var(--muted); }

    .card { background: var(--card); border: 1px solid rgba(255, 255, 255, 0.06); border-radius: 16px; padding: 16px; box-shadow: var(--shadow); backdrop-filter: blur(6px); }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 14px; }
    .label { color: var(--muted); text-transform: uppercase; font-size: 12px; letter-spacing: 0.06em; margin-bottom: 6px; }
    .value { font-weight: 700; font-size: 18px; }
    .list { margin: 0; padding: 0; list-style: none; display: grid; gap: 8px; }
    .list li { padding: 10px 12px; border-radius: 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.06); }

    .editable { display: inline-flex; align-items: center; gap: 8px; }
    .edit-btn { cursor: pointer; border: none; background: transparent; color: var(--muted); font-size: 16px; padding: 4px; }
    .edit-btn:hover { color: var(--text); }
    .edit-input { padding: 8px 10px; border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.12); background: rgba(255, 255, 255, 0.08); color: var(--text); min-width: 180px; }
    .edit-save { cursor: pointer; border: none; border-radius: 10px; padding: 8px 10px; background: rgba(255, 255, 255, 0.12); color: var(--text); font-weight: 700; }

    .btn { cursor: pointer; border: none; border-radius: 12px; padding: 12px 14px; background: linear-gradient(135deg, #ffb800, #ff8f3f); color: #0b0c10; font-weight: 700; font-size: 15px; box-shadow: 0 10px 30px rgba(255, 184, 0, 0.25); transition: transform 0.1s ease, box-shadow 0.1s ease; margin-top: 10px; }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 12px 32px rgba(255, 184, 0, 0.35); }

    .message { padding: 12px; border-radius: 12px; background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.12); color: var(--text); margin-bottom: 14px; }
    .error { border-color: rgba(255, 99, 99, 0.6); color: #ffc0c0; }

    @media (max-width: 780px) {
      .nav-links { display: none; }
      .nav-links.open { display: flex; flex-direction: column; align-items: flex-start; width: 100%; margin-top: 10px; }
      .top-nav { flex-wrap: wrap; }
      .menu-toggle { display: inline-flex; }
    }
  </style>
</head>
<body>
  <header class="top-nav">
    <div class="brand">MiniDeN<span>—É—é—Ç–Ω—ã–µ –∫–æ—Ä–∑–∏–Ω–∫–∏ –∏ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã</span></div>
    <button class="menu-toggle" aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é">‚ò∞</button>
    <nav class="nav-links open">
      <a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
      <a href="products.html">–¢–æ–≤–∞—Ä—ã</a>
      <a href="masterclasses.html">–ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã</a>
      <a href="cart.html">–ö–æ—Ä–∑–∏–Ω–∞</a>
      <a href="profile.html" class="active">–ü—Ä–æ—Ñ–∏–ª—å</a>
      <a href="admin.html" id="admin-link">–ê–¥–º–∏–Ω–∫–∞</a>
    </nav>
  </header>

  <main>
    <h1>–ü—Ä–æ—Ñ–∏–ª—å</h1>
    <p>–î–∞–Ω–Ω—ã–µ –±–µ—Ä—É—Ç—Å—è –∏–∑ –≤–∞—à–µ–≥–æ Telegram-–ø—Ä–æ—Ñ–∏–ª—è MiniDeN –∏ –∑–∞–∫–∞–∑–æ–≤.</p>

    <div id="status" class="message" style="display:none"></div>

    <div class="grid" id="profile-grid" style="display:none">
      <div class="card">
        <div class="label">–ò–º—è</div>
        <div class="value editable"><span id="full-name">‚Äî</span><button class="edit-btn" id="edit-full-name" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–º—è">‚úèÔ∏è</button></div>
        <div class="label" style="margin-top: 12px;">Telegram</div>
        <div class="value" id="username">‚Äî</div>
        <div class="label" style="margin-top: 12px;">Telegram ID</div>
        <div class="value" id="telegram-id">‚Äî</div>
        <div class="label" style="margin-top: 12px;">–¢–µ–ª–µ—Ñ–æ–Ω</div>
        <div class="value editable"><span id="phone">‚Äî</span><button class="edit-btn" id="edit-phone" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω">‚úèÔ∏è</button></div>
        <div class="label" style="margin-top: 12px;">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</div>
        <div class="value" id="created-at">‚Äî</div>
      </div>

      <div class="card">
        <div class="label">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</div>
        <ul class="list" id="orders-list"></ul>
      </div>

      <div class="card">
        <div class="label">–ú–æ–∏ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã</div>
        <ul class="list" id="courses-list"></ul>
      </div>

      <div class="card">
        <div class="label">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</div>
        <ul class="list" id="favorites-list"></ul>
      </div>

      <div class="card">
        <div class="label">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
        <ul class="list" id="stats-list"></ul>
      </div>
    </div>
  </main>

  <section class="section" id="login-hint" style="display: none; text-align: center;">
    <h2>–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã</h2>
    <p>–ü—Ä–æ—Ñ–∏–ª—å, –∑–∞–∫–∞–∑—ã –∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Telegram. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ <a href="index.html">–≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É</a>, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Ö–æ–¥ –∏ –≤–µ—Ä–Ω–∏—Ç–µ—Å—å —Å—é–¥–∞.</p>
    <button class="btn" id="login-button" type="button">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram</button>
  </section>

  <div id="profile-actions" style="display: none; gap: 10px; margin-top: 16px;">
    <button class="btn secondary" id="switch-user-btn" type="button">–°–º–µ–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
    <a class="btn" href="products.html">–ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥</a>
  </div>

  <script src="js/api.js"></script>
  <script>
    const toggle = document.querySelector('.menu-toggle');
    const nav = document.querySelector('.nav-links');
    toggle?.addEventListener('click', () => nav?.classList.toggle('open'));

    const statusEl = document.getElementById('status');
    const loginHint = document.getElementById('login-hint');
    const profileGrid = document.getElementById('profile-grid');
    const fullNameEl = document.getElementById('full-name');
    const usernameEl = document.getElementById('username');
    const telegramIdEl = document.getElementById('telegram-id');
    const phoneEl = document.getElementById('phone');
    const createdAtEl = document.getElementById('created-at');
    const ordersList = document.getElementById('orders-list');
    const coursesList = document.getElementById('courses-list');
    const favoritesList = document.getElementById('favorites-list');
    const statsList = document.getElementById('stats-list');
    const adminLink = document.getElementById('admin-link');
    const actions = document.getElementById('profile-actions');
    const switchUserBtn = document.getElementById('switch-user-btn');
    const loginButton = document.getElementById('login-button');
    const editFullNameBtn = document.getElementById('edit-full-name');
    const editPhoneBtn = document.getElementById('edit-phone');

    let currentUser = null;
    const isTelegramWebApp = Boolean(window.Telegram?.WebApp);

    function updateAdminLinkVisibility() {
      if (!adminLink) return;
      adminLink.style.display = currentUser?.is_admin ? '' : 'none';
    }

    function setStatus(message, isError = false) {
      if (!message) {
        statusEl.style.display = 'none';
        statusEl.textContent = '';
        statusEl.classList.remove('error');
        return;
      }
      statusEl.textContent = message;
      statusEl.classList.toggle('error', isError);
      statusEl.style.display = 'block';
    }

    function showLoginHint(message) {
      if (loginHint) {
        loginHint.style.display = 'block';
      }
      setStatus(message, true);
      actions?.style.setProperty('display', 'none');
      profileGrid?.style.setProperty('display', 'none');
    }

    async function saveProfileUpdates(updates) {
      const res = await fetch('/api/profile/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updates || {}),
      });

      if (!res.ok) {
        const errorData = await res.json().catch(() => ({}));
        const message = errorData?.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
        const err = new Error(message);
        err.status = res.status;
        throw err;
      }

      const data = await res.json();
      if (!data?.ok || !data.user) {
        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è');
      }
      currentUser = data.user;
      return currentUser;
    }

    function startEditing(field) {
      if (!currentUser) return;
      const valueEl = field === 'full_name' ? fullNameEl : phoneEl;
      const container = valueEl?.parentElement;
      const editBtn = field === 'full_name' ? editFullNameBtn : editPhoneBtn;
      if (!valueEl || !container || !editBtn) return;

      const currentValue = field === 'full_name' ? (currentUser.full_name || '') : (currentUser.phone || '');
      const input = document.createElement('input');
      input.type = 'text';
      input.value = currentValue;
      input.className = 'edit-input';

      const saveBtn = document.createElement('button');
      saveBtn.type = 'button';
      saveBtn.className = 'edit-save';
      saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';

      container.replaceChild(input, valueEl);
      editBtn.style.display = 'none';
      container.insertBefore(saveBtn, editBtn);

      saveBtn.addEventListener('click', async () => {
        try {
          const updates = field === 'full_name' ? { full_name: input.value } : { phone: input.value };
          const updated = await saveProfileUpdates(updates);
          container.replaceChild(valueEl, input);
          if (saveBtn.parentElement === container) container.removeChild(saveBtn);
          editBtn.style.display = '';
          renderProfile(updated);
        } catch (e) {
          alert(e?.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è');
          container.replaceChild(valueEl, input);
          if (saveBtn.parentElement === container) container.removeChild(saveBtn);
          editBtn.style.display = '';
          renderProfile(currentUser);
        }
      });
    }

    function renderOrders(orders) {
      ordersList.innerHTML = '';
      if (!orders || !orders.length) {
        const li = document.createElement('li');
        li.textContent = '–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç';
        ordersList.appendChild(li);
        return;
      }

      orders.forEach((order) => {
        const li = document.createElement('li');
        const dateText = order.created_at ? new Date(order.created_at).toLocaleString('ru-RU') : '';
        const header = document.createElement('div');
        header.textContent = `–ó–∞–∫–∞–∑ #${order.id} ‚Äî ${order.total} ‚ÇΩ (${order.status || '–≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ'}) ${dateText ? '‚Ä¢ ' + dateText : ''}`;
        const list = document.createElement('ul');
        list.className = 'list';

        (order.items || []).forEach((item) => {
          const itemLi = document.createElement('li');
          const prefix = item.type === 'course' ? 'üéì' : 'üß∫';
          const baseText = `${prefix} ${item.name || '–¢–æ–≤–∞—Ä'} ‚Äî ${item.qty} √ó ${item.price ?? 0} ‚ÇΩ`;
          if (item.type === 'course') {
            if ((order.status || '').toLowerCase() !== 'paid') {
              itemLi.textContent = `${baseText} ‚Ä¢ –°—Å—ã–ª–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã`;
            } else {
              itemLi.textContent = `${baseText} ‚Ä¢ –î–æ—Å—Ç—É–ø –æ—Ç–∫—Ä—ã—Ç –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–ú–æ–∏ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã¬ª`;
            }
          } else {
            itemLi.textContent = baseText;
          }
          list.appendChild(itemLi);
        });

        li.appendChild(header);
        if (list.childElementCount > 0) {
          li.appendChild(list);
        }
        ordersList.appendChild(li);
      });
    }

    function renderCourses(courses) {
      coursesList.innerHTML = '';
      if (!courses || !courses.length) {
        const li = document.createElement('li');
        li.textContent = '–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å–æ–≤';
        coursesList.appendChild(li);
        return;
      }

      courses.forEach((course) => {
        const li = document.createElement('li');
        const statusText = course.is_paid ? '–û–ø–ª–∞—á–µ–Ω' : '–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π';
        const linkText = course.masterclass_url
          ? ` ‚Äî <a href="${course.masterclass_url}" target="_blank">–ü–µ—Ä–µ–π—Ç–∏</a>`
          : '';
        li.innerHTML = `üéì ${course.name || '–ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å'} ‚Ä¢ ${statusText}${linkText}`;
        coursesList.appendChild(li);
      });
    }

    function renderFavorites(favorites) {
      favoritesList.innerHTML = '';
      if (!favorites || !favorites.length) {
        const li = document.createElement('li');
        li.textContent = '–ò–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç';
        favoritesList.appendChild(li);
        return;
      }

      favorites.forEach((fav) => {
        const li = document.createElement('li');
        const prefix = fav.type === 'course' ? 'üéì' : 'üß∫';
        li.textContent = `${prefix} ${fav.name || '–¢–æ–≤–∞—Ä'} ‚Äî ${fav.price ?? 0} ‚ÇΩ`;
        favoritesList.appendChild(li);
      });
    }

    function renderStats(stats, ban) {
      statsList.innerHTML = '';
      const rows = [
        `–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤: ${stats?.orders_count ?? 0}`,
        `–ü–æ—Ç—Ä–∞—á–µ–Ω–æ: ${stats?.total_spent ?? 0} ‚ÇΩ`,
        stats?.last_order_at ? `–ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–∫–∞–∑: ${new Date(stats.last_order_at).toLocaleString('ru-RU')}` : null,
        ban?.is_banned ? `–°—Ç–∞—Ç—É—Å: –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω (${ban.ban_reason || '–±–µ–∑ –ø—Ä–∏—á–∏–Ω—ã'})` : '–°—Ç–∞—Ç—É—Å: –∞–∫—Ç–∏–≤–µ–Ω',
      ].filter(Boolean);

      rows.forEach((row) => {
        const li = document.createElement('li');
        li.textContent = row;
        statsList.appendChild(li);
      });
    }

    function renderProfile(profile) {
      fullNameEl.textContent = profile.full_name || '‚Äî';
      usernameEl.textContent = profile.telegram_username ? `@${profile.telegram_username}` : '‚Äî';
      telegramIdEl.textContent = profile.telegram_id ?? '‚Äî';
      phoneEl.textContent = profile.phone || '‚Äî';
      createdAtEl.textContent = profile.created_at ? new Date(profile.created_at).toLocaleDateString('ru-RU') : '‚Äî';
      renderOrders(profile.orders || []);
      renderCourses(profile.courses || []);
      renderFavorites(profile.favorites || []);
      renderStats(profile.stats || {}, profile.ban || {});
      profileGrid.style.display = 'grid';
      actions?.style.setProperty('display', 'flex');
      editFullNameBtn.style.display = '';
      editPhoneBtn.style.display = '';
    }

    async function logout() {
      try {
        await fetch('/api/auth/logout', { method: 'POST' });
      } catch (e) {
        console.warn('Logout request failed', e);
      }

      if (isTelegramWebApp && window.Telegram?.WebApp?.close) {
        profileGrid?.style.setProperty('display', 'none');
        actions?.style.setProperty('display', 'none');
        setStatus('–í—ã –≤—ã—à–ª–∏. –ß—Ç–æ–±—ã –≤–æ–π—Ç–∏ –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º, –æ—Ç–∫—Ä–æ–π—Ç–µ WebApp –∑–∞–Ω–æ–≤–æ –∏–∑ –±–æ—Ç–∞.', false);
        setTimeout(() => window.Telegram.WebApp.close(), 200);
      } else {
        window.location.href = '/index.html';
      }
    }

    async function initProfile() {
      try {
        currentUser = await getCurrentUserProfile({ includeNotes: true });
        if (!currentUser) {
          showLoginHint('–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram.');
          return;
        }
        updateAdminLinkVisibility();
        loginHint?.style.setProperty('display', 'none');
        setStatus('');
        renderProfile(currentUser);
      } catch (e) {
        console.error(e);
        setStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å', true);
      }
    }

    switchUserBtn?.addEventListener('click', logout);
    editFullNameBtn?.addEventListener('click', () => startEditing('full_name'));
    editPhoneBtn?.addEventListener('click', () => startEditing('phone'));
    loginButton?.addEventListener('click', () => {
      window.location.href = '/index.html';
    });

    if (isTelegramWebApp && window.Telegram?.WebApp?.ready) {
      window.Telegram.WebApp.ready();
    }

    initProfile();
  </script>

</body>
</html>
