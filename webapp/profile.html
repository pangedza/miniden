<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MiniDeN — Профиль</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <link rel="icon" id="site-favicon" href="/favicon.ico" />
  <link rel="stylesheet" id="theme-stylesheet" href="css/theme.css" />
  <link rel="stylesheet" href="css/profile.css?v=20260124" />
  <link rel="stylesheet" href="css/support_widget.css?v=20250605" />
</head>
<body class="page-profile">
  <header class="top-nav">
    <div class="brand" data-branding-block>
      <div class="brand__logo-wrapper">
        <img data-branding-logo class="brand__logo" alt="Логотип MiniDeN" />
      </div>
      <div class="brand__text">
        <div class="brand__title" data-branding-title data-branding-default="MiniDeN">MiniDeN</div>
        <span data-branding-tagline>уютные корзинки и мастер-классы</span>
      </div>
    </div>
    <div class="header-actions">
      <div class="theme-switcher">
        <label for="theme-select">Тема</label>
        <select id="theme-select">
          <option value="lifestyle">Lifestyle</option>
          <option value="purple">Фиолетовая</option>
          <option value="dark">Тёмная</option>
          <option value="light">Светлая</option>
          <option value="cream">Сливочная</option>
        </select>
      </div>
      <button class="menu-toggle" aria-label="Открыть меню">☰</button>
    </div>
    <nav class="nav-links app-sidebar">
      <div class="sidebar-brand" data-branding-block>
        <div class="brand__logo-wrapper brand__logo-wrapper--sidebar">
          <img data-branding-logo class="brand__logo brand__logo--sidebar" alt="Логотип MiniDeN" />
        </div>
        <div class="brand__text">
          <strong data-branding-title data-branding-default="Miniden">Miniden</strong>
          <span data-branding-tagline>уют, семья, вязание</span>
        </div>
      </div>
      <a href="index.html">Главная</a>
      <a href="/categories">Категории</a>
      <a href="products.html">Товары</a>
      <a href="masterclasses.html">Мастер-классы</a>
      <a href="cart.html">Корзина</a>
      <a href="profile.html" class="active">Профиль</a>
      <a href="/adminsite" id="admin-link" style="display:none;">Админка</a>
    </nav>
  </header>

  <div class="app-sidebar-overlay"></div>
  <div id="toast-container"></div>

  <main class="profile-page">
    <div class="profile-container">
      <section id="auth-card" class="card profile-card profile-auth-card">
        <div class="card-title">Вход в профиль</div>
        <p class="hint">Введите телефон и одноразовый код из Telegram-бота MiniDeN.</p>
        <form id="login-form" class="profile-form" autocomplete="on">
          <label class="field">
            <span class="field-label">Телефон</span>
            <input
              id="login-phone"
              name="phone"
              type="tel"
              inputmode="tel"
              placeholder="+7 (999) 123-45-67"
              autocomplete="tel"
              required
            />
          </label>
          <label class="field">
            <span class="field-label">Код</span>
            <input
              id="login-code"
              name="code"
              type="text"
              inputmode="numeric"
              placeholder="123456"
              autocomplete="one-time-code"
              required
            />
          </label>
          <button id="login-submit" class="btn profile-button" type="submit">Войти</button>
          <div id="login-error" class="error-text" role="alert" aria-live="polite"></div>
        </form>
        <p class="hint hint-secondary">
          Как получить код: откройте бот MiniDeN, запросите вход и введите код здесь.
        </p>
      </section>

      <section id="profile-view" class="profile-view" style="display:none;">
        <section class="card profile-card profile-summary-card">
          <div class="profile-summary">
            <div>
              <div class="card-title">Профиль</div>
              <div id="profile-status" class="hint profile-status"></div>
            </div>
            <button id="logout-button" class="btn secondary profile-logout" type="button">Выйти</button>
          </div>
          <div class="profile-meta">
            <div class="profile-meta-row">
              <span class="label">Телефон</span>
              <span class="value" id="profile-phone">—</span>
            </div>
            <div class="profile-meta-row">
              <span class="label">Имя</span>
              <span class="value" id="profile-name">—</span>
            </div>
            <div class="profile-meta-row">
              <span class="label">Telegram</span>
              <span class="value" id="profile-telegram">—</span>
            </div>
          </div>
        </section>

        <section class="card profile-card">
          <div class="card-title">Адреса</div>
          <ul id="addresses-list" class="profile-list"></ul>
        </section>

        <section class="card profile-card">
          <div class="card-title">Заказы</div>
          <ul id="orders-list" class="profile-list"></ul>
        </section>

        <section class="card profile-card">
          <div class="card-title">Корзина</div>
          <ul id="cart-list" class="profile-list"></ul>
        </section>
      </section>
    </div>
  </main>

  <script src="js/app.js?v=20251218"></script>
  <script src="js/api.js?v=20250605"></script>
  <script src="js/app_shell.js?v=20251220"></script>
  <script>
    (function () {
      const ACCESS_TOKEN_KEY = 'access_token';
      const LEGACY_ACCESS_TOKEN_KEY = 'miniden_access_token';

      const apiTokenGet = typeof window.getToken === 'function' ? window.getToken.bind(window) : null;
      const apiTokenSet = typeof window.setToken === 'function' ? window.setToken.bind(window) : null;
      const apiTokenClear = typeof window.clearToken === 'function' ? window.clearToken.bind(window) : null;

      const auth = {
        getToken() {
          if (apiTokenGet) {
            return apiTokenGet() || '';
          }
          try {
            return localStorage.getItem(ACCESS_TOKEN_KEY) || '';
          } catch (error) {
            console.warn('Storage read failed', error);
            return '';
          }
        },
        setToken(token) {
          if (apiTokenSet) {
            apiTokenSet(token);
            return;
          }
          try {
            if (token) {
              localStorage.setItem(ACCESS_TOKEN_KEY, token);
            } else {
              localStorage.removeItem(ACCESS_TOKEN_KEY);
            }
          } catch (error) {
            console.warn('Storage write failed', error);
          }
        },
        clearToken() {
          if (apiTokenClear) {
            apiTokenClear();
            return;
          }
          try {
            localStorage.removeItem(ACCESS_TOKEN_KEY);
          } catch (error) {
            console.warn('Storage write failed', error);
          }
        },
        migrateLegacyToken() {
          const current = auth.getToken();
          if (current) return current;
          try {
            const legacyToken = localStorage.getItem(LEGACY_ACCESS_TOKEN_KEY) || '';
            if (!legacyToken) return '';
            auth.setToken(legacyToken);
            localStorage.removeItem(LEGACY_ACCESS_TOKEN_KEY);
            return legacyToken;
          } catch (error) {
            console.warn('Storage read failed', error);
            return '';
          }
        },
        hasToken() {
          return Boolean(auth.getToken());
        },
      };

      const authCard = document.getElementById('auth-card');
      const profileView = document.getElementById('profile-view');
      const loginForm = document.getElementById('login-form');
      const phoneInput = document.getElementById('login-phone');
      const codeInput = document.getElementById('login-code');
      const loginSubmit = document.getElementById('login-submit');
      const loginError = document.getElementById('login-error');
      const profileStatus = document.getElementById('profile-status');
      const logoutButton = document.getElementById('logout-button');
      const profilePhone = document.getElementById('profile-phone');
      const profileName = document.getElementById('profile-name');
      const profileTelegram = document.getElementById('profile-telegram');
      const addressesList = document.getElementById('addresses-list');
      const ordersList = document.getElementById('orders-list');
      const cartList = document.getElementById('cart-list');
      const adminLink = document.getElementById('admin-link');

      let currentUser = null;

    function showAuth(message = '') {
      authCard.style.display = 'block';
      profileView.style.display = 'none';
      loginError.textContent = message;
      loginError.style.display = message ? 'block' : 'none';
      profileStatus.textContent = '';
      currentUser = null;
      updateAdminLinkVisibility();
    }

    function showProfile() {
      authCard.style.display = 'none';
      profileView.style.display = 'grid';
      loginError.textContent = '';
      loginError.style.display = 'none';
    }

    function updateAdminLinkVisibility() {
      if (!adminLink) return;
      adminLink.style.display = currentUser?.is_admin ? '' : 'none';
    }

    function setProfileStatus(message, isError = false) {
      profileStatus.textContent = message || '';
      profileStatus.classList.toggle('is-error', Boolean(message) && isError);
    }

    async function apiFetch(path, options = {}) {
      const token = auth.getToken();
      const headers = new Headers(options.headers || {});

      if (token) {
        headers.set('Authorization', `Bearer ${token}`);
      }

      if (options.body && !(options.body instanceof FormData) && !headers.has('Content-Type')) {
        headers.set('Content-Type', 'application/json');
      }

      const response = await fetch(path, {
        ...options,
        headers,
        credentials: options.credentials || 'same-origin',
      });

      if (response.status === 204) return null;

      const contentType = response.headers.get('content-type') || '';
      const isJson = contentType.includes('application/json');
      const payload = isJson ? await response.json().catch(() => null) : await response.text();

      if (!response.ok) {
        const detail = isJson ? payload?.detail || payload?.message : payload;
        const error = new Error(detail || `Ошибка ${response.status}`);
        error.status = response.status;
        error.payload = payload;
        throw error;
      }

      return payload;
    }

    function renderProfile(user) {
      const phone = user?.phone || user?.phone_number || user?.login || '—';
      const name = user?.full_name || user?.name || user?.first_name || 'Гость MiniDeN';
      const telegram = user?.telegram_username ? `@${user.telegram_username}` : 'не привязан';

      profilePhone.textContent = phone;
      profileName.textContent = name;
      profileTelegram.textContent = telegram;
      updateAdminLinkVisibility();
    }

    function renderSectionMessage(target, message, cssClass = 'profile-empty') {
      if (!target) return;
      const li = document.createElement('li');
      li.className = cssClass;
      li.textContent = message;
      target.replaceChildren(li);
    }

    function normalizeListPayload(payload, keys = []) {
      if (Array.isArray(payload)) return payload;
      for (const key of keys) {
        if (Array.isArray(payload?.[key])) {
          return payload[key];
        }
      }
      if (Array.isArray(payload?.items)) return payload.items;
      if (Array.isArray(payload?.data)) return payload.data;
      return [];
    }

    function renderList(target, items, renderer, emptyMessage) {
      if (!target) return;
      if (!items.length) {
        renderSectionMessage(target, emptyMessage);
        return;
      }
      const fragment = document.createDocumentFragment();
      items.forEach((item) => {
        const node = renderer(item);
        if (node) fragment.appendChild(node);
      });
      target.replaceChildren(fragment);
    }

    function handleSectionError(error, target, fallbackMessage) {
      if (!error) return false;
      if (error.status === 401) {
        auth.clearToken();
        showAuth('Сессия истекла. Введите телефон и код ещё раз.');
        return true;
      }
      if (error.status === 404 || error.status === 405) {
        renderSectionMessage(target, 'Раздел пока не подключён');
        return true;
      }
      renderSectionMessage(target, fallbackMessage, 'profile-empty profile-empty--error');
      return false;
    }

    function renderAddressItem(address) {
      const li = document.createElement('li');
      const title = address?.title || address?.label || 'Адрес';
      const text = address?.address || address?.full_address || address?.line || 'Адрес скоро появится';

      const titleEl = document.createElement('div');
      titleEl.className = 'profile-item-title';
      titleEl.textContent = title;

      const textEl = document.createElement('div');
      textEl.className = 'profile-item-text';
      textEl.textContent = text;

      li.appendChild(titleEl);
      li.appendChild(textEl);
      return li;
    }

    function renderOrderItem(order) {
      const li = document.createElement('li');
      const number = order?.number || order?.id || '—';
      const status = order?.status || order?.state || 'в обработке';
      const total = order?.total || order?.amount || order?.sum;
      const totalText = Number.isFinite(total) ? `${total} ₽` : total ? `${total} ₽` : 'сумма уточняется';

      const titleEl = document.createElement('div');
      titleEl.className = 'profile-item-title';
      titleEl.textContent = `Заказ №${number}`;

      const metaEl = document.createElement('div');
      metaEl.className = 'profile-item-text';
      metaEl.textContent = `Статус: ${status} • ${totalText}`;

      li.appendChild(titleEl);
      li.appendChild(metaEl);
      return li;
    }

    function renderCartItem(item) {
      const li = document.createElement('li');
      const title = item?.title || item?.name || item?.product_name || 'Товар';
      const qty = item?.qty || item?.quantity ?? 1;
      const price = item?.price ?? item?.unit_price;
      const total = Number.isFinite(price) ? `${price} ₽` : 'цена уточняется';

      const titleEl = document.createElement('div');
      titleEl.className = 'profile-item-title';
      titleEl.textContent = title;

      const metaEl = document.createElement('div');
      metaEl.className = 'profile-item-text';
      metaEl.textContent = `Количество: ${qty} • ${total}`;

      li.appendChild(titleEl);
      li.appendChild(metaEl);
      return li;
    }

    async function loadAddresses() {
      renderSectionMessage(addressesList, 'Загрузка адресов…');
      try {
        const data = await apiFetch('/api/me/addresses');
        const addresses = normalizeListPayload(data, ['addresses', 'items', 'data']);
        renderList(addressesList, addresses, renderAddressItem, 'Пока нет адресов');
      } catch (error) {
        const handled = handleSectionError(error, addressesList, 'Не удалось загрузить адреса');
        if (!handled) {
          console.warn('Не удалось загрузить адреса', error);
        }
      }
    }

    async function loadOrders() {
      renderSectionMessage(ordersList, 'Загрузка заказов…');
      try {
        const data = await apiFetch('/api/me/orders');
        const orders = normalizeListPayload(data, ['orders', 'items', 'data']);
        renderList(ordersList, orders, renderOrderItem, 'Пока нет заказов');
      } catch (error) {
        const handled = handleSectionError(error, ordersList, 'Не удалось загрузить заказы');
        if (!handled) {
          console.warn('Не удалось загрузить заказы', error);
        }
      }
    }

    async function loadCart() {
      renderSectionMessage(cartList, 'Загрузка корзины…');
      try {
        const data = await apiFetch('/api/me/cart');
        const cartItems = normalizeListPayload(data, ['items', 'cart_items', 'data']);
        renderList(cartList, cartItems, renderCartItem, 'Корзина пуста');
      } catch (error) {
        const handled = handleSectionError(error, cartList, 'Не удалось загрузить корзину');
        if (!handled) {
          console.warn('Не удалось загрузить корзину', error);
        }
      }
    }

    async function loadProfile() {
      try {
        const user = await apiFetch('/api/me');
        currentUser = user?.user || user;
        if (!currentUser) {
          throw new Error('Профиль не найден');
        }
        renderProfile(currentUser);
        showProfile();
        setProfileStatus('Данные профиля обновлены.');
        await Promise.all([loadAddresses(), loadOrders(), loadCart()]);
      } catch (error) {
        console.warn('Не удалось загрузить профиль', error);
        if (error.status === 401) {
          auth.clearToken();
          showAuth('Сессия истекла. Введите телефон и код ещё раз.');
          return;
        }
        showAuth(error.message || 'Не удалось загрузить профиль');
      }
    }

    async function verifyCode(phone, code) {
      const data = await apiFetch('/api/auth/verify-code', {
        method: 'POST',
        body: JSON.stringify({ phone, code }),
      });
      const token = data?.access_token || data?.token;
      if (!token) {
        throw new Error('Сервер не вернул токен');
      }
      auth.setToken(token);
      return token;
    }

    async function attemptAutoLoginFromQuery() {
      const params = new URLSearchParams(window.location.search);
      const phone = (params.get('phone') || '').trim();
      const code = (params.get('code') || '').trim();
      if (!phone || !code) return false;

      params.delete('phone');
      params.delete('code');
      const nextQuery = params.toString();
      const nextUrl = `${window.location.pathname}${nextQuery ? `?${nextQuery}` : ''}${window.location.hash}`;
      window.history.replaceState({}, document.title, nextUrl);

      phoneInput.value = phone;
      codeInput.value = code;
      loginError.textContent = '';
      loginError.style.display = 'none';
      setProfileStatus('Подтверждаем вход…');

      loginSubmit.disabled = true;
      loginSubmit.textContent = 'Входим…';

      try {
        await verifyCode(phone, code);
        codeInput.value = '';
        await loadProfile();
        return true;
      } catch (error) {
        console.warn('Автовход не выполнен', error);
        showAuth(error.message || 'Не удалось выполнить вход по ссылке');
        return false;
      } finally {
        loginSubmit.disabled = false;
        loginSubmit.textContent = 'Войти';
      }
    }

    loginForm?.addEventListener('submit', async (event) => {
      event.preventDefault();
      const phone = (phoneInput.value || '').trim();
      const code = (codeInput.value || '').trim();

      if (!phone || !code) {
        showAuth('Введите телефон и код.');
        return;
      }

      loginSubmit.disabled = true;
      loginSubmit.textContent = 'Входим…';
      loginError.textContent = '';
      loginError.style.display = 'none';
      setProfileStatus('Подтверждаем вход…');

      try {
        await verifyCode(phone, code);
        codeInput.value = '';
        await loadProfile();
      } catch (error) {
        console.warn('Ошибка входа', error);
        showAuth(error.message || 'Не удалось выполнить вход');
      } finally {
        loginSubmit.disabled = false;
        loginSubmit.textContent = 'Войти';
      }
    });

    logoutButton?.addEventListener('click', () => {
      auth.clearToken();
      showAuth('Вы вышли из профиля.');
      phoneInput.focus();
    });

    document.addEventListener('DOMContentLoaded', async () => {
      auth.migrateLegacyToken();

      const autoLoggedIn = await attemptAutoLoginFromQuery();
      if (autoLoggedIn) return;

      if (!auth.hasToken()) {
        showAuth('');
        phoneInput.focus();
        return;
      }

      setProfileStatus('Загружаем профиль…');
      await loadProfile();
    });
  })();
</script>
  <script src="js/support_widget.js?v=20250605" defer></script>
</body>
</html>
