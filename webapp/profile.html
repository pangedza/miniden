<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MiniDeN ‚Äî –ü—Ä–æ—Ñ–∏–ª—å</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="css/theme.css?v=20241215" />

</head>
<body data-theme="purple" class="page-profile">
  <header class="top-nav">
    <div class="brand">MiniDeN<span>—É—é—Ç–Ω—ã–µ –∫–æ—Ä–∑–∏–Ω–∫–∏ –∏ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã</span></div>
    <div class="header-actions">
      <div class="theme-switcher">
        <label for="theme-select">–¢–µ–º–∞</label>
        <select id="theme-select">
          <option value="purple">–§–∏–æ–ª–µ—Ç–æ–≤–∞—è</option>
          <option value="dark">–¢—ë–º–Ω–∞—è</option>
          <option value="light">–°–≤–µ—Ç–ª–∞—è</option>
        </select>
      </div>
      <button class="menu-toggle" aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é">‚ò∞</button>
    </div>
    <nav class="nav-links app-sidebar">
      <a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
      <a href="products.html">–¢–æ–≤–∞—Ä—ã</a>
      <a href="masterclasses.html">–ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã</a>
      <a href="cart.html">–ö–æ—Ä–∑–∏–Ω–∞</a>
      <a href="profile.html" class="active">–ü—Ä–æ—Ñ–∏–ª—å</a>
      <a href="admin.html" id="admin-link" style="display:none;">–ê–¥–º–∏–Ω–∫–∞</a>
    </nav>
  </header>

  <div class="app-sidebar-overlay"></div>
  <div id="toast-container"></div>

  <main>
    <h1>–ü—Ä–æ—Ñ–∏–ª—å</h1>
    <p>–î–∞–Ω–Ω—ã–µ –±–µ—Ä—É—Ç—Å—è –∏–∑ –≤–∞—à–µ–≥–æ Telegram-–ø—Ä–æ—Ñ–∏–ª—è MiniDeN –∏ –∑–∞–∫–∞–∑–æ–≤.</p>

    <div id="status" class="message" style="display:none"></div>

    <div class="profile-avatar-wrapper" id="profile-avatar-wrapper" style="display:none;">
      <div id="profile-avatar" class="profile-avatar">
        <span id="profile-avatar-initials" class="profile-avatar-initials"></span>
      </div>
      <div class="profile-avatar-edit-row">
        <input type="text" id="profile-avatar-url-input" placeholder="/media/users/&lt;tg_id&gt;/avatar.jpg">
        <button id="profile-avatar-url-save-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</button>
      </div>
    </div>

    <div class="grid" id="profile-grid" style="display:none">
      <div class="card">
        <div class="label">–ò–º—è</div>
        <div class="value editable"><span id="full-name">‚Äî</span><button class="edit-btn" id="edit-full-name" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–º—è">‚úèÔ∏è</button></div>
        <div class="label" style="margin-top: 12px;">Telegram</div>
        <div class="value" id="username">‚Äî</div>
        <div class="label" style="margin-top: 12px;">Telegram ID</div>
        <div class="value" id="telegram-id">‚Äî</div>
        <div class="label" style="margin-top: 12px;">–¢–µ–ª–µ—Ñ–æ–Ω</div>
        <div class="value editable"><span id="phone">‚Äî</span><button class="edit-btn" id="edit-phone" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω">‚úèÔ∏è</button></div>
        <div class="label" style="margin-top: 12px;">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</div>
        <div class="value" id="created-at">‚Äî</div>
      </div>

      <div class="card">
        <div class="label">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</div>
        <ul class="list" id="orders-list"></ul>
      </div>

      <div class="card">
        <div class="label">–ú–æ–∏ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã</div>
        <ul class="list" id="courses-list"></ul>
      </div>

      <div class="card">
        <div class="label">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</div>
        <ul class="list" id="favorites-list"></ul>
      </div>

      <div class="card">
        <div class="label">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
        <ul class="list" id="stats-list"></ul>
      </div>
    </div>
  </main>

  <section class="section" id="login-hint" style="display: none; text-align: center;">
    <h2>–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã</h2>
    <p>–ü—Ä–æ—Ñ–∏–ª—å, –∑–∞–∫–∞–∑—ã –∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Telegram. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ <a href="index.html">–≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É</a>, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Ö–æ–¥ –∏ –≤–µ—Ä–Ω–∏—Ç–µ—Å—å —Å—é–¥–∞.</p>
    <button class="btn" id="login-button" type="button">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram</button>
  </section>

  <div id="profile-actions" style="display: none; gap: 10px; margin-top: 16px;">
    <button class="btn secondary" id="switch-user-btn" type="button">–°–º–µ–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
    <a class="btn" href="products.html">–ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥</a>
  </div>

  <script src="js/app.js?v=20241215"></script>
  <script src="js/api.js?v=20241215"></script>
  <script>
    const statusEl = document.getElementById('status');
    const loginHint = document.getElementById('login-hint');
    const profileGrid = document.getElementById('profile-grid');
    const profileAvatarWrapper = document.getElementById('profile-avatar-wrapper');
    const avatarDiv = document.getElementById('profile-avatar');
    const avatarInitialsSpan = document.getElementById('profile-avatar-initials');
    const avatarUrlInput = document.getElementById('profile-avatar-url-input');
    const avatarSaveBtn = document.getElementById('profile-avatar-url-save-btn');
    const fullNameEl = document.getElementById('full-name');
    const usernameEl = document.getElementById('username');
    const telegramIdEl = document.getElementById('telegram-id');
    const phoneEl = document.getElementById('phone');
    const createdAtEl = document.getElementById('created-at');
    const ordersList = document.getElementById('orders-list');
    const coursesList = document.getElementById('courses-list');
    const favoritesList = document.getElementById('favorites-list');
    const statsList = document.getElementById('stats-list');
    const adminLink = document.getElementById('admin-link');
    const actions = document.getElementById('profile-actions');
    const switchUserBtn = document.getElementById('switch-user-btn');
    const loginButton = document.getElementById('login-button');
    const editFullNameBtn = document.getElementById('edit-full-name');
    const editPhoneBtn = document.getElementById('edit-phone');

    let currentUser = null;
    const isTelegramWebApp = Boolean(window.Telegram?.WebApp);

    function updateAdminLinkVisibility() {
      if (!adminLink) return;
      adminLink.style.display = currentUser?.is_admin ? '' : 'none';
    }

    function setStatus(message, isError = false) {
      if (!message) {
        statusEl.style.display = 'none';
        statusEl.textContent = '';
        statusEl.classList.remove('error');
        return;
      }
      statusEl.textContent = message;
      statusEl.classList.toggle('error', isError);
      statusEl.style.display = 'block';
    }

    function showLoginHint(message) {
      if (loginHint) {
        loginHint.style.display = 'block';
      }
      setStatus(message, true);
      actions?.style.setProperty('display', 'none');
      profileGrid?.style.setProperty('display', 'none');
    }

    async function saveProfileUpdates(updates) {
      const res = await fetch('/api/profile/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updates || {}),
      });

      if (!res.ok) {
        const errorData = await res.json().catch(() => ({}));
        const message = errorData?.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
        const err = new Error(message);
        err.status = res.status;
        throw err;
      }

      const data = await res.json();
      if (!data?.ok || !data.user) {
        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è');
      }
      currentUser = data.user;
      return currentUser;
    }

    function startEditing(field) {
      if (!currentUser) return;
      const valueEl = field === 'full_name' ? fullNameEl : phoneEl;
      const container = valueEl?.parentElement;
      const editBtn = field === 'full_name' ? editFullNameBtn : editPhoneBtn;
      if (!valueEl || !container || !editBtn) return;

      const currentValue = field === 'full_name' ? (currentUser.full_name || '') : (currentUser.phone || '');
      const input = document.createElement('input');
      input.type = 'text';
      input.value = currentValue;
      input.className = 'edit-input';

      const saveBtn = document.createElement('button');
      saveBtn.type = 'button';
      saveBtn.className = 'edit-save';
      saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';

      container.replaceChild(input, valueEl);
      editBtn.style.display = 'none';
      container.insertBefore(saveBtn, editBtn);

      saveBtn.addEventListener('click', async () => {
        try {
          const updates = field === 'full_name' ? { full_name: input.value } : { phone: input.value };
          const updated = await saveProfileUpdates(updates);
          container.replaceChild(valueEl, input);
          if (saveBtn.parentElement === container) container.removeChild(saveBtn);
          editBtn.style.display = '';
          renderProfile(updated);
        } catch (e) {
          showToast(e?.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è');
          container.replaceChild(valueEl, input);
          if (saveBtn.parentElement === container) container.removeChild(saveBtn);
          editBtn.style.display = '';
          renderProfile(currentUser);
        }
      });
    }

    function renderOrders(orders) {
      ordersList.innerHTML = '';
      if (!orders || !orders.length) {
        const li = document.createElement('li');
        li.textContent = '–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç';
        ordersList.appendChild(li);
        return;
      }

      orders.forEach((order) => {
        const li = document.createElement('li');
        const dateText = order.created_at ? new Date(order.created_at).toLocaleString('ru-RU') : '';
        const header = document.createElement('div');
        header.textContent = `–ó–∞–∫–∞–∑ #${order.id} ‚Äî ${order.total} ‚ÇΩ (${order.status || '–≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ'}) ${dateText ? '‚Ä¢ ' + dateText : ''}`;
        const list = document.createElement('ul');
        list.className = 'list';

        (order.items || []).forEach((item) => {
          const itemLi = document.createElement('li');
          const prefix = item.type === 'course' ? 'üéì' : 'üß∫';
          const baseText = `${prefix} ${item.name || '–¢–æ–≤–∞—Ä'} ‚Äî ${item.qty} √ó ${item.price ?? 0} ‚ÇΩ`;
          if (item.type === 'course') {
            if ((order.status || '').toLowerCase() !== 'paid') {
              itemLi.textContent = `${baseText} ‚Ä¢ –°—Å—ã–ª–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã`;
            } else {
              itemLi.textContent = `${baseText} ‚Ä¢ –î–æ—Å—Ç—É–ø –æ—Ç–∫—Ä—ã—Ç –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–ú–æ–∏ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã¬ª`;
            }
          } else {
            itemLi.textContent = baseText;
          }
          list.appendChild(itemLi);
        });

        li.appendChild(header);
        if (list.childElementCount > 0) {
          li.appendChild(list);
        }
        ordersList.appendChild(li);
      });
    }

    function renderCourses(courses) {
      coursesList.innerHTML = '';
      if (!courses || !courses.length) {
        const li = document.createElement('li');
        li.textContent = '–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å–æ–≤';
        coursesList.appendChild(li);
        return;
      }

      courses.forEach((course) => {
        const li = document.createElement('li');
        const statusText = course.is_paid ? '–û–ø–ª–∞—á–µ–Ω' : '–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π';
        const linkText = course.masterclass_url
          ? ` ‚Äî <a href="${course.masterclass_url}" target="_blank">–ü–µ—Ä–µ–π—Ç–∏</a>`
          : '';
        li.innerHTML = `üéì ${course.name || '–ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å'} ‚Ä¢ ${statusText}${linkText}`;
        coursesList.appendChild(li);
      });
    }

    function renderFavorites(favorites) {
      favoritesList.innerHTML = '';
      if (!favorites || !favorites.length) {
        const li = document.createElement('li');
        li.textContent = '–ò–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç';
        favoritesList.appendChild(li);
        return;
      }

      favorites.forEach((fav) => {
        const li = document.createElement('li');
        const prefix = fav.type === 'course' ? 'üéì' : 'üß∫';
        li.textContent = `${prefix} ${fav.name || '–¢–æ–≤–∞—Ä'} ‚Äî ${fav.price ?? 0} ‚ÇΩ`;
        favoritesList.appendChild(li);
      });
    }

    function renderStats(stats, ban) {
      statsList.innerHTML = '';
      const rows = [
        `–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤: ${stats?.orders_count ?? 0}`,
        `–ü–æ—Ç—Ä–∞—á–µ–Ω–æ: ${stats?.total_spent ?? 0} ‚ÇΩ`,
        stats?.last_order_at ? `–ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–∫–∞–∑: ${new Date(stats.last_order_at).toLocaleString('ru-RU')}` : null,
        ban?.is_banned ? `–°—Ç–∞—Ç—É—Å: –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω (${ban.ban_reason || '–±–µ–∑ –ø—Ä–∏—á–∏–Ω—ã'})` : '–°—Ç–∞—Ç—É—Å: –∞–∫—Ç–∏–≤–µ–Ω',
      ].filter(Boolean);

      rows.forEach((row) => {
        const li = document.createElement('li');
        li.textContent = row;
        statsList.appendChild(li);
      });
    }

    function updateAvatar(profile) {
      if (avatarUrlInput) {
        avatarUrlInput.value = profile.avatar_url || '';
      }

      if (avatarDiv) {
        if (profile.avatar_url) {
          avatarDiv.style.backgroundImage = `url(${profile.avatar_url})`;
        } else {
          avatarDiv.style.backgroundImage = 'none';
        }
      }

      if (avatarInitialsSpan) {
        let initials = '';
        if (profile.full_name) {
          const parts = profile.full_name.trim().split(' ');
          if (parts.length >= 2) {
            initials = (parts[0][0] + parts[1][0]).toUpperCase();
          } else {
            initials = parts[0][0].toUpperCase();
          }
        } else if (profile.username) {
          initials = profile.username[0].toUpperCase();
        } else {
          initials = 'üôÇ';
        }
        avatarInitialsSpan.textContent = initials;
      }

      if (profileAvatarWrapper) {
        profileAvatarWrapper.style.display = 'flex';
      }
    }

    async function saveAvatarUrl() {
      if (!avatarUrlInput) return;
      const avatarUrl = avatarUrlInput.value.trim();
      if (!avatarUrl) {
        showToast('–í–≤–µ–¥–∏—Ç–µ URL –∞–≤–∞—Ç–∞—Ä–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä /media/users/<tg_id>/avatar.jpg');
        return;
      }

      try {
        const res = await fetch('/api/profile/avatar-url', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ avatar_url: avatarUrl }),
        });
        const data = await res.json();
        if (!data.ok) {
          showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä');
          return;
        }
        currentUser = data.profile || currentUser;
        updateAvatar(currentUser);
        showToast('–ê–≤–∞—Ç–∞—Ä —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
      } catch (e) {
        console.error(e);
        showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∞–≤–∞—Ç–∞—Ä–∞');
      }
    }

    function renderProfile(profile) {
      fullNameEl.textContent = profile.full_name || '‚Äî';
      usernameEl.textContent = profile.telegram_username ? `@${profile.telegram_username}` : '‚Äî';
      telegramIdEl.textContent = profile.telegram_id ?? '‚Äî';
      phoneEl.textContent = profile.phone || '‚Äî';
      createdAtEl.textContent = profile.created_at ? new Date(profile.created_at).toLocaleDateString('ru-RU') : '‚Äî';
      updateAvatar(profile);
      renderOrders(profile.orders || []);
      renderCourses(profile.courses || []);
      renderFavorites(profile.favorites || []);
      renderStats(profile.stats || {}, profile.ban || {});
      profileGrid.style.display = 'grid';
      actions?.style.setProperty('display', 'flex');
      editFullNameBtn.style.display = '';
      editPhoneBtn.style.display = '';
    }

    async function logout() {
      try {
        await fetch('/api/auth/logout', { method: 'POST' });
      } catch (e) {
        console.warn('Logout request failed', e);
      }

      if (isTelegramWebApp && window.Telegram?.WebApp?.close) {
        profileGrid?.style.setProperty('display', 'none');
        actions?.style.setProperty('display', 'none');
        setStatus('–í—ã –≤—ã—à–ª–∏. –ß—Ç–æ–±—ã –≤–æ–π—Ç–∏ –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º, –æ—Ç–∫—Ä–æ–π—Ç–µ WebApp –∑–∞–Ω–æ–≤–æ –∏–∑ –±–æ—Ç–∞.', false);
        setTimeout(() => window.Telegram.WebApp.close(), 200);
      } else {
        window.location.href = '/index.html';
      }
    }

    async function initProfile() {
      try {
        currentUser = await getCurrentUserProfile({ includeNotes: true });
        if (!currentUser) {
          showLoginHint('–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram.');
          return;
        }
        updateAdminLinkVisibility();
        loginHint?.style.setProperty('display', 'none');
        setStatus('');
        renderProfile(currentUser);
      } catch (e) {
        console.error(e);
        setStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å', true);
      }
    }

    switchUserBtn?.addEventListener('click', logout);
    editFullNameBtn?.addEventListener('click', () => startEditing('full_name'));
    editPhoneBtn?.addEventListener('click', () => startEditing('phone'));
    avatarSaveBtn?.addEventListener('click', saveAvatarUrl);
    loginButton?.addEventListener('click', () => {
      window.location.href = '/index.html';
    });

    if (isTelegramWebApp && window.Telegram?.WebApp?.ready) {
      window.Telegram.WebApp.ready();
    }

    initProfile();
  </script>

</body>
</html>
