<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MiniDeN — Профиль</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <link rel="icon" id="site-favicon" href="/favicon.ico" />
  <link rel="stylesheet" id="theme-stylesheet" href="css/theme.css" />
  <link rel="stylesheet" href="css/support_widget.css?v=20250605" />
</head>
<body class="page-profile">
  <header class="top-nav">
    <div class="brand" data-branding-block>
      <div class="brand__logo-wrapper">
        <img data-branding-logo class="brand__logo" alt="Логотип MiniDeN" />
      </div>
      <div class="brand__text">
        <div class="brand__title" data-branding-title data-branding-default="MiniDeN">MiniDeN</div>
        <span data-branding-tagline>уютные корзинки и мастер-классы</span>
      </div>
    </div>
    <div class="header-actions">
      <div class="theme-switcher">
        <label for="theme-select">Тема</label>
        <select id="theme-select">
          <option value="lifestyle">Lifestyle</option>
          <option value="purple">Фиолетовая</option>
          <option value="dark">Тёмная</option>
          <option value="light">Светлая</option>
          <option value="cream">Сливочная</option>
        </select>
      </div>
      <button class="menu-toggle" aria-label="Открыть меню">☰</button>
    </div>
    <nav class="nav-links app-sidebar">
      <div class="sidebar-brand" data-branding-block>
        <div class="brand__logo-wrapper brand__logo-wrapper--sidebar">
          <img data-branding-logo class="brand__logo brand__logo--sidebar" alt="Логотип MiniDeN" />
        </div>
        <div class="brand__text">
          <strong data-branding-title data-branding-default="Miniden">Miniden</strong>
          <span data-branding-tagline>уют, семья, вязание</span>
        </div>
      </div>
      <a href="index.html">Главная</a>
      <a href="/categories">Категории</a>
      <a href="products.html">Товары</a>
      <a href="masterclasses.html">Мастер-классы</a>
      <a href="cart.html">Корзина</a>
      <a href="profile.html" class="active">Профиль</a>
      <a href="/adminsite" id="admin-link" style="display:none;">Админка</a>
    </nav>
  </header>

  <div class="app-sidebar-overlay"></div>
  <div id="toast-container"></div>

  <main class="profile-page">
    <div class="profile-container">
      <section id="auth-card" class="card profile-card profile-auth-card">
        <div class="card-title">Вход в профиль</div>
        <p class="hint">Введите телефон и одноразовый код из Telegram-бота MiniDeN.</p>
        <form id="login-form" class="profile-form" autocomplete="on">
          <label class="field">
            <span class="field-label">Телефон</span>
            <input
              id="login-phone"
              name="phone"
              type="tel"
              inputmode="tel"
              placeholder="+7 (999) 123-45-67"
              autocomplete="tel"
              required
            />
          </label>
          <label class="field">
            <span class="field-label">Код</span>
            <input
              id="login-code"
              name="code"
              type="text"
              inputmode="numeric"
              placeholder="123456"
              autocomplete="one-time-code"
              required
            />
          </label>
          <button id="login-submit" class="btn profile-button" type="submit">Войти</button>
          <div id="login-error" class="error-text" role="alert" aria-live="polite"></div>
        </form>
        <p class="hint hint-secondary">
          Как получить код: откройте бот MiniDeN, запросите вход и введите код здесь.
        </p>
      </section>

      <section id="profile-view" class="profile-view" style="display:none;">
        <section class="card profile-card profile-summary-card">
          <div class="profile-summary">
            <div>
              <div class="card-title">Профиль</div>
              <div id="profile-status" class="hint profile-status"></div>
            </div>
            <button id="logout-button" class="btn secondary profile-logout" type="button">Выйти</button>
          </div>
          <div class="profile-meta">
            <div class="profile-meta-row">
              <span class="label">Телефон</span>
              <span class="value" id="profile-phone">—</span>
            </div>
            <div class="profile-meta-row">
              <span class="label">Имя</span>
              <span class="value" id="profile-name">—</span>
            </div>
            <div class="profile-meta-row">
              <span class="label">Telegram</span>
              <span class="value" id="profile-telegram">—</span>
            </div>
          </div>
        </section>

        <section class="card profile-card">
          <div class="card-title">Адреса</div>
          <ul id="addresses-list" class="profile-list"></ul>
        </section>

        <section class="card profile-card">
          <div class="card-title">Заказы</div>
          <ul id="orders-list" class="profile-list"></ul>
        </section>

        <section class="card profile-card">
          <div class="card-title">Корзина</div>
          <ul id="cart-list" class="profile-list"></ul>
        </section>
      </section>
    </div>
  </main>

  <script src="js/app.js?v=20251218"></script>
  <script src="js/api.js?v=20250605"></script>
  <script src="js/app_shell.js?v=20251220"></script>
  <script>
    const ACCESS_TOKEN_KEY = 'access_token';

    const authCard = document.getElementById('auth-card');
    const profileView = document.getElementById('profile-view');
    const loginForm = document.getElementById('login-form');
    const phoneInput = document.getElementById('login-phone');
    const codeInput = document.getElementById('login-code');
    const loginSubmit = document.getElementById('login-submit');
    const loginError = document.getElementById('login-error');
    const profileStatus = document.getElementById('profile-status');
    const logoutButton = document.getElementById('logout-button');
    const profilePhone = document.getElementById('profile-phone');
    const profileName = document.getElementById('profile-name');
    const profileTelegram = document.getElementById('profile-telegram');
    const addressesList = document.getElementById('addresses-list');
    const ordersList = document.getElementById('orders-list');
    const cartList = document.getElementById('cart-list');
    const adminLink = document.getElementById('admin-link');

    let currentUser = null;

    function getToken() {
      return localStorage.getItem(ACCESS_TOKEN_KEY) || '';
    }

    function setToken(token) {
      localStorage.setItem(ACCESS_TOKEN_KEY, token);
    }

    function clearToken() {
      localStorage.removeItem(ACCESS_TOKEN_KEY);
    }

    function showAuth(message = '') {
      authCard.style.display = 'block';
      profileView.style.display = 'none';
      loginError.textContent = message;
      loginError.style.display = message ? 'block' : 'none';
      profileStatus.textContent = '';
      currentUser = null;
      updateAdminLinkVisibility();
    }

    function showProfile() {
      authCard.style.display = 'none';
      profileView.style.display = 'grid';
      loginError.textContent = '';
      loginError.style.display = 'none';
    }

    function updateAdminLinkVisibility() {
      if (!adminLink) return;
      adminLink.style.display = currentUser?.is_admin ? '' : 'none';
    }

    function setProfileStatus(message, isError = false) {
      profileStatus.textContent = message || '';
      profileStatus.classList.toggle('is-error', Boolean(message) && isError);
    }

    async function apiFetch(path, options = {}) {
      const token = getToken();
      const headers = new Headers(options.headers || {});

      if (token) {
        headers.set('Authorization', `Bearer ${token}`);
      }

      if (options.body && !(options.body instanceof FormData) && !headers.has('Content-Type')) {
        headers.set('Content-Type', 'application/json');
      }

      const response = await fetch(path, {
        ...options,
        headers,
      });

      const text = await response.text();
      let data = null;
      if (text) {
        try {
          data = JSON.parse(text);
        } catch (error) {
          data = null;
        }
      }

      if (!response.ok) {
        const error = new Error(data?.detail || data?.message || `Ошибка ${response.status}`);
        error.status = response.status;
        error.payload = data;
        throw error;
      }

      return data;
    }

    function normalizeListPayload(payload, keys) {
      if (Array.isArray(payload)) return payload;
      for (const key of keys) {
        if (Array.isArray(payload?.[key])) {
          return payload[key];
        }
      }
      return [];
    }

    function renderList(listEl, items, renderItem, emptyMessage) {
      listEl.innerHTML = '';
      const safeItems = Array.isArray(items) ? items : [];

      if (!safeItems.length) {
        const emptyLi = document.createElement('li');
        emptyLi.className = 'profile-empty';
        emptyLi.textContent = emptyMessage;
        listEl.appendChild(emptyLi);
        return;
      }

      safeItems.forEach((item) => {
        const li = renderItem(item);
        if (li) listEl.appendChild(li);
      });
    }

    function renderProfile(user) {
      profilePhone.textContent = user?.phone || '—';
      profileName.textContent = user?.name || user?.full_name || '—';
      profileTelegram.textContent = user?.telegram_username ? `@${user.telegram_username}` : 'не указан';
      updateAdminLinkVisibility();
    }

    function renderAddressItem(address) {
      const li = document.createElement('li');
      const title = address?.label || address?.title || address?.name || 'Адрес';
      const line =
        address?.address ||
        address?.full_address ||
        address?.line1 ||
        [address?.street, address?.city].filter(Boolean).join(', ');

      const titleEl = document.createElement('div');
      titleEl.className = 'profile-item-title';
      titleEl.textContent = title;

      const lineEl = document.createElement('div');
      lineEl.className = 'profile-item-text';
      lineEl.textContent = line || 'Адрес будет доступен после добавления.';

      li.appendChild(titleEl);
      li.appendChild(lineEl);
      return li;
    }

    function renderOrderItem(order) {
      const li = document.createElement('li');
      const createdAt = order?.created_at ? new Date(order.created_at).toLocaleString('ru-RU') : '';
      const header = document.createElement('div');
      header.className = 'profile-item-title';
      header.textContent = `Заказ #${order?.id ?? '—'}`;

      const meta = document.createElement('div');
      meta.className = 'profile-item-text';
      const parts = [
        order?.status ? `Статус: ${order.status}` : null,
        Number.isFinite(order?.total) ? `Сумма: ${order.total} ₽` : null,
        createdAt || null,
      ].filter(Boolean);
      meta.textContent = parts.join(' • ') || 'Детали заказа появятся после оформления.';

      li.appendChild(header);
      li.appendChild(meta);
      return li;
    }

    function renderCartItem(item) {
      const li = document.createElement('li');
      const title = item?.name || item?.title || 'Позиция';
      const qty = item?.qty ?? item?.quantity ?? 1;
      const price = item?.price ?? item?.unit_price;
      const total = Number.isFinite(price) ? `${price} ₽` : 'цена уточняется';

      const titleEl = document.createElement('div');
      titleEl.className = 'profile-item-title';
      titleEl.textContent = title;

      const metaEl = document.createElement('div');
      metaEl.className = 'profile-item-text';
      metaEl.textContent = `Количество: ${qty} • ${total}`;

      li.appendChild(titleEl);
      li.appendChild(metaEl);
      return li;
    }

    async function loadAddresses() {
      try {
        const data = await apiFetch('/api/me/addresses');
        const addresses = normalizeListPayload(data, ['addresses', 'items', 'data']);
        renderList(addressesList, addresses, renderAddressItem, 'Пока нет адресов');
      } catch (error) {
        if (error.status === 404) {
          renderList(addressesList, [], renderAddressItem, 'Пока нет адресов');
          return;
        }
        console.warn('Не удалось загрузить адреса', error);
        renderList(addressesList, [], renderAddressItem, 'Не удалось загрузить адреса');
      }
    }

    async function loadOrders() {
      try {
        const data = await apiFetch('/api/me/orders');
        const orders = normalizeListPayload(data, ['orders', 'items', 'data']);
        renderList(ordersList, orders, renderOrderItem, 'Пока нет заказов');
      } catch (error) {
        if (error.status === 404) {
          renderList(ordersList, [], renderOrderItem, 'Пока нет заказов');
          return;
        }
        console.warn('Не удалось загрузить заказы', error);
        renderList(ordersList, [], renderOrderItem, 'Не удалось загрузить заказы');
      }
    }

    async function loadCart() {
      try {
        const data = await apiFetch('/api/me/cart');
        const cartItems = normalizeListPayload(data, ['items', 'cart_items', 'data']);
        renderList(cartList, cartItems, renderCartItem, 'Корзина пуста');
      } catch (error) {
        if (error.status === 404) {
          renderList(cartList, [], renderCartItem, 'Корзина пуста');
          return;
        }
        console.warn('Не удалось загрузить корзину', error);
        renderList(cartList, [], renderCartItem, 'Не удалось загрузить корзину');
      }
    }

    async function loadProfile() {
      try {
        const user = await apiFetch('/api/me');
        currentUser = user?.user || user;
        if (!currentUser) {
          throw new Error('Профиль не найден');
        }
        renderProfile(currentUser);
        showProfile();
        setProfileStatus('Данные профиля обновлены.');
        await Promise.all([loadAddresses(), loadOrders(), loadCart()]);
      } catch (error) {
        console.warn('Не удалось загрузить профиль', error);
        if (error.status === 401) {
          clearToken();
          showAuth('Сессия истекла. Введите телефон и код ещё раз.');
          return;
        }
        showAuth(error.message || 'Не удалось загрузить профиль');
      }
    }

    loginForm?.addEventListener('submit', async (event) => {
      event.preventDefault();
      const phone = (phoneInput.value || '').trim();
      const code = (codeInput.value || '').trim();

      if (!phone || !code) {
        showAuth('Введите телефон и код.');
        return;
      }

      loginSubmit.disabled = true;
      loginSubmit.textContent = 'Входим…';
      loginError.textContent = '';
      loginError.style.display = 'none';

      try {
        const data = await apiFetch('/api/auth/verify-code', {
          method: 'POST',
          body: JSON.stringify({ phone, code }),
        });
        const token = data?.access_token || data?.token;
        if (!token) {
          throw new Error('Сервер не вернул токен');
        }
        setToken(token);
        codeInput.value = '';
        await loadProfile();
      } catch (error) {
        console.warn('Ошибка входа', error);
        showAuth(error.message || 'Не удалось выполнить вход');
      } finally {
        loginSubmit.disabled = false;
        loginSubmit.textContent = 'Войти';
      }
    });

    logoutButton?.addEventListener('click', () => {
      clearToken();
      showAuth('Вы вышли из профиля.');
      phoneInput.focus();
    });

    document.addEventListener('DOMContentLoaded', async () => {
      if (!getToken()) {
        showAuth('');
        phoneInput.focus();
        return;
      }
      setProfileStatus('Загружаем профиль…');
      await loadProfile();
    });
  </script>
  <script src="js/support_widget.js?v=20250605" defer></script>
</body>
</html>
