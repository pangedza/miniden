<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MiniDeN — Админка</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <link rel="icon" id="site-favicon" href="/favicon.ico" />
  <link rel="stylesheet" href="css/theme.css?v=20251218" />
  <link rel="stylesheet" href="css/admin_chats.css?v=20250610" />

</head>
<body data-theme="lifestyle" class="page-admin">
  <div class="admin-layout">
    <aside class="admin-sidebar">
      <div class="admin-brand">MiniDeN<br /><span>админ-панель</span></div>
      <nav class="admin-nav">
        <button class="nav-btn active" data-view="orders">Заказы</button>
        <div class="nav-group" data-group="products">
          <button class="nav-btn nav-parent" data-group-toggle="products">Товары</button>
          <div class="nav-submenu">
            <button class="nav-btn nav-sub" data-view="product-list" data-action="product-new">Создать товар</button>
            <button class="nav-btn nav-sub" data-view="product-list">Список товаров</button>
            <button class="nav-btn nav-sub" data-view="product-categories">Категории товаров</button>
          </div>
        </div>
        <div class="nav-group" data-group="courses">
          <button class="nav-btn nav-parent" data-group-toggle="courses">Мастер-классы</button>
          <div class="nav-submenu">
            <button class="nav-btn nav-sub" data-view="course-list" data-action="course-new">Создать мастер-класс</button>
            <button class="nav-btn nav-sub" data-view="course-list">Список мастер-классов</button>
            <button class="nav-btn nav-sub" data-view="course-categories">Категории мастер-классов</button>
          </div>
        </div>
        <button class="nav-btn" data-view="home-cms">Главная страница</button>
        <button class="nav-btn" data-view="branding">Брендинг</button>
        <button class="nav-btn" data-view="reviews">Отзывы</button>
        <button class="nav-btn" data-view="faq">FAQ (база знаний)</button>
        <button class="nav-btn" data-view="support-chats">Чаты</button>
        <div class="nav-group" data-group="promocodes">
          <button class="nav-btn nav-parent" data-group-toggle="promocodes" data-default-view="promocode-list">Промокоды</button>
          <div class="nav-submenu">
            <button class="nav-btn nav-sub" data-view="promocode-list" data-action="promo-new">Создать промокод</button>
            <button class="nav-btn nav-sub" data-view="promocode-list">Список промокодов</button>
          </div>
        </div>
        <button class="nav-btn" data-view="stats">Статистика</button>
      </nav>
      <div class="muted" style="margin-top:16px; font-size:13px;">Выйдите в профиль, чтобы проверить статус авторизации.</div>
    </aside>

    <main class="admin-main">
      <div class="section-header admin-top-row">
        <h1>Админка</h1>
        <div class="header-actions">
          <div class="theme-switcher">
            <label for="theme-select">Тема</label>
            <select id="theme-select">
              <option value="purple">Фиолетовая</option>
              <option value="dark">Тёмная</option>
              <option value="light">Светлая</option>
          <option value="cream">Сливочная</option>
            </select>
          </div>
          <a href="/webapp/index.html" class="admin-btn secondary admin-back-to-main">Вернуться на главную</a>
        </div>
      </div>
      <div id="status" class="status-box" style="display:none"></div>

      <div id="access-denied" class="card" style="display:none;">
        <h2>Нет доступа</h2>
        <p class="muted">Админка доступна только администраторам. Авторизуйтесь через Telegram WebApp или войдите в профиль с правами администратора.</p>
      </div>

      <section id="orders" class="card admin-view" data-view="orders">
        <div class="section-header">
          <div>
            <h2>Заказы</h2>
            <p class="muted">Просматривайте заказы, обновляйте статусы и выдавайте доступ к мастер-классам после оплаты.</p>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <label for="status-filter" class="muted" style="margin:0;">Статус</label>
            <select id="status-filter">
              <option value="all">Все</option>
              <option value="new">Новый</option>
              <option value="in_progress">В работе</option>
              <option value="paid">Оплачен</option>
              <option value="sent">Отправлен</option>
              <option value="archived">Архив</option>
            </select>
          </div>
        </div>
        <table aria-label="Список заказов">
          <thead>
            <tr>
              <th>ID</th>
              <th>Клиент</th>
              <th>Сумма</th>
              <th>Статус</th>
              <th>Дата</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="orders-body"></tbody>
        </table>

        <div id="order-detail" class="card" style="margin-top:14px; display:none;">
          <div class="section-header">
            <h3>Заказ <span id="detail-id"></span></h3>
            <div style="display:flex; gap:8px; align-items:center;">
              <label for="detail-status" class="muted" style="margin:0;">Статус</label>
              <select id="detail-status">
                <option value="new">Новый</option>
                <option value="in_progress">В работе</option>
                <option value="paid">Оплачен</option>
                <option value="sent">Отправлен</option>
                <option value="archived">Архив</option>
              </select>
              <button class="btn secondary" type="button" id="save-status">Сохранить</button>
            </div>
          </div>
          <div class="grid" style="margin-top:10px;">
            <div>
              <div class="muted">Клиент</div>
              <div id="detail-client">—</div>
              <div class="muted" style="margin-top:8px;">Контакт</div>
              <div id="detail-contact">—</div>
              <div class="muted" style="margin-top:8px;">Telegram ID</div>
              <div id="detail-telegram-id">—</div>
              <div class="muted" style="margin-top:12px;">Связаться</div>
              <div class="order-contact-actions" style="display:flex; gap:8px; margin-top:4px; flex-wrap:wrap;">
                <a id="order-call-link" class="btn secondary" target="_blank" rel="noopener" style="display:none;">Позвонить</a>
                <a id="order-telegram-link" class="btn secondary" target="_blank" rel="noopener" style="display:none;">Написать в Telegram</a>
              </div>
              <div class="muted" style="margin-top:8px;">Промокод</div>
              <div id="detail-promocode">—</div>
            </div>
            <div>
              <div class="muted">Комментарий</div>
              <div id="detail-comment">—</div>
            </div>
          </div>
          <h4>Позиции</h4>
          <ul class="list" id="detail-items"></ul>
          <div id="detail-total" class="muted"></div>
        </div>
      </section>

      <section id="product-categories" class="card admin-view" data-view="product-categories" style="display:none;">
        <div class="section-header">
          <div>
            <h2>Категории товаров</h2>
            <p class="muted">Управляйте группами корзинок и аксессуаров.</p>
          </div>
        </div>
        <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));">
          <div class="card" style="background: rgba(255,255,255,0.03);">
            <h3 id="product-category-form-title">Создать категорию</h3>
            <form id="product-category-form" class="stacked-form">
              <label>Название</label>
              <input type="text" name="name" required />
              <label>Slug/код</label>
              <input type="text" name="slug" placeholder="basket" />
              <label>Тип</label>
              <select name="type">
                <option value="basket">Товары</option>
                <option value="course">Мастер-классы</option>
                <option value="mixed">Смешанная</option>
              </select>
              <label>Описание направления</label>
              <textarea name="description" rows="3" placeholder="Краткий текст о категории"></textarea>
              <label>Баннер / Image URL</label>
              <input type="url" name="image_url" placeholder="https://example.com/banner.jpg" />
              <label>Загрузить изображение</label>
              <input type="file" name="image_file" id="product-category-image-file" accept="image/*" />
              <div class="image-preview" id="product-category-image-preview" style="display:none;">
                <img alt="Превью категории" />
              </div>
              <label>Порядок сортировки</label>
              <input type="number" name="sort_order" min="0" value="0" />
              <label style="display:flex; gap:8px; align-items:center; margin-top:8px;">
                <input type="checkbox" name="is_active" checked /> Активна
              </label>
              <div class="form-actions">
                <button class="btn primary" type="submit">Сохранить</button>
                <button class="btn secondary danger" type="button" id="product-category-delete" style="display:none;">Удалить</button>
                <button class="btn secondary" type="button" id="product-category-reset">Сбросить</button>
              </div>
            </form>
          </div>
          <div class="table-wrapper">
              <table aria-label="Категории товаров">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Название</th>
                    <th>Slug</th>
                    <th>Тип</th>
                    <th>Порядок</th>
                    <th>Активна</th>
                    <th>Обновлён</th>
                    <th></th>
                  </tr>
                </thead>
              <tbody id="product-categories-table"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="course-categories" class="card admin-view" data-view="course-categories" style="display:none;">
        <div class="section-header">
          <div>
            <h2>Категории мастер-классов</h2>
            <p class="muted">Типы курсов и уроков.</p>
          </div>
        </div>
        <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));">
          <div class="card" style="background: rgba(255,255,255,0.03);">
            <h3 id="course-category-form-title">Создать категорию</h3>
            <form id="course-category-form" class="stacked-form">
              <label>Название</label>
              <input type="text" name="name" required />
              <label>Slug/код</label>
              <input type="text" name="slug" placeholder="free" />
              <label>Тип</label>
              <select name="type">
                <option value="course">Мастер-классы</option>
                <option value="basket">Товары</option>
                <option value="mixed">Смешанная</option>
              </select>
              <label>Описание направления</label>
              <textarea name="description" rows="3" placeholder="О чём эти уроки"></textarea>
              <label>Баннер / Image URL</label>
              <input type="url" name="image_url" placeholder="https://example.com/banner.jpg" />
              <label>Загрузить изображение</label>
              <input type="file" name="image_file" id="course-category-image-file" accept="image/*" />
              <div class="image-preview" id="course-category-image-preview" style="display:none;">
                <img alt="Превью категории" />
              </div>
              <label>Порядок сортировки</label>
              <input type="number" name="sort_order" min="0" value="0" />
              <label style="display:flex; gap:8px; align-items:center; margin-top:8px;">
                <input type="checkbox" name="is_active" checked /> Активна
              </label>
              <div class="form-actions">
                <button class="btn primary" type="submit">Сохранить</button>
                <button class="btn secondary danger" type="button" id="course-category-delete" style="display:none;">Удалить</button>
                <button class="btn secondary" type="button" id="course-category-reset">Сбросить</button>
              </div>
            </form>
          </div>
          <div class="table-wrapper">
              <table aria-label="Категории мастер-классов">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Название</th>
                    <th>Slug</th>
                    <th>Тип</th>
                    <th>Порядок</th>
                    <th>Активна</th>
                    <th>Обновлён</th>
                    <th></th>
                  </tr>
                </thead>
              <tbody id="course-categories-table"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="product-list" class="card admin-view" data-view="product-list" style="display:none;">
        <div class="section-header">
          <div>
            <h2>Товары</h2>
            <p class="muted">Все корзинки и аксессуары.</p>
          </div>
          <div class="filters-row">
            <select id="products-category"></select>
            <select id="products-status">
              <option value="all">Все</option>
              <option value="active">Активные</option>
              <option value="hidden">Скрытые</option>
            </select>
            <button class="btn primary" type="button" id="product-reset">Новый товар</button>
          </div>
        </div>

        <div class="table-wrapper">
          <table aria-label="Товары">
            <thead>
              <tr>
                <th>ID</th>
                <th>Название</th>
                <th>Категория</th>
                <th>Цена</th>
                <th>Активен</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="products-table"></tbody>
          </table>
        </div>

        <div class="card" style="background: rgba(255,255,255,0.03); margin-top:16px;">
          <h3 id="product-form-title">Создать товар</h3>
          <form id="product-form" class="stacked-form">
            <div class="form-grid">
              <label>Категория</label>
              <select name="category_id" id="product-category-select"></select>
              <label>Название</label>
              <input type="text" name="name" id="product-name" required />
              <label>Цена</label>
              <input type="number" name="price" id="product-price" min="0" required />
              <label>Краткое описание</label>
              <textarea name="short_description" id="product-short-description" rows="2" placeholder="Кратко, до ~100–150 символов. Показывается на карточке товара."></textarea>
              <label>Описание</label>
              <textarea name="description" id="product-description"></textarea>
              <label>Ссылка на Wildberries</label>
              <input type="text" name="wb_url" id="product-wb-url" />
              <label>Ссылка на Ozon</label>
              <input type="text" name="ozon_url" id="product-ozon-url" />
              <label>Ссылка на Яндекс.Маркет</label>
              <input type="text" name="yandex_url" id="product-yandex-url" />
              <label>Ссылка на Авито</label>
              <input type="text" name="avito_url" id="product-avito-url" />
              <label>Ссылка на мастер-класс</label>
              <input type="text" name="masterclass_url" id="product-masterclass-url" />
              <label>Ссылка на подробности</label>
              <input type="text" name="detail_url" id="product-detail-url" />
            </div>

            <div class="form-group">
              <label>Фото товара</label>
              <input type="file" id="product-image-file-input" accept="image/*">
            </div>
            <div class="form-group">
              <label>URL изображения (image_url)</label>
              <input type="text" id="product-image-url-input" name="image_url" placeholder="/media/products/xxx.jpg">
            </div>
            <div class="form-group">
              <div id="product-image-preview" class="image-preview-box">Нет изображения</div>
            </div>
            <div class="form-group">
              <label>Фотографии товара</label>
              <div class="image-upload-row">
                <input type="file" id="product-gallery-input" accept="image/*" multiple>
                <div class="muted" style="font-size:13px;">Можно выбрать несколько файлов одновременно.</div>
              </div>
              <div id="product-images-list" class="image-list muted">Сохраните товар, чтобы добавить фото.</div>
            </div>
            <div class="form-actions">
              <button class="btn primary" type="submit">Создать товар</button>
              <button class="btn secondary" type="button" id="product-cancel">Новый товар</button>
            </div>
          </form>
        </div>
      </section>

      <section id="course-list" class="card admin-view" data-view="course-list" style="display:none;">
        <div class="section-header">
          <div>
            <h2>Мастер-классы</h2>
            <p class="muted">Онлайн уроки. Бесплатные доступны сразу, платные — после оплаты заказа.</p>
          </div>
          <div class="filters-row">
            <select id="courses-category"></select>
            <select id="courses-status">
              <option value="all">Все</option>
              <option value="active">Активные</option>
              <option value="hidden">Скрытые</option>
            </select>
            <button class="btn primary" type="button" id="course-reset">Новый мастер-класс</button>
          </div>
        </div>
        <div class="table-wrapper">
          <table aria-label="Мастер-классы">
            <thead>
              <tr>
                <th>ID</th>
                <th>Название</th>
                <th>Категория</th>
                <th>Цена</th>
                <th>Активен</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="courses-table"></tbody>
          </table>
        </div>

        <div class="card" style="background: rgba(255,255,255,0.03); margin-top:16px;">
          <h3 id="course-form-title">Создать мастер-класс</h3>
          <form id="course-form" class="stacked-form">
            <div class="form-grid">
              <label>Категория</label>
              <select name="category_id" id="course-category-select"></select>
              <label>Название</label>
              <input type="text" name="name" id="course-name" required />
              <label>Цена (0 — бесплатно)</label>
              <input type="number" name="price" id="course-price" min="0" required />
              <label>Краткое описание</label>
              <textarea name="short_description" id="course-short-description" rows="2" placeholder="Кратко, до ~100–150 символов. Показывается на карточке курса."></textarea>
              <label>Описание</label>
              <textarea name="description" id="course-description"></textarea>
              <label>Ссылка на мастер-класс</label>
              <input type="text" name="masterclass_url" id="course-masterclass-url" />
              <label>Ссылка на подробности</label>
              <input type="text" name="detail_url" id="course-detail-url" />
            </div>
            <div class="form-group">
              <label>Фото курса</label>
              <input type="file" id="course-image-file-input" accept="image/*">
            </div>
            <div class="form-group">
              <label>URL изображения (image_url)</label>
              <input type="text" id="course-image-url-input" name="image_url" placeholder="/media/courses/xxx.jpg">
            </div>
            <div class="form-group">
              <div id="course-image-preview" class="image-preview-box">Нет изображения</div>
            </div>
            <div class="form-group">
              <label>Фотографии мастер-класса</label>
              <div class="image-upload-row">
                <input type="file" id="course-gallery-input" accept="image/*" multiple>
                <div class="muted" style="font-size:13px;">Добавьте одно или несколько изображений.</div>
              </div>
              <div id="course-images-list" class="image-list muted">Сохраните мастер-класс, чтобы добавить фото.</div>
            </div>
            <div class="form-actions">
              <button class="btn primary" type="submit">Создать мастер-класс</button>
              <button class="btn secondary" type="button" id="course-cancel">Новый мастер-класс</button>
            </div>
          </form>
        </div>
      </section>

      <section id="promocode-list" class="card admin-view" data-view="promocode-list" style="display:none;">
        <div class="section-header">
          <div>
            <h2>Список промокодов</h2>
            <p class="muted">Все созданные промокоды с возможностью фильтрации и редактирования.</p>
          </div>
          <div class="filters-row">
            <select id="promo-status-filter">
              <option value="all">Все</option>
              <option value="active">Активные</option>
              <option value="inactive">Не активные</option>
            </select>
            <button class="btn primary" type="button" id="promo-create-new" data-view="promocode-list" data-action="promo-new">Новый промокод</button>
          </div>
        </div>
        <div class="card" style="overflow:auto;">
          <table aria-label="Промокоды" style="width:100%; min-width:760px;">
            <thead>
              <tr>
                <th>ID</th>
                <th>Код</th>
                <th>Тип скидки</th>
                <th>Значение</th>
                <th>Область / цель</th>
                <th>Период действия</th>
                <th>Статус</th>
                <th>Использовано</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="promo-table"></tbody>
          </table>
        </div>

        <div class="card" style="max-width:720px; margin:16px auto 0;">
          <h3 id="promo-create-title">Создать промокод</h3>
          <form id="promo-create-form" class="stacked-form">
            <label for="promo-create-code">Код</label>
            <input type="text" id="promo-create-code" name="code" required />

            <label for="promo-create-discount-type">Тип скидки</label>
            <select id="promo-create-discount-type" name="discount_type" required>
              <option value="percent">Процент</option>
              <option value="fixed">Фиксированная</option>
            </select>

            <label for="promo-create-discount-value">Значение</label>
            <input type="number" id="promo-create-discount-value" name="discount_value" min="1" step="1" required />

            <label for="promo-create-scope">Область применения</label>
            <select id="promo-create-scope" name="scope" required>
              <option value="all">На весь заказ</option>
              <option value="basket">Только корзинки</option>
              <option value="course">Только мастер-классы</option>
              <option value="product">Определённый товар/курс</option>
              <option value="category">Категория корзинок</option>
            </select>

            <label for="promo-create-target">ID цели (для product/category)</label>
            <input type="number" id="promo-create-target" name="target_id" min="0" placeholder="Например, ID товара или категории" />

            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
              <div>
                <label for="promo-create-date-start">Дата начала</label>
                <input type="datetime-local" id="promo-create-date-start" name="date_start" />
              </div>
              <div>
                <label for="promo-create-date-end">Дата окончания</label>
                <input type="datetime-local" id="promo-create-date-end" name="date_end" />
              </div>
            </div>

            <label for="promo-create-max-uses">Максимум использований</label>
            <input type="number" id="promo-create-max-uses" name="max_uses" min="0" placeholder="0 — без лимита" />

            <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:6px;">
              <label style="display:flex; align-items:center; gap:6px; margin:0;"><input type="checkbox" id="promo-create-active" name="active" checked /> Активен</label>
              <label style="display:flex; align-items:center; gap:6px; margin:0;"><input type="checkbox" id="promo-create-one-per-user" name="one_per_user" /> Один раз на пользователя</label>
            </div>

            <div class="form-actions">
              <button class="btn primary" type="submit">Создать промокод</button>
              <button class="btn secondary" type="button" id="promo-create-reset">Сбросить</button>
            </div>
          </form>
        </div>
      </section>

      <section id="home-cms" class="card admin-view" data-view="home-cms" style="display:none;">
        <div class="section-header">
          <div>
            <h2>Главная страница</h2>
            <p class="muted">Управляйте баннерами, текстовыми блоками и мини-блогом главной страницы.</p>
          </div>
        </div>

        <div class="home-admin-tabs admin-tabs" id="home-tabs">
          <button class="home-admin-tab admin-tab active" data-tab="hero">Hero</button>
          <button class="home-admin-tab admin-tab" data-tab="tiles">Плитки</button>
          <button class="home-admin-tab admin-tab" data-tab="texts">Тексты</button>
          <button class="home-admin-tab admin-tab" data-tab="entries">Переходы</button>
          <button class="home-admin-tab admin-tab" data-tab="posts">Мини-блог</button>
        </div>

        <div class="home-admin-tab-panel admin-tab-view" data-panel="blocks">
          <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); gap:16px;">
            <div class="table-wrapper">
              <div class="filters-row" style="justify-content: space-between; gap:12px;">
                <div class="muted">Выберите вкладку выше, чтобы отфильтровать блоки.</div>
                <select id="home-block-filter" style="min-width:180px;">
                  <option value="all">Все блоки</option>
                  <option value="hero">Hero</option>
                  <option value="tiles">Плитки</option>
                  <option value="texts">Тексты</option>
                  <option value="entries">Переходы</option>
                </select>
              </div>
              <table aria-label="Блоки главной" class="table-selectable">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Ключ</th>
                    <th>Заголовок</th>
                    <th>Активен</th>
                    <th>Порядок</th>
                    <th>Обновлено</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="home-blocks-list"></tbody>
              </table>
            </div>
            <div class="card" style="background: rgba(255,255,255,0.03);">
              <h3 id="home-block-form-title">Создать блок</h3>
              <p class="muted" id="home-block-form-meta" style="margin-top:-8px;">Выберите блок в таблице слева.</p>
              <form id="home-block-form" class="stacked-form">
                <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:12px;">
                  <div>
                    <label for="home-block-id">ID</label>
                    <input type="text" id="home-block-id" value="—" disabled />
                  </div>
                  <div>
                    <label for="home-block-key">Ключ блока</label>
                    <select name="block_key" id="home-block-key" required>
                      <option value="hero_main">Hero</option>
                      <option value="tile_home_kids">Плитка — Дом и дети</option>
                      <option value="tile_process">Плитка — Процесс</option>
                      <option value="tile_baskets">Плитка — Корзинки</option>
                      <option value="tile_learning">Плитка — Обучение</option>
                      <option value="about_short">Текст — Обо мне</option>
                      <option value="process_text">Текст — Процесс</option>
                      <option value="shop_entry">Переход — Каталог</option>
                      <option value="learning_entry">Переход — Обучение</option>
                    </select>
                  </div>
                </div>

                <label>Заголовок</label>
                <input type="text" name="title" required />

                <label>Подзаголовок</label>
                <textarea name="subtitle" rows="2"></textarea>

                <label>Текст/описание</label>
                <textarea name="body" rows="3"></textarea>

                <label>Текст кнопки</label>
                <input type="text" name="button_text" />

                <label>Ссылка кнопки</label>
                <input type="text" name="button_url" />

                <label for="home-block-image-file">Загрузить изображение</label>
                <input type="file" id="home-block-image-file" accept="image/*" />
                <div class="muted" style="font-size:13px; margin-top:-6px;">Файл сохранится в /media/home/</div>

                <label>Image URL (https или /uploads)</label>
                <input type="text" name="image_url" id="home-block-image-url" placeholder="https://..." />
                <div class="muted" id="home-block-image-link" style="font-size:13px; margin-top:-6px;">
                  Текущий URL: <a href="#" id="home-block-image-href" target="_blank" rel="noopener">—</a>
                </div>
                <div class="home-banner-image-preview" style="border: 1px dashed var(--border); padding:10px; border-radius:12px; background: rgba(255,255,255,0.02); display:flex; align-items:center; justify-content:center;">
                  <img id="home-block-image-preview" alt="Превью блока" style="max-width:100%; border-radius:12px;" />
                </div>

                <label>Порядок</label>
                <input type="number" name="order" value="0" />

                <label style="display:flex; gap:8px; align-items:center;">
                  <input type="checkbox" name="is_active" checked /> Активен
                </label>
                <div class="form-actions">
                  <button class="btn primary" type="submit">Сохранить</button>
                  <button class="btn secondary" type="button" id="home-block-reset">Создать блок</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <div class="home-admin-tab-panel admin-tab-view" data-panel="posts" style="display:none;">
          <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap:16px;">
            <div class="table-wrapper">
              <table aria-label="Мини-блог">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Заголовок</th>
                    <th>Активен</th>
                    <th>Порядок</th>
                    <th>Дата</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="home-posts-list"></tbody>
              </table>
            </div>
            <div class="card" style="background: rgba(255,255,255,0.03);">
              <h3 id="home-post-form-title">Создать пост</h3>
              <form id="home-post-form" class="stacked-form">
                <label>Заголовок</label>
                <input type="text" name="title" required />
                <label>Краткий текст</label>
                <textarea name="short_text" rows="3" required></textarea>
                <label>Ссылка (опционально)</label>
                <input type="text" name="link" />
                <label>Порядок сортировки</label>
                <input type="number" name="sort_order" value="0" />
                <label style="display:flex; gap:8px; align-items:center;">
                  <input type="checkbox" name="is_active" checked /> Активен
                </label>
                <div class="form-actions">
                  <button class="btn primary" type="submit">Сохранить</button>
                  <button class="btn secondary" type="button" id="home-post-reset">Создать пост</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </section>

      <section id="reviews" class="card admin-view" data-view="reviews" style="display:none;">
        <div class="section-header" style="align-items:flex-start; gap:12px;">
          <div>
            <h2>Отзывы</h2>
            <p class="muted">Модерируйте отзывы покупателей, просматривайте текст и фото, меняйте статусы.</p>
            <div class="review-counters" id="review-counters">
              <span class="tag">Всего: <strong id="reviews-count-total">0</strong></span>
              <span class="tag">На модерации: <strong id="reviews-count-pending">0</strong></span>
              <span class="tag">Одобрено: <strong id="reviews-count-approved">0</strong></span>
              <span class="tag">Отклонено: <strong id="reviews-count-rejected">0</strong></span>
            </div>
          </div>
          <div class="review-filters">
            <label class="muted">Статус</label>
            <select id="review-status-filter">
              <option value="all">Все</option>
              <option value="pending">На модерации</option>
              <option value="approved">Одобрено</option>
              <option value="rejected">Отклонено</option>
            </select>
            <label class="muted">Товар</label>
            <select id="review-product-filter"></select>
            <label class="muted">Пользователь</label>
            <input type="text" id="review-user-filter" placeholder="ID или имя" />
            <button class="btn secondary" type="button" id="review-reset-btn">Сбросить</button>
          </div>
        </div>

        <div class="card" style="overflow:auto;">
          <table aria-label="Отзывы" class="reviews-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Товар</th>
                <th>Пользователь</th>
                <th>Рейтинг</th>
                <th>Текст</th>
                <th>Фото</th>
                <th>Статус</th>
                <th>Дата</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="reviews-table-body"></tbody>
          </table>
        </div>
      </section>

      <section id="faq" class="card admin-view" data-view="faq" style="display:none;">
        <div class="section-header">
          <div>
            <h2>База знаний / FAQ</h2>
            <p class="muted">Управляйте разделами и ответами на популярные вопросы.</p>
          </div>
          <div class="filters-row">
            <label for="faq-category-filter" class="muted" style="margin:0;">Категория</label>
            <select id="faq-category-filter">
              <option value="">Все категории</option>
            </select>
            <button class="btn primary" type="button" id="faq-add-btn">Добавить вопрос</button>
          </div>
        </div>

        <div class="table-wrapper" style="margin-bottom:16px;">
          <table aria-label="FAQ" style="width:100%;">
            <thead>
              <tr>
                <th>ID</th>
                <th>Категория</th>
                <th>Вопрос</th>
                <th>Порядок</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="faq-table"></tbody>
          </table>
        </div>

        <div class="card" style="background: rgba(255,255,255,0.03);">
          <h3 id="faq-form-title">Добавить вопрос</h3>
          <form id="faq-form" class="stacked-form">
            <label for="faq-category">Категория</label>
            <input type="text" id="faq-category" name="category" required />

            <label for="faq-question">Вопрос</label>
            <textarea id="faq-question" name="question" rows="3" required></textarea>

            <label for="faq-answer">Ответ</label>
            <textarea id="faq-answer" name="answer" rows="4" required></textarea>

            <label for="faq-sort">Порядок</label>
            <input type="number" id="faq-sort" name="sort_order" min="0" value="0" />

            <div class="form-actions">
              <button class="btn primary" type="submit">Сохранить</button>
              <button class="btn secondary" type="button" id="faq-reset">Сбросить</button>
            </div>
          </form>
        </div>
      </section>

      <section id="support-chats" class="card admin-view" data-view="support-chats" style="display:none;">
        <div class="section-header">
          <div>
            <h2>Чаты</h2>
            <p class="muted">Структура как в мессенджере: выберите диалог слева и переписку справа.</p>
          </div>
          <button class="btn secondary" type="button" id="chat-sidebar-toggle" aria-label="Свернуть список чатов">☰</button>
        </div>

        <div class="chat-app" id="admin-chat-app">
          <aside class="chat-sidebar" id="chat-sidebar" aria-label="Список чатов">
            <div class="chat-sidebar__controls">
              <div class="chat-search">
                <input
                  type="search"
                  id="chat-search-input"
                  placeholder="Поиск по имени / user_id / session_key"
                  aria-label="Поиск по имени или session_key"
                />
              </div>
              <div class="chat-filter-group">
                <select id="chat-status-filter" aria-label="Фильтр статуса">
                  <option value="all">Все</option>
                  <option value="open">Открытые</option>
                  <option value="waiting_manager">Ожидают ответа</option>
                  <option value="closed">Закрытые</option>
                </select>
                <button class="chat-icon-button" type="button" id="chat-refresh-button" title="Обновить список">↻</button>
              </div>
            </div>
            <div class="chat-list" id="chat-list" role="listbox" aria-label="Диалоги"></div>
          </aside>

          <main class="chat-main">
            <div class="chat-header" id="chat-header">
              <div class="chat-header__info">
                <div class="chat-title" id="chat-title">Выберите чат</div>
                <div class="chat-subtitle" id="chat-subtitle">Чтобы увидеть переписку, выберите диалог слева.</div>
              </div>
              <div class="chat-header__actions">
                <span class="chat-status-badge" id="chat-status-badge">—</span>
                <button class="chat-icon-button" type="button" id="chat-header-refresh" title="Обновить чат">↻</button>
                <button class="chat-btn secondary" type="button" id="chat-reopen-button" disabled>Открыть снова</button>
                <button class="chat-btn primary" type="button" id="chat-close-button" disabled>Закрыть чат</button>
              </div>
            </div>

            <div class="chat-main__body">
              <div class="chat-messages" id="chat-messages" aria-live="polite"></div>
              <button class="chat-new-indicator hidden" id="chat-new-indicator" type="button">⬇ Новые сообщения</button>
            </div>

            <div class="chat-composer" id="chat-composer">
              <textarea
                id="chat-input"
                rows="3"
                placeholder="Напишите ответ..."
                aria-label="Ответ менеджера"
                disabled
              ></textarea>
              <div class="chat-composer__footer">
                <div class="chat-composer__hint" id="chat-closed-hint" hidden>
                  Чат закрыт. Нажмите «Открыть снова», чтобы ответить.
                </div>
                <button class="chat-send-button" id="chat-send-button" type="button" title="Отправить" disabled>▶</button>
              </div>
            </div>
          </main>
        </div>
      </section>

      <section id="branding" class="card admin-view" data-view="branding" style="display:none;">
        <div class="section-header">
          <div>
            <h2>Брендинг</h2>
            <p class="muted">Управляйте логотипом, favicon и названием сайта. При отсутствии файлов используются дефолтные значения.</p>
          </div>
          <div class="muted" id="branding-assets-version">Версия ассетов: v1</div>
        </div>

        <form class="stacked-form" id="branding-title-form">
          <label for="branding-site-title">Название сайта (опционально)</label>
          <input type="text" id="branding-site-title" name="site_title" placeholder="MiniDeN" />
          <div class="form-actions">
            <button class="btn primary" type="submit" id="branding-save-title">Сохранить название</button>
          </div>
        </form>

        <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); margin-top: 16px; gap: 16px;">
          <div class="card" style="background: rgba(255,255,255,0.03);">
            <div class="section-header" style="margin-bottom: 10px;">
              <div>
                <h3>Логотип</h3>
                <p class="muted">PNG, JPG, WEBP, SVG до 5 МБ</p>
              </div>
            </div>
            <div class="branding-preview" id="branding-logo-preview-wrapper">
              <img id="branding-logo-preview" alt="Логотип сайта" style="max-width: 220px; max-height: 120px; object-fit: contain; display:none;" />
              <div class="muted" id="branding-logo-placeholder">Логотип не загружен</div>
            </div>
            <input type="file" id="branding-logo-file" accept=".png,.jpg,.jpeg,.webp,.svg,image/png,image/jpeg,image/webp,image/svg+xml" />
            <div class="form-actions">
              <button class="btn primary" type="button" id="branding-save-logo">Сохранить</button>
            </div>
          </div>

          <div class="card" style="background: rgba(255,255,255,0.03);">
            <div class="section-header" style="margin-bottom: 10px;">
              <div>
                <h3>Favicon</h3>
                <p class="muted">ICO, PNG, SVG до 2 МБ</p>
              </div>
            </div>
            <div class="branding-preview" id="branding-favicon-preview-wrapper">
              <img
                id="branding-favicon-preview"
                alt="Favicon"
                style="width: 64px; height: 64px; object-fit: contain; display:none;"
              />
              <a id="branding-favicon-link" class="muted" href="#" target="_blank" rel="noopener" style="display:none;">Открыть favicon</a>
              <div class="muted" id="branding-favicon-placeholder">Favicon не загружен</div>
            </div>
            <input type="file" id="branding-favicon-file" accept=".ico,.png,.svg,image/x-icon,image/png,image/svg+xml" />
            <div class="form-actions">
              <button class="btn primary" type="button" id="branding-save-favicon">Сохранить</button>
            </div>
          </div>
        </div>

        <p class="muted" style="margin-top: 12px;">Изменения могут потребовать обновления вкладки, но assets_version сбрасывает кеш браузера автоматически.</p>
      </section>

      <section id="stats" class="card admin-view" data-view="stats" style="display:none;">
        <h2>Статистика</h2>
        <p class="muted">Статистика заказов и продаж остаётся доступной через существующий API. Эта вкладка — заглушка для будущего UI.</p>
      </section>
    </main>
  </div>
  
  <script src="js/app.js?v=20251218"></script>
  <script src="js/api.js?v=20250610"></script>
  <script src="js/app_shell.js?v=20251220"></script>
  <script src="js/admin_chats.js?v=20250610"></script>
  <script>
    const statusBox = document.getElementById('status');
    const accessDenied = document.getElementById('access-denied');
    const navLinks = document.querySelectorAll('.nav-btn[data-view]');
    const navParents = document.querySelectorAll('[data-group-toggle]');

    const ordersBody = document.getElementById('orders-body');
    const statusFilter = document.getElementById('status-filter');
    const orderDetail = document.getElementById('order-detail');
    const detailId = document.getElementById('detail-id');
    const detailStatus = document.getElementById('detail-status');
    const saveStatusBtn = document.getElementById('save-status');
    const detailClient = document.getElementById('detail-client');
    const detailContact = document.getElementById('detail-contact');
    const detailTelegramId = document.getElementById('detail-telegram-id');
    const orderCallLink = document.getElementById('order-call-link');
    const orderTelegramLink = document.getElementById('order-telegram-link');
    const detailPromocode = document.getElementById('detail-promocode');
    const detailComment = document.getElementById('detail-comment');
    const detailItems = document.getElementById('detail-items');
    const detailTotal = document.getElementById('detail-total');

    const reviewStatusFilter = document.getElementById('review-status-filter');
    const reviewProductFilter = document.getElementById('review-product-filter');
    const reviewUserFilter = document.getElementById('review-user-filter');
    const reviewResetBtn = document.getElementById('review-reset-btn');
    const reviewsTableBody = document.getElementById('reviews-table-body');
    const reviewsCountTotal = document.getElementById('reviews-count-total');
    const reviewsCountPending = document.getElementById('reviews-count-pending');
    const reviewsCountApproved = document.getElementById('reviews-count-approved');
    const reviewsCountRejected = document.getElementById('reviews-count-rejected');

    const faqTableBody = document.getElementById('faq-table');
    const faqCategoryFilter = document.getElementById('faq-category-filter');
    const faqAddBtn = document.getElementById('faq-add-btn');
    const faqForm = document.getElementById('faq-form');
    const faqFormTitle = document.getElementById('faq-form-title');
    const faqCategoryInput = document.getElementById('faq-category');
    const faqQuestionInput = document.getElementById('faq-question');
    const faqAnswerInput = document.getElementById('faq-answer');
    const faqSortInput = document.getElementById('faq-sort');
    const faqResetBtn = document.getElementById('faq-reset');

    const productCategoryFilter = document.getElementById('products-category');
    const courseCategoryFilter = document.getElementById('courses-category');
    const productsStatusFilter = document.getElementById('products-status');
    const coursesStatusFilter = document.getElementById('courses-status');
    const productsTable = document.getElementById('products-table');
    const coursesTable = document.getElementById('courses-table');
    const productImageFileInput = document.getElementById('product-image-file-input');
    const productImageUrlInput = document.getElementById('product-image-url-input');
    const productImagePreview = document.getElementById('product-image-preview');
    const productGalleryInput = document.getElementById('product-gallery-input');
    const productImagesList = document.getElementById('product-images-list');
    const courseImageFileInput = document.getElementById('course-image-file-input');
    const courseImageUrlInput = document.getElementById('course-image-url-input');
    const courseImagePreview = document.getElementById('course-image-preview');
    const courseGalleryInput = document.getElementById('course-gallery-input');
    const courseImagesList = document.getElementById('course-images-list');
    const imageModal = document.getElementById('image-modal');
    const imageModalClose = document.getElementById('image-modal-close');
    const imageModalPicture = document.getElementById('image-modal-picture');

    const productForm = document.getElementById('product-form');
    const courseForm = document.getElementById('course-form');
    const productFormTitle = document.getElementById('product-form-title');
    const courseFormTitle = document.getElementById('course-form-title');
    const productCategorySelect = document.getElementById('product-category-select');
    const courseCategorySelect = document.getElementById('course-category-select');
    const productCancel = document.getElementById('product-cancel');
    const courseCancel = document.getElementById('course-cancel');
    const productReset = document.getElementById('product-reset');
    const courseReset = document.getElementById('course-reset');
    const promoTable = document.getElementById('promo-table');
    const promoStatusFilter = document.getElementById('promo-status-filter');
    const promoCreateForm = document.getElementById('promo-create-form');
    const promoCreateTitle = document.getElementById('promo-create-title');
    const promoCreateCode = document.getElementById('promo-create-code');
    const promoCreateDiscountType = document.getElementById('promo-create-discount-type');
    const promoCreateDiscountValue = document.getElementById('promo-create-discount-value');
    const promoCreateScope = document.getElementById('promo-create-scope');
    const promoCreateTarget = document.getElementById('promo-create-target');
    const promoCreateDateStart = document.getElementById('promo-create-date-start');
    const promoCreateDateEnd = document.getElementById('promo-create-date-end');
    const promoCreateMaxUses = document.getElementById('promo-create-max-uses');
    const promoCreateActive = document.getElementById('promo-create-active');
    const promoCreateOnePerUser = document.getElementById('promo-create-one-per-user');
    const promoCreateReset = document.getElementById('promo-create-reset');
    const homeTabButtons = document.querySelectorAll('.home-admin-tab');
    const homeTabPanels = document.querySelectorAll('.home-admin-tab-panel');
    const homeBlocksList = document.getElementById('home-blocks-list');
    const homePostsList = document.getElementById('home-posts-list');
    const homeBlockForm = document.getElementById('home-block-form');
    const homeBlockImageFileInput = document.getElementById('home-block-image-file');
    const homeBlockImageUrlInput = document.getElementById('home-block-image-url');
    const homeBlockImagePreview = document.getElementById('home-block-image-preview');
    const homeBlockImageLink = document.getElementById('home-block-image-link');
    const homeBlockImageHref = document.getElementById('home-block-image-href');
    const homeBlockIdInput = document.getElementById('home-block-id');
    const homeBlockMeta = document.getElementById('home-block-form-meta');
    const homeBlockKeySelect = document.getElementById('home-block-key');
    const homeBlockFilter = document.getElementById('home-block-filter');
    const homePostForm = document.getElementById('home-post-form');
    const homeBlockFormTitle = document.getElementById('home-block-form-title');
    const homePostFormTitle = document.getElementById('home-post-form-title');
    const homeBlockReset = document.getElementById('home-block-reset');
    const homePostReset = document.getElementById('home-post-reset');
    const homeBlockSubmit = homeBlockForm?.querySelector('button[type="submit"]');
    const homePostSubmit = homePostForm?.querySelector('button[type="submit"]');
    const productCategoriesTable = document.getElementById('product-categories-table');
    const courseCategoriesTable = document.getElementById('course-categories-table');
    const productCategoryForm = document.getElementById('product-category-form');
    const courseCategoryForm = document.getElementById('course-category-form');
    const productCategoryFormTitle = document.getElementById('product-category-form-title');
    const courseCategoryFormTitle = document.getElementById('course-category-form-title');
    const productCategoryReset = document.getElementById('product-category-reset');
    const courseCategoryReset = document.getElementById('course-category-reset');
    const productCategoryDeleteBtn = document.getElementById('product-category-delete');
    const courseCategoryDeleteBtn = document.getElementById('course-category-delete');
    const productCategoryImageFile = document.getElementById('product-category-image-file');
    const courseCategoryImageFile = document.getElementById('course-category-image-file');
    const productCategoryImagePreview = document.getElementById('product-category-image-preview');
    const courseCategoryImagePreview = document.getElementById('course-category-image-preview');

    const brandingSiteTitleInput = document.getElementById('branding-site-title');
    const brandingAssetsVersion = document.getElementById('branding-assets-version');
    const brandingLogoPreview = document.getElementById('branding-logo-preview');
    const brandingLogoPlaceholder = document.getElementById('branding-logo-placeholder');
    const brandingLogoFileInput = document.getElementById('branding-logo-file');
    const brandingSaveLogoBtn = document.getElementById('branding-save-logo');
    const brandingFaviconPreview = document.getElementById('branding-favicon-preview');
    const brandingFaviconLink = document.getElementById('branding-favicon-link');
    const brandingFaviconPlaceholder = document.getElementById('branding-favicon-placeholder');
    const brandingFaviconFileInput = document.getElementById('branding-favicon-file');
    const brandingSaveFaviconBtn = document.getElementById('branding-save-favicon');
    const brandingTitleForm = document.getElementById('branding-title-form');

    const DEFAULT_ORDER_STATUS = 'new';

    let currentUser = null;
    let brandingData = null;
    const categoryMaps = {
      basket: new Map(),
      course: new Map(),
    };

    if (statusFilter) {
      statusFilter.value = DEFAULT_ORDER_STATUS;
    }
    let selectedOrder = null;
    const productFormDefaults = {
      category_id: '',
      name: '',
      price: null,
      short_description: '',
      description: '',
      wb_url: '',
      ozon_url: '',
      yandex_url: '',
      avito_url: '',
      masterclass_url: '',
      detail_url: '',
      image_url: '',
    };
    const courseFormDefaults = {
      category_id: '',
      name: '',
      price: null,
      short_description: '',
      description: '',
      masterclass_url: '',
      detail_url: '',
      image_url: '',
    };
    const promoFormDefaults = {
      code: '',
      discount_type: 'percent',
      discount_value: null,
      scope: 'all',
      target_id: '',
      date_start: '',
      date_end: '',
      max_uses: '',
      active: true,
      one_per_user: false,
    };
    const homeBlockDefaults = {
      block_key: 'hero_main',
      title: '',
      subtitle: '',
      body: '',
      button_text: '',
      button_url: '',
      image_url: '',
      order: 0,
      is_active: true,
    };
    const homePostDefaults = {
      title: '',
      short_text: '',
      link: '',
      sort_order: 0,
      is_active: true,
    };
    const HOME_IMAGE_PLACEHOLDER = '/static/img/home-placeholder.svg';
    const HOME_IMAGE_GRADIENT =
      'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 600 360"><defs><linearGradient id="g" x1="0" x2="1" y1="0" y2="1"><stop offset="0%" stop-color="%23f3e7e9"/><stop offset="100%" stop-color="%23e3eeff"/></linearGradient></defs><rect width="600" height="360" fill="url(%23g)"/><rect x="140" y="110" width="320" height="140" rx="16" fill="rgba(0,0,0,0.05)"/></svg>';
    const faqDefaults = {
      category: '',
      question: '',
      answer: '',
      sort_order: 0,
    };

    const productFormState = createSectionFormState(productFormDefaults);
    const courseFormState = createSectionFormState(courseFormDefaults);
    const promoCreateState = createSectionFormState(promoFormDefaults);
    const homeBlockState = createSectionFormState(homeBlockDefaults);
    const homePostState = createSectionFormState(homePostDefaults);
    const faqFormState = createSectionFormState(faqDefaults);
    let editingProductCategoryId = null;
    let editingCourseCategoryId = null;
    let productCategoryItems = [];
    let courseCategoryItems = [];
    let promocodeItems = [];
    let reviewItems = [];
    let faqItems = [];
    let productItems = [];
    let courseItems = [];
    let homeBlockItems = [];
    let homePostItems = [];
    let productCurrentId = null;
    let masterclassCurrentId = null;
    let promoCurrentId = null;
    let currentBlockId = null;
    let currentPostId = null;
    let currentFaqId = null;
    let currentView = 'orders';
    let currentHomeTab = 'hero';
    const productSubmitBtn = productForm?.querySelector('button[type="submit"]');
    const courseSubmitBtn = courseForm?.querySelector('button[type="submit"]');
    const promoSubmitBtn = promoCreateForm?.querySelector('button[type="submit"]');

    function setStatus(message, isError = false) {
      if (!message) {
        statusBox.style.display = 'none';
        statusBox.textContent = '';
        statusBox.classList.remove('error');
        return;
      }
      statusBox.style.display = 'block';
      statusBox.textContent = message;
      statusBox.style.borderColor = isError ? 'rgba(255,99,99,0.7)' : 'var(--border)';
    }

    function getErrorMessage(error, fallback = 'Произошла ошибка') {
      if (!error) return fallback;
      if (error.data?.detail) return error.data.detail;
      if (error.data?.message) return error.data.message;
      if (error.message) return error.message;
      if (typeof error === 'string') return error;
      return fallback;
    }

    function handleError(error, fallback = 'Произошла ошибка') {
      console.error(error);
      setStatus(getErrorMessage(error, fallback), true);
    }

    async function apiPut(path, body, params) {
      const res = await fetch(buildUrl(path, params), {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: body ? JSON.stringify(body) : undefined,
      });
      return handleResponse(res);
    }

    async function apiDelete(path, params) {
      const res = await fetch(buildUrl(path, params), { method: 'DELETE' });
      return handleResponse(res);
    }

    function truncateText(text, limit = 80) {
      if (!text) return '';
      if (text.length <= limit) return text;
      return `${text.slice(0, limit)}…`;
    }

    function showImageListPlaceholder(target, message) {
      if (!target) return;
      target.classList.add('muted');
      target.innerHTML = `<div class="muted small">${message}</div>`;
    }

    function openImageModal(url) {
      if (!imageModal || !imageModalPicture) return;
      imageModalPicture.src = url;
      imageModal.classList.remove('hidden');
    }

    function closeImageModal() {
      if (!imageModal || !imageModalPicture) return;
      imageModalPicture.src = '';
      imageModal.classList.add('hidden');
    }

    function cacheBust(url, version) {
      if (typeof window.withCacheBusting === 'function') {
        return window.withCacheBusting(url, version);
      }
      if (!url) return '';
      const separator = url.includes('?') ? '&' : '?';
      return `${url}${separator}v=${version || 1}`;
    }

    function updateBrandingPreview(data) {
      brandingData = data || {};
      const version = brandingData.assets_version || 1;

      if (brandingAssetsVersion) {
        brandingAssetsVersion.textContent = `Версия ассетов: v${version}`;
      }

      if (brandingSiteTitleInput) {
        brandingSiteTitleInput.value = brandingData.site_title || '';
      }

      const logoUrl = brandingData.logo_url ? cacheBust(brandingData.logo_url, version) : null;
      if (brandingLogoPreview) {
        if (logoUrl) {
          brandingLogoPreview.src = logoUrl;
          brandingLogoPreview.style.display = 'block';
          brandingLogoPlaceholder?.classList.add('hidden');
        } else {
          brandingLogoPreview.removeAttribute('src');
          brandingLogoPreview.style.display = 'none';
          brandingLogoPlaceholder?.classList.remove('hidden');
        }
      }

      const rawFaviconUrl = brandingData.favicon_url || '';
      const faviconUrl = rawFaviconUrl ? cacheBust(rawFaviconUrl, version) : null;
      const isIco = rawFaviconUrl.toLowerCase().endsWith('.ico');

      if (brandingFaviconPreview) {
        if (faviconUrl && !isIco) {
          brandingFaviconPreview.src = faviconUrl;
          brandingFaviconPreview.style.display = 'block';
        } else {
          brandingFaviconPreview.removeAttribute('src');
          brandingFaviconPreview.style.display = 'none';
        }
      }

      if (brandingFaviconLink) {
        if (faviconUrl && isIco) {
          brandingFaviconLink.href = faviconUrl;
          brandingFaviconLink.style.display = 'inline-block';
        } else {
          brandingFaviconLink.removeAttribute('href');
          brandingFaviconLink.style.display = 'none';
        }
      }

      if (brandingFaviconPlaceholder) {
        brandingFaviconPlaceholder.style.display = faviconUrl ? 'none' : 'block';
      }
    }

    async function loadBrandingSettings(forceRefresh = false) {
      if (brandingData && !forceRefresh) {
        updateBrandingPreview(brandingData);
        return brandingData;
      }

      try {
        const data = await apiGet('/branding');
        updateBrandingPreview(data);
        return data;
      } catch (error) {
        handleError(error, 'Не удалось загрузить брендинг');
        return null;
      }
    }

    async function submitBrandingForm({ siteTitle, logoFile, faviconFile }) {
      const formData = new FormData();
      if (siteTitle !== undefined) {
        formData.append('site_title', siteTitle);
      }
      if (logoFile) {
        formData.append('logo_file', logoFile);
      }
      if (faviconFile) {
        formData.append('favicon_file', faviconFile);
      }

      const res = await fetch(`${API_BASE}/admin/branding`, {
        method: 'POST',
        body: formData,
      });
      return handleResponse(res);
    }

    function validateBrandingFile(file, allowedExtensions, maxSizeMb) {
      if (!file) return { ok: false, reason: 'Файл не выбран' };
      const ext = (file.name || '').split('.').pop()?.toLowerCase() || '';
      if (!allowedExtensions.includes(ext)) {
        return { ok: false, reason: `Поддерживаемые форматы: ${allowedExtensions.join(', ')}` };
      }
      if (file.size > maxSizeMb * 1024 * 1024) {
        return { ok: false, reason: `Размер файла должен быть до ${maxSizeMb} МБ` };
      }
      return { ok: true };
    }

    window.adminChats?.init({
      onError: (error, message) => handleError(error || new Error(message)),
      onStatus: (message, isError) => setStatus(message, isError),
    });

    async function sendJson(path, method = 'GET', body = null) {
      const res = await fetch(`${API_BASE}${path}`, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: body ? JSON.stringify(body) : undefined,
      });
      return handleResponse(res);
    }

    function formatDate(value) {
      if (!value) return '—';
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return '—';
      return date.toLocaleString('ru-RU');
    }

    function clearFileInput(input) {
      if (!input) return;
      try {
        input.value = '';
      } catch (e) {
        // ignore
      }
    }

    function setCategoryPreview(previewEl, url, version) {
      if (!previewEl) return;
      const img = previewEl.querySelector('img');
      const preparedUrl = url
        ? url.startsWith('blob:')
          ? url
          : cacheBustUrl(url, version)
        : '';
      if (img && preparedUrl) {
        img.src = preparedUrl;
        img.style.display = 'block';
        previewEl.style.display = '';
      } else if (img) {
        img.removeAttribute('src');
        img.style.display = 'none';
        previewEl.style.display = 'none';
      }
    }

    function showSection(id) {
      document.querySelectorAll('.admin-view').forEach((el) => {
        el.style.display = el.dataset.view === id ? 'block' : 'none';
      });
      currentView = id;
      navLinks.forEach((btn) => {
        const isActive = btn.dataset.view === id;
        btn.classList.toggle('active', isActive);
        const group = btn.closest('.nav-group');
        if (isActive && group) {
          group.classList.add('open');
        }
      });
    }

    function handleViewNavigation(view) {
      if (view !== 'support-chats') {
        window.adminChats?.deactivate();
      }
      showSection(view);
      if (view === 'product-categories') {
        loadProductCategories();
      }
      if (view === 'course-categories') {
        loadCourseCategories();
      }
      if (view === 'promocode-list') {
        loadPromocodes();
      }
      if (view === 'product-list') {
        loadProducts();
      }
      if (view === 'course-list') {
        loadCourses();
      }
      if (view === 'orders') {
        loadOrders();
      }
      if (view === 'reviews') {
        loadReviews();
      }
      if (view === 'faq') {
        loadFaqItems();
      }
      if (view === 'support-chats') {
        window.adminChats?.activate();
      }
      if (view === 'home-cms') {
        showHomeTab('hero');
        loadHomeBlocks();
        loadHomePosts();
      }
      if (view === 'branding') {
        loadBrandingSettings();
      }
    }

    function openProductCreateView() {
      resetProductCreateForm();
      showSection('product-list');
      productForm?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function openCourseCreateView() {
      resetCourseFormState();
      showSection('course-list');
      courseForm?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function openPromocodeCreateView() {
      resetPromoCreateForm();
      showSection('promocode-list');
      promoCreateForm?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    async function saveBrandingTitle(event) {
      event?.preventDefault();
      try {
        const data = await submitBrandingForm({ siteTitle: brandingSiteTitleInput?.value ?? '' });
        updateBrandingPreview(data);
        window.applyBranding?.(data);
        window.loadBranding?.(true);
        showToast('Обновлено');
      } catch (error) {
        handleError(error, 'Не удалось сохранить название');
      }
    }

    async function saveBrandingLogo() {
      const file = brandingLogoFileInput?.files?.[0];
      const validation = validateBrandingFile(file, ['png', 'jpg', 'jpeg', 'webp', 'svg'], 5);
      if (!validation.ok) {
        showToast(validation.reason || 'Неверный файл логотипа');
        return;
      }

      try {
        const data = await submitBrandingForm({ siteTitle: brandingSiteTitleInput?.value ?? '', logoFile: file });
        brandingLogoFileInput.value = '';
        updateBrandingPreview(data);
        window.applyBranding?.(data);
        window.loadBranding?.(true);
        showToast('Обновлено');
      } catch (error) {
        handleError(error, 'Не удалось сохранить логотип');
      }
    }

    async function saveBrandingFavicon() {
      const file = brandingFaviconFileInput?.files?.[0];
      const validation = validateBrandingFile(file, ['ico', 'png', 'svg'], 2);
      if (!validation.ok) {
        showToast(validation.reason || 'Неверный файл favicon');
        return;
      }

      try {
        const data = await submitBrandingForm({ siteTitle: brandingSiteTitleInput?.value ?? '', faviconFile: file });
        brandingFaviconFileInput.value = '';
        updateBrandingPreview(data);
        window.applyBranding?.(data);
        window.loadBranding?.(true);
        showToast('Обновлено');
      } catch (error) {
        handleError(error, 'Не удалось сохранить favicon');
      }
    }

    navLinks.forEach((btn) => {
      btn.addEventListener('click', () => {
        const view = btn.dataset.view;
        if (btn.dataset.action === 'product-new') return openProductCreateView();
        if (btn.dataset.action === 'course-new') return openCourseCreateView();
        if (btn.dataset.action === 'promo-new') return openPromocodeCreateView();
        handleViewNavigation(view);
      });
    });

    document.querySelectorAll('[data-view]').forEach((btn) => {
      if (btn.classList.contains('nav-btn')) return;
      btn.addEventListener('click', () => {
        const view = btn.dataset.view;
        if (btn.dataset.action === 'product-new') return openProductCreateView();
        if (btn.dataset.action === 'course-new') return openCourseCreateView();
        if (btn.dataset.action === 'promo-new') return openPromocodeCreateView();
        handleViewNavigation(view);
      });
    });

    navParents.forEach((parent) => {
      parent.addEventListener('click', () => {
        const groupName = parent.dataset.groupToggle;
        const group = document.querySelector(`.nav-group[data-group="${groupName}"]`);
        group?.classList.toggle('open');
        const defaultView = parent.dataset.defaultView;
        if (defaultView) {
          handleViewNavigation(defaultView);
        }
      });
    });

    brandingTitleForm?.addEventListener('submit', saveBrandingTitle);
    brandingSaveLogoBtn?.addEventListener('click', saveBrandingLogo);
    brandingSaveFaviconBtn?.addEventListener('click', saveBrandingFavicon);

    faqAddBtn?.addEventListener('click', () => {
      resetFaqFormState();
      faqForm?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    faqResetBtn?.addEventListener('click', () => {
      resetFaqFormState();
    });

    faqCategoryFilter?.addEventListener('change', () => {
      renderFaqTable(getFilteredFaqItems());
    });

    faqForm?.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (!currentUser) return handleError(new Error('Нет данных пользователя'));
      const payload = {
        category: (faqCategoryInput.value || '').trim(),
        question: (faqQuestionInput.value || '').trim(),
        answer: (faqAnswerInput.value || '').trim(),
        sort_order: Number(faqSortInput.value) || 0,
      };

      try {
        if (currentFaqId) {
          await apiPut(`/admin/faq/${currentFaqId}`, payload, { user_id: currentUser.telegram_id });
          setStatus('Вопрос обновлён');
        } else {
          await apiPost(`/admin/faq?user_id=${currentUser.telegram_id}`, payload);
          setStatus('Вопрос создан');
        }
        resetFaqFormState();
        await loadFaqItems();
      } catch (error) {
        handleError(error, 'Не удалось сохранить вопрос');
      }
    });

    function requireAdmin(profile) {
      if (!profile || !profile.is_admin) {
        setStatus('Доступ запрещён', true);
        accessDenied.style.display = 'block';
        document.querySelectorAll('.admin-view').forEach((el) => (el.style.display = 'none'));
        return false;
      }
      accessDenied.style.display = 'none';
      return true;
    }

    function renderReviewCounters(items) {
      const stats = items.reduce(
        (acc, item) => {
          acc.total += 1;
          if (item.status === 'approved') acc.approved += 1;
          if (item.status === 'pending') acc.pending += 1;
          if (item.status === 'rejected') acc.rejected += 1;
          return acc;
        },
        { total: 0, approved: 0, pending: 0, rejected: 0 }
      );
      reviewsCountTotal.textContent = stats.total;
      reviewsCountPending.textContent = stats.pending;
      reviewsCountApproved.textContent = stats.approved;
      reviewsCountRejected.textContent = stats.rejected;
    }

    function getProductLabel(product) {
      if (!product) return '—';
      return product.title || product.name || product.short_name || `Товар #${product.id}`;
    }

    function getProductLink(product) {
      if (!product) return null;
      return product.detail_url || `/webapp/products.html#${product.id || ''}`;
    }

    function renderReviewPhotosCell(photos) {
      const container = document.createElement('div');
      container.className = 'review-photos';
      const images = Array.isArray(photos) ? photos.filter(Boolean) : [];
      if (!images.length) {
        container.textContent = '—';
        container.classList.add('muted');
        return container;
      }

      images.forEach((url, idx) => {
        const thumb = document.createElement('img');
        thumb.className = 'review-photo-thumb';
        thumb.src = url;
        thumb.alt = `Фото отзыва ${idx + 1}`;
        container.appendChild(thumb);
      });
      return container;
    }

    function renderReviewActionsCell(review) {
      const cell = document.createElement('td');
      cell.className = 'review-actions-cell';

      const approveBtn = document.createElement('button');
      approveBtn.className = 'btn secondary';
      approveBtn.textContent = 'Одобрить';
      approveBtn.disabled = review.status === 'approved';
      approveBtn.addEventListener('click', () => updateReviewStatus(review, 'approved'));

      const rejectBtn = document.createElement('button');
      rejectBtn.className = 'btn secondary';
      rejectBtn.textContent = 'Отклонить';
      rejectBtn.disabled = review.status === 'rejected';
      rejectBtn.addEventListener('click', () => updateReviewStatus(review, 'rejected'));

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'btn secondary danger';
      deleteBtn.textContent = review.is_deleted ? 'Удалено' : 'Удалить';
      deleteBtn.disabled = review.is_deleted;
      deleteBtn.addEventListener('click', () => updateReviewStatus(review, review.status, true));

      const detailsBtn = document.createElement('button');
      detailsBtn.className = 'btn secondary';
      detailsBtn.textContent = 'Подробнее';
      detailsBtn.addEventListener('click', () => openReviewModal(review));

      [approveBtn, rejectBtn, deleteBtn, detailsBtn].forEach((btn) => cell.appendChild(btn));
      return cell;
    }

    function renderReviewsTable(items) {
      reviewsTableBody.innerHTML = '';
      if (!items.length) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 9;
        cell.textContent = 'Отзывы не найдены';
        cell.className = 'muted';
        row.appendChild(cell);
        reviewsTableBody.appendChild(row);
        renderReviewCounters(items);
        return;
      }

      items.forEach((review) => {
        const row = document.createElement('tr');
        if (review.is_deleted) {
          row.classList.add('muted');
        }
        const date = review.created_at ? new Date(review.created_at).toLocaleString('ru-RU') : '—';
        const productLink = getProductLink(review.product);
        const textPreview = document.createElement('div');
        textPreview.className = 'review-text-preview';
        textPreview.textContent = review.text || '—';

        row.innerHTML = `
          <td>#${review.id}</td>
          <td>
            <div class="review-product">
              <span>${getProductLabel(review.product)}</span>
              ${productLink ? `<a href="${productLink}" target="_blank" rel="noopener" title="Открыть товар">🔗</a>` : ''}
            </div>
          </td>
          <td>${review.user_name || '—'}${review.user_id ? ` (#${review.user_id})` : ''}</td>
          <td>${review.rating ? `${'★'.repeat(review.rating)}${'☆'.repeat(5 - review.rating)}` : '—'}</td>
          <td></td>
          <td></td>
          <td><span class="admin-pill review-status-${review.status}">${review.status}</span>${review.is_deleted ? '<div class="muted" style="font-size:12px;">Удалён</div>' : ''}</td>
          <td>${date}</td>
        `;

        row.children[4].appendChild(textPreview);
        row.children[5].appendChild(renderReviewPhotosCell(review.photos || review.photos_json || []));
        row.appendChild(renderReviewActionsCell(review));
        reviewsTableBody.appendChild(row);
      });
      renderReviewCounters(items);
    }

    function applyReviewSearchFilter(items) {
      const query = (reviewUserFilter.value || '').trim().toLowerCase();
      if (!query) return items;
      const isNumeric = /^\d+$/.test(query);
      return items.filter((item) => {
        const userName = (item.user_name || '').toLowerCase();
        const userIdMatch = item.user_id ? String(item.user_id).includes(query) : false;
        if (isNumeric) return userIdMatch;
        return userName.includes(query) || userIdMatch;
      });
    }

    function renderFaqCategories(items) {
      if (!faqCategoryFilter) return;
      const current = faqCategoryFilter.value;
      const categories = Array.from(
        new Set(items.map((item) => item.category).filter(Boolean))
      ).sort((a, b) => a.localeCompare(b));

      faqCategoryFilter.innerHTML = '<option value="">Все категории</option>';
      categories.forEach((category) => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        faqCategoryFilter.appendChild(option);
      });

      if (current) {
        faqCategoryFilter.value = current;
      }
    }

    function renderFaqTable(items) {
      if (!faqTableBody) return;
      faqTableBody.innerHTML = '';

      if (!items.length) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 5;
        cell.textContent = 'FAQ не найдены';
        cell.className = 'muted';
        row.appendChild(cell);
        faqTableBody.appendChild(row);
        return;
      }

      items.forEach((item) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>#${item.id}</td>
          <td>${item.category || '—'}</td>
          <td>${truncateText(item.question || '', 80)}</td>
          <td>${item.sort_order ?? 0}</td>
          <td></td>
        `;

        const actionsCell = row.querySelector('td:last-child');
        const editBtn = document.createElement('button');
        editBtn.className = 'btn secondary';
        editBtn.textContent = 'Редактировать';
        editBtn.addEventListener('click', () => openFaqForm(item));

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn secondary danger';
        deleteBtn.textContent = 'Удалить';
        deleteBtn.addEventListener('click', () => deleteFaqItem(item));

        actionsCell.appendChild(editBtn);
        actionsCell.appendChild(deleteBtn);
        faqTableBody.appendChild(row);
      });
    }

    function getFilteredFaqItems() {
      const category = faqCategoryFilter?.value || '';
      if (!category) return faqItems;
      return faqItems.filter((item) => item.category === category);
    }

    function openFaqForm(item) {
      currentFaqId = item?.id || null;
      faqFormState.mode = currentFaqId ? 'edit' : 'create';
      faqFormState.currentId = currentFaqId;
      faqFormTitle.textContent = currentFaqId ? 'Редактировать вопрос' : 'Добавить вопрос';
      resetFormState(faqFormState.formData, { ...faqDefaults, ...(item || {}) });
      applyStateToForm(faqForm, faqFormState.formData);
    }

    function resetFaqFormState() {
      currentFaqId = null;
      faqFormTitle.textContent = 'Добавить вопрос';
      faqFormState.mode = 'create';
      faqFormState.currentId = null;
      resetFormState(faqFormState.formData, faqDefaults);
      applyStateToForm(faqForm, faqFormState.formData);
    }

    async function loadFaqItems() {
      if (!currentUser) return;
      try {
        const data = await apiGet('/admin/faq', { user_id: currentUser.telegram_id });
        faqItems = data.items || [];
        renderFaqCategories(faqItems);
        renderFaqTable(getFilteredFaqItems());
      } catch (error) {
        handleError(error, 'Не удалось загрузить FAQ');
      }
    }

    async function deleteFaqItem(item) {
      if (!item?.id || !currentUser) return;
      const confirmed = window.confirm('Удалить этот вопрос?');
      if (!confirmed) return;
      try {
        await apiDelete(`/admin/faq/${item.id}`, { user_id: currentUser.telegram_id });
        setStatus('Вопрос удалён');
        await loadFaqItems();
      } catch (error) {
        handleError(error, 'Не удалось удалить вопрос');
      }
    }


    async function loadReviewProducts() {
      try {
        const data = await apiGet('/admin/products', { user_id: currentUser.telegram_id, type: 'basket', status: 'all' });
        reviewProductFilter.innerHTML = '';
        const allOption = document.createElement('option');
        allOption.value = '';
        allOption.textContent = 'Все товары';
        reviewProductFilter.appendChild(allOption);
        (data.items || []).forEach((product) => {
          const option = document.createElement('option');
          option.value = product.id;
          option.textContent = `${product.id} — ${product.name}`;
          reviewProductFilter.appendChild(option);
        });
      } catch (e) {
        console.error('Не удалось загрузить товары для фильтра отзывов', e);
      }
    }

    async function loadReviews() {
      if (!currentUser) return;
      try {
        const status = reviewStatusFilter.value === 'all' ? undefined : reviewStatusFilter.value;
        const productId = reviewProductFilter.value ? Number(reviewProductFilter.value) : undefined;
        const userQuery = (reviewUserFilter.value || '').trim();
        const params = { status, product_id: productId, page: 1, limit: 100 };
        if (/^\d+$/.test(userQuery)) {
          params.user_id = Number(userQuery);
        }

        const data = await apiGet('/admin/reviews', params);
        reviewItems = data.items || [];
        const filtered = applyReviewSearchFilter(reviewItems);
        renderReviewsTable(filtered);
        setStatus('');
      } catch (e) {
        handleError(e, 'Не удалось загрузить отзывы');
      }
    }

    async function updateReviewStatus(review, newStatus, isDeleted = false) {
      try {
        const payload = { status: newStatus, is_deleted: Boolean(isDeleted) };
        const res = await apiPost(`/admin/reviews/${review.id}/status`, payload);
        review.status = res.status;
        review.is_deleted = res.is_deleted;
        if (reviewStatusFilter.value !== 'all' && reviewStatusFilter.value !== res.status) {
          reviewItems = reviewItems.filter((item) => item.id !== review.id);
        }
        renderReviewsTable(applyReviewSearchFilter(reviewItems));
        showToast('Статус отзыва обновлён');
      } catch (e) {
        handleError(e, 'Не удалось обновить статус отзыва');
      }
    }

    function openReviewModal(review) {
      const modal = document.getElementById('review-modal');
      const titleEl = document.getElementById('review-modal-title');
      const textEl = document.getElementById('review-modal-text');
      const galleryEl = document.getElementById('review-modal-photos');

      titleEl.textContent = `${getProductLabel(review.product)} • ${review.user_name || '—'} • ${review.rating || '-'}★`;
      textEl.textContent = review.text || '—';

      galleryEl.innerHTML = '';
      (review.photos || review.photos_json || []).forEach((url) => {
        const img = document.createElement('img');
        img.src = url;
        img.alt = 'Фото отзыва';
        galleryEl.appendChild(img);
      });

      modal.classList.remove('hidden');
    }

    function closeReviewModal() {
      const modal = document.getElementById('review-modal');
      modal.classList.add('hidden');
    }

    function renderOrders(orders) {
      ordersBody.innerHTML = '';
      if (!orders || !orders.length) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 6;
        cell.textContent = 'Заказов нет';
        cell.className = 'muted';
        row.appendChild(cell);
        ordersBody.appendChild(row);
        return;
      }

      orders.forEach((order) => {
        const row = document.createElement('tr');
        const date = order.created_at ? new Date(order.created_at).toLocaleString('ru-RU') : '';
        const clientName = order.client_name || order.customer_name || order.name || 'Без имени';
        row.innerHTML = `
          <td>#${order.id}</td>
          <td>${clientName}</td>
          <td>${order.total || 0} ₽</td>
          <td>${order.status || 'new'}</td>
          <td>${date}</td>
          <td><button class="btn secondary" data-id="${order.id}">Подробнее</button></td>
        `;
        row.querySelector('button').addEventListener('click', () => loadOrderDetail(order.id));
        ordersBody.appendChild(row);
      });
    }

    function renderOrderDetail(order) {
      selectedOrder = order;
      orderDetail.style.display = 'block';
      detailId.textContent = `#${order.id}`;
      detailStatus.value = order.status || 'new';
      const clientName = order.client_name || order.customer_name || order.name || 'Без имени';
      const clientPhone = order.client_phone || order.contact || order.phone || null;
      const telegramId = order.telegram_id || null;
      const telegramUsername = order.telegram_username || null;

      detailClient.textContent = clientName || '—';
      detailContact.textContent = clientPhone || order.contact || '—';
      if (detailTelegramId) {
        detailTelegramId.textContent = telegramId || '—';
      }

      if (orderCallLink) {
        if (clientPhone) {
          const normalized = String(clientPhone).replace(/\s+/g, '');
          orderCallLink.href = `tel:${normalized}`;
          orderCallLink.style.display = '';
        } else {
          orderCallLink.style.display = 'none';
        }
      }

      if (orderTelegramLink) {
        if (telegramUsername) {
          orderTelegramLink.href = `https://t.me/${telegramUsername.replace(/^@/, '')}`;
          orderTelegramLink.style.display = '';
        } else if (telegramId) {
          orderTelegramLink.href = `tg://user?id=${telegramId}`;
          orderTelegramLink.style.display = '';
        } else {
          orderTelegramLink.style.display = 'none';
        }
      }
      detailPromocode.textContent = order.promocode_code || '—';
      detailComment.textContent = order.comment || '—';
      detailItems.innerHTML = '';

      (order.items || []).forEach((item) => {
        const li = document.createElement('li');
        const label = item.type === 'course' ? '🎓' : '🧺';
        const access = item.type === 'course' ? (item.can_access ? 'доступ открыт' : 'после оплаты') : '';
        li.textContent = `${label} ${item.name || 'Товар'} — ${item.qty} × ${item.price} ₽ ${access}`;
        detailItems.appendChild(li);
      });

      detailTotal.textContent = `Итого: ${order.total || 0} ₽`;
    }

    async function loadOrders() {
      if (!currentUser) return;
      try {
        const status = statusFilter.value === 'all' ? undefined : statusFilter.value;
        const data = await apiGet('/admin/orders', { user_id: currentUser.telegram_id, status });
        renderOrders(data.items || []);
        setStatus('');
      } catch (e) {
        handleError(e, 'Не удалось загрузить заказы');
      }
    }

    async function loadOrderDetail(orderId) {
      try {
        const order = await apiGet(`/admin/orders/${orderId}`, { user_id: currentUser.telegram_id });
        renderOrderDetail(order);
      } catch (e) {
        handleError(e, 'Не удалось загрузить заказ');
      }
    }

    async function updateOrderStatus() {
      if (!currentUser || !selectedOrder) return;
      try {
        const payload = { user_id: currentUser.telegram_id, status: detailStatus.value };
        const updated = await apiPost(`/admin/orders/${selectedOrder.id}/status`, payload);
        setStatus('Статус заказа обновлён');
        renderOrderDetail(updated);
        await loadOrders();
      } catch (e) {
        handleError(e, 'Не удалось обновить статус заказа');
      }
    }

    statusFilter.addEventListener('change', loadOrders);
    saveStatusBtn.addEventListener('click', updateOrderStatus);

    async function loadCategories(targetSelect, type, { includeAllOption = false } = {}) {
      try {
        const categoriesRes = await apiGet('/categories', { type, active_only: true });
        const categoriesRaw = Array.isArray(categoriesRes) ? categoriesRes : categoriesRes?.items || [];
        const categories = categoriesRaw.filter((cat) => cat?.is_active);
        const targetMap = categoryMaps[type] || categoryMaps.basket;
        targetMap.clear();
        categories.forEach((cat) => {
          if (cat?.id !== undefined && cat?.id !== null) {
            targetMap.set(cat.id, cat);
          }
        });

        if (!targetSelect) return;
        targetSelect.innerHTML = '';

        if (includeAllOption) {
          const allOption = document.createElement('option');
          allOption.value = '';
          allOption.textContent = 'Все категории';
          targetSelect.appendChild(allOption);
        }

        Array.from(targetMap.values()).forEach((cat) => {
          const option = document.createElement('option');
          option.value = String(cat.id);
          option.textContent = cat.name;
          targetSelect.appendChild(option);
        });
      } catch (e) {
        handleError(e, 'Не удалось загрузить категории');
      }
    }

    function fillForm(form, data = {}) {
      if (!form) return;
      Object.entries(data).forEach(([key, value]) => {
        const el = form.elements.namedItem(key);
        if (!el) return;
        if (el.type === 'checkbox') {
          el.checked = Boolean(value);
          return;
        }
        if (el.type === 'radio') {
          const radio = form.querySelector(`input[name="${key}"][value="${value}"]`);
          if (radio) radio.checked = true;
          return;
        }
        if (el.tagName === 'SELECT' || el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
          el.value = value ?? '';
        }
      });
    }

    function serializeForm(form) {
      const payload = {};
      Array.from(form.elements).forEach((el) => {
        if (!el.name) return;
        const value = typeof el.value === 'string' ? el.value.trim() : el.value;
        if (el.type === 'checkbox') {
          payload[el.name] = el.checked;
          return;
        }
        if (el.name === 'category_id') {
          payload[el.name] = value && !Number.isNaN(Number(value)) ? Number(value) : null;
          return;
        }
        if (el.type === 'number') {
          const numberValue = value === '' || value === null ? null : Number(value);
          payload[el.name] = Number.isNaN(numberValue) ? null : numberValue;
        } else {
          payload[el.name] = value === '' ? null : value;
        }
      });
      return payload;
    }

    function createFormState(defaults = {}) {
      return { ...defaults };
    }

    function createSectionFormState(defaults = {}) {
      return {
        mode: 'create',
        currentId: null,
        formData: createFormState(defaults),
      };
    }

    function resetFormState(state, defaults = {}) {
      Object.keys(state).forEach((key) => delete state[key]);
      Object.assign(state, defaults);
    }

    function applyStateToForm(form, state) {
      if (!form || !state) return;
      Array.from(form.elements).forEach((el) => {
        if (!el.name || !(el.name in state)) return;
        const value = state[el.name];
        if (el.type === 'checkbox') {
          el.checked = Boolean(value);
        } else if (el.type === 'radio') {
          el.checked = el.value === value;
        } else {
          el.value = value ?? '';
        }
      });
    }

    function handleFormInput(event, state) {
      const el = event.target;
      if (!el?.name || !(el.name in state)) return;
      if (el.type === 'checkbox') {
        state[el.name] = el.checked;
        return;
      }
      if (el.type === 'number') {
        state[el.name] = el.value === '' ? null : Number(el.value);
        return;
      }
      state[el.name] = el.value;
    }

    function bindStateToForm(form, state) {
      if (!form || !state) return;
      applyStateToForm(form, state);
      form.addEventListener('input', (event) => handleFormInput(event, state));
      form.addEventListener('change', (event) => handleFormInput(event, state));
    }

    function setProductImagePreview(url) {
      if (!productImagePreview) return;
      if (url) {
        productImagePreview.style.backgroundImage = `url(${url})`;
        productImagePreview.textContent = '';
      } else {
        productImagePreview.style.backgroundImage = '';
        productImagePreview.textContent = 'Нет изображения';
      }
    }

    function setCourseImagePreview(url) {
      if (!courseImagePreview) return;
      if (url) {
        courseImagePreview.style.backgroundImage = `url(${url})`;
        courseImagePreview.textContent = '';
      } else {
        courseImagePreview.style.backgroundImage = '';
        courseImagePreview.textContent = 'Нет изображения';
      }
    }

    function resetProductImageInputs() {
      if (productImageFileInput) productImageFileInput.value = '';
      if (productImageUrlInput) productImageUrlInput.value = '';
      setProductImagePreview('');
    }

    function resetCourseImageInputs() {
      if (courseImageFileInput) courseImageFileInput.value = '';
      if (courseImageUrlInput) courseImageUrlInput.value = '';
      setCourseImagePreview('');
    }

    async function uploadProductImageFile() {
      const file = productImageFileInput?.files?.[0];
      if (!file) return;

      const formData = new FormData();
      formData.append('kind', 'product');
      formData.append('file', file);

      try {
        const res = await fetch('/api/admin/upload-image', { method: 'POST', body: formData });
        const data = await res.json();
        if (!data.ok) {
          throw new Error('Ошибка загрузки изображения');
        }

        if (productImageUrlInput) productImageUrlInput.value = data.url;
        setProductImagePreview(data.url);
      } catch (e) {
        handleError(e, 'Не удалось загрузить изображение товара');
      }
    }

    async function uploadCourseImageFile() {
      const file = courseImageFileInput?.files?.[0];
      if (!file) return;

      const formData = new FormData();
      formData.append('kind', 'course');
      formData.append('file', file);

      try {
        const res = await fetch('/api/admin/upload-image', { method: 'POST', body: formData });
        const data = await res.json();
        if (!data.ok) {
          throw new Error('Ошибка загрузки изображения');
        }

        if (courseImageUrlInput) courseImageUrlInput.value = data.url;
        setCourseImagePreview(data.url);
      } catch (e) {
        handleError(e, 'Не удалось загрузить изображение мастер-класса');
      }
    }

    async function uploadHomeBlockImageFile() {
      const file = homeBlockImageFileInput?.files?.[0];
      if (!file) return;

      const formData = new FormData();
      formData.append('file', file);

      try {
        const response = await fetch('/api/admin/home/upload_image', { method: 'POST', body: formData });
        const data = await response.json();
        const imageUrl = data.url;
        if (!response.ok || !imageUrl) {
          throw new Error(data?.detail || 'Ошибка загрузки изображения');
        }

        homeBlockState.formData.image_url = imageUrl;
        setHomeBlockImage(imageUrl, imageUrl);

        if (currentUser && (homeBlockState.currentId || currentBlockId)) {
          await saveHomeBlockImageUrl(imageUrl);
        } else {
          setStatus('Изображение загружено. Сохраните блок, чтобы применить.');
        }
      } catch (e) {
        handleError(e, 'Не удалось загрузить изображение блока');
      } finally {
        if (homeBlockImageFileInput) homeBlockImageFileInput.value = '';
      }
    }

    function renderImageRow(image, type, reloadFn) {
      const row = document.createElement('div');
      row.className = 'image-row';

      const thumb = document.createElement('img');
      thumb.src = image.image_url;
      thumb.alt = 'preview';
      thumb.className = 'image-thumb';

      const info = document.createElement('div');
      info.className = 'image-url-text';
      info.title = image.image_url;
      info.textContent = image.image_url;

      const meta = document.createElement('div');
      meta.className = 'image-meta muted';
      meta.textContent = `#${image.id} · позиция ${image.position}`;

      const actions = document.createElement('div');
      actions.className = 'image-row-actions';

      const previewBtn = document.createElement('button');
      previewBtn.type = 'button';
      previewBtn.className = 'btn secondary';
      previewBtn.textContent = 'Просмотр';
      previewBtn.addEventListener('click', () => openImageModal(image.image_url));

      const deleteBtn = document.createElement('button');
      deleteBtn.type = 'button';
      deleteBtn.className = 'btn secondary danger';
      deleteBtn.textContent = 'Удалить';
      deleteBtn.addEventListener('click', () => deleteGalleryImage(image.id, type, reloadFn));

      actions.appendChild(previewBtn);
      actions.appendChild(deleteBtn);

      const infoWrapper = document.createElement('div');
      infoWrapper.className = 'image-row-info';
      infoWrapper.appendChild(info);
      infoWrapper.appendChild(meta);

      row.appendChild(thumb);
      row.appendChild(infoWrapper);
      row.appendChild(actions);
      return row;
    }

    function renderImagesList(items, target, type, reloadFn) {
      if (!target) return;
      target.innerHTML = '';
      target.classList.remove('muted');
      if (!items || !items.length) {
        showImageListPlaceholder(target, 'Нет изображений');
        return;
      }
      items.forEach((image) => {
        target.appendChild(renderImageRow(image, type, reloadFn));
      });
    }

    async function loadProductImages(productId, target = productImagesList) {
      const reloadFn = () => loadProductImages(productId, target);
      if (!target) return;
      if (!productId) {
        showImageListPlaceholder(target, 'Сохраните товар, чтобы добавить фото.');
        return;
      }
      try {
        const data = await apiGet(`/admin/products/${productId}/images`, { user_id: currentUser.telegram_id });
        renderImagesList(data.items || data || [], target, 'product', reloadFn);
      } catch (e) {
        console.error(e);
        showImageListPlaceholder(target, 'Не удалось загрузить фотографии товара');
      }
    }

    async function loadCourseImages(courseId, target = courseImagesList) {
      const reloadFn = () => loadCourseImages(courseId, target);
      if (!target) return;
      if (!courseId) {
        showImageListPlaceholder(target, 'Сохраните мастер-класс, чтобы добавить фото.');
        return;
      }
      try {
        const data = await apiGet(`/admin/masterclasses/${courseId}/images`, { user_id: currentUser.telegram_id });
        renderImagesList(data.items || data || [], target, 'course', reloadFn);
      } catch (e) {
        console.error(e);
        showImageListPlaceholder(target, 'Не удалось загрузить фотографии мастер-класса');
      }
    }

    async function uploadProductGalleryFiles(event, target = productImagesList) {
      const files = Array.from(event.target?.files || []);
      if (!files.length) return;
      if (!productCurrentId) {
        alert('Сначала сохраните товар.');
        event.target.value = '';
        return;
      }
      const formData = new FormData();
      files.forEach((file) => formData.append('files', file));
      try {
        const res = await fetch(`${API_BASE}/admin/products/${productCurrentId}/images`, {
          method: 'POST',
          body: formData,
        });
        const data = await handleResponse(res);
        renderImagesList(data.items || data || [], target, 'product', () => loadProductImages(productCurrentId, target));
        setStatus('Фото товара добавлены');
      } catch (e) {
        handleError(e, 'Не удалось загрузить фото товара');
      }
      event.target.value = '';
    }

    function startProductInlineEdit(item) {
      if (!item) return;
      productFormState.mode = 'edit';
      productCurrentId = item.id;
      productFormState.currentId = productCurrentId;
      productFormTitle.textContent = `Редактировать товар #${item.id}`;
      if (productSubmitBtn) productSubmitBtn.textContent = 'Сохранить изменения';
      const productImageUrl = item.image_url || item.image || item.images?.[0]?.image_url || '';
      resetFormState(productFormState.formData, productFormDefaults);
      Object.assign(productFormState.formData, {
        category_id: item.category_id != null ? String(item.category_id) : '',
        name: item.name || '',
        price: item.price ?? null,
        image_url: productImageUrl,
        short_description: item.short_description || '',
        description: item.description || '',
        wb_url: item.wb_url || '',
        ozon_url: item.ozon_url || '',
        yandex_url: item.yandex_url || '',
        avito_url: item.avito_url || '',
        masterclass_url: item.masterclass_url || '',
        detail_url: item.detail_url || '',
      });
      applyStateToForm(productForm, productFormState.formData);
      if (productCategorySelect) {
        productCategorySelect.value = item.category_id != null ? String(item.category_id) : '';
      }
      if (productImageUrlInput) productImageUrlInput.value = productImageUrl || '';
      setProductImagePreview(productImageUrl);
      showImageListPlaceholder(productImagesList, 'Загрузите фото после сохранения.');
      showSection('product-list');
      loadProductImages(productCurrentId, productImagesList);
      productForm?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function startCourseInlineEdit(item) {
      if (!item) return;
      courseFormState.mode = 'edit';
      masterclassCurrentId = item.id;
      courseFormState.currentId = masterclassCurrentId;
      courseFormTitle.textContent = `Редактировать мастер-класс #${item.id}`;
      if (courseSubmitBtn) courseSubmitBtn.textContent = 'Сохранить изменения';
      const courseImageUrl = item.image_url || item.image || item.images?.[0]?.image_url || '';
      resetFormState(courseFormState.formData, courseFormDefaults);
      Object.assign(courseFormState.formData, {
        category_id: item.category_id != null ? String(item.category_id) : '',
        name: item.name || '',
        price: item.price ?? null,
        image_url: courseImageUrl,
        short_description: item.short_description || '',
        description: item.description || '',
        masterclass_url: item.masterclass_url || '',
        detail_url: item.detail_url || '',
      });
      applyStateToForm(courseForm, courseFormState.formData);
      if (courseCategorySelect) {
        courseCategorySelect.value = item.category_id != null ? String(item.category_id) : '';
      }

      if (courseImageUrlInput) courseImageUrlInput.value = courseImageUrl || '';
      setCourseImagePreview(courseImageUrl);
      showImageListPlaceholder(courseImagesList, 'Загрузите фото после сохранения.');
      showSection('course-list');
      loadCourseImages(masterclassCurrentId, courseImagesList);
      courseForm?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    async function uploadCourseGalleryFiles(event, target = courseImagesList) {
      const files = Array.from(event.target?.files || []);
      if (!files.length) return;
      if (!masterclassCurrentId) {
        alert('Сначала сохраните мастер-класс.');
        event.target.value = '';
        return;
      }
      const formData = new FormData();
      files.forEach((file) => formData.append('files', file));
      try {
        const res = await fetch(`${API_BASE}/admin/masterclasses/${masterclassCurrentId}/images`, {
          method: 'POST',
          body: formData,
        });
        const data = await handleResponse(res);
        renderImagesList(data.items || data || [], target, 'course', () => loadCourseImages(masterclassCurrentId, target));
        setStatus('Фото мастер-класса добавлены');
      } catch (e) {
        handleError(e, 'Не удалось загрузить фото мастер-класса');
      }
      event.target.value = '';
    }

    async function deleteGalleryImage(imageId, type, reloadFn) {
      if (!currentUser) return;
      const basePath = type === 'product' ? '/admin/products/images/' : '/admin/masterclasses/images/';
      try {
        await fetch(`${API_BASE}${basePath}${imageId}?user_id=${currentUser.telegram_id}`, {
          method: 'DELETE',
        }).then(handleResponse);
        if (reloadFn) {
          await reloadFn();
        } else if (type === 'product') {
          await loadProductImages(productCurrentId, productImagesList);
        } else {
          await loadCourseImages(masterclassCurrentId, courseImagesList);
        }
      } catch (e) {
        handleError(e, 'Не удалось удалить изображение');
      }
    }

    function renderCategories(items, targetTable, onEdit, onDelete, selectedId = null) {
      targetTable.innerHTML = '';
      if (!items || !items.length) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 8;
        cell.textContent = 'Категорий нет';
        cell.className = 'muted';
        row.appendChild(cell);
        targetTable.appendChild(row);
        return;
      }

      items.forEach((cat) => {
        const row = document.createElement('tr');
        row.dataset.id = cat.id;
        row.classList.toggle('selected', String(cat.id) === String(selectedId));
        const updated = formatDate(cat.updated_at);
        row.innerHTML = `
          <td>#${cat.id}</td>
          <td>${cat.name}</td>
          <td>${cat.slug || '—'}</td>
          <td>${cat.type || '—'}</td>
          <td>${cat.sort_order ?? 0}</td>
          <td>${cat.is_active ? 'Да' : 'Нет'}</td>
          <td>${updated}</td>
          <td>
            <div style="display:flex; gap:6px; flex-wrap:wrap;">
              <button class="btn secondary" type="button" data-edit="${cat.id}">Редактировать</button>
              <button class="btn secondary danger" type="button" data-delete="${cat.id}">Удалить</button>
            </div>
          </td>
        `;
        row.addEventListener('click', (event) => {
          if (event.target.closest('button')) return;
          onEdit?.(cat);
        });
        const editBtn = row.querySelector('button[data-edit]');
        const deleteBtn = row.querySelector('button[data-delete]');
        editBtn?.addEventListener('click', (e) => {
          e.stopPropagation();
          onEdit?.(cat);
        });
        deleteBtn?.addEventListener('click', (e) => {
          e.stopPropagation();
          onDelete?.(cat);
        });
        targetTable.appendChild(row);
      });
    }

    function findProductItemById(id, type) {
      const source = type === 'course' ? courseItems : productItems;
      return source.find((item) => String(item.id) === String(id));
    }

    async function handleProductTableClick(event) {
      const btn = event.target.closest('[data-action]');
      if (!btn) return;
      const { action, id, type } = btn.dataset;
      if (!id) return;
      const productType = type || 'basket';

      if (action === 'edit') {
        const item = findProductItemById(id, productType);
        if (!item) return;
        if (productType === 'basket') {
          startProductInlineEdit(item);
        } else {
          startCourseInlineEdit(item);
        }
        return;
      }

      if (action === 'toggle') {
        try {
          await apiPost(`/admin/products/${id}/toggle`, { user_id: currentUser.telegram_id, type: productType });
          setStatus('Статус товара обновлён');
          if (productType === 'basket') {
            await loadProducts();
          } else {
            await loadCourses();
          }
        } catch (e) {
          handleError(e, 'Не удалось переключить активность');
        }
      }
    }

    function fillCategoryForm(form, category, previewEl, defaultType = 'basket') {
      if (!form || !category) return;
      form.elements.name.value = category.name || '';
      form.elements.slug.value = category.slug || '';
      form.elements.description.value = category.description || '';
      form.elements.image_url.value = category.image_url || '';
      form.elements.sort_order.value = category.sort_order ?? 0;
      form.elements.is_active.checked = !!category.is_active;
      if (form.elements.type) {
        form.elements.type.value = category.type || defaultType;
      }
      setCategoryPreview(previewEl, category.image_url, category.image_version || category.updated_at);
      clearFileInput(form.elements.image_file);
    }

    function resetCategoryForm(form, titleEl, defaultTitle, defaultType = 'basket', previewEl = null, deleteBtn = null) {
      form?.reset();
      if (form?.elements?.is_active) form.elements.is_active.checked = true;
      if (form?.elements?.type) form.elements.type.value = defaultType;
      if (titleEl) titleEl.textContent = defaultTitle;
      if (deleteBtn) deleteBtn.style.display = 'none';
      setCategoryPreview(previewEl, '', null);
      clearFileInput(form?.elements?.image_file);
    }

    async function renderProductTable(items, targetTable, type) {
      targetTable.innerHTML = '';
      if (!items || !items.length) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 6;
        cell.textContent = 'Пусто';
        cell.className = 'muted';
        row.appendChild(cell);
        targetTable.appendChild(row);
        return;
      }

      const categoryMap = categoryMaps[type] || categoryMaps.basket;
      items.forEach((item) => {
        const row = document.createElement('tr');
        const categoryLabel = categoryMap.get(item.category_id)?.name || '—';
        const priceLabel = `${item.price || 0} ₽${type === 'course' && (!item.price || item.price === 0) ? ' (бесплатно)' : ''}`;
        row.innerHTML = `
          <td>#${item.id}</td>
          <td>${item.name}</td>
          <td>${categoryLabel}</td>
          <td>${priceLabel}</td>
          <td>${item.is_active ? 'Да' : 'Нет'}</td>
          <td style="display:flex; gap:6px; flex-wrap:wrap;">
            <button class="btn secondary" type="button" data-action="edit" data-id="${item.id}" data-type="${type}">Редактировать</button>
            <button class="btn secondary" type="button" data-action="toggle" data-id="${item.id}" data-type="${type}">${item.is_active ? 'Скрыть' : 'Показать'}</button>
          </td>
        `;
        targetTable.appendChild(row);
      });
    }

    async function submitCategoryForm(form, categoryId, defaultType = 'basket') {
      if (!currentUser || !form) return null;
      const formData = new FormData();
      formData.append('user_id', currentUser.telegram_id);
      formData.append('name', (form.elements.name.value || '').trim());
      const slug = (form.elements.slug.value || '').trim();
      if (slug) formData.append('slug', slug);
      formData.append('type', form.elements.type?.value || defaultType);
      const description = (form.elements.description.value || '').trim();
      if (description) formData.append('description', description);
      const imageUrl = (form.elements.image_url.value || '').trim();
      if (imageUrl) formData.append('image_url', imageUrl);
      formData.append('sort_order', form.elements.sort_order.value || '0');
      formData.append('is_active', form.elements.is_active.checked ? '1' : '0');
      const fileInput = form.querySelector('input[name="image_file"]');
      if (fileInput?.files?.[0]) {
        formData.append('image_file', fileInput.files[0]);
      }

      const path = categoryId ? `/admin/product-categories/${categoryId}` : '/admin/product-categories';
      const method = categoryId ? 'PUT' : 'POST';
      const res = await fetch(`${API_BASE}${path}`, { method, body: formData });
      return handleResponse(res);
    }

    async function loadProductCategories(selectedId = null) {
      if (!currentUser) return;
      try {
        const data = await apiGet('/admin/product-categories', { user_id: currentUser.telegram_id, type: 'basket' });
        productCategoryItems = data.items || [];
        renderCategories(
          productCategoryItems,
          productCategoriesTable,
          (cat) => startCategoryEdit(cat, 'basket'),
          (cat) => handleCategoryDelete(cat, 'basket'),
          selectedId ?? editingProductCategoryId
        );
      } catch (e) {
        handleError(e, 'Не удалось загрузить категории товаров');
      }
    }

    async function loadCourseCategories(selectedId = null) {
      if (!currentUser) return;
      try {
        const data = await apiGet('/admin/product-categories', { user_id: currentUser.telegram_id, type: 'course' });
        courseCategoryItems = data.items || [];
        renderCategories(
          courseCategoryItems,
          courseCategoriesTable,
          (cat) => startCategoryEdit(cat, 'course'),
          (cat) => handleCategoryDelete(cat, 'course'),
          selectedId ?? editingCourseCategoryId
        );
      } catch (e) {
        handleError(e, 'Не удалось загрузить категории мастер-классов');
      }
    }

    function startCategoryEdit(category, scope = 'basket') {
      if (!category) return;
      const isBasket = scope === 'basket';
      const form = isBasket ? productCategoryForm : courseCategoryForm;
      const titleEl = isBasket ? productCategoryFormTitle : courseCategoryFormTitle;
      const deleteBtn = isBasket ? productCategoryDeleteBtn : courseCategoryDeleteBtn;
      const previewEl = isBasket ? productCategoryImagePreview : courseCategoryImagePreview;
      const defaultType = isBasket ? 'basket' : 'course';

      if (isBasket) {
        editingProductCategoryId = category.id;
      } else {
        editingCourseCategoryId = category.id;
      }

      if (titleEl) titleEl.textContent = `Редактировать категорию #${category.id}`;
      if (deleteBtn) deleteBtn.style.display = '';
      fillCategoryForm(form, category, previewEl, defaultType);

      renderCategories(
        isBasket ? productCategoryItems : courseCategoryItems,
        isBasket ? productCategoriesTable : courseCategoriesTable,
        (cat) => startCategoryEdit(cat, scope),
        (cat) => handleCategoryDelete(cat, scope),
        category.id
      );
    }

    function resetCategoryState(scope = 'basket') {
      const isBasket = scope === 'basket';
      const form = isBasket ? productCategoryForm : courseCategoryForm;
      const titleEl = isBasket ? productCategoryFormTitle : courseCategoryFormTitle;
      const deleteBtn = isBasket ? productCategoryDeleteBtn : courseCategoryDeleteBtn;
      const previewEl = isBasket ? productCategoryImagePreview : courseCategoryImagePreview;
      const defaultType = isBasket ? 'basket' : 'course';
      const items = isBasket ? productCategoryItems : courseCategoryItems;
      if (isBasket) {
        editingProductCategoryId = null;
      } else {
        editingCourseCategoryId = null;
      }

      resetCategoryForm(form, titleEl, 'Создать категорию', defaultType, previewEl, deleteBtn);
      renderCategories(
        items,
        isBasket ? productCategoriesTable : courseCategoriesTable,
        (cat) => startCategoryEdit(cat, scope),
        (cat) => handleCategoryDelete(cat, scope),
        null
      );
    }

    async function handleCategoryDelete(category, scope = 'basket') {
      if (!category?.id || !currentUser) return;
      const confirmed = window.confirm('Удалить категорию?');
      if (!confirmed) return;
      try {
        await fetch(`${API_BASE}/admin/product-categories/${category.id}?user_id=${currentUser.telegram_id}`, {
          method: 'DELETE',
        }).then(handleResponse);
        setStatus('Категория удалена');
        resetCategoryState(scope);
        if (scope === 'basket') {
          await Promise.all([
            loadProductCategories(),
            loadCategories(productCategorySelect, 'basket'),
            loadCategories(productCategoryFilter, 'basket', { includeAllOption: true }),
          ]);
        } else {
          await Promise.all([
            loadCourseCategories(),
            loadCategories(courseCategorySelect, 'course'),
            loadCategories(courseCategoryFilter, 'course', { includeAllOption: true }),
          ]);
        }
      } catch (e) {
        handleError(e, 'Не удалось удалить категорию');
      }
    }

    async function handleProductCategoryFormSubmit(event) {
      event.preventDefault();
      if (!currentUser) return;
      try {
        const response = await submitCategoryForm(productCategoryForm, editingProductCategoryId, 'basket');
        const selectedId = editingProductCategoryId || response?.id || null;
        setStatus('Категория сохранена');
        resetCategoryState('basket');
        await Promise.all([
          loadProductCategories(selectedId),
          loadCategories(productCategorySelect, 'basket'),
          loadCategories(productCategoryFilter, 'basket', { includeAllOption: true }),
        ]);
      } catch (e) {
        handleError(e, 'Не удалось сохранить категорию товара');
      }
    }

    async function handleCourseCategoryFormSubmit(event) {
      event.preventDefault();
      if (!currentUser) return;
      try {
        const response = await submitCategoryForm(courseCategoryForm, editingCourseCategoryId, 'course');
        const selectedId = editingCourseCategoryId || response?.id || null;
        setStatus('Категория сохранена');
        resetCategoryState('course');
        await Promise.all([
          loadCourseCategories(selectedId),
          loadCategories(courseCategorySelect, 'course'),
          loadCategories(courseCategoryFilter, 'course', { includeAllOption: true }),
        ]);
      } catch (e) {
        handleError(e, 'Не удалось сохранить категорию мастер-класса');
      }
    }

    async function loadProducts() {
      if (!currentUser) return;
      try {
        const status = productsStatusFilter.value === 'all' ? undefined : productsStatusFilter.value;
        const data = await apiGet('/admin/products', { user_id: currentUser.telegram_id, type: 'basket', status });
        let items = data.items || [];
        productItems = items;
        const catFilter = productCategoryFilter.value;
        if (catFilter) {
          items = items.filter((i) => String(i.category_id ?? '') === String(catFilter));
        }
        renderProductTable(items, productsTable, 'basket');
      } catch (e) {
        handleError(e, 'Не удалось загрузить товары');
      }
    }

    async function loadCourses() {
      if (!currentUser) return;
      try {
        const status = coursesStatusFilter.value === 'all' ? undefined : coursesStatusFilter.value;
        const data = await apiGet('/admin/products', { user_id: currentUser.telegram_id, type: 'course', status });
        let items = data.items || [];
        courseItems = items;
        const catFilter = courseCategoryFilter.value;
        if (catFilter) {
          items = items.filter((i) => String(i.category_id ?? '') === String(catFilter));
        }
        renderProductTable(items, coursesTable, 'course');
      } catch (e) {
        handleError(e, 'Не удалось загрузить мастер-классы');
      }
    }

    function toInputDate(value) {
      if (!value) return '';
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return '';
      const offset = date.getTimezoneOffset();
      const local = new Date(date.getTime() - offset * 60000);
      return local.toISOString().slice(0, 16);
    }

    function fromInputDate(value) {
      if (!value) return null;
      const date = new Date(value);
      return Number.isNaN(date.getTime()) ? null : date.toISOString();
    }

    function updatePromoTargetState(scopeSelect, targetInput) {
      if (!scopeSelect || !targetInput) return;
      const needsTarget = ['product', 'category'].includes(scopeSelect.value);
      targetInput.disabled = !needsTarget;
      targetInput.placeholder = needsTarget ? 'Например, ID товара или категории' : 'Не требуется для выбранной области';
      if (!needsTarget) {
        targetInput.value = '';
      }
    }

    function applyPromocodeFilters(items) {
      const statusFilter = promoStatusFilter?.value || 'all';
      if (statusFilter === 'active') return items.filter((p) => p.active);
      if (statusFilter === 'inactive') return items.filter((p) => !p.active);
      return items;
    }

    const HOME_BLOCK_GROUPS = {
      hero: ['hero_main'],
      tiles: ['tile_home_kids', 'tile_process', 'tile_baskets', 'tile_learning'],
      texts: ['about_short', 'process_text'],
      entries: ['shop_entry', 'learning_entry'],
    };

    function cacheBustUrl(url, version) {
      if (!url) return '';
      const trimmed = url.trim();
      if (!trimmed) return '';
      const needsHttps = trimmed.startsWith('http://');
      const base = needsHttps ? trimmed.replace('http://', 'https://') : trimmed;
      if (!version) return base;
      const separator = base.includes('?') ? '&' : '?';
      return `${base}${separator}v=${version}`;
    }

    function normalizeHomeBlockFromApi(item) {
      if (!item) return null;
      const baseImageUrl = item.image_url || '';
      const imageUrlWithVersion = item.image_url_with_version || cacheBustUrl(baseImageUrl, item.image_version);
      return {
        ...item,
        order: item.order ?? item.sort_order ?? 0,
        button_url: item.button_url || item.button_link || '',
        block_key: item.block_key || item.slug || 'custom',
        image_url: baseImageUrl,
        image_url_with_version: imageUrlWithVersion || item.image_url_with_version || '',
        image_version: item.image_version,
      };
    }

    function getPreferredBlockImage(block) {
      if (!block) return '';
      return block.image_url_with_version || cacheBustUrl(block.image_url, block.image_version) || '';
    }

    function getTabForBlockKey(key) {
      if (!key) return 'hero';
      const match = Object.entries(HOME_BLOCK_GROUPS).find(([, list]) => list.includes(key));
      return match?.[0] || 'hero';
    }

    function getDefaultKeyForTab(tab) {
      const list = HOME_BLOCK_GROUPS[tab];
      if (list && list.length) return list[0];
      return 'hero_main';
    }

    function showHomeTab(tabName = 'hero') {
      currentHomeTab = tabName;
      homeTabButtons.forEach((btn) => {
        const isActive = btn.dataset.tab === tabName;
        btn.classList.toggle('active', isActive);
      });
      homeTabPanels.forEach((panel) => {
        if (panel.dataset.panel === 'posts') {
          panel.style.display = tabName === 'posts' ? '' : 'none';
        } else {
          panel.style.display = tabName === 'posts' ? 'none' : '';
        }
      });
      renderHomeBlocks(homeBlockItems, homeBlockFilter?.value || 'all');
      if (tabName === 'posts') {
        renderHomePosts(homePostItems);
      }
      if (homeBlockKeySelect && tabName !== 'posts' && homeBlockState.mode === 'create') {
        homeBlockKeySelect.value = getDefaultKeyForTab(tabName);
        homeBlockState.formData.block_key = homeBlockKeySelect.value;
      }
    }

    function resetHomeBlockForm() {
      homeBlockState.mode = 'create';
      homeBlockState.currentId = null;
      currentBlockId = null;
      homeBlockFormTitle.textContent = 'Создать блок';
      if (homeBlockSubmit) homeBlockSubmit.textContent = 'Сохранить';
      resetFormState(homeBlockState.formData, homeBlockDefaults);
      homeBlockState.formData.block_key = getDefaultKeyForTab(currentHomeTab || 'hero');
      applyStateToForm(homeBlockForm, homeBlockState.formData);
      setHomeBlockImage(homeBlockState.formData.image_url);
      if (homeBlockImageFileInput) homeBlockImageFileInput.value = '';
      setHomeBlockMeta(null);
      renderHomeBlocks(homeBlockItems, homeBlockFilter?.value || 'all');
    }

    function resetHomePostForm() {
      homePostState.mode = 'create';
      homePostState.currentId = null;
      currentPostId = null;
      homePostFormTitle.textContent = 'Создать пост';
      if (homePostSubmit) homePostSubmit.textContent = 'Сохранить';
      resetFormState(homePostState.formData, homePostDefaults);
      applyStateToForm(homePostForm, homePostState.formData);
    }

    function setHomeBlockImage(url, previewUrl = null) {
      const normalized = (url || '').trim();
      const previewNormalized = (previewUrl ?? url ?? '').trim();
      const safeUrl = normalized.startsWith('http://')
        ? normalized.replace('http://', 'https://')
        : normalized;
      const safePreview = previewNormalized.startsWith('http://')
        ? previewNormalized.replace('http://', 'https://')
        : previewNormalized;
      if (homeBlockImageUrlInput) {
        homeBlockImageUrlInput.value = normalized;
      }
      if (homeBlockImageHref && homeBlockImageLink) {
        const hasPreview = Boolean(safePreview);
        homeBlockImageHref.textContent = hasPreview ? safePreview : '—';
        homeBlockImageHref.href = hasPreview ? safePreview : '#';
        homeBlockImageLink.style.visibility = hasPreview ? 'visible' : 'hidden';
      }
      if (homeBlockImagePreview) {
        const fallback = HOME_IMAGE_PLACEHOLDER || HOME_IMAGE_GRADIENT;
        const gradientFallback = HOME_IMAGE_GRADIENT || HOME_IMAGE_PLACEHOLDER;
        homeBlockImagePreview.onerror = () => {
          homeBlockImagePreview.onerror = null;
          homeBlockImagePreview.src = gradientFallback;
        };
        homeBlockImagePreview.src = safePreview || fallback || gradientFallback;
        homeBlockImagePreview.style.display = 'block';
      }
    }

    function setHomeBlockMeta(block = null) {
      const idValue = block?.id ? `#${block.id}` : '—';
      if (homeBlockIdInput) {
        homeBlockIdInput.value = idValue;
      }
      if (homeBlockMeta) {
        homeBlockMeta.textContent = block?.id
          ? `ID ${idValue.replace('#', '')} • ключ ${block.block_key || '—'}`
          : 'Выберите блок в таблице слева.';
      }
      if (homeBlockKeySelect) {
        homeBlockKeySelect.disabled = Boolean(block?.id);
      }
    }

    function filterBlocksByTab(items, tabName) {
      if (!items?.length) return [];
      if (!tabName || tabName === 'all' || tabName === 'posts') return items;
      const keys = HOME_BLOCK_GROUPS[tabName] || [];
      if (!keys.length) return items;
      return items.filter((block) => keys.includes(block.block_key));
    }

    function renderHomeBlocks(items, tabName = homeBlockFilter?.value || 'all') {
      if (!homeBlocksList) return;
      const filtered = filterBlocksByTab(items, tabName || 'all');
      homeBlocksList.innerHTML = '';
      if (!filtered.length) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 7;
        cell.textContent = 'Блоки отсутствуют';
        cell.className = 'muted';
        row.appendChild(cell);
        homeBlocksList.appendChild(row);
        return;
      }

      filtered.forEach((block) => {
        const row = document.createElement('tr');
        row.dataset.blockId = block.id;
        row.classList.toggle('selected', String(block.id) === String(currentBlockId));
        const date = block.updated_at ? new Date(block.updated_at).toLocaleString('ru-RU') : '—';
        row.innerHTML = `
          <td>#${block.id}</td>
          <td>${block.block_key || '—'}</td>
          <td>${block.title || '—'}</td>
          <td>${block.is_active ? 'Да' : 'Нет'}</td>
          <td>${block.order ?? 0}</td>
          <td>${date}</td>
          <td>
            <div style="display:flex; gap:6px; flex-wrap:wrap;">
              <button class="btn secondary" type="button" data-action="edit-block" data-id="${block.id}">Редактировать</button>
              <button class="btn secondary danger" type="button" data-action="delete-block" data-id="${block.id}">Удалить</button>
            </div>
          </td>
        `;
        homeBlocksList.appendChild(row);
      });
    }

    function renderHomePosts(items) {
      if (!homePostsList) return;
      homePostsList.innerHTML = '';
      if (!items.length) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 6;
        cell.textContent = 'Посты отсутствуют';
        cell.className = 'muted';
        row.appendChild(cell);
        homePostsList.appendChild(row);
        return;
      }

      items.forEach((post) => {
        const row = document.createElement('tr');
        const date = post.created_at ? new Date(post.created_at).toLocaleString('ru-RU') : '—';
        row.innerHTML = `
          <td>#${post.id}</td>
          <td>${post.title}</td>
          <td>${post.is_active ? 'Да' : 'Нет'}</td>
          <td>${post.sort_order ?? 0}</td>
          <td>${date}</td>
          <td>
            <div style="display:flex; gap:6px; flex-wrap:wrap;">
              <button class="btn secondary" type="button" data-action="edit-post" data-id="${post.id}">Редактировать</button>
              <button class="btn secondary danger" type="button" data-action="delete-post" data-id="${post.id}">Удалить</button>
            </div>
          </td>
        `;
        homePostsList.appendChild(row);
      });
    }

    async function loadHomeBlocks(selectId = null) {
      if (!currentUser) return;
      try {
        const data = await apiGet('/admin/home/blocks', { user_id: currentUser.telegram_id });
        homeBlockItems = (data.items || data || [])
          .map((item) => normalizeHomeBlockFromApi(item))
          .filter(Boolean)
          .sort(
            (a, b) => (a.order ?? 0) - (b.order ?? 0) || Number(a.id || 0) - Number(b.id || 0)
          );
        const filterValue = homeBlockFilter?.value || 'all';
        const filtered = filterBlocksByTab(homeBlockItems, filterValue);
        const preferredId = selectId ?? currentBlockId ?? filtered[0]?.id ?? homeBlockItems[0]?.id;
        const selected = preferredId
          ? (filtered.find((block) => String(block.id) === String(preferredId)) ||
              homeBlockItems.find((block) => String(block.id) === String(preferredId)))
          : null;
        if (selected) {
          openHomeBlockEdit(selected);
        } else {
          currentBlockId = null;
          setHomeBlockMeta(null);
          renderHomeBlocks(homeBlockItems, filterValue);
          resetHomeBlockForm();
        }
      } catch (e) {
        handleError(e, 'Не удалось загрузить блоки');
      }
    }

    async function loadHomePosts() {
      if (!currentUser) return;
      try {
        const data = await apiGet('/admin/home/posts', { user_id: currentUser.telegram_id });
        homePostItems = data.items || data || [];
        renderHomePosts(homePostItems);
      } catch (e) {
        handleError(e, 'Не удалось загрузить посты');
      }
    }

    async function fetchHomeBlock(id) {
      if (!currentUser || !id) return null;
      const item = await apiGet(`/admin/home/blocks/${id}`, { user_id: currentUser.telegram_id });
      return normalizeHomeBlockFromApi(item);
    }

    async function fetchHomePost(id) {
      if (!currentUser || !id) return null;
      return apiGet(`/admin/home/posts/${id}`, { user_id: currentUser.telegram_id });
    }

    function openHomeBlockEdit(block) {
      homeBlockState.mode = 'edit';
      homeBlockState.currentId = block.id;
      currentBlockId = block.id;
      homeBlockFormTitle.textContent = `Редактировать блок #${block.id}`;
      if (homeBlockSubmit) homeBlockSubmit.textContent = 'Обновить блок';
      resetFormState(homeBlockState.formData, { ...homeBlockDefaults, ...block });
      applyStateToForm(homeBlockForm, homeBlockState.formData);
      setHomeBlockImage(block.image_url, getPreferredBlockImage(block));
      setHomeBlockMeta(block);
      renderHomeBlocks(homeBlockItems, homeBlockFilter?.value || 'all');
    }

    function openHomePostEdit(post) {
      homePostState.mode = 'edit';
      homePostState.currentId = post.id;
      currentPostId = post.id;
      homePostFormTitle.textContent = `Редактировать пост #${post.id}`;
      if (homePostSubmit) homePostSubmit.textContent = 'Обновить пост';
      resetFormState(homePostState.formData, { ...homePostDefaults, ...post });
      applyStateToForm(homePostForm, homePostState.formData);
    }

    async function deleteHomeBlock(id) {
      if (!currentUser || !id) return;
      try {
        await sendJson(`/admin/home/blocks/${id}?user_id=${currentUser.telegram_id}`, 'DELETE');
        await loadHomeBlocks();
        showToast('Блок удалён');
      } catch (e) {
        handleError(e, 'Не удалось удалить блок');
      }
    }

    async function deleteHomePost(id) {
      if (!currentUser || !id) return;
      try {
        await sendJson(`/admin/home/posts/${id}?user_id=${currentUser.telegram_id}`, 'DELETE');
        await loadHomePosts();
        showToast('Пост удалён');
      } catch (e) {
        handleError(e, 'Не удалось удалить пост');
      }
    }

    function handleHomeBlocksRowClick(event) {
      const actionBtn = event.target.closest('button[data-action]');
      if (actionBtn) return;
      const row = event.target.closest('tr[data-block-id]');
      if (!row) return;
      const block = homeBlockItems.find((item) => String(item.id) === String(row.dataset.blockId));
      if (!block) return;
      const tab = getTabForBlockKey(block.block_key);
      showHomeTab(tab);
      openHomeBlockEdit(block);
      homeBlockForm?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    async function handleHomeActionClick(event) {
      const btn = event.target.closest('button[data-action]');
      if (!btn) return;
      const action = btn.dataset.action;
      const id = btn.dataset.id;
      if (!action || !id) return;

      if (action === 'edit-block') {
        try {
          const block = await fetchHomeBlock(id);
          if (block) {
            const normalized = { ...homeBlockDefaults, ...block };
            const existingIndex = homeBlockItems.findIndex(
              (item) => String(item.id) === String(normalized.id)
            );
            if (existingIndex >= 0) {
              homeBlockItems[existingIndex] = { ...homeBlockItems[existingIndex], ...normalized };
            } else {
              homeBlockItems.push(normalized);
            }
            const tab = getTabForBlockKey(normalized.block_key);
            showHomeTab(tab);
            openHomeBlockEdit(normalized);
            homeBlockForm?.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        } catch (e) {
          handleError(e, 'Не удалось загрузить блок');
        }
        return;
      }

      if (action === 'edit-post') {
        try {
          const post = await fetchHomePost(id);
          if (post) {
            showHomeTab('posts');
            openHomePostEdit(post);
            homePostForm?.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        } catch (e) {
          handleError(e, 'Не удалось загрузить пост');
        }
        return;
      }

      if (action === 'delete-block') {
        deleteHomeBlock(id);
        return;
      }
      if (action === 'delete-post') {
        deleteHomePost(id);
      }
    }

    async function saveHomeBlockImageUrl(imageUrl) {
      const targetId = homeBlockState.currentId || currentBlockId;
      if (!targetId || !currentUser || !homeBlockForm) return;
      const payload = serializeForm(homeBlockForm);
      payload.order = payload.order ? Number(payload.order) : 0;
      payload.block_key = payload.block_key || homeBlockState.formData.block_key;
      payload.image_url = imageUrl;
      const path = `/admin/home/blocks/${targetId}?user_id=${currentUser.telegram_id}`;
      try {
        await sendJson(path, 'PUT', payload);
        setStatus('Изображение блока обновлено');
        await loadHomeBlocks(targetId);
      } catch (e) {
        handleError(e, 'Изображение загружено, но не удалось сохранить блок');
      }
    }

    async function handleHomeBlockSubmit(event) {
      event.preventDefault();
      if (!currentUser) return;
      const payload = serializeForm(homeBlockForm);
      payload.order = payload.order ? Number(payload.order) : 0;
      const query = `?user_id=${currentUser.telegram_id}`;
      homeBlockState.currentId = currentBlockId;
      const path = homeBlockState.currentId
        ? `/admin/home/blocks/${homeBlockState.currentId}${query}`
        : `/admin/home/blocks${query}`;
      const method = homeBlockState.currentId ? 'PUT' : 'POST';
      try {
        const saved = await sendJson(path, method, payload);
        const targetId = saved?.id || homeBlockState.currentId || currentBlockId;
        setStatus('Сохранено');
        await loadHomeBlocks(targetId);
        if (!targetId) {
          resetHomeBlockForm();
        }
      } catch (e) {
        handleError(e, 'Не удалось сохранить блок');
      }
    }

    async function handleHomePostSubmit(event) {
      event.preventDefault();
      if (!currentUser) return;
      const payload = serializeForm(homePostForm);
      payload.sort_order = payload.sort_order ? Number(payload.sort_order) : 0;
      const query = `?user_id=${currentUser.telegram_id}`;
      homePostState.currentId = currentPostId;
      const path = homePostState.currentId
        ? `/admin/home/posts/${homePostState.currentId}${query}`
        : `/admin/home/posts${query}`;
      const method = homePostState.currentId ? 'PUT' : 'POST';
      try {
        await sendJson(path, method, payload);
        setStatus('Пост сохранён');
        resetHomePostForm();
        await loadHomePosts();
      } catch (e) {
        handleError(e, 'Не удалось сохранить пост');
      }
    }
    function findPromocodeById(id) {
      return promocodeItems.find((p) => String(p.id) === String(id));
    }

    async function handlePromoTableClick(event) {
      const btn = event.target.closest('[data-edit], [data-delete], [data-toggle]');
      if (!btn) return;
      const promoId = btn.dataset.edit || btn.dataset.delete || btn.dataset.toggle;
      if (!promoId) return;
      const promo = findPromocodeById(promoId);

      if (btn.dataset.edit) {
        if (promo) openPromocodeEdit(promo);
        return;
      }
      if (btn.dataset.delete) {
        deletePromocode(Number(promoId));
        return;
      }
      if (btn.dataset.toggle && promo) {
        togglePromocodeActive(promo);
      }
    }

    function renderPromocodes(promos) {
      promoTable.innerHTML = '';
      if (!promos || !promos.length) {
        const emptyRow = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 9;
        cell.textContent = 'Промокоды отсутствуют';
        cell.className = 'muted';
        emptyRow.appendChild(cell);
        promoTable.appendChild(emptyRow);
        return;
      }

      const scopeLabels = {
        all: 'Весь заказ',
        basket: 'Корзинки',
        course: 'Мастер-классы',
        product: 'Товар/курс',
        category: 'Категория корзинок',
      };

      promos.forEach((promo) => {
        const row = document.createElement('tr');
        const discountText = promo.discount_type === 'percent' ? `${promo.discount_value}%` : `${promo.discount_value} ₽`;
        const period = [promo.date_start, promo.date_end]
          .filter(Boolean)
          .map((d) => new Date(d).toLocaleString('ru-RU'))
          .join(' — ');
        const statusText = promo.active ? 'Активен' : 'Не активен';
        const usageText = `${promo.used_count || 0}/${promo.max_uses || '∞'}`;

        row.innerHTML = `
          <td>#${promo.id}</td>
          <td>${promo.code}</td>
          <td>${promo.discount_type === 'percent' ? 'Процент' : 'Фиксированная'}</td>
          <td>${discountText}</td>
          <td>${scopeLabels[promo.scope] || promo.scope}${promo.target_id ? ` #${promo.target_id}` : ''}</td>
          <td>${period || '—'}</td>
          <td>${statusText}</td>
          <td>${usageText}</td>
          <td style="display:flex; gap:6px; flex-wrap:wrap;">
            <button class="btn secondary" type="button" data-toggle="${promo.id}">${promo.active ? 'Выключить' : 'Активировать'}</button>
            <button class="btn secondary" type="button" data-edit="${promo.id}">Редактировать</button>
            <button class="btn secondary" type="button" data-delete="${promo.id}">Удалить</button>
          </td>
        `;
        promoTable.appendChild(row);
      });
    }

    async function loadPromocodes() {
      if (!currentUser) return;
      try {
        const data = await apiGet('/admin/promocodes', { user_id: currentUser.telegram_id });
        const items = (data.items || []).sort((a, b) => {
          const aDate = a.created_at ? new Date(a.created_at).getTime() : 0;
          const bDate = b.created_at ? new Date(b.created_at).getTime() : 0;
          return bDate !== aDate ? bDate - aDate : (b.id || 0) - (a.id || 0);
        });
        promocodeItems = items;
        renderPromocodes(applyPromocodeFilters(items));
      } catch (e) {
        handleError(e, 'Не удалось загрузить промокоды');
      }
    }

    function openPromocodeEdit(promo) {
      promoCreateState.mode = 'edit';
      promoCurrentId = promo.id;
      promoCreateState.currentId = promoCurrentId;
      promoCreateTitle.textContent = `Редактировать промокод #${promo.id}`;
      if (promoSubmitBtn) promoSubmitBtn.textContent = 'Сохранить изменения';
      resetFormState(promoCreateState.formData, promoFormDefaults);
      Object.assign(promoCreateState.formData, {
        code: promo.code || '',
        discount_type: promo.discount_type || 'percent',
        discount_value: promo.discount_value ?? null,
        scope: promo.scope || 'all',
        target_id: promo.target_id ?? '',
        date_start: toInputDate(promo.date_start),
        date_end: toInputDate(promo.date_end),
        max_uses: promo.max_uses ?? '',
        active: promo.active !== false,
        one_per_user: Boolean(promo.one_per_user),
      });
      applyStateToForm(promoCreateForm, promoCreateState.formData);
      updatePromoTargetState(promoCreateScope, promoCreateTarget);
      showSection('promocode-list');
      promoCreateForm?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    async function deletePromocode(id) {
      if (!currentUser || !id) return;
      if (!confirm('Удалить промокод?')) return;
      try {
        await sendJson(`/admin/promocodes/${id}?user_id=${currentUser.telegram_id}`, 'DELETE');
        setStatus('Промокод удалён');
        await loadPromocodes();
      } catch (e) {
        handleError(e, 'Не удалось удалить промокод');
      }
    }

    async function togglePromocodeActive(promo) {
      if (!currentUser || !promo?.id) return;
      try {
        await sendJson(`/admin/promocodes/${promo.id}`, 'PUT', {
          user_id: currentUser.telegram_id,
          active: !promo.active,
        });
        setStatus(promo.active ? 'Промокод выключен' : 'Промокод активирован');
        await loadPromocodes();
      } catch (e) {
        handleError(e, 'Не удалось обновить статус промокода');
      }
    }

    function resetPromoCreateForm() {
      promoCreateState.mode = 'create';
      promoCurrentId = null;
      promoCreateState.currentId = null;
      promoCreateTitle.textContent = 'Создать промокод';
      if (promoSubmitBtn) promoSubmitBtn.textContent = 'Создать промокод';
      resetFormState(promoCreateState.formData, promoFormDefaults);
      applyStateToForm(promoCreateForm, promoCreateState.formData);
      updatePromoTargetState(promoCreateScope, promoCreateTarget);
    }

    async function submitPromocodeCreate(event) {
      event.preventDefault();
      if (!currentUser) return;

      const payload = {
        user_id: currentUser.telegram_id,
        code: (promoCreateCode.value || '').trim(),
        discount_type: promoCreateDiscountType.value,
        discount_value:
          promoCreateDiscountValue.value === '' ? null : Number(promoCreateDiscountValue.value || 0),
        scope: promoCreateScope.value,
        target_id: promoCreateTarget.value ? Number(promoCreateTarget.value) : null,
        date_start: fromInputDate(promoCreateDateStart.value),
        date_end: fromInputDate(promoCreateDateEnd.value),
        max_uses: promoCreateMaxUses.value ? Number(promoCreateMaxUses.value) : null,
        active: promoCreateActive.checked,
        one_per_user: promoCreateOnePerUser.checked,
      };

      try {
        if (promoCurrentId) {
          await sendJson(`/admin/promocodes/${promoCurrentId}`, 'PUT', payload);
          setStatus('Промокод обновлён');
        } else {
          await sendJson('/admin/promocodes', 'POST', payload);
          setStatus('Промокод создан');
        }
        resetPromoCreateForm();
        await loadPromocodes();
        showSection('promocode-list');
      } catch (e) {
        handleError(e, 'Не удалось сохранить промокод');
      }
    }

    async function handleProductFormSubmit(event) {
      event.preventDefault();
      if (!currentUser) return;
      const payload = serializeForm(productForm);
      payload.user_id = currentUser.telegram_id;
      payload.type = 'basket';
      payload.price = payload.price ? Number(payload.price) : 0;
      payload.image_url = productImageUrlInput?.value.trim() || null;

      try {
        if (productCurrentId) {
          await fetch(`${API_BASE}/admin/products/${productCurrentId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          }).then(handleResponse);
          setStatus('Товар сохранён');
        } else {
          await apiPost('/admin/products', payload);
          setStatus('Товар создан');
        }
        resetProductCreateForm();
        await loadProducts();
      } catch (e) {
        handleError(e, 'Не удалось сохранить товар');
      }
    }

    function resetProductCreateForm() {
      productFormState.mode = 'create';
      productCurrentId = null;
      productFormState.currentId = null;
      productFormTitle.textContent = 'Создать товар';
      if (productSubmitBtn) productSubmitBtn.textContent = 'Создать товар';
      resetFormState(productFormState.formData, productFormDefaults);
      applyStateToForm(productForm, productFormState.formData);
      resetProductImageInputs();
      showImageListPlaceholder(productImagesList, 'Сохраните товар, чтобы добавить фото.');
    }

    function resetCourseFormState() {
      courseFormState.mode = 'create';
      masterclassCurrentId = null;
      courseFormState.currentId = null;
      courseFormTitle.textContent = 'Создать мастер-класс';
      if (courseSubmitBtn) courseSubmitBtn.textContent = 'Создать мастер-класс';
      resetFormState(courseFormState.formData, courseFormDefaults);
      applyStateToForm(courseForm, courseFormState.formData);
      resetCourseImageInputs();
      showImageListPlaceholder(courseImagesList, 'Сохраните мастер-класс, чтобы добавить фото.');
    }

    async function handleCourseFormSubmit(event) {
      event.preventDefault();
      if (!currentUser) return;
      const payload = serializeForm(courseForm);
      payload.user_id = currentUser.telegram_id;
      payload.type = 'course';
      payload.price = payload.price ? Number(payload.price) : 0;
      payload.image_url = courseImageUrlInput?.value.trim() || null;

      try {
        if (masterclassCurrentId) {
          await fetch(`${API_BASE}/admin/products/${masterclassCurrentId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          }).then(handleResponse);
          setStatus('Мастер-класс сохранён');
        } else {
          await apiPost('/admin/products', payload);
          setStatus('Мастер-класс сохранён');
        }
        resetCourseFormState();
        await loadCourses();
      } catch (e) {
        handleError(e, 'Не удалось сохранить мастер-класс');
      }
    }

    bindStateToForm(productForm, productFormState.formData);
    bindStateToForm(courseForm, courseFormState.formData);
    bindStateToForm(promoCreateForm, promoCreateState.formData);
    bindStateToForm(homeBlockForm, homeBlockState.formData);
    bindStateToForm(homePostForm, homePostState.formData);
    setHomeBlockImage(homeBlockState.formData.image_url || '');

    promoCreateForm?.addEventListener('submit', submitPromocodeCreate);
    promoCreateReset?.addEventListener('click', resetPromoCreateForm);
    promoCreateScope?.addEventListener('change', () => updatePromoTargetState(promoCreateScope, promoCreateTarget));
    productForm.addEventListener('submit', handleProductFormSubmit);
    courseForm.addEventListener('submit', handleCourseFormSubmit);
    homeBlockForm?.addEventListener('submit', handleHomeBlockSubmit);
    homeBlockImageUrlInput?.addEventListener('input', (event) => {
      setHomeBlockImage(event.target.value);
    });
    homePostForm?.addEventListener('submit', handleHomePostSubmit);
    productCategoryForm?.addEventListener('submit', handleProductCategoryFormSubmit);
    courseCategoryForm?.addEventListener('submit', handleCourseCategoryFormSubmit);
    productsTable?.addEventListener('click', handleProductTableClick);
    coursesTable?.addEventListener('click', handleProductTableClick);
    promoTable?.addEventListener('click', handlePromoTableClick);
    productCancel.addEventListener('click', () => {
      resetProductCreateForm();
      productForm?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
    courseCancel.addEventListener('click', () => {
      resetCourseFormState();
      courseForm?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
    productReset.addEventListener('click', () => {
      resetProductCreateForm();
      showSection('product-list');
      productForm?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
    courseReset.addEventListener('click', () => {
      resetCourseFormState();
      showSection('course-list');
      courseForm?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
    productCategoryReset?.addEventListener('click', () => resetCategoryState('basket'));
    courseCategoryReset?.addEventListener('click', () => resetCategoryState('course'));
    productCategoryDeleteBtn?.addEventListener('click', () => {
      const category = productCategoryItems.find((cat) => String(cat.id) === String(editingProductCategoryId));
      handleCategoryDelete(category || { id: editingProductCategoryId }, 'basket');
    });
    courseCategoryDeleteBtn?.addEventListener('click', () => {
      const category = courseCategoryItems.find((cat) => String(cat.id) === String(editingCourseCategoryId));
      handleCategoryDelete(category || { id: editingCourseCategoryId }, 'course');
    });
    homeBlockReset?.addEventListener('click', resetHomeBlockForm);
    homePostReset?.addEventListener('click', resetHomePostForm);

    productImageFileInput?.addEventListener('change', uploadProductImageFile);
    courseImageFileInput?.addEventListener('change', uploadCourseImageFile);
    homeBlockImageFileInput?.addEventListener('change', uploadHomeBlockImageFile);
    productCategoryImageFile?.addEventListener('change', (event) => {
      const file = event.target.files?.[0];
      if (file) {
        setCategoryPreview(productCategoryImagePreview, URL.createObjectURL(file), Date.now());
      }
    });
    courseCategoryImageFile?.addEventListener('change', (event) => {
      const file = event.target.files?.[0];
      if (file) {
        setCategoryPreview(courseCategoryImagePreview, URL.createObjectURL(file), Date.now());
      }
    });
    productGalleryInput?.addEventListener('change', uploadProductGalleryFiles);
    courseGalleryInput?.addEventListener('change', uploadCourseGalleryFiles);
    productImageUrlInput?.addEventListener('input', () => setProductImagePreview(productImageUrlInput.value.trim()));
    courseImageUrlInput?.addEventListener('input', () => setCourseImagePreview(courseImageUrlInput.value.trim()));
    imageModalClose?.addEventListener('click', closeImageModal);
    imageModal?.addEventListener('click', (event) => {
      if (event.target.id === 'image-modal') closeImageModal();
    });
    promoStatusFilter?.addEventListener('change', () => {
      renderPromocodes(applyPromocodeFilters(promocodeItems));
    });

    homeBlockFilter?.addEventListener('change', () => {
      const filterValue = homeBlockFilter.value || 'all';
      const visible = filterBlocksByTab(homeBlockItems, filterValue);
      renderHomeBlocks(homeBlockItems, filterValue);
      const target =
        visible.find((block) => String(block.id) === String(currentBlockId)) || visible[0];
      if (target) {
        const tab = getTabForBlockKey(target.block_key);
        showHomeTab(tab);
        openHomeBlockEdit(target);
      } else {
        resetHomeBlockForm();
      }
    });

    homeTabButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab || 'hero';
        showHomeTab(tab);
        if (tab === 'posts') {
          loadHomePosts();
        } else {
          loadHomeBlocks();
        }
      });
    });
    homeBlocksList?.addEventListener('click', handleHomeBlocksRowClick);
    document.addEventListener('click', handleHomeActionClick);

    reviewStatusFilter?.addEventListener('change', loadReviews);
    reviewProductFilter?.addEventListener('change', loadReviews);
    reviewUserFilter?.addEventListener('input', () => {
      const filtered = applyReviewSearchFilter(reviewItems);
      renderReviewsTable(filtered);
    });
    reviewResetBtn?.addEventListener('click', () => {
      reviewStatusFilter.value = 'all';
      reviewProductFilter.value = '';
      reviewUserFilter.value = '';
      loadReviews();
    });
    document.getElementById('review-modal-close')?.addEventListener('click', closeReviewModal);
    document.getElementById('review-modal')?.addEventListener('click', (event) => {
      if (event.target.id === 'review-modal') closeReviewModal();
    });

    productsStatusFilter.addEventListener('change', loadProducts);
    coursesStatusFilter.addEventListener('change', loadCourses);
    productCategoryFilter.addEventListener('change', loadProducts);
    courseCategoryFilter.addEventListener('change', loadCourses);

    async function initApp() {
      console.log('[admin] initApp start');
      try {
        currentUser = await getCurrentUser({ includeNotes: true });
        if (!requireAdmin(currentUser)) return;

        resetHomeBlockForm();
        resetHomePostForm();
        resetFaqFormState();

        await Promise.all([
          loadCategories(productCategoryFilter, 'basket', { includeAllOption: true }),
          loadCategories(productCategorySelect, 'basket'),
          loadCategories(courseCategoryFilter, 'course', { includeAllOption: true }),
          loadCategories(courseCategorySelect, 'course'),
        ]);

        await Promise.all([loadProductCategories(), loadCourseCategories()]);

        resetPromoCreateForm();
        await loadOrders();
        await loadProducts();
        await loadCourses();
        await loadPromocodes();
        await loadReviewProducts();
        await loadReviews();
        await Promise.all([loadHomeBlocks(), loadHomePosts()]);
        await loadBrandingSettings();
        showSection('orders');
        console.log('[admin] initApp done');
      } catch (e) {
        handleError(e, 'Ошибка загрузки админки');
      }
    }

    initApp();
  </script>

  <div id="image-modal" class="admin-modal hidden">
    <div class="admin-modal__content image-modal__content">
      <div class="admin-modal__header">
        <h3>Предпросмотр</h3>
        <button class="btn secondary" type="button" id="image-modal-close">Закрыть</button>
      </div>
      <div class="admin-modal__body image-modal__body">
        <img id="image-modal-picture" src="" alt="Просмотр изображения">
      </div>
    </div>
  </div>

  <div id="review-modal" class="admin-modal hidden">
    <div class="admin-modal__content">
      <div class="admin-modal__header">
        <h3 id="review-modal-title"></h3>
        <button class="btn secondary" type="button" id="review-modal-close">Закрыть</button>
      </div>
      <div class="admin-modal__body">
        <p id="review-modal-text" class="review-modal-text"></p>
        <div id="review-modal-photos" class="review-modal-gallery"></div>
      </div>
    </div>
  </div>
</body>
</html>