<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MiniDeN — Админка</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      color-scheme: light;
      --bg: #0b0c10;
      --card: rgba(255, 255, 255, 0.06);
      --text: #f6f7fb;
      --muted: #c7c9d3;
      --accent: #ffb800;
      --accent-2: #7bd8ff;
      --shadow: 0 14px 50px rgba(0, 0, 0, 0.35);
      --nav: rgba(17, 17, 19, 0.82);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 10% 20%, rgba(255, 184, 0, 0.06), transparent 35%),
        radial-gradient(circle at 80% 10%, rgba(123, 216, 255, 0.08), transparent 30%),
        radial-gradient(circle at 60% 80%, rgba(255, 184, 0, 0.05), transparent 32%),
        #0b0c10;
      color: var(--text);
      min-height: 100vh;
      padding: 0 18px 48px;
    }

    .top-nav {
      position: sticky;
      top: 0;
      z-index: 20;
      background: var(--nav);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 12px;
      margin: 0 -18px;
    }

    .brand { display: flex; flex-direction: column; gap: 2px; font-weight: 800; letter-spacing: -0.02em; }
    .brand span { color: var(--muted); font-size: 13px; font-weight: 600; letter-spacing: normal; }

    .nav-links { display: flex; gap: 12px; align-items: center; }
    .nav-links a { color: var(--muted); text-decoration: none; font-weight: 600; padding: 10px 12px; border-radius: 12px; transition: background 0.15s ease, color 0.15s ease; }
    .nav-links a:hover { color: var(--text); background: rgba(255, 255, 255, 0.06); }
    .nav-links a.active { color: var(--text); background: linear-gradient(135deg, rgba(255, 184, 0, 0.18), rgba(123, 216, 255, 0.14)); }

    .menu-toggle { display: none; background: transparent; border: 1px solid rgba(255, 255, 255, 0.12); color: var(--text); border-radius: 12px; padding: 10px 12px; cursor: pointer; }

    main { max-width: 1180px; margin: 0 auto; padding-top: 28px; display: flex; flex-direction: column; gap: 18px; }

    h1 { margin: 0 0 8px; }
    h2 { margin: 0 0 10px; }

    .card { background: var(--card); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 16px; padding: 14px; box-shadow: var(--shadow); backdrop-filter: blur(6px); }
    .section-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap; }
    .muted { color: var(--muted); }
    .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 14px; border-radius: 12px; border: none; cursor: pointer; font-weight: 700; color: #0b0c10; background: linear-gradient(135deg, #ffb800, #ff8f3f); box-shadow: 0 10px 30px rgba(255, 184, 0, 0.25); }
    .btn.secondary { background: rgba(255, 255, 255, 0.08); color: var(--text); box-shadow: none; border: 1px solid rgba(255, 255, 255, 0.12); }
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { padding: 10px 8px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.08); }
    .table th { color: var(--muted); font-weight: 700; }
    select { padding: 8px 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06); color: var(--text); }
    .grid { display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
    .list { margin: 0; padding: 0; list-style: none; display: grid; gap: 8px; }
    .list li { padding: 10px 12px; border-radius: 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.06); }

    @media (max-width: 780px) {
      .nav-links { display: none; }
      .nav-links.open { display: flex; flex-direction: column; align-items: flex-start; width: 100%; margin-top: 10px; }
      .top-nav { flex-wrap: wrap; }
      .menu-toggle { display: inline-flex; }
    }
  </style>
</head>
<body>
  <nav class="top-nav">
    <div class="brand">
      MiniDeN
      <span>уютные корзинки</span>
    </div>
    <button class="menu-toggle" aria-label="Открыть меню">☰</button>
    <div class="nav-links open">
      <a href="index.html">Главная</a>
      <a href="products.html">Товары</a>
      <a href="masterclasses.html">Мастер-классы</a>
      <a href="cart.html">Корзина</a>
      <a href="profile.html">Профиль</a>
      <a href="admin.html" id="admin-link" class="active">Админка</a>
    </div>
  </nav>

  <main>
    <header>
      <h1>Админка</h1>
      <p class="muted">Управляйте заказами и пользователями через REST API backend.</p>
    </header>

    <div id="status" class="card" style="display:none"></div>

    <section class="card" id="access-denied" style="display:none; text-align:center;">
      <h2>Доступ запрещён</h2>
      <p class="muted">Админка доступна только администраторам MiniDeN. Авторизуйтесь через Telegram в боте и откройте эту страницу из WebApp.</p>
    </section>

    <section class="card" id="orders-section" style="display:none;">
      <div class="section-header">
        <h2>Заказы</h2>
        <div style="display:flex; gap:8px; align-items:center;">
          <label class="muted">Статус</label>
          <select id="status-filter">
            <option value="all">Все</option>
            <option value="new">Новый</option>
            <option value="in_progress">В работе</option>
            <option value="paid">Оплачен</option>
            <option value="sent">Отправлен</option>
            <option value="archived">Архив</option>
          </select>
        </div>
      </div>
      <table class="table" aria-label="Список заказов">
        <thead>
          <tr>
            <th>ID</th>
            <th>Покупатель</th>
            <th>Сумма</th>
            <th>Статус</th>
            <th>Дата</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="orders-body"></tbody>
      </table>
    </section>

    <section class="card" id="order-detail" style="display:none;">
      <div class="section-header">
        <h2>Заказ <span id="detail-id"></span></h2>
        <div style="display:flex; gap:8px; align-items:center;">
          <label class="muted">Статус</label>
          <select id="detail-status">
            <option value="new">Новый</option>
            <option value="in_progress">В работе</option>
            <option value="paid">Оплачен</option>
            <option value="sent">Отправлен</option>
            <option value="archived">Архив</option>
          </select>
          <button class="btn secondary" type="button" id="save-status">Сохранить</button>
        </div>
      </div>
      <div class="grid" style="margin-top:12px;">
        <div>
          <div class="muted">Клиент</div>
          <div id="detail-client">—</div>
          <div class="muted" style="margin-top:8px;">Контакт</div>
          <div id="detail-contact">—</div>
          <div class="muted" style="margin-top:8px;">Промокод</div>
          <div id="detail-promocode">—</div>
        </div>
        <div>
          <div class="muted">Комментарий</div>
          <div id="detail-comment">—</div>
        </div>
      </div>
      <h3>Товары</h3>
      <ul class="list" id="detail-items"></ul>
      <div class="muted" id="detail-total"></div>
    </section>
  </main>

  <script src="js/api.js"></script>
  <script>
    const toggle = document.querySelector('.menu-toggle');
    const nav = document.querySelector('.nav-links');
    toggle?.addEventListener('click', () => nav?.classList.toggle('open'));

    const adminLink = document.getElementById('admin-link');
    const statusBox = document.getElementById('status');
    const accessDenied = document.getElementById('access-denied');
    const ordersSection = document.getElementById('orders-section');
    const orderDetail = document.getElementById('order-detail');
    const ordersBody = document.getElementById('orders-body');
    const statusFilter = document.getElementById('status-filter');
    const detailId = document.getElementById('detail-id');
    const detailStatus = document.getElementById('detail-status');
    const saveStatusBtn = document.getElementById('save-status');
    const detailClient = document.getElementById('detail-client');
    const detailContact = document.getElementById('detail-contact');
    const detailPromocode = document.getElementById('detail-promocode');
    const detailComment = document.getElementById('detail-comment');
    const detailItems = document.getElementById('detail-items');
    const detailTotal = document.getElementById('detail-total');

    let currentUser = null;
    let selectedOrder = null;

    function setStatus(message, isError = false) {
      if (!message) {
        statusBox.style.display = 'none';
        statusBox.textContent = '';
        statusBox.classList.remove('error');
        return;
      }
      statusBox.style.display = 'block';
      statusBox.textContent = message;
      statusBox.classList.toggle('error', isError);
    }

    function updateAdminLinkVisibility() {
      adminLink.style.display = currentUser?.is_admin ? '' : 'none';
    }

    function requireAdmin(profile) {
      if (!profile || !profile.is_admin) {
        setStatus('Доступ запрещён', true);
        accessDenied.style.display = 'block';
        ordersSection.style.display = 'none';
        orderDetail.style.display = 'none';
        return false;
      }
      accessDenied.style.display = 'none';
      return true;
    }

    function renderOrders(orders) {
      ordersBody.innerHTML = '';
      if (!orders || !orders.length) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 6;
        cell.textContent = 'Заказов нет';
        cell.className = 'muted';
        row.appendChild(cell);
        ordersBody.appendChild(row);
        return;
      }

      orders.forEach((order) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>#${order.id}</td>
          <td>${order.customer_name || 'Без имени'}</td>
          <td>${order.total || 0} ₽</td>
          <td>${order.status || 'new'}</td>
          <td>${order.created_at ? new Date(order.created_at).toLocaleString('ru-RU') : ''}</td>
          <td><button class="btn secondary" data-id="${order.id}">Открыть</button></td>
        `;
        const btn = row.querySelector('button');
        btn.addEventListener('click', () => loadOrderDetail(order.id));
        ordersBody.appendChild(row);
      });
    }

    function renderOrderDetail(order) {
      selectedOrder = order;
      orderDetail.style.display = 'block';
      detailId.textContent = `#${order.id}`;
      detailStatus.value = order.status || 'new';
      detailClient.textContent = order.customer_name || '—';
      detailContact.textContent = order.contact || '—';
      detailPromocode.textContent = order.promocode_code || '—';
      detailComment.textContent = order.comment || '—';
      detailItems.innerHTML = '';

      (order.items || []).forEach((item) => {
        const li = document.createElement('li');
        li.textContent = `${item.name || 'Товар'} — ${item.qty} × ${item.price} ₽ (${item.type || 'basket'})`;
        detailItems.appendChild(li);
      });

      detailTotal.textContent = `Итого: ${(order.total || 0)} ₽`;
    }

    async function loadOrders() {
      if (!currentUser) return;
      try {
        const status = statusFilter.value === 'all' ? undefined : statusFilter.value;
        const data = await apiGet('/admin/orders', { user_id: currentUser.telegram_id, status });
        renderOrders(data.items || []);
        ordersSection.style.display = 'block';
        setStatus('');
      } catch (e) {
        setStatus('Не удалось загрузить заказы', true);
      }
    }

    async function loadOrderDetail(orderId) {
      if (!currentUser) return;
      try {
        const order = await apiGet(`/admin/orders/${orderId}`, { user_id: currentUser.telegram_id });
        renderOrderDetail(order);
      } catch (e) {
        setStatus('Не удалось загрузить заказ', true);
      }
    }

    async function updateOrderStatus() {
      if (!currentUser || !selectedOrder) return;
      try {
        const payload = { user_id: currentUser.telegram_id, status: detailStatus.value };
        const updated = await apiPost(`/admin/orders/${selectedOrder.id}/status`, payload);
        setStatus('Статус заказа обновлён');
        renderOrderDetail(updated);
        await loadOrders();
      } catch (e) {
        setStatus('Не удалось обновить статус заказа', true);
      }
    }

    statusFilter.addEventListener('change', loadOrders);
    saveStatusBtn.addEventListener('click', updateOrderStatus);

    async function initApp() {
      try {
        currentUser = await getCurrentUser({ includeNotes: true });
        updateAdminLinkVisibility();
        if (!requireAdmin(currentUser)) return;
        await loadOrders();
      } catch (e) {
        console.error(e);
        setStatus('Ошибка загрузки админки', true);
      }
    }

    initApp();
  </script>
</body>
</html>
