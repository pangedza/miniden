<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MiniDeN ‚Äî –ê–¥–º–∏–Ω–∫–∞</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="css/theme.css?v=20241216" />

</head>
<body data-theme="purple" class="page-admin">
  <div class="admin-layout">
    <aside class="admin-sidebar">
      <div class="admin-brand">MiniDeN<br /><span>–∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</span></div>
      <button class="nav-btn active" data-section="orders">–ó–∞–∫–∞–∑—ã</button>
      <button class="nav-btn" data-section="products">–¢–æ–≤–∞—Ä—ã</button>
      <button class="nav-btn" data-section="courses">–ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã</button>
      <button class="nav-btn" data-section="reviews">–û—Ç–∑—ã–≤—ã</button>
      <button class="nav-btn" data-section="promocodes">–ü—Ä–æ–º–æ–∫–æ–¥—ã</button>
      <button class="nav-btn" data-section="stats">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
      <div class="muted" style="margin-top:16px; font-size:13px;">–í—ã–π–¥–∏—Ç–µ –≤ –ø—Ä–æ—Ñ–∏–ª—å, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.</div>
    </aside>

    <main class="admin-main">
      <div class="section-header admin-top-row">
        <h1>–ê–¥–º–∏–Ω–∫–∞</h1>
        <div class="header-actions">
          <div class="theme-switcher">
            <label for="theme-select">–¢–µ–º–∞</label>
            <select id="theme-select">
              <option value="purple">–§–∏–æ–ª–µ—Ç–æ–≤–∞—è</option>
              <option value="dark">–¢—ë–º–Ω–∞—è</option>
              <option value="light">–°–≤–µ—Ç–ª–∞—è</option>
          <option value="cream">–°–ª–∏–≤–æ—á–Ω–∞—è</option>
            </select>
          </div>
          <a href="/webapp/index.html" class="admin-btn secondary admin-back-to-main">–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
        </div>
      </div>
      <div id="status" class="status-box" style="display:none"></div>

      <div id="access-denied" class="card" style="display:none;">
        <h2>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞</h2>
        <p class="muted">–ê–¥–º–∏–Ω–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å —á–µ—Ä–µ–∑ Telegram WebApp –∏–ª–∏ –≤–æ–π–¥–∏—Ç–µ –≤ –ø—Ä–æ—Ñ–∏–ª—å —Å –ø—Ä–∞–≤–∞–º–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.</p>
      </div>

      <section id="orders" class="card">
        <div class="section-header">
          <div>
            <h2>–ó–∞–∫–∞–∑—ã</h2>
            <p class="muted">–ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ –∑–∞–∫–∞–∑—ã, –æ–±–Ω–æ–≤–ª—è–π—Ç–µ —Å—Ç–∞—Ç—É—Å—ã –∏ –≤—ã–¥–∞–≤–∞–π—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å–∞–º –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã.</p>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <label for="status-filter" class="muted" style="margin:0;">–°—Ç–∞—Ç—É—Å</label>
            <select id="status-filter">
              <option value="all">–í—Å–µ</option>
              <option value="new">–ù–æ–≤—ã–π</option>
              <option value="in_progress">–í —Ä–∞–±–æ—Ç–µ</option>
              <option value="paid">–û–ø–ª–∞—á–µ–Ω</option>
              <option value="sent">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω</option>
              <option value="archived">–ê—Ä—Ö–∏–≤</option>
            </select>
          </div>
        </div>
        <table aria-label="–°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤">
          <thead>
            <tr>
              <th>ID</th>
              <th>–ö–ª–∏–µ–Ω—Ç</th>
              <th>–°—É–º–º–∞</th>
              <th>–°—Ç–∞—Ç—É—Å</th>
              <th>–î–∞—Ç–∞</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="orders-body"></tbody>
        </table>

        <div id="order-detail" class="card" style="margin-top:14px; display:none;">
          <div class="section-header">
            <h3>–ó–∞–∫–∞–∑ <span id="detail-id"></span></h3>
            <div style="display:flex; gap:8px; align-items:center;">
              <label for="detail-status" class="muted" style="margin:0;">–°—Ç–∞—Ç—É—Å</label>
              <select id="detail-status">
                <option value="new">–ù–æ–≤—ã–π</option>
                <option value="in_progress">–í —Ä–∞–±–æ—Ç–µ</option>
                <option value="paid">–û–ø–ª–∞—á–µ–Ω</option>
                <option value="sent">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω</option>
                <option value="archived">–ê—Ä—Ö–∏–≤</option>
              </select>
              <button class="btn secondary" type="button" id="save-status">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
          </div>
          <div class="grid" style="margin-top:10px;">
            <div>
              <div class="muted">–ö–ª–∏–µ–Ω—Ç</div>
              <div id="detail-client">‚Äî</div>
              <div class="muted" style="margin-top:8px;">–ö–æ–Ω—Ç–∞–∫—Ç</div>
              <div id="detail-contact">‚Äî</div>
              <div class="muted" style="margin-top:8px;">–ü—Ä–æ–º–æ–∫–æ–¥</div>
              <div id="detail-promocode">‚Äî</div>
            </div>
            <div>
              <div class="muted">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</div>
              <div id="detail-comment">‚Äî</div>
            </div>
          </div>
          <h4>–ü–æ–∑–∏—Ü–∏–∏</h4>
          <ul class="list" id="detail-items"></ul>
          <div id="detail-total" class="muted"></div>
        </div>
      </section>

      <section id="products" class="card" style="display:none;">
        <div class="section-header">
          <div>
            <h2>–¢–æ–≤–∞—Ä—ã</h2>
            <p class="muted">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫–æ—Ä–∑–∏–Ω–æ–∫ –∏ –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤.</p>
          </div>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <select id="products-category"></select>
            <select id="products-status">
              <option value="all">–í—Å–µ</option>
              <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
              <option value="hidden">–°–∫—Ä—ã—Ç—ã–µ</option>
            </select>
            <button class="btn primary" type="button" id="product-reset">–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä</button>
          </div>
        </div>

        <div class="grid">
          <div class="card" style="background: rgba(255,255,255,0.03);">
            <h3 id="product-form-title">–°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä</h3>
            <form id="product-form">
              <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
              <select name="category_id" id="product-category-select"></select>
              <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
              <input type="text" name="name" required />
              <label>–¶–µ–Ω–∞</label>
              <input type="number" name="price" min="0" required />
              <div class="form-group">
                <label>–§–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞</label>
                <input type="file" id="product-image-file-input" accept="image/*">
              </div>
              <div class="form-group">
                <label>URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (image_url)</label>
                <input type="text" id="product-image-url-input" name="image_url" placeholder="/media/products/xxx.jpg">
              </div>
              <div class="form-group">
                <div id="product-image-preview" class="image-preview-box">–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
              </div>
              <label>–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</label>
              <textarea name="short_description" rows="2" placeholder="–ö—Ä–∞—Ç–∫–æ, –¥–æ ~100‚Äì150 —Å–∏–º–≤–æ–ª–æ–≤. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ —Ç–æ–≤–∞—Ä–∞."></textarea>
              <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
              <textarea name="description"></textarea>
              <label>–°—Å—ã–ª–∫–∞ –Ω–∞ Wildberries</label>
              <input type="text" name="wb_url" />
              <label>–°—Å—ã–ª–∫–∞ –Ω–∞ Ozon</label>
              <input type="text" name="ozon_url" />
              <label>–°—Å—ã–ª–∫–∞ –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–ú–∞—Ä–∫–µ—Ç</label>
              <input type="text" name="yandex_url" />
              <label>–°—Å—ã–ª–∫–∞ –Ω–∞ –ê–≤–∏—Ç–æ</label>
              <input type="text" name="avito_url" />
              <label>–°—Å—ã–ª–∫–∞ –Ω–∞ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å</label>
              <input type="text" name="masterclass_url" />
              <label>–°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏</label>
              <input type="text" name="detail_url" />
              <div style="display:flex; gap:8px; margin-top:10px;">
                <button class="btn primary" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn secondary" type="button" id="product-cancel">–û—Ç–º–µ–Ω–∞</button>
              </div>
            </form>
          </div>

          <div class="card" style="overflow:auto;">
            <table aria-label="–¢–æ–≤–∞—Ä—ã">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                  <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                  <th>–¶–µ–Ω–∞</th>
                  <th>–ê–∫—Ç–∏–≤–µ–Ω</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="products-table"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="courses" class="card" style="display:none;">
        <div class="section-header">
          <div>
            <h2>–ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã</h2>
            <p class="muted">–û–Ω–ª–∞–π–Ω —É—Ä–æ–∫–∏. –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã —Å—Ä–∞–∑—É, –ø–ª–∞—Ç–Ω—ã–µ ‚Äî –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –∑–∞–∫–∞–∑–∞.</p>
          </div>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <select id="courses-category"></select>
            <select id="courses-status">
              <option value="all">–í—Å–µ</option>
              <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
              <option value="hidden">–°–∫—Ä—ã—Ç—ã–µ</option>
            </select>
            <button class="btn primary" type="button" id="course-reset">–ù–æ–≤—ã–π –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å</button>
          </div>
        </div>

        <div class="grid">
          <div class="card" style="background: rgba(255,255,255,0.03);">
            <h3 id="course-form-title">–°–æ–∑–¥–∞—Ç—å –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å</h3>
            <form id="course-form">
              <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
              <select name="category_id" id="course-category-select"></select>
              <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
              <input type="text" name="name" required />
              <label>–¶–µ–Ω–∞ (0 ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω–æ)</label>
              <input type="number" name="price" min="0" required />
              <div class="form-group">
                <label>–§–æ—Ç–æ –∫—É—Ä—Å–∞</label>
                <input type="file" id="course-image-file-input" accept="image/*">
              </div>
              <div class="form-group">
                <label>URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (image_url)</label>
                <input type="text" id="course-image-url-input" name="image_url" placeholder="/media/courses/xxx.jpg">
              </div>
              <div class="form-group">
                <div id="course-image-preview" class="image-preview-box">–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
              </div>
              <label>–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</label>
              <textarea name="short_description" rows="2" placeholder="–ö—Ä–∞—Ç–∫–æ, –¥–æ ~100‚Äì150 —Å–∏–º–≤–æ–ª–æ–≤. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ –∫—É—Ä—Å–∞."></textarea>
              <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
              <textarea name="description"></textarea>
              <label>–°—Å—ã–ª–∫–∞ –Ω–∞ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å</label>
              <input type="text" name="masterclass_url" />
              <label>–°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏</label>
              <input type="text" name="detail_url" />
              <div style="display:flex; gap:8px; margin-top:10px;">
                <button class="btn primary" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn secondary" type="button" id="course-cancel">–û—Ç–º–µ–Ω–∞</button>
              </div>
            </form>
          </div>

          <div class="card" style="overflow:auto;">
            <table aria-label="–ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                  <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                  <th>–¶–µ–Ω–∞</th>
                  <th>–ê–∫—Ç–∏–≤–µ–Ω</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="courses-table"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="promocodes" class="card" style="display:none;">
        <div class="section-header">
          <div>
            <h2>–ü—Ä–æ–º–æ–∫–æ–¥—ã</h2>
            <p class="muted">–°–æ–∑–¥–∞–≤–∞–π—Ç–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –∏ –æ—Ç–∫–ª—é—á–∞–π—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã –¥–ª—è –∫–æ—Ä–∑–∏–Ω—ã –∏ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤.</p>
          </div>
        </div>
        <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));">
          <div class="card">
            <h3 id="promo-form-title">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</h3>
            <form id="promo-form">
              <label for="promo-code-input">–ö–æ–¥</label>
              <input type="text" id="promo-code-input" required />

              <label for="promo-discount-type">–¢–∏–ø —Å–∫–∏–¥–∫–∏</label>
              <select id="promo-discount-type" required>
                <option value="percent">–ü—Ä–æ—Ü–µ–Ω—Ç</option>
                <option value="fixed">–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è</option>
              </select>

              <label for="promo-discount-value">–ó–Ω–∞—á–µ–Ω–∏–µ</label>
              <input type="number" id="promo-discount-value" min="1" step="1" required />

              <label for="promo-scope">–û–±–ª–∞—Å—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è</label>
              <select id="promo-scope" required>
                <option value="all">–ù–∞ –≤–µ—Å—å –∑–∞–∫–∞–∑</option>
                <option value="basket">–¢–æ–ª—å–∫–æ –∫–æ—Ä–∑–∏–Ω–∫–∏</option>
                <option value="course">–¢–æ–ª—å–∫–æ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã</option>
                <option value="product">–û–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä/–∫—É—Ä—Å</option>
                <option value="category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∫–æ—Ä–∑–∏–Ω–æ–∫</option>
              </select>

              <label for="promo-target">ID —Ü–µ–ª–∏ (–¥–ª—è product/category)</label>
              <input type="number" id="promo-target" min="0" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, ID —Ç–æ–≤–∞—Ä–∞ –∏–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" />

              <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
                <div>
                  <label for="promo-date-start">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                  <input type="datetime-local" id="promo-date-start" />
                </div>
                <div>
                  <label for="promo-date-end">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                  <input type="datetime-local" id="promo-date-end" />
                </div>
              </div>

              <label for="promo-max-uses">–ú–∞–∫—Å–∏–º—É–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π</label>
              <input type="number" id="promo-max-uses" min="0" placeholder="0 ‚Äî –±–µ–∑ –ª–∏–º–∏—Ç–∞" />

              <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:6px;">
                <label style="display:flex; align-items:center; gap:6px; margin:0;"><input type="checkbox" id="promo-active" checked /> –ê–∫—Ç–∏–≤–µ–Ω</label>
                <label style="display:flex; align-items:center; gap:6px; margin:0;"><input type="checkbox" id="promo-one-per-user" /> –û–¥–∏–Ω —Ä–∞–∑ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
              </div>

              <div style="display:flex; gap:8px; margin-top:12px;">
                <button class="btn primary" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn secondary" type="button" id="promo-reset">–°–±—Ä–æ—Å–∏—Ç—å</button>
              </div>
            </form>
          </div>

          <div class="card" style="overflow:auto;">
            <table aria-label="–ü—Ä–æ–º–æ–∫–æ–¥—ã" style="width:100%;">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>–ö–æ–¥</th>
                  <th>–°–∫–∏–¥–∫–∞</th>
                  <th>–û–±–ª–∞—Å—Ç—å</th>
                  <th>–õ–∏–º–∏—Ç—ã</th>
                  <th>–°—Ç–∞—Ç—É—Å</th>
                  <th></th>
                </tr>
              </thead>
          <tbody id="promo-table"></tbody>
        </table>
      </div>
    </div>
  </section>

      <section id="reviews" class="card" style="display:none;">
        <div class="section-header" style="align-items:flex-start; gap:12px;">
          <div>
            <h2>–û—Ç–∑—ã–≤—ã</h2>
            <p class="muted">–ú–æ–¥–µ—Ä–∏—Ä—É–π—Ç–µ –æ—Ç–∑—ã–≤—ã –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π, –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ —Ç–µ–∫—Å—Ç –∏ —Ñ–æ—Ç–æ, –º–µ–Ω—è–π—Ç–µ —Å—Ç–∞—Ç—É—Å—ã.</p>
            <div class="review-counters" id="review-counters">
              <span class="tag">–í—Å–µ–≥–æ: <strong id="reviews-count-total">0</strong></span>
              <span class="tag">–ù–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏: <strong id="reviews-count-pending">0</strong></span>
              <span class="tag">–û–¥–æ–±—Ä–µ–Ω–æ: <strong id="reviews-count-approved">0</strong></span>
              <span class="tag">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ: <strong id="reviews-count-rejected">0</strong></span>
            </div>
          </div>
          <div class="review-filters">
            <label class="muted">–°—Ç–∞—Ç—É—Å</label>
            <select id="review-status-filter">
              <option value="all">–í—Å–µ</option>
              <option value="pending">–ù–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏</option>
              <option value="approved">–û–¥–æ–±—Ä–µ–Ω–æ</option>
              <option value="rejected">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</option>
            </select>
            <label class="muted">–¢–æ–≤–∞—Ä</label>
            <select id="review-product-filter"></select>
            <label class="muted">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
            <input type="text" id="review-user-filter" placeholder="ID –∏–ª–∏ –∏–º—è" />
            <button class="btn secondary" type="button" id="review-reset-btn">–°–±—Ä–æ—Å–∏—Ç—å</button>
          </div>
        </div>

        <div class="card" style="overflow:auto;">
          <table aria-label="–û—Ç–∑—ã–≤—ã" class="reviews-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>–¢–æ–≤–∞—Ä</th>
                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                <th>–†–µ–π—Ç–∏–Ω–≥</th>
                <th>–¢–µ–∫—Å—Ç</th>
                <th>–§–æ—Ç–æ</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–î–∞—Ç–∞</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="reviews-table-body"></tbody>
          </table>
        </div>
      </section>

      <section id="stats" class="card" style="display:none;">
        <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
        <p class="muted">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –∏ –ø—Ä–æ–¥–∞–∂ –æ—Å—Ç–∞—ë—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω–æ–π —á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π API. –≠—Ç–∞ –≤–∫–ª–∞–¥–∫–∞ ‚Äî –∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è –±—É–¥—É—â–µ–≥–æ UI.</p>
      </section>
    </main>
  </div>

  <script src="js/app.js?v=20241216"></script>
  <script src="js/api.js?v=20241216"></script>
  <script>
    const statusBox = document.getElementById('status');
    const accessDenied = document.getElementById('access-denied');
    const navButtons = document.querySelectorAll('.nav-btn');

    const ordersBody = document.getElementById('orders-body');
    const statusFilter = document.getElementById('status-filter');
    const orderDetail = document.getElementById('order-detail');
    const detailId = document.getElementById('detail-id');
    const detailStatus = document.getElementById('detail-status');
    const saveStatusBtn = document.getElementById('save-status');
    const detailClient = document.getElementById('detail-client');
    const detailContact = document.getElementById('detail-contact');
    const detailPromocode = document.getElementById('detail-promocode');
    const detailComment = document.getElementById('detail-comment');
    const detailItems = document.getElementById('detail-items');
    const detailTotal = document.getElementById('detail-total');

    const reviewStatusFilter = document.getElementById('review-status-filter');
    const reviewProductFilter = document.getElementById('review-product-filter');
    const reviewUserFilter = document.getElementById('review-user-filter');
    const reviewResetBtn = document.getElementById('review-reset-btn');
    const reviewsTableBody = document.getElementById('reviews-table-body');
    const reviewsCountTotal = document.getElementById('reviews-count-total');
    const reviewsCountPending = document.getElementById('reviews-count-pending');
    const reviewsCountApproved = document.getElementById('reviews-count-approved');
    const reviewsCountRejected = document.getElementById('reviews-count-rejected');

    const productCategoryFilter = document.getElementById('products-category');
    const courseCategoryFilter = document.getElementById('courses-category');
    const productsStatusFilter = document.getElementById('products-status');
    const coursesStatusFilter = document.getElementById('courses-status');
    const productsTable = document.getElementById('products-table');
    const coursesTable = document.getElementById('courses-table');
    const productImageFileInput = document.getElementById('product-image-file-input');
    const productImageUrlInput = document.getElementById('product-image-url-input');
    const productImagePreview = document.getElementById('product-image-preview');
    const courseImageFileInput = document.getElementById('course-image-file-input');
    const courseImageUrlInput = document.getElementById('course-image-url-input');
    const courseImagePreview = document.getElementById('course-image-preview');

    const productForm = document.getElementById('product-form');
    const courseForm = document.getElementById('course-form');
    const productFormTitle = document.getElementById('product-form-title');
    const courseFormTitle = document.getElementById('course-form-title');
    const productCategorySelect = document.getElementById('product-category-select');
    const courseCategorySelect = document.getElementById('course-category-select');
    const productCancel = document.getElementById('product-cancel');
    const courseCancel = document.getElementById('course-cancel');
    const productReset = document.getElementById('product-reset');
    const courseReset = document.getElementById('course-reset');
    const promoForm = document.getElementById('promo-form');
    const promoFormTitle = document.getElementById('promo-form-title');
    const promoTable = document.getElementById('promo-table');
    const promoCodeInput = document.getElementById('promo-code-input');
    const promoDiscountType = document.getElementById('promo-discount-type');
    const promoDiscountValue = document.getElementById('promo-discount-value');
    const promoScope = document.getElementById('promo-scope');
    const promoTarget = document.getElementById('promo-target');
    const promoDateStart = document.getElementById('promo-date-start');
    const promoDateEnd = document.getElementById('promo-date-end');
    const promoMaxUses = document.getElementById('promo-max-uses');
    const promoActive = document.getElementById('promo-active');
    const promoOnePerUser = document.getElementById('promo-one-per-user');
    const promoReset = document.getElementById('promo-reset');

    let currentUser = null;
    let selectedOrder = null;
    let editingProductId = null;
    let editingCourseId = null;
    let editingPromoId = null;
    let reviewItems = [];

    function setStatus(message, isError = false) {
      if (!message) {
        statusBox.style.display = 'none';
        statusBox.textContent = '';
        statusBox.classList.remove('error');
        return;
      }
      statusBox.style.display = 'block';
      statusBox.textContent = message;
      statusBox.style.borderColor = isError ? 'rgba(255,99,99,0.7)' : 'var(--border)';
    }

    async function sendJson(path, method = 'GET', body = null) {
      const res = await fetch(`${API_BASE}${path}`, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: body ? JSON.stringify(body) : undefined,
      });
      const text = await res.text();
      let data = null;
      if (text) {
        try {
          data = JSON.parse(text);
        } catch (_) {
          data = null;
        }
      }
      if (!res.ok) {
        const message = (data && (data.detail || data.message)) || text || '–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞';
        throw new Error(message);
      }
      if (!text) return null;
      return data ?? text;
    }

    function showSection(id) {
      document.querySelectorAll('section.card').forEach((el) => {
        el.style.display = el.id === id ? 'block' : 'none';
      });
      navButtons.forEach((btn) => btn.classList.toggle('active', btn.dataset.section === id));
    }

    navButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        showSection(btn.dataset.section);
      });
    });

    function requireAdmin(profile) {
      if (!profile || !profile.is_admin) {
        setStatus('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω', true);
        accessDenied.style.display = 'block';
        document.querySelectorAll('section.card').forEach((el) => (el.style.display = 'none'));
        return false;
      }
      accessDenied.style.display = 'none';
      return true;
    }

    function renderReviewCounters(items) {
      const stats = items.reduce(
        (acc, item) => {
          acc.total += 1;
          if (item.status === 'approved') acc.approved += 1;
          if (item.status === 'pending') acc.pending += 1;
          if (item.status === 'rejected') acc.rejected += 1;
          return acc;
        },
        { total: 0, approved: 0, pending: 0, rejected: 0 }
      );
      reviewsCountTotal.textContent = stats.total;
      reviewsCountPending.textContent = stats.pending;
      reviewsCountApproved.textContent = stats.approved;
      reviewsCountRejected.textContent = stats.rejected;
    }

    function getProductLabel(product) {
      if (!product) return '‚Äî';
      return product.title || product.name || product.short_name || `–¢–æ–≤–∞—Ä #${product.id}`;
    }

    function getProductLink(product) {
      if (!product) return null;
      return product.detail_url || `/webapp/products.html#${product.id || ''}`;
    }

    function renderReviewPhotosCell(photos) {
      const container = document.createElement('div');
      container.className = 'review-photos';
      const count = Array.isArray(photos) ? photos.length : 0;
      if (!count) {
        container.textContent = '‚Äî';
        container.classList.add('muted');
        return container;
      }
      const first = photos[0];
      const thumb = document.createElement('div');
      thumb.className = 'review-photo-thumb';
      thumb.style.backgroundImage = `url(${first})`;
      const badge = document.createElement('span');
      badge.className = 'review-photo-count';
      badge.textContent = `${count}`;
      thumb.appendChild(badge);
      container.appendChild(thumb);
      return container;
    }

    function renderReviewActionsCell(review) {
      const cell = document.createElement('td');
      cell.className = 'review-actions-cell';

      const approveBtn = document.createElement('button');
      approveBtn.className = 'btn secondary';
      approveBtn.textContent = '–û–¥–æ–±—Ä–∏—Ç—å';
      approveBtn.disabled = review.status === 'approved';
      approveBtn.addEventListener('click', () => updateReviewStatus(review, 'approved'));

      const rejectBtn = document.createElement('button');
      rejectBtn.className = 'btn secondary';
      rejectBtn.textContent = '–û—Ç–∫–ª–æ–Ω–∏—Ç—å';
      rejectBtn.disabled = review.status === 'rejected';
      rejectBtn.addEventListener('click', () => updateReviewStatus(review, 'rejected'));

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'btn secondary danger';
      deleteBtn.textContent = review.is_deleted ? '–£–¥–∞–ª–µ–Ω–æ' : '–£–¥–∞–ª–∏—Ç—å';
      deleteBtn.disabled = review.is_deleted;
      deleteBtn.addEventListener('click', () => updateReviewStatus(review, review.status, true));

      const detailsBtn = document.createElement('button');
      detailsBtn.className = 'btn secondary';
      detailsBtn.textContent = '–ü–æ–¥—Ä–æ–±–Ω–µ–µ';
      detailsBtn.addEventListener('click', () => openReviewModal(review));

      [approveBtn, rejectBtn, deleteBtn, detailsBtn].forEach((btn) => cell.appendChild(btn));
      return cell;
    }

    function renderReviewsTable(items) {
      reviewsTableBody.innerHTML = '';
      if (!items.length) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 9;
        cell.textContent = '–û—Ç–∑—ã–≤—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
        cell.className = 'muted';
        row.appendChild(cell);
        reviewsTableBody.appendChild(row);
        renderReviewCounters(items);
        return;
      }

      items.forEach((review) => {
        const row = document.createElement('tr');
        if (review.is_deleted) {
          row.classList.add('muted');
        }
        const date = review.created_at ? new Date(review.created_at).toLocaleString('ru-RU') : '‚Äî';
        const productLink = getProductLink(review.product);
        const textPreview = document.createElement('div');
        textPreview.className = 'review-text-preview';
        textPreview.textContent = review.text || '‚Äî';

        row.innerHTML = `
          <td>#${review.id}</td>
          <td>
            <div class="review-product">
              <span>${getProductLabel(review.product)}</span>
              ${productLink ? `<a href="${productLink}" target="_blank" rel="noopener" title="–û—Ç–∫—Ä—ã—Ç—å —Ç–æ–≤–∞—Ä">üîó</a>` : ''}
            </div>
          </td>
          <td>${review.user_name || '‚Äî'}${review.user_id ? ` (#${review.user_id})` : ''}</td>
          <td>${review.rating ? `${'‚òÖ'.repeat(review.rating)}${'‚òÜ'.repeat(5 - review.rating)}` : '‚Äî'}</td>
          <td></td>
          <td></td>
          <td><span class="admin-pill review-status-${review.status}">${review.status}</span>${review.is_deleted ? '<div class="muted" style="font-size:12px;">–£–¥–∞–ª—ë–Ω</div>' : ''}</td>
          <td>${date}</td>
        `;

        row.children[4].appendChild(textPreview);
        row.children[5].appendChild(renderReviewPhotosCell(review.photos || review.photos_json || []));
        row.appendChild(renderReviewActionsCell(review));
        reviewsTableBody.appendChild(row);
      });
      renderReviewCounters(items);
    }

    function applyReviewSearchFilter(items) {
      const query = (reviewUserFilter.value || '').trim().toLowerCase();
      if (!query) return items;
      const isNumeric = /^\d+$/.test(query);
      return items.filter((item) => {
        const userName = (item.user_name || '').toLowerCase();
        const userIdMatch = item.user_id ? String(item.user_id).includes(query) : false;
        if (isNumeric) return userIdMatch;
        return userName.includes(query) || userIdMatch;
      });
    }

    async function loadReviewProducts() {
      try {
        const data = await apiGet('/admin/products', { user_id: currentUser.telegram_id, type: 'basket', status: 'all' });
        reviewProductFilter.innerHTML = '';
        const allOption = document.createElement('option');
        allOption.value = '';
        allOption.textContent = '–í—Å–µ —Ç–æ–≤–∞—Ä—ã';
        reviewProductFilter.appendChild(allOption);
        (data.items || []).forEach((product) => {
          const option = document.createElement('option');
          option.value = product.id;
          option.textContent = `${product.id} ‚Äî ${product.name}`;
          reviewProductFilter.appendChild(option);
        });
      } catch (e) {
        console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–≤–∞—Ä—ã –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ –æ—Ç–∑—ã–≤–æ–≤', e);
      }
    }

    async function loadReviews() {
      if (!currentUser) return;
      try {
        const status = reviewStatusFilter.value === 'all' ? undefined : reviewStatusFilter.value;
        const productId = reviewProductFilter.value ? Number(reviewProductFilter.value) : undefined;
        const userQuery = (reviewUserFilter.value || '').trim();
        const params = { status, product_id: productId, page: 1, limit: 100 };
        if (/^\d+$/.test(userQuery)) {
          params.user_id = Number(userQuery);
        }

        const data = await apiGet('/admin/reviews', params);
        reviewItems = data.items || [];
        const filtered = applyReviewSearchFilter(reviewItems);
        renderReviewsTable(filtered);
        setStatus('');
      } catch (e) {
        console.error(e);
        setStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç–∑—ã–≤—ã', true);
      }
    }

    async function updateReviewStatus(review, newStatus, isDeleted = false) {
      try {
        const payload = { status: newStatus, is_deleted: Boolean(isDeleted) };
        const res = await apiPost(`/admin/reviews/${review.id}/status`, payload);
        review.status = res.status;
        review.is_deleted = res.is_deleted;
        if (reviewStatusFilter.value !== 'all' && reviewStatusFilter.value !== res.status) {
          reviewItems = reviewItems.filter((item) => item.id !== review.id);
        }
        renderReviewsTable(applyReviewSearchFilter(reviewItems));
        showToast('–°—Ç–∞—Ç—É—Å –æ—Ç–∑—ã–≤–∞ –æ–±–Ω–æ–≤–ª—ë–Ω');
      } catch (e) {
        console.error(e);
        setStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –æ—Ç–∑—ã–≤–∞', true);
      }
    }

    function openReviewModal(review) {
      const modal = document.getElementById('review-modal');
      const titleEl = document.getElementById('review-modal-title');
      const textEl = document.getElementById('review-modal-text');
      const galleryEl = document.getElementById('review-modal-photos');

      titleEl.textContent = `${getProductLabel(review.product)} ‚Ä¢ ${review.user_name || '‚Äî'} ‚Ä¢ ${review.rating || '-'}‚òÖ`;
      textEl.textContent = review.text || '‚Äî';

      galleryEl.innerHTML = '';
      (review.photos || review.photos_json || []).forEach((url) => {
        const img = document.createElement('img');
        img.src = url;
        img.alt = '–§–æ—Ç–æ –æ—Ç–∑—ã–≤–∞';
        galleryEl.appendChild(img);
      });

      modal.classList.remove('hidden');
    }

    function closeReviewModal() {
      const modal = document.getElementById('review-modal');
      modal.classList.add('hidden');
    }

    function renderOrders(orders) {
      ordersBody.innerHTML = '';
      if (!orders || !orders.length) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 6;
        cell.textContent = '–ó–∞–∫–∞–∑–æ–≤ –Ω–µ—Ç';
        cell.className = 'muted';
        row.appendChild(cell);
        ordersBody.appendChild(row);
        return;
      }

      orders.forEach((order) => {
        const row = document.createElement('tr');
        const date = order.created_at ? new Date(order.created_at).toLocaleString('ru-RU') : '';
        row.innerHTML = `
          <td>#${order.id}</td>
          <td>${order.customer_name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</td>
          <td>${order.total || 0} ‚ÇΩ</td>
          <td>${order.status || 'new'}</td>
          <td>${date}</td>
          <td><button class="btn secondary" data-id="${order.id}">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button></td>
        `;
        row.querySelector('button').addEventListener('click', () => loadOrderDetail(order.id));
        ordersBody.appendChild(row);
      });
    }

    function renderOrderDetail(order) {
      selectedOrder = order;
      orderDetail.style.display = 'block';
      detailId.textContent = `#${order.id}`;
      detailStatus.value = order.status || 'new';
      detailClient.textContent = order.customer_name || '‚Äî';
      detailContact.textContent = order.contact || '‚Äî';
      detailPromocode.textContent = order.promocode_code || '‚Äî';
      detailComment.textContent = order.comment || '‚Äî';
      detailItems.innerHTML = '';

      (order.items || []).forEach((item) => {
        const li = document.createElement('li');
        const label = item.type === 'course' ? 'üéì' : 'üß∫';
        const access = item.type === 'course' ? (item.can_access ? '–¥–æ—Å—Ç—É–ø –æ—Ç–∫—Ä—ã—Ç' : '–ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã') : '';
        li.textContent = `${label} ${item.name || '–¢–æ–≤–∞—Ä'} ‚Äî ${item.qty} √ó ${item.price} ‚ÇΩ ${access}`;
        detailItems.appendChild(li);
      });

      detailTotal.textContent = `–ò—Ç–æ–≥–æ: ${order.total || 0} ‚ÇΩ`;
    }

    async function loadOrders() {
      if (!currentUser) return;
      try {
        const status = statusFilter.value === 'all' ? undefined : statusFilter.value;
        const data = await apiGet('/admin/orders', { user_id: currentUser.telegram_id, status });
        renderOrders(data.items || []);
        setStatus('');
      } catch (e) {
        console.error(e);
        setStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–∫–∞–∑—ã', true);
      }
    }

    async function loadOrderDetail(orderId) {
      try {
        const order = await apiGet(`/admin/orders/${orderId}`, { user_id: currentUser.telegram_id });
        renderOrderDetail(order);
      } catch (e) {
        console.error(e);
        setStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–∫–∞–∑', true);
      }
    }

    async function updateOrderStatus() {
      if (!currentUser || !selectedOrder) return;
      try {
        const payload = { user_id: currentUser.telegram_id, status: detailStatus.value };
        const updated = await apiPost(`/admin/orders/${selectedOrder.id}/status`, payload);
        setStatus('–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –æ–±–Ω–æ–≤–ª—ë–Ω');
        renderOrderDetail(updated);
        await loadOrders();
      } catch (e) {
        console.error(e);
        setStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞', true);
      }
    }

    statusFilter.addEventListener('change', loadOrders);
    saveStatusBtn.addEventListener('click', updateOrderStatus);

    async function loadCategories(targetSelect, type) {
      try {
        const categories = await apiGet('/categories', { type });
        targetSelect.innerHTML = '';
        const allOption = document.createElement('option');
        allOption.value = '';
        allOption.textContent = '–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
        targetSelect.appendChild(allOption);
        categories.forEach((cat) => {
          const option = document.createElement('option');
          option.value = cat.id ?? cat.slug ?? '';
          option.textContent = cat.name;
          targetSelect.appendChild(option);
        });
      } catch (e) {
        console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏', e);
      }
    }

    function fillForm(form, data = {}) {
      Object.entries(data).forEach(([key, value]) => {
        const el = form.elements.namedItem(key);
        if (!el) return;
        if (el.tagName === 'SELECT' || el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
          el.value = value ?? '';
        }
      });
    }

    function serializeForm(form) {
      const payload = {};
      Array.from(form.elements).forEach((el) => {
        if (!el.name) return;
        if (el.name === 'category_id') {
          payload[el.name] = el.value && !Number.isNaN(Number(el.value)) ? Number(el.value) : null;
          return;
        }
        if (el.type === 'number') {
          payload[el.name] = el.value ? Number(el.value) : null;
        } else {
          payload[el.name] = el.value || null;
        }
      });
      return payload;
    }

    function setProductImagePreview(url) {
      if (!productImagePreview) return;
      if (url) {
        productImagePreview.style.backgroundImage = `url(${url})`;
        productImagePreview.textContent = '';
      } else {
        productImagePreview.style.backgroundImage = '';
        productImagePreview.textContent = '–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è';
      }
    }

    function setCourseImagePreview(url) {
      if (!courseImagePreview) return;
      if (url) {
        courseImagePreview.style.backgroundImage = `url(${url})`;
        courseImagePreview.textContent = '';
      } else {
        courseImagePreview.style.backgroundImage = '';
        courseImagePreview.textContent = '–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è';
      }
    }

    function resetProductImageInputs() {
      if (productImageFileInput) productImageFileInput.value = '';
      if (productImageUrlInput) productImageUrlInput.value = '';
      setProductImagePreview('');
    }

    function resetCourseImageInputs() {
      if (courseImageFileInput) courseImageFileInput.value = '';
      if (courseImageUrlInput) courseImageUrlInput.value = '';
      setCourseImagePreview('');
    }

    async function uploadProductImageFile() {
      const file = productImageFileInput?.files?.[0];
      if (!file) return;

      const formData = new FormData();
      formData.append('kind', 'product');
      formData.append('file', file);

      const res = await fetch('/api/admin/upload-image', { method: 'POST', body: formData });
      const data = await res.json();
      if (!data.ok) {
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
        return;
      }

      if (productImageUrlInput) productImageUrlInput.value = data.url;
      setProductImagePreview(data.url);
    }

    async function uploadCourseImageFile() {
      const file = courseImageFileInput?.files?.[0];
      if (!file) return;

      const formData = new FormData();
      formData.append('kind', 'course');
      formData.append('file', file);

      const res = await fetch('/api/admin/upload-image', { method: 'POST', body: formData });
      const data = await res.json();
      if (!data.ok) {
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
        return;
      }

      if (courseImageUrlInput) courseImageUrlInput.value = data.url;
      setCourseImagePreview(data.url);
    }

    function renderProductTable(items, targetTable, type) {
      targetTable.innerHTML = '';
      if (!items || !items.length) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 6;
        cell.textContent = '–ü—É—Å—Ç–æ';
        cell.className = 'muted';
        row.appendChild(cell);
        targetTable.appendChild(row);
        return;
      }

      items.forEach((item) => {
        const row = document.createElement('tr');
        const categoryLabel = item.category_name || '‚Äî';
        const priceLabel = `${item.price || 0} ‚ÇΩ${type === 'course' && (!item.price || item.price === 0) ? ' (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)' : ''}`;
        row.innerHTML = `
          <td>#${item.id}</td>
          <td>${item.name}</td>
          <td>${categoryLabel}</td>
          <td>${priceLabel}</td>
          <td>${item.is_active ? '–î–∞' : '–ù–µ—Ç'}</td>
          <td style="display:flex; gap:6px; flex-wrap:wrap;">
            <button class="btn secondary" type="button" data-action="edit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <button class="btn secondary" type="button" data-action="toggle">${item.is_active ? '–°–∫—Ä—ã—Ç—å' : '–ü–æ–∫–∞–∑–∞—Ç—å'}</button>
          </td>
        `;
        const editBtn = row.querySelector('[data-action="edit"]');
        const toggleBtn = row.querySelector('[data-action="toggle"]');
        editBtn.addEventListener('click', () => {
          if (type === 'basket') {
            editingProductId = item.id;
            productFormTitle.textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä #${item.id}`;
            const productImageUrl = item.image_url || item.image || '';
              fillForm(productForm, {
                category_id: item.category_id ?? '',
                name: item.name,
                price: item.price,
                image_url: productImageUrl,
                short_description: item.short_description,
                description: item.description,
                wb_url: item.wb_url,
                ozon_url: item.ozon_url,
                yandex_url: item.yandex_url,
                avito_url: item.avito_url,
              masterclass_url: item.masterclass_url,
              detail_url: item.detail_url,
            });
            if (productImageUrlInput) productImageUrlInput.value = productImageUrl || '';
            setProductImagePreview(productImageUrl);
          } else {
            editingCourseId = item.id;
            courseFormTitle.textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å #${item.id}`;
            const courseImageUrl = item.image_url || item.image || '';
              fillForm(courseForm, {
                category_id: item.category_id ?? '',
                name: item.name,
                price: item.price,
                image_url: courseImageUrl,
                short_description: item.short_description,
                description: item.description,
                masterclass_url: item.masterclass_url,
                detail_url: item.detail_url,
              });
            if (courseImageUrlInput) courseImageUrlInput.value = courseImageUrl || '';
            setCourseImagePreview(courseImageUrl);
          }
        });
        toggleBtn.addEventListener('click', async () => {
          try {
            await apiPost(`/admin/products/${item.id}/toggle`, { user_id: currentUser.telegram_id, type });
            setStatus('–°—Ç–∞—Ç—É—Å —Ç–æ–≤–∞—Ä–∞ –æ–±–Ω–æ–≤–ª—ë–Ω');
            if (type === 'basket') {
              await loadProducts();
            } else {
              await loadCourses();
            }
          } catch (e) {
            console.error(e);
            setStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', true);
          }
        });
        targetTable.appendChild(row);
      });
    }

    async function loadProducts() {
      if (!currentUser) return;
      try {
        const status = productsStatusFilter.value === 'all' ? undefined : productsStatusFilter.value;
        const data = await apiGet('/admin/products', { user_id: currentUser.telegram_id, type: 'basket', status });
        let items = data.items || [];
        const catFilter = productCategoryFilter.value;
        if (catFilter) {
          items = items.filter((i) => String(i.category_id || i.category_slug || '') === String(catFilter));
        }
        renderProductTable(items, productsTable, 'basket');
      } catch (e) {
        console.error(e);
        setStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–≤–∞—Ä—ã', true);
      }
    }

    async function loadCourses() {
      if (!currentUser) return;
      try {
        const status = coursesStatusFilter.value === 'all' ? undefined : coursesStatusFilter.value;
        const data = await apiGet('/admin/products', { user_id: currentUser.telegram_id, type: 'course', status });
        let items = data.items || [];
        const catFilter = courseCategoryFilter.value;
        if (catFilter) {
          items = items.filter((i) => String(i.category_slug || i.category_id || '') === String(catFilter));
        }
        renderProductTable(items, coursesTable, 'course');
      } catch (e) {
        console.error(e);
        setStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã', true);
      }
    }

    function resetPromoFormFields() {
      editingPromoId = null;
      promoFormTitle.textContent = '–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥';
      promoForm?.reset();
      promoActive.checked = true;
      promoOnePerUser.checked = false;
      promoTarget.value = '';
      updatePromoTargetState();
    }

    function toInputDate(value) {
      if (!value) return '';
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return '';
      const offset = date.getTimezoneOffset();
      const local = new Date(date.getTime() - offset * 60000);
      return local.toISOString().slice(0, 16);
    }

    function fromInputDate(value) {
      if (!value) return null;
      const date = new Date(value);
      return Number.isNaN(date.getTime()) ? null : date.toISOString();
    }

    function updatePromoTargetState() {
      const needsTarget = ['product', 'category'].includes(promoScope.value);
      promoTarget.disabled = !needsTarget;
      promoTarget.placeholder = needsTarget ? '–ù–∞–ø—Ä–∏–º–µ—Ä, ID —Ç–æ–≤–∞—Ä–∞ –∏–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏' : '–ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏';
      if (!needsTarget) {
        promoTarget.value = '';
      }
    }

    function renderPromocodes(promos) {
      promoTable.innerHTML = '';
      if (!promos || !promos.length) {
        const emptyRow = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 7;
        cell.textContent = '–ü—Ä–æ–º–æ–∫–æ–¥—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç';
        cell.className = 'muted';
        emptyRow.appendChild(cell);
        promoTable.appendChild(emptyRow);
        return;
      }

      const scopeLabels = {
        all: '–í–µ—Å—å –∑–∞–∫–∞–∑',
        basket: '–ö–æ—Ä–∑–∏–Ω–∫–∏',
        course: '–ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã',
        product: '–¢–æ–≤–∞—Ä/–∫—É—Ä—Å',
        category: '–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∫–æ—Ä–∑–∏–Ω–æ–∫',
      };

      promos.forEach((promo) => {
        const row = document.createElement('tr');
        const limitText = `${promo.used_count || 0}/${promo.max_uses || '‚àû'}`;
        const discountText =
          promo.discount_type === 'percent'
            ? `${promo.discount_value}%`
            : `${promo.discount_value} ‚ÇΩ`;
        const dates = [promo.date_start, promo.date_end]
          .filter(Boolean)
          .map((d) => new Date(d).toLocaleString('ru-RU'))
          .join(' ‚Äî ');
        const status = promo.active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–í—ã–∫–ª—é—á–µ–Ω';

        row.innerHTML = `
          <td>#${promo.id}</td>
          <td>${promo.code}</td>
          <td>${discountText}</td>
          <td>${scopeLabels[promo.scope] || promo.scope}${promo.target_id ? ` #${promo.target_id}` : ''}</td>
          <td>${limitText}</td>
          <td>${status}<div class="muted" style="font-size:12px;">${dates || '‚Äî'}</div></td>
          <td style="display:flex; gap:6px;">
            <button class="btn secondary" type="button" data-edit="${promo.id}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <button class="btn secondary" type="button" data-delete="${promo.id}">–£–¥–∞–ª–∏—Ç—å</button>
          </td>
        `;

        row.querySelector('[data-edit]')?.addEventListener('click', () => editPromocode(promo));
        row.querySelector('[data-delete]')?.addEventListener('click', () => deletePromocode(promo.id));
        promoTable.appendChild(row);
      });
    }

    async function loadPromocodes() {
      if (!currentUser) return;
      try {
        const data = await apiGet('/admin/promocodes', { user_id: currentUser.telegram_id });
        renderPromocodes(data.items || []);
      } catch (e) {
        console.error(e);
        setStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥—ã', true);
      }
    }

    function editPromocode(promo) {
      editingPromoId = promo.id;
      promoFormTitle.textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ #${promo.id}`;
      promoCodeInput.value = promo.code || '';
      promoDiscountType.value = promo.discount_type || 'percent';
      promoDiscountValue.value = promo.discount_value || '';
      promoScope.value = promo.scope || 'all';
      promoTarget.value = promo.target_id ?? '';
      promoDateStart.value = toInputDate(promo.date_start);
      promoDateEnd.value = toInputDate(promo.date_end);
      promoMaxUses.value = promo.max_uses ?? '';
      promoActive.checked = promo.active !== false;
      promoOnePerUser.checked = Boolean(promo.one_per_user);
      updatePromoTargetState();
    }

    async function deletePromocode(id) {
      if (!currentUser || !id) return;
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥?')) return;
      try {
        await sendJson(`/admin/promocodes/${id}?user_id=${currentUser.telegram_id}`, 'DELETE');
        setStatus('–ü—Ä–æ–º–æ–∫–æ–¥ —É–¥–∞–ª—ë–Ω');
        await loadPromocodes();
      } catch (e) {
        console.error(e);
        setStatus(e?.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥', true);
      }
    }

    async function submitPromocode(event) {
      event.preventDefault();
      if (!currentUser) return;

      const payload = {
        user_id: currentUser.telegram_id,
        code: promoCodeInput.value.trim(),
        discount_type: promoDiscountType.value,
        discount_value: Number(promoDiscountValue.value || 0),
        scope: promoScope.value,
        target_id: promoTarget.value ? Number(promoTarget.value) : null,
        date_start: fromInputDate(promoDateStart.value),
        date_end: fromInputDate(promoDateEnd.value),
        max_uses: promoMaxUses.value ? Number(promoMaxUses.value) : null,
        active: promoActive.checked,
        one_per_user: promoOnePerUser.checked,
      };

      try {
        if (editingPromoId) {
          await sendJson(`/admin/promocodes/${editingPromoId}`, 'PUT', payload);
        } else {
          await sendJson('/admin/promocodes', 'POST', payload);
        }
        setStatus('–ü—Ä–æ–º–æ–∫–æ–¥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
        resetPromoFormFields();
        await loadPromocodes();
      } catch (e) {
        console.error(e);
        setStatus(e?.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥', true);
      }
    }

    async function submitProductForm(event) {
      event.preventDefault();
      if (!currentUser) return;
      const payload = serializeForm(productForm);
      payload.user_id = currentUser.telegram_id;
      payload.type = 'basket';
      payload.price = payload.price ? Number(payload.price) : 0;
      payload.image_url = productImageUrlInput?.value.trim() || null;

      try {
        if (editingProductId) {
          await fetch(`${API_BASE}/admin/products/${editingProductId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          }).then(handleResponse);
        } else {
          await apiPost('/admin/products', payload);
        }
        setStatus('–¢–æ–≤–∞—Ä —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
        editingProductId = null;
        productFormTitle.textContent = '–°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä';
        productForm.reset();
        resetProductImageInputs();
        await loadProducts();
      } catch (e) {
        console.error(e);
        setStatus('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–≤–∞—Ä', true);
      }
    }

    async function submitCourseForm(event) {
      event.preventDefault();
      if (!currentUser) return;
      const payload = serializeForm(courseForm);
      payload.user_id = currentUser.telegram_id;
      payload.type = 'course';
      payload.price = payload.price ? Number(payload.price) : 0;
      payload.image_url = courseImageUrlInput?.value.trim() || null;

      try {
        if (editingCourseId) {
          await fetch(`${API_BASE}/admin/products/${editingCourseId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          }).then(handleResponse);
        } else {
          await apiPost('/admin/products', payload);
        }
        setStatus('–ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
        editingCourseId = null;
        courseFormTitle.textContent = '–°–æ–∑–¥–∞—Ç—å –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å';
        courseForm.reset();
        resetCourseImageInputs();
        await loadCourses();
      } catch (e) {
        console.error(e);
        setStatus('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å', true);
      }
    }

    promoForm.addEventListener('submit', submitPromocode);
    promoReset.addEventListener('click', resetPromoFormFields);
    promoScope.addEventListener('change', updatePromoTargetState);
    productForm.addEventListener('submit', submitProductForm);
    courseForm.addEventListener('submit', submitCourseForm);
    productCancel.addEventListener('click', () => {
      editingProductId = null;
      productFormTitle.textContent = '–°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä';
      productForm.reset();
      resetProductImageInputs();
    });
    courseCancel.addEventListener('click', () => {
      editingCourseId = null;
      courseFormTitle.textContent = '–°–æ–∑–¥–∞—Ç—å –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å';
      courseForm.reset();
      resetCourseImageInputs();
    });
    productReset.addEventListener('click', () => {
      editingProductId = null;
      productFormTitle.textContent = '–°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä';
      productForm.reset();
      resetProductImageInputs();
    });
    courseReset.addEventListener('click', () => {
      editingCourseId = null;
      courseFormTitle.textContent = '–°–æ–∑–¥–∞—Ç—å –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å';
      courseForm.reset();
      resetCourseImageInputs();
    });

    productImageFileInput?.addEventListener('change', uploadProductImageFile);
    courseImageFileInput?.addEventListener('change', uploadCourseImageFile);
    productImageUrlInput?.addEventListener('input', () => setProductImagePreview(productImageUrlInput.value.trim()));
    courseImageUrlInput?.addEventListener('input', () => setCourseImagePreview(courseImageUrlInput.value.trim()));

    reviewStatusFilter?.addEventListener('change', loadReviews);
    reviewProductFilter?.addEventListener('change', loadReviews);
    reviewUserFilter?.addEventListener('input', () => {
      const filtered = applyReviewSearchFilter(reviewItems);
      renderReviewsTable(filtered);
    });
    reviewResetBtn?.addEventListener('click', () => {
      reviewStatusFilter.value = 'all';
      reviewProductFilter.value = '';
      reviewUserFilter.value = '';
      loadReviews();
    });
    document.getElementById('review-modal-close')?.addEventListener('click', closeReviewModal);
    document.getElementById('review-modal')?.addEventListener('click', (event) => {
      if (event.target.id === 'review-modal') closeReviewModal();
    });

    productsStatusFilter.addEventListener('change', loadProducts);
    coursesStatusFilter.addEventListener('change', loadCourses);
    productCategoryFilter.addEventListener('change', loadProducts);
    courseCategoryFilter.addEventListener('change', loadCourses);

    async function initApp() {
      try {
        currentUser = await getCurrentUser({ includeNotes: true });
        if (!requireAdmin(currentUser)) return;

        await Promise.all([
          loadCategories(productCategoryFilter, 'basket'),
          loadCategories(productCategorySelect, 'basket'),
          loadCategories(courseCategoryFilter, 'course'),
          loadCategories(courseCategorySelect, 'course'),
        ]);

        updatePromoTargetState();
        await loadOrders();
        await loadProducts();
        await loadCourses();
        await loadPromocodes();
        await loadReviewProducts();
        await loadReviews();
        showSection('orders');
      } catch (e) {
        console.error(e);
        setStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–¥–º–∏–Ω–∫–∏', true);
      }
    }

    initApp();
  </script>

  <div id="review-modal" class="admin-modal hidden">
    <div class="admin-modal__content">
      <div class="admin-modal__header">
        <h3 id="review-modal-title"></h3>
        <button class="btn secondary" type="button" id="review-modal-close">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="admin-modal__body">
        <p id="review-modal-text" class="review-modal-text"></p>
        <div id="review-modal-photos" class="review-modal-gallery"></div>
      </div>
    </div>
  </div>
</body>
</html>
