<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MiniDeN ‚Äî –ê–¥–º–∏–Ω–∫–∞</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="css/theme.css?v=20241222" />

</head>
<body data-theme="purple" class="page-admin">
  <div class="admin-layout">
    <aside class="admin-sidebar">
      <div class="admin-brand">MiniDeN<br /><span>–∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</span></div>
      <nav class="admin-nav">
        <button class="nav-btn active" data-view="orders">–ó–∞–∫–∞–∑—ã</button>
        <div class="nav-group" data-group="products">
          <button class="nav-btn nav-parent" data-group-toggle="products">–¢–æ–≤–∞—Ä—ã</button>
          <div class="nav-submenu">
            <button class="nav-btn nav-sub" data-view="product-list" data-action="product-new">–°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä</button>
            <button class="nav-btn nav-sub" data-view="product-list">–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤</button>
            <button class="nav-btn nav-sub" data-view="product-categories">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤</button>
          </div>
        </div>
        <div class="nav-group" data-group="courses">
          <button class="nav-btn nav-parent" data-group-toggle="courses">–ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã</button>
          <div class="nav-submenu">
            <button class="nav-btn nav-sub" data-view="course-list" data-action="course-new">–°–æ–∑–¥–∞—Ç—å –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å</button>
            <button class="nav-btn nav-sub" data-view="course-list">–°–ø–∏—Å–æ–∫ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å–æ–≤</button>
            <button class="nav-btn nav-sub" data-view="course-categories">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å–æ–≤</button>
          </div>
        </div>
        <button class="nav-btn" data-view="reviews">–û—Ç–∑—ã–≤—ã</button>
        <div class="nav-group" data-group="promocodes">
          <button class="nav-btn nav-parent" data-group-toggle="promocodes" data-default-view="promocode-list">–ü—Ä–æ–º–æ–∫–æ–¥—ã</button>
          <div class="nav-submenu">
            <button class="nav-btn nav-sub" data-view="promocode-list" data-action="promo-new">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</button>
            <button class="nav-btn nav-sub" data-view="promocode-list">–°–ø–∏—Å–æ–∫ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤</button>
          </div>
        </div>
        <button class="nav-btn" data-view="stats">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
      </nav>
      <div class="muted" style="margin-top:16px; font-size:13px;">–í—ã–π–¥–∏—Ç–µ –≤ –ø—Ä–æ—Ñ–∏–ª—å, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.</div>
    </aside>

    <main class="admin-main">
      <div class="section-header admin-top-row">
        <h1>–ê–¥–º–∏–Ω–∫–∞</h1>
        <div class="header-actions">
          <div class="theme-switcher">
            <label for="theme-select">–¢–µ–º–∞</label>
            <select id="theme-select">
              <option value="purple">–§–∏–æ–ª–µ—Ç–æ–≤–∞—è</option>
              <option value="dark">–¢—ë–º–Ω–∞—è</option>
              <option value="light">–°–≤–µ—Ç–ª–∞—è</option>
          <option value="cream">–°–ª–∏–≤–æ—á–Ω–∞—è</option>
            </select>
          </div>
          <a href="/webapp/index.html" class="admin-btn secondary admin-back-to-main">–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
        </div>
      </div>
      <div id="status" class="status-box" style="display:none"></div>

      <div id="access-denied" class="card" style="display:none;">
        <h2>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞</h2>
        <p class="muted">–ê–¥–º–∏–Ω–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å —á–µ—Ä–µ–∑ Telegram WebApp –∏–ª–∏ –≤–æ–π–¥–∏—Ç–µ –≤ –ø—Ä–æ—Ñ–∏–ª—å —Å –ø—Ä–∞–≤–∞–º–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.</p>
      </div>

      <section id="orders" class="card admin-view" data-view="orders">
        <div class="section-header">
          <div>
            <h2>–ó–∞–∫–∞–∑—ã</h2>
            <p class="muted">–ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ –∑–∞–∫–∞–∑—ã, –æ–±–Ω–æ–≤–ª—è–π—Ç–µ —Å—Ç–∞—Ç—É—Å—ã –∏ –≤—ã–¥–∞–≤–∞–π—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å–∞–º –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã.</p>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <label for="status-filter" class="muted" style="margin:0;">–°—Ç–∞—Ç—É—Å</label>
            <select id="status-filter">
              <option value="all">–í—Å–µ</option>
              <option value="new">–ù–æ–≤—ã–π</option>
              <option value="in_progress">–í —Ä–∞–±–æ—Ç–µ</option>
              <option value="paid">–û–ø–ª–∞—á–µ–Ω</option>
              <option value="sent">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω</option>
              <option value="archived">–ê—Ä—Ö–∏–≤</option>
            </select>
          </div>
        </div>
        <table aria-label="–°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤">
          <thead>
            <tr>
              <th>ID</th>
              <th>–ö–ª–∏–µ–Ω—Ç</th>
              <th>–°—É–º–º–∞</th>
              <th>–°—Ç–∞—Ç—É—Å</th>
              <th>–î–∞—Ç–∞</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="orders-body"></tbody>
        </table>

        <div id="order-detail" class="card" style="margin-top:14px; display:none;">
          <div class="section-header">
            <h3>–ó–∞–∫–∞–∑ <span id="detail-id"></span></h3>
            <div style="display:flex; gap:8px; align-items:center;">
              <label for="detail-status" class="muted" style="margin:0;">–°—Ç–∞—Ç—É—Å</label>
              <select id="detail-status">
                <option value="new">–ù–æ–≤—ã–π</option>
                <option value="in_progress">–í —Ä–∞–±–æ—Ç–µ</option>
                <option value="paid">–û–ø–ª–∞—á–µ–Ω</option>
                <option value="sent">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω</option>
                <option value="archived">–ê—Ä—Ö–∏–≤</option>
              </select>
              <button class="btn secondary" type="button" id="save-status">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
          </div>
          <div class="grid" style="margin-top:10px;">
            <div>
              <div class="muted">–ö–ª–∏–µ–Ω—Ç</div>
              <div id="detail-client">‚Äî</div>
              <div class="muted" style="margin-top:8px;">–ö–æ–Ω—Ç–∞–∫—Ç</div>
              <div id="detail-contact">‚Äî</div>
              <div class="muted" style="margin-top:8px;">–ü—Ä–æ–º–æ–∫–æ–¥</div>
              <div id="detail-promocode">‚Äî</div>
            </div>
            <div>
              <div class="muted">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</div>
              <div id="detail-comment">‚Äî</div>
            </div>
          </div>
          <h4>–ü–æ–∑–∏—Ü–∏–∏</h4>
          <ul class="list" id="detail-items"></ul>
          <div id="detail-total" class="muted"></div>
        </div>
      </section>

      <section id="product-categories" class="card admin-view" data-view="product-categories" style="display:none;">
        <div class="section-header">
          <div>
            <h2>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤</h2>
            <p class="muted">–£–ø—Ä–∞–≤–ª—è–π—Ç–µ –≥—Ä—É–ø–ø–∞–º–∏ –∫–æ—Ä–∑–∏–Ω–æ–∫ –∏ –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤.</p>
          </div>
        </div>
        <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));">
          <div class="card" style="background: rgba(255,255,255,0.03);">
            <h3 id="product-category-form-title">–°–æ–∑–¥–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h3>
            <form id="product-category-form" class="stacked-form">
              <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
              <input type="text" name="name" required />
              <label>Slug/–∫–æ–¥</label>
              <input type="text" name="slug" placeholder="basket" />
              <label>–ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</label>
              <input type="number" name="sort_order" min="0" value="0" />
              <label style="display:flex; gap:8px; align-items:center; margin-top:8px;">
                <input type="checkbox" name="is_active" checked /> –ê–∫—Ç–∏–≤–Ω–∞
              </label>
              <div class="form-actions">
                <button class="btn primary" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn secondary" type="button" id="product-category-reset">–°–±—Ä–æ—Å–∏—Ç—å</button>
              </div>
            </form>
          </div>
          <div class="table-wrapper">
            <table aria-label="–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                  <th>–ü–æ—Ä—è–¥–æ–∫</th>
                  <th>–ê–∫—Ç–∏–≤–Ω–∞</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="product-categories-table"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="course-categories" class="card admin-view" data-view="course-categories" style="display:none;">
        <div class="section-header">
          <div>
            <h2>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å–æ–≤</h2>
            <p class="muted">–¢–∏–ø—ã –∫—É—Ä—Å–æ–≤ –∏ —É—Ä–æ–∫–æ–≤.</p>
          </div>
        </div>
        <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));">
          <div class="card" style="background: rgba(255,255,255,0.03);">
            <h3 id="course-category-form-title">–°–æ–∑–¥–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h3>
            <form id="course-category-form" class="stacked-form">
              <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
              <input type="text" name="name" required />
              <label>Slug/–∫–æ–¥</label>
              <input type="text" name="slug" placeholder="free" />
              <label>–ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</label>
              <input type="number" name="sort_order" min="0" value="0" />
              <label style="display:flex; gap:8px; align-items:center; margin-top:8px;">
                <input type="checkbox" name="is_active" checked /> –ê–∫—Ç–∏–≤–Ω–∞
              </label>
              <div class="form-actions">
                <button class="btn primary" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn secondary" type="button" id="course-category-reset">–°–±—Ä–æ—Å–∏—Ç—å</button>
              </div>
            </form>
          </div>
          <div class="table-wrapper">
            <table aria-label="–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å–æ–≤">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                  <th>–ü–æ—Ä—è–¥–æ–∫</th>
                  <th>–ê–∫—Ç–∏–≤–Ω–∞</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="course-categories-table"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="product-list" class="card admin-view" data-view="product-list" style="display:none;">
        <div class="section-header">
          <div>
            <h2>–¢–æ–≤–∞—Ä—ã</h2>
            <p class="muted">–í—Å–µ –∫–æ—Ä–∑–∏–Ω–∫–∏ –∏ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã.</p>
          </div>
          <div class="filters-row">
            <select id="products-category"></select>
            <select id="products-status">
              <option value="all">–í—Å–µ</option>
              <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
              <option value="hidden">–°–∫—Ä—ã—Ç—ã–µ</option>
            </select>
            <button class="btn primary" type="button" id="product-reset">–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä</button>
          </div>
        </div>

        <div class="table-wrapper">
          <table aria-label="–¢–æ–≤–∞—Ä—ã">
            <thead>
              <tr>
                <th>ID</th>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                <th>–¶–µ–Ω–∞</th>
                <th>–ê–∫—Ç–∏–≤–µ–Ω</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="products-table"></tbody>
          </table>
        </div>

        <div class="card" style="background: rgba(255,255,255,0.03); margin-top:16px;">
          <h3 id="product-form-title">–°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä</h3>
          <form id="product-form" class="stacked-form">
            <div class="form-grid">
              <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
              <select name="category_id" id="product-category-select"></select>
              <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
              <input type="text" name="name" id="product-name" required />
              <label>–¶–µ–Ω–∞</label>
              <input type="number" name="price" id="product-price" min="0" required />
              <label>–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</label>
              <textarea name="short_description" id="product-short-description" rows="2" placeholder="–ö—Ä–∞—Ç–∫–æ, –¥–æ ~100‚Äì150 —Å–∏–º–≤–æ–ª–æ–≤. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ —Ç–æ–≤–∞—Ä–∞."></textarea>
              <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
              <textarea name="description" id="product-description"></textarea>
              <label>–°—Å—ã–ª–∫–∞ –Ω–∞ Wildberries</label>
              <input type="text" name="wb_url" id="product-wb-url" />
              <label>–°—Å—ã–ª–∫–∞ –Ω–∞ Ozon</label>
              <input type="text" name="ozon_url" id="product-ozon-url" />
              <label>–°—Å—ã–ª–∫–∞ –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–ú–∞—Ä–∫–µ—Ç</label>
              <input type="text" name="yandex_url" id="product-yandex-url" />
              <label>–°—Å—ã–ª–∫–∞ –Ω–∞ –ê–≤–∏—Ç–æ</label>
              <input type="text" name="avito_url" id="product-avito-url" />
              <label>–°—Å—ã–ª–∫–∞ –Ω–∞ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å</label>
              <input type="text" name="masterclass_url" id="product-masterclass-url" />
              <label>–°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏</label>
              <input type="text" name="detail_url" id="product-detail-url" />
            </div>

            <div class="form-group">
              <label>–§–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞</label>
              <input type="file" id="product-image-file-input" accept="image/*">
            </div>
            <div class="form-group">
              <label>URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (image_url)</label>
              <input type="text" id="product-image-url-input" name="image_url" placeholder="/media/products/xxx.jpg">
            </div>
            <div class="form-group">
              <div id="product-image-preview" class="image-preview-box">–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
            </div>
            <div class="form-group">
              <label>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Ç–æ–≤–∞—Ä–∞</label>
              <div class="image-upload-row">
                <input type="file" id="product-gallery-input" accept="image/*" multiple>
                <div class="muted" style="font-size:13px;">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.</div>
              </div>
              <div id="product-images-list" class="image-list muted">–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ç–æ–≤–∞—Ä, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ.</div>
            </div>
            <div class="form-actions">
              <button class="btn primary" type="submit">–°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä</button>
              <button class="btn secondary" type="button" id="product-cancel">–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä</button>
            </div>
          </form>
        </div>
      </section>

      <section id="course-list" class="card admin-view" data-view="course-list" style="display:none;">
        <div class="section-header">
          <div>
            <h2>–ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã</h2>
            <p class="muted">–û–Ω–ª–∞–π–Ω —É—Ä–æ–∫–∏. –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã —Å—Ä–∞–∑—É, –ø–ª–∞—Ç–Ω—ã–µ ‚Äî –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –∑–∞–∫–∞–∑–∞.</p>
          </div>
          <div class="filters-row">
            <select id="courses-category"></select>
            <select id="courses-status">
              <option value="all">–í—Å–µ</option>
              <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
              <option value="hidden">–°–∫—Ä—ã—Ç—ã–µ</option>
            </select>
            <button class="btn primary" type="button" id="course-reset">–ù–æ–≤—ã–π –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å</button>
          </div>
        </div>
        <div class="table-wrapper">
          <table aria-label="–ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã">
            <thead>
              <tr>
                <th>ID</th>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                <th>–¶–µ–Ω–∞</th>
                <th>–ê–∫—Ç–∏–≤–µ–Ω</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="courses-table"></tbody>
          </table>
        </div>

        <div class="card" style="background: rgba(255,255,255,0.03); margin-top:16px;">
          <h3 id="course-form-title">–°–æ–∑–¥–∞—Ç—å –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å</h3>
          <form id="course-form" class="stacked-form">
            <div class="form-grid">
              <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
              <select name="category_id" id="course-category-select"></select>
              <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
              <input type="text" name="name" id="course-name" required />
              <label>–¶–µ–Ω–∞ (0 ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω–æ)</label>
              <input type="number" name="price" id="course-price" min="0" required />
              <label>–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</label>
              <textarea name="short_description" id="course-short-description" rows="2" placeholder="–ö—Ä–∞—Ç–∫–æ, –¥–æ ~100‚Äì150 —Å–∏–º–≤–æ–ª–æ–≤. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ –∫—É—Ä—Å–∞."></textarea>
              <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
              <textarea name="description" id="course-description"></textarea>
              <label>–°—Å—ã–ª–∫–∞ –Ω–∞ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å</label>
              <input type="text" name="masterclass_url" id="course-masterclass-url" />
              <label>–°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏</label>
              <input type="text" name="detail_url" id="course-detail-url" />
            </div>
            <div class="form-group">
              <label>–§–æ—Ç–æ –∫—É—Ä—Å–∞</label>
              <input type="file" id="course-image-file-input" accept="image/*">
            </div>
            <div class="form-group">
              <label>URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (image_url)</label>
              <input type="text" id="course-image-url-input" name="image_url" placeholder="/media/courses/xxx.jpg">
            </div>
            <div class="form-group">
              <div id="course-image-preview" class="image-preview-box">–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
            </div>
            <div class="form-group">
              <label>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å–∞</label>
              <div class="image-upload-row">
                <input type="file" id="course-gallery-input" accept="image/*" multiple>
                <div class="muted" style="font-size:13px;">–î–æ–±–∞–≤—å—Ç–µ –æ–¥–Ω–æ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.</div>
              </div>
              <div id="course-images-list" class="image-list muted">–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ.</div>
            </div>
            <div class="form-actions">
              <button class="btn primary" type="submit">–°–æ–∑–¥–∞—Ç—å –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å</button>
              <button class="btn secondary" type="button" id="course-cancel">–ù–æ–≤—ã–π –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å</button>
            </div>
          </form>
        </div>
      </section>

      <section id="promocode-list" class="card admin-view" data-view="promocode-list" style="display:none;">
        <div class="section-header">
          <div>
            <h2>–°–ø–∏—Å–æ–∫ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤</h2>
            <p class="muted">–í—Å–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.</p>
          </div>
          <div class="filters-row">
            <select id="promo-status-filter">
              <option value="all">–í—Å–µ</option>
              <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
              <option value="inactive">–ù–µ –∞–∫—Ç–∏–≤–Ω—ã–µ</option>
            </select>
            <button class="btn primary" type="button" id="promo-create-new" data-view="promocode-list" data-action="promo-new">–ù–æ–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥</button>
          </div>
        </div>
        <div class="card" style="overflow:auto;">
          <table aria-label="–ü—Ä–æ–º–æ–∫–æ–¥—ã" style="width:100%; min-width:760px;">
            <thead>
              <tr>
                <th>ID</th>
                <th>–ö–æ–¥</th>
                <th>–¢–∏–ø —Å–∫–∏–¥–∫–∏</th>
                <th>–ó–Ω–∞—á–µ–Ω–∏–µ</th>
                <th>–û–±–ª–∞—Å—Ç—å / —Ü–µ–ª—å</th>
                <th>–ü–µ—Ä–∏–æ–¥ –¥–µ–π—Å—Ç–≤–∏—è</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="promo-table"></tbody>
          </table>
        </div>

        <div class="card" style="max-width:720px; margin:16px auto 0;">
          <h3 id="promo-create-title">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</h3>
          <form id="promo-create-form" class="stacked-form">
            <label for="promo-create-code">–ö–æ–¥</label>
            <input type="text" id="promo-create-code" name="code" required />

            <label for="promo-create-discount-type">–¢–∏–ø —Å–∫–∏–¥–∫–∏</label>
            <select id="promo-create-discount-type" name="discount_type" required>
              <option value="percent">–ü—Ä–æ—Ü–µ–Ω—Ç</option>
              <option value="fixed">–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è</option>
            </select>

            <label for="promo-create-discount-value">–ó–Ω–∞—á–µ–Ω–∏–µ</label>
            <input type="number" id="promo-create-discount-value" name="discount_value" min="1" step="1" required />

            <label for="promo-create-scope">–û–±–ª–∞—Å—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è</label>
            <select id="promo-create-scope" name="scope" required>
              <option value="all">–ù–∞ –≤–µ—Å—å –∑–∞–∫–∞–∑</option>
              <option value="basket">–¢–æ–ª—å–∫–æ –∫–æ—Ä–∑–∏–Ω–∫–∏</option>
              <option value="course">–¢–æ–ª—å–∫–æ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã</option>
              <option value="product">–û–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä/–∫—É—Ä—Å</option>
              <option value="category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∫–æ—Ä–∑–∏–Ω–æ–∫</option>
            </select>

            <label for="promo-create-target">ID —Ü–µ–ª–∏ (–¥–ª—è product/category)</label>
            <input type="number" id="promo-create-target" name="target_id" min="0" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, ID —Ç–æ–≤–∞—Ä–∞ –∏–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" />

            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
              <div>
                <label for="promo-create-date-start">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                <input type="datetime-local" id="promo-create-date-start" name="date_start" />
              </div>
              <div>
                <label for="promo-create-date-end">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                <input type="datetime-local" id="promo-create-date-end" name="date_end" />
              </div>
            </div>

            <label for="promo-create-max-uses">–ú–∞–∫—Å–∏–º—É–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π</label>
            <input type="number" id="promo-create-max-uses" name="max_uses" min="0" placeholder="0 ‚Äî –±–µ–∑ –ª–∏–º–∏—Ç–∞" />

            <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:6px;">
              <label style="display:flex; align-items:center; gap:6px; margin:0;"><input type="checkbox" id="promo-create-active" name="active" checked /> –ê–∫—Ç–∏–≤–µ–Ω</label>
              <label style="display:flex; align-items:center; gap:6px; margin:0;"><input type="checkbox" id="promo-create-one-per-user" name="one_per_user" /> –û–¥–∏–Ω —Ä–∞–∑ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
            </div>

            <div class="form-actions">
              <button class="btn primary" type="submit">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</button>
              <button class="btn secondary" type="button" id="promo-create-reset">–°–±—Ä–æ—Å–∏—Ç—å</button>
            </div>
          </form>
        </div>
      </section>

      <section id="reviews" class="card admin-view" data-view="reviews" style="display:none;">
        <div class="section-header" style="align-items:flex-start; gap:12px;">
          <div>
            <h2>–û—Ç–∑—ã–≤—ã</h2>
            <p class="muted">–ú–æ–¥–µ—Ä–∏—Ä—É–π—Ç–µ –æ—Ç–∑—ã–≤—ã –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π, –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ —Ç–µ–∫—Å—Ç –∏ —Ñ–æ—Ç–æ, –º–µ–Ω—è–π—Ç–µ —Å—Ç–∞—Ç—É—Å—ã.</p>
            <div class="review-counters" id="review-counters">
              <span class="tag">–í—Å–µ–≥–æ: <strong id="reviews-count-total">0</strong></span>
              <span class="tag">–ù–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏: <strong id="reviews-count-pending">0</strong></span>
              <span class="tag">–û–¥–æ–±—Ä–µ–Ω–æ: <strong id="reviews-count-approved">0</strong></span>
              <span class="tag">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ: <strong id="reviews-count-rejected">0</strong></span>
            </div>
          </div>
          <div class="review-filters">
            <label class="muted">–°—Ç–∞—Ç—É—Å</label>
            <select id="review-status-filter">
              <option value="all">–í—Å–µ</option>
              <option value="pending">–ù–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏</option>
              <option value="approved">–û–¥–æ–±—Ä–µ–Ω–æ</option>
              <option value="rejected">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</option>
            </select>
            <label class="muted">–¢–æ–≤–∞—Ä</label>
            <select id="review-product-filter"></select>
            <label class="muted">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
            <input type="text" id="review-user-filter" placeholder="ID –∏–ª–∏ –∏–º—è" />
            <button class="btn secondary" type="button" id="review-reset-btn">–°–±—Ä–æ—Å–∏—Ç—å</button>
          </div>
        </div>

        <div class="card" style="overflow:auto;">
          <table aria-label="–û—Ç–∑—ã–≤—ã" class="reviews-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>–¢–æ–≤–∞—Ä</th>
                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                <th>–†–µ–π—Ç–∏–Ω–≥</th>
                <th>–¢–µ–∫—Å—Ç</th>
                <th>–§–æ—Ç–æ</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–î–∞—Ç–∞</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="reviews-table-body"></tbody>
          </table>
        </div>
      </section>

      <section id="stats" class="card admin-view" data-view="stats" style="display:none;">
        <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
        <p class="muted">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –∏ –ø—Ä–æ–¥–∞–∂ –æ—Å—Ç–∞—ë—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω–æ–π —á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π API. –≠—Ç–∞ –≤–∫–ª–∞–¥–∫–∞ ‚Äî –∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è –±—É–¥—É—â–µ–≥–æ UI.</p>
      </section>
    </main>
  </div>

  <script src="js/app.js?v=20241222"></script>
  <script src="js/api.js?v=20241222"></script>
  <script>
    const statusBox = document.getElementById('status');
    const accessDenied = document.getElementById('access-denied');
    const navLinks = document.querySelectorAll('.nav-btn[data-view]');
    const navParents = document.querySelectorAll('[data-group-toggle]');

    const ordersBody = document.getElementById('orders-body');
    const statusFilter = document.getElementById('status-filter');
    const orderDetail = document.getElementById('order-detail');
    const detailId = document.getElementById('detail-id');
    const detailStatus = document.getElementById('detail-status');
    const saveStatusBtn = document.getElementById('save-status');
    const detailClient = document.getElementById('detail-client');
    const detailContact = document.getElementById('detail-contact');
    const detailPromocode = document.getElementById('detail-promocode');
    const detailComment = document.getElementById('detail-comment');
    const detailItems = document.getElementById('detail-items');
    const detailTotal = document.getElementById('detail-total');

    const reviewStatusFilter = document.getElementById('review-status-filter');
    const reviewProductFilter = document.getElementById('review-product-filter');
    const reviewUserFilter = document.getElementById('review-user-filter');
    const reviewResetBtn = document.getElementById('review-reset-btn');
    const reviewsTableBody = document.getElementById('reviews-table-body');
    const reviewsCountTotal = document.getElementById('reviews-count-total');
    const reviewsCountPending = document.getElementById('reviews-count-pending');
    const reviewsCountApproved = document.getElementById('reviews-count-approved');
    const reviewsCountRejected = document.getElementById('reviews-count-rejected');

    const productCategoryFilter = document.getElementById('products-category');
    const courseCategoryFilter = document.getElementById('courses-category');
    const productsStatusFilter = document.getElementById('products-status');
    const coursesStatusFilter = document.getElementById('courses-status');
    const productsTable = document.getElementById('products-table');
    const coursesTable = document.getElementById('courses-table');
    const productImageFileInput = document.getElementById('product-image-file-input');
    const productImageUrlInput = document.getElementById('product-image-url-input');
    const productImagePreview = document.getElementById('product-image-preview');
    const productGalleryInput = document.getElementById('product-gallery-input');
    const productImagesList = document.getElementById('product-images-list');
    const courseImageFileInput = document.getElementById('course-image-file-input');
    const courseImageUrlInput = document.getElementById('course-image-url-input');
    const courseImagePreview = document.getElementById('course-image-preview');
    const courseGalleryInput = document.getElementById('course-gallery-input');
    const courseImagesList = document.getElementById('course-images-list');
    const imageModal = document.getElementById('image-modal');
    const imageModalClose = document.getElementById('image-modal-close');
    const imageModalPicture = document.getElementById('image-modal-picture');

    const productForm = document.getElementById('product-form');
    const courseForm = document.getElementById('course-form');
    const productFormTitle = document.getElementById('product-form-title');
    const courseFormTitle = document.getElementById('course-form-title');
    const productCategorySelect = document.getElementById('product-category-select');
    const courseCategorySelect = document.getElementById('course-category-select');
    const productCancel = document.getElementById('product-cancel');
    const courseCancel = document.getElementById('course-cancel');
    const productReset = document.getElementById('product-reset');
    const courseReset = document.getElementById('course-reset');
    const promoTable = document.getElementById('promo-table');
    const promoStatusFilter = document.getElementById('promo-status-filter');
    const promoCreateForm = document.getElementById('promo-create-form');
    const promoCreateTitle = document.getElementById('promo-create-title');
    const promoCreateCode = document.getElementById('promo-create-code');
    const promoCreateDiscountType = document.getElementById('promo-create-discount-type');
    const promoCreateDiscountValue = document.getElementById('promo-create-discount-value');
    const promoCreateScope = document.getElementById('promo-create-scope');
    const promoCreateTarget = document.getElementById('promo-create-target');
    const promoCreateDateStart = document.getElementById('promo-create-date-start');
    const promoCreateDateEnd = document.getElementById('promo-create-date-end');
    const promoCreateMaxUses = document.getElementById('promo-create-max-uses');
    const promoCreateActive = document.getElementById('promo-create-active');
    const promoCreateOnePerUser = document.getElementById('promo-create-one-per-user');
    const promoCreateReset = document.getElementById('promo-create-reset');
    const productCategoriesTable = document.getElementById('product-categories-table');
    const courseCategoriesTable = document.getElementById('course-categories-table');
    const productCategoryForm = document.getElementById('product-category-form');
    const courseCategoryForm = document.getElementById('course-category-form');
    const productCategoryFormTitle = document.getElementById('product-category-form-title');
    const courseCategoryFormTitle = document.getElementById('course-category-form-title');
    const productCategoryReset = document.getElementById('product-category-reset');
    const courseCategoryReset = document.getElementById('course-category-reset');

    let currentUser = null;
    let selectedOrder = null;
    const productFormDefaults = {
      category_id: '',
      name: '',
      price: null,
      short_description: '',
      description: '',
      wb_url: '',
      ozon_url: '',
      yandex_url: '',
      avito_url: '',
      masterclass_url: '',
      detail_url: '',
      image_url: '',
    };
    const courseFormDefaults = {
      category_id: '',
      name: '',
      price: null,
      short_description: '',
      description: '',
      masterclass_url: '',
      detail_url: '',
      image_url: '',
    };
    const promoFormDefaults = {
      code: '',
      discount_type: 'percent',
      discount_value: null,
      scope: 'all',
      target_id: '',
      date_start: '',
      date_end: '',
      max_uses: '',
      active: true,
      one_per_user: false,
    };

    const productFormState = createSectionFormState(productFormDefaults);
    const courseFormState = createSectionFormState(courseFormDefaults);
    const promoCreateState = createSectionFormState(promoFormDefaults);
    let editingProductCategoryId = null;
    let editingCourseCategoryId = null;
    let promocodeItems = [];
    let reviewItems = [];
    let productItems = [];
    let courseItems = [];
    let productCurrentId = null;
    let masterclassCurrentId = null;
    let promoCurrentId = null;
    const productSubmitBtn = productForm?.querySelector('button[type="submit"]');
    const courseSubmitBtn = courseForm?.querySelector('button[type="submit"]');
    const promoSubmitBtn = promoCreateForm?.querySelector('button[type="submit"]');

    function setStatus(message, isError = false) {
      if (!message) {
        statusBox.style.display = 'none';
        statusBox.textContent = '';
        statusBox.classList.remove('error');
        return;
      }
      statusBox.style.display = 'block';
      statusBox.textContent = message;
      statusBox.style.borderColor = isError ? 'rgba(255,99,99,0.7)' : 'var(--border)';
    }

    function getErrorMessage(error, fallback = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞') {
      if (!error) return fallback;
      if (error.data?.detail) return error.data.detail;
      if (error.data?.message) return error.data.message;
      if (error.message) return error.message;
      if (typeof error === 'string') return error;
      return fallback;
    }

    function handleError(error, fallback = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞') {
      console.error(error);
      setStatus(getErrorMessage(error, fallback), true);
    }

    function showImageListPlaceholder(target, message) {
      if (!target) return;
      target.classList.add('muted');
      target.innerHTML = `<div class="muted small">${message}</div>`;
    }

    function openImageModal(url) {
      if (!imageModal || !imageModalPicture) return;
      imageModalPicture.src = url;
      imageModal.classList.remove('hidden');
    }

    function closeImageModal() {
      if (!imageModal || !imageModalPicture) return;
      imageModalPicture.src = '';
      imageModal.classList.add('hidden');
    }

    async function sendJson(path, method = 'GET', body = null) {
      const res = await fetch(`${API_BASE}${path}`, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: body ? JSON.stringify(body) : undefined,
      });
      return handleResponse(res);
    }

    function showSection(id) {
      document.querySelectorAll('.admin-view').forEach((el) => {
        el.style.display = el.dataset.view === id ? 'block' : 'none';
      });
      navLinks.forEach((btn) => {
        const isActive = btn.dataset.view === id;
        btn.classList.toggle('active', isActive);
        const group = btn.closest('.nav-group');
        if (isActive && group) {
          group.classList.add('open');
        }
      });
    }

    function handleViewNavigation(view) {
      showSection(view);
      if (view === 'product-categories') {
        loadProductCategories();
      }
      if (view === 'course-categories') {
        loadCourseCategories();
      }
      if (view === 'promocode-list') {
        loadPromocodes();
      }
      if (view === 'product-list') {
        loadProducts();
      }
      if (view === 'course-list') {
        loadCourses();
      }
      if (view === 'orders') {
        loadOrders();
      }
      if (view === 'reviews') {
        loadReviews();
      }
    }

    function openProductCreateView() {
      resetProductCreateForm();
      showSection('product-list');
      productForm?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function openCourseCreateView() {
      resetCourseFormState();
      showSection('course-list');
      courseForm?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function openPromocodeCreateView() {
      resetPromoCreateForm();
      showSection('promocode-list');
      promoCreateForm?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    navLinks.forEach((btn) => {
      btn.addEventListener('click', () => {
        const view = btn.dataset.view;
        if (btn.dataset.action === 'product-new') return openProductCreateView();
        if (btn.dataset.action === 'course-new') return openCourseCreateView();
        if (btn.dataset.action === 'promo-new') return openPromocodeCreateView();
        handleViewNavigation(view);
      });
    });

    document.querySelectorAll('[data-view]').forEach((btn) => {
      if (btn.classList.contains('nav-btn')) return;
      btn.addEventListener('click', () => {
        const view = btn.dataset.view;
        if (btn.dataset.action === 'product-new') return openProductCreateView();
        if (btn.dataset.action === 'course-new') return openCourseCreateView();
        if (btn.dataset.action === 'promo-new') return openPromocodeCreateView();
        handleViewNavigation(view);
      });
    });

    navParents.forEach((parent) => {
      parent.addEventListener('click', () => {
        const groupName = parent.dataset.groupToggle;
        const group = document.querySelector(`.nav-group[data-group="${groupName}"]`);
        group?.classList.toggle('open');
        const defaultView = parent.dataset.defaultView;
        if (defaultView) {
          handleViewNavigation(defaultView);
        }
      });
    });

    function requireAdmin(profile) {
      if (!profile || !profile.is_admin) {
        setStatus('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω', true);
        accessDenied.style.display = 'block';
        document.querySelectorAll('.admin-view').forEach((el) => (el.style.display = 'none'));
        return false;
      }
      accessDenied.style.display = 'none';
      return true;
    }

    function renderReviewCounters(items) {
      const stats = items.reduce(
        (acc, item) => {
          acc.total += 1;
          if (item.status === 'approved') acc.approved += 1;
          if (item.status === 'pending') acc.pending += 1;
          if (item.status === 'rejected') acc.rejected += 1;
          return acc;
        },
        { total: 0, approved: 0, pending: 0, rejected: 0 }
      );
      reviewsCountTotal.textContent = stats.total;
      reviewsCountPending.textContent = stats.pending;
      reviewsCountApproved.textContent = stats.approved;
      reviewsCountRejected.textContent = stats.rejected;
    }

    function getProductLabel(product) {
      if (!product) return '‚Äî';
      return product.title || product.name || product.short_name || `–¢–æ–≤–∞—Ä #${product.id}`;
    }

    function getProductLink(product) {
      if (!product) return null;
      return product.detail_url || `/webapp/products.html#${product.id || ''}`;
    }

    function renderReviewPhotosCell(photos) {
      const container = document.createElement('div');
      container.className = 'review-photos';
      const images = Array.isArray(photos) ? photos.filter(Boolean) : [];
      if (!images.length) {
        container.textContent = '‚Äî';
        container.classList.add('muted');
        return container;
      }

      images.forEach((url, idx) => {
        const thumb = document.createElement('img');
        thumb.className = 'review-photo-thumb';
        thumb.src = url;
        thumb.alt = `–§–æ—Ç–æ –æ—Ç–∑—ã–≤–∞ ${idx + 1}`;
        container.appendChild(thumb);
      });
      return container;
    }

    function renderReviewActionsCell(review) {
      const cell = document.createElement('td');
      cell.className = 'review-actions-cell';

      const approveBtn = document.createElement('button');
      approveBtn.className = 'btn secondary';
      approveBtn.textContent = '–û–¥–æ–±—Ä–∏—Ç—å';
      approveBtn.disabled = review.status === 'approved';
      approveBtn.addEventListener('click', () => updateReviewStatus(review, 'approved'));

      const rejectBtn = document.createElement('button');
      rejectBtn.className = 'btn secondary';
      rejectBtn.textContent = '–û—Ç–∫–ª–æ–Ω–∏—Ç—å';
      rejectBtn.disabled = review.status === 'rejected';
      rejectBtn.addEventListener('click', () => updateReviewStatus(review, 'rejected'));

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'btn secondary danger';
      deleteBtn.textContent = review.is_deleted ? '–£–¥–∞–ª–µ–Ω–æ' : '–£–¥–∞–ª–∏—Ç—å';
      deleteBtn.disabled = review.is_deleted;
      deleteBtn.addEventListener('click', () => updateReviewStatus(review, review.status, true));

      const detailsBtn = document.createElement('button');
      detailsBtn.className = 'btn secondary';
      detailsBtn.textContent = '–ü–æ–¥—Ä–æ–±–Ω–µ–µ';
      detailsBtn.addEventListener('click', () => openReviewModal(review));

      [approveBtn, rejectBtn, deleteBtn, detailsBtn].forEach((btn) => cell.appendChild(btn));
      return cell;
    }

    function renderReviewsTable(items) {
      reviewsTableBody.innerHTML = '';
      if (!items.length) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 9;
        cell.textContent = '–û—Ç–∑—ã–≤—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
        cell.className = 'muted';
        row.appendChild(cell);
        reviewsTableBody.appendChild(row);
        renderReviewCounters(items);
        return;
      }

      items.forEach((review) => {
        const row = document.createElement('tr');
        if (review.is_deleted) {
          row.classList.add('muted');
        }
        const date = review.created_at ? new Date(review.created_at).toLocaleString('ru-RU') : '‚Äî';
        const productLink = getProductLink(review.product);
        const textPreview = document.createElement('div');
        textPreview.className = 'review-text-preview';
        textPreview.textContent = review.text || '‚Äî';

        row.innerHTML = `
          <td>#${review.id}</td>
          <td>
            <div class="review-product">
              <span>${getProductLabel(review.product)}</span>
              ${productLink ? `<a href="${productLink}" target="_blank" rel="noopener" title="–û—Ç–∫—Ä—ã—Ç—å —Ç–æ–≤–∞—Ä">üîó</a>` : ''}
            </div>
          </td>
          <td>${review.user_name || '‚Äî'}${review.user_id ? ` (#${review.user_id})` : ''}</td>
          <td>${review.rating ? `${'‚òÖ'.repeat(review.rating)}${'‚òÜ'.repeat(5 - review.rating)}` : '‚Äî'}</td>
          <td></td>
          <td></td>
          <td><span class="admin-pill review-status-${review.status}">${review.status}</span>${review.is_deleted ? '<div class="muted" style="font-size:12px;">–£–¥–∞–ª—ë–Ω</div>' : ''}</td>
          <td>${date}</td>
        `;

        row.children[4].appendChild(textPreview);
        row.children[5].appendChild(renderReviewPhotosCell(review.photos || review.photos_json || []));
        row.appendChild(renderReviewActionsCell(review));
        reviewsTableBody.appendChild(row);
      });
      renderReviewCounters(items);
    }

    function applyReviewSearchFilter(items) {
      const query = (reviewUserFilter.value || '').trim().toLowerCase();
      if (!query) return items;
      const isNumeric = /^\d+$/.test(query);
      return items.filter((item) => {
        const userName = (item.user_name || '').toLowerCase();
        const userIdMatch = item.user_id ? String(item.user_id).includes(query) : false;
        if (isNumeric) return userIdMatch;
        return userName.includes(query) || userIdMatch;
      });
    }

    async function loadReviewProducts() {
      try {
        const data = await apiGet('/admin/products', { user_id: currentUser.telegram_id, type: 'basket', status: 'all' });
        reviewProductFilter.innerHTML = '';
        const allOption = document.createElement('option');
        allOption.value = '';
        allOption.textContent = '–í—Å–µ —Ç–æ–≤–∞—Ä—ã';
        reviewProductFilter.appendChild(allOption);
        (data.items || []).forEach((product) => {
          const option = document.createElement('option');
          option.value = product.id;
          option.textContent = `${product.id} ‚Äî ${product.name}`;
          reviewProductFilter.appendChild(option);
        });
      } catch (e) {
        console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–≤–∞—Ä—ã –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ –æ—Ç–∑—ã–≤–æ–≤', e);
      }
    }

    async function loadReviews() {
      if (!currentUser) return;
      try {
        const status = reviewStatusFilter.value === 'all' ? undefined : reviewStatusFilter.value;
        const productId = reviewProductFilter.value ? Number(reviewProductFilter.value) : undefined;
        const userQuery = (reviewUserFilter.value || '').trim();
        const params = { status, product_id: productId, page: 1, limit: 100 };
        if (/^\d+$/.test(userQuery)) {
          params.user_id = Number(userQuery);
        }

        const data = await apiGet('/admin/reviews', params);
        reviewItems = data.items || [];
        const filtered = applyReviewSearchFilter(reviewItems);
        renderReviewsTable(filtered);
        setStatus('');
      } catch (e) {
        handleError(e, '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç–∑—ã–≤—ã');
      }
    }

    async function updateReviewStatus(review, newStatus, isDeleted = false) {
      try {
        const payload = { status: newStatus, is_deleted: Boolean(isDeleted) };
        const res = await apiPost(`/admin/reviews/${review.id}/status`, payload);
        review.status = res.status;
        review.is_deleted = res.is_deleted;
        if (reviewStatusFilter.value !== 'all' && reviewStatusFilter.value !== res.status) {
          reviewItems = reviewItems.filter((item) => item.id !== review.id);
        }
        renderReviewsTable(applyReviewSearchFilter(reviewItems));
        showToast('–°—Ç–∞—Ç—É—Å –æ—Ç–∑—ã–≤–∞ –æ–±–Ω–æ–≤–ª—ë–Ω');
      } catch (e) {
        handleError(e, '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –æ—Ç–∑—ã–≤–∞');
      }
    }

    function openReviewModal(review) {
      const modal = document.getElementById('review-modal');
      const titleEl = document.getElementById('review-modal-title');
      const textEl = document.getElementById('review-modal-text');
      const galleryEl = document.getElementById('review-modal-photos');

      titleEl.textContent = `${getProductLabel(review.product)} ‚Ä¢ ${review.user_name || '‚Äî'} ‚Ä¢ ${review.rating || '-'}‚òÖ`;
      textEl.textContent = review.text || '‚Äî';

      galleryEl.innerHTML = '';
      (review.photos || review.photos_json || []).forEach((url) => {
        const img = document.createElement('img');
        img.src = url;
        img.alt = '–§–æ—Ç–æ –æ—Ç–∑—ã–≤–∞';
        galleryEl.appendChild(img);
      });

      modal.classList.remove('hidden');
    }

    function closeReviewModal() {
      const modal = document.getElementById('review-modal');
      modal.classList.add('hidden');
    }

    function renderOrders(orders) {
      ordersBody.innerHTML = '';
      if (!orders || !orders.length) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 6;
        cell.textContent = '–ó–∞–∫–∞–∑–æ–≤ –Ω–µ—Ç';
        cell.className = 'muted';
        row.appendChild(cell);
        ordersBody.appendChild(row);
        return;
      }

      orders.forEach((order) => {
        const row = document.createElement('tr');
        const date = order.created_at ? new Date(order.created_at).toLocaleString('ru-RU') : '';
        row.innerHTML = `
          <td>#${order.id}</td>
          <td>${order.customer_name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</td>
          <td>${order.total || 0} ‚ÇΩ</td>
          <td>${order.status || 'new'}</td>
          <td>${date}</td>
          <td><button class="btn secondary" data-id="${order.id}">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button></td>
        `;
        row.querySelector('button').addEventListener('click', () => loadOrderDetail(order.id));
        ordersBody.appendChild(row);
      });
    }

    function renderOrderDetail(order) {
      selectedOrder = order;
      orderDetail.style.display = 'block';
      detailId.textContent = `#${order.id}`;
      detailStatus.value = order.status || 'new';
      detailClient.textContent = order.customer_name || '‚Äî';
      detailContact.textContent = order.contact || '‚Äî';
      detailPromocode.textContent = order.promocode_code || '‚Äî';
      detailComment.textContent = order.comment || '‚Äî';
      detailItems.innerHTML = '';

      (order.items || []).forEach((item) => {
        const li = document.createElement('li');
        const label = item.type === 'course' ? 'üéì' : 'üß∫';
        const access = item.type === 'course' ? (item.can_access ? '–¥–æ—Å—Ç—É–ø –æ—Ç–∫—Ä—ã—Ç' : '–ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã') : '';
        li.textContent = `${label} ${item.name || '–¢–æ–≤–∞—Ä'} ‚Äî ${item.qty} √ó ${item.price} ‚ÇΩ ${access}`;
        detailItems.appendChild(li);
      });

      detailTotal.textContent = `–ò—Ç–æ–≥–æ: ${order.total || 0} ‚ÇΩ`;
    }

    async function loadOrders() {
      if (!currentUser) return;
      try {
        const status = statusFilter.value === 'all' ? undefined : statusFilter.value;
        const data = await apiGet('/admin/orders', { user_id: currentUser.telegram_id, status });
        renderOrders(data.items || []);
        setStatus('');
      } catch (e) {
        handleError(e, '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–∫–∞–∑—ã');
      }
    }

    async function loadOrderDetail(orderId) {
      try {
        const order = await apiGet(`/admin/orders/${orderId}`, { user_id: currentUser.telegram_id });
        renderOrderDetail(order);
      } catch (e) {
        handleError(e, '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–∫–∞–∑');
      }
    }

    async function updateOrderStatus() {
      if (!currentUser || !selectedOrder) return;
      try {
        const payload = { user_id: currentUser.telegram_id, status: detailStatus.value };
        const updated = await apiPost(`/admin/orders/${selectedOrder.id}/status`, payload);
        setStatus('–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –æ–±–Ω–æ–≤–ª—ë–Ω');
        renderOrderDetail(updated);
        await loadOrders();
      } catch (e) {
        handleError(e, '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞');
      }
    }

    statusFilter.addEventListener('change', loadOrders);
    saveStatusBtn.addEventListener('click', updateOrderStatus);

    async function loadCategories(targetSelect, type) {
      try {
        if (!targetSelect) return;
        const categoriesRes = await apiGet('/categories', { type });
        const categories = Array.isArray(categoriesRes) ? categoriesRes : categoriesRes?.items || [];
        targetSelect.innerHTML = '';
        const allOption = document.createElement('option');
        allOption.value = '';
        allOption.textContent = '–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
        targetSelect.appendChild(allOption);
        categories.forEach((cat) => {
          const option = document.createElement('option');
          option.value = cat.id ?? cat.slug ?? '';
          option.textContent = cat.name;
          targetSelect.appendChild(option);
        });
      } catch (e) {
        handleError(e, '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
      }
    }

    function fillForm(form, data = {}) {
      if (!form) return;
      Object.entries(data).forEach(([key, value]) => {
        const el = form.elements.namedItem(key);
        if (!el) return;
        if (el.type === 'checkbox') {
          el.checked = Boolean(value);
          return;
        }
        if (el.type === 'radio') {
          const radio = form.querySelector(`input[name="${key}"][value="${value}"]`);
          if (radio) radio.checked = true;
          return;
        }
        if (el.tagName === 'SELECT' || el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
          el.value = value ?? '';
        }
      });
    }

    function serializeForm(form) {
      const payload = {};
      Array.from(form.elements).forEach((el) => {
        if (!el.name) return;
        const value = typeof el.value === 'string' ? el.value.trim() : el.value;
        if (el.type === 'checkbox') {
          payload[el.name] = el.checked;
          return;
        }
        if (el.name === 'category_id') {
          payload[el.name] = value && !Number.isNaN(Number(value)) ? Number(value) : null;
          return;
        }
        if (el.type === 'number') {
          const numberValue = value === '' || value === null ? null : Number(value);
          payload[el.name] = Number.isNaN(numberValue) ? null : numberValue;
        } else {
          payload[el.name] = value === '' ? null : value;
        }
      });
      return payload;
    }

    function createFormState(defaults = {}) {
      return { ...defaults };
    }

    function createSectionFormState(defaults = {}) {
      return {
        mode: 'create',
        currentId: null,
        formData: createFormState(defaults),
      };
    }

    function resetFormState(state, defaults = {}) {
      Object.keys(state).forEach((key) => delete state[key]);
      Object.assign(state, defaults);
    }

    function applyStateToForm(form, state) {
      if (!form || !state) return;
      Array.from(form.elements).forEach((el) => {
        if (!el.name || !(el.name in state)) return;
        const value = state[el.name];
        if (el.type === 'checkbox') {
          el.checked = Boolean(value);
        } else if (el.type === 'radio') {
          el.checked = el.value === value;
        } else {
          el.value = value ?? '';
        }
      });
    }

    function handleFormInput(event, state) {
      const el = event.target;
      if (!el?.name || !(el.name in state)) return;
      if (el.type === 'checkbox') {
        state[el.name] = el.checked;
        return;
      }
      if (el.type === 'number') {
        state[el.name] = el.value === '' ? null : Number(el.value);
        return;
      }
      state[el.name] = el.value;
    }

    function bindStateToForm(form, state) {
      if (!form || !state) return;
      applyStateToForm(form, state);
      form.addEventListener('input', (event) => handleFormInput(event, state));
      form.addEventListener('change', (event) => handleFormInput(event, state));
    }

    function setProductImagePreview(url) {
      if (!productImagePreview) return;
      if (url) {
        productImagePreview.style.backgroundImage = `url(${url})`;
        productImagePreview.textContent = '';
      } else {
        productImagePreview.style.backgroundImage = '';
        productImagePreview.textContent = '–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è';
      }
    }

    function setCourseImagePreview(url) {
      if (!courseImagePreview) return;
      if (url) {
        courseImagePreview.style.backgroundImage = `url(${url})`;
        courseImagePreview.textContent = '';
      } else {
        courseImagePreview.style.backgroundImage = '';
        courseImagePreview.textContent = '–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è';
      }
    }

    function resetProductImageInputs() {
      if (productImageFileInput) productImageFileInput.value = '';
      if (productImageUrlInput) productImageUrlInput.value = '';
      setProductImagePreview('');
    }

    function resetCourseImageInputs() {
      if (courseImageFileInput) courseImageFileInput.value = '';
      if (courseImageUrlInput) courseImageUrlInput.value = '';
      setCourseImagePreview('');
    }

    async function uploadProductImageFile() {
      const file = productImageFileInput?.files?.[0];
      if (!file) return;

      const formData = new FormData();
      formData.append('kind', 'product');
      formData.append('file', file);

      try {
        const res = await fetch('/api/admin/upload-image', { method: 'POST', body: formData });
        const data = await res.json();
        if (!data.ok) {
          throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
        }

        if (productImageUrlInput) productImageUrlInput.value = data.url;
        setProductImagePreview(data.url);
      } catch (e) {
        handleError(e, '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞');
      }
    }

    async function uploadCourseImageFile() {
      const file = courseImageFileInput?.files?.[0];
      if (!file) return;

      const formData = new FormData();
      formData.append('kind', 'course');
      formData.append('file', file);

      try {
        const res = await fetch('/api/admin/upload-image', { method: 'POST', body: formData });
        const data = await res.json();
        if (!data.ok) {
          throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
        }

        if (courseImageUrlInput) courseImageUrlInput.value = data.url;
        setCourseImagePreview(data.url);
      } catch (e) {
        handleError(e, '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å–∞');
      }
    }

    function renderImageRow(image, type, reloadFn) {
      const row = document.createElement('div');
      row.className = 'image-row';

      const thumb = document.createElement('img');
      thumb.src = image.image_url;
      thumb.alt = 'preview';
      thumb.className = 'image-thumb';

      const info = document.createElement('div');
      info.className = 'image-url-text';
      info.title = image.image_url;
      info.textContent = image.image_url;

      const meta = document.createElement('div');
      meta.className = 'image-meta muted';
      meta.textContent = `#${image.id} ¬∑ –ø–æ–∑–∏—Ü–∏—è ${image.position}`;

      const actions = document.createElement('div');
      actions.className = 'image-row-actions';

      const previewBtn = document.createElement('button');
      previewBtn.type = 'button';
      previewBtn.className = 'btn secondary';
      previewBtn.textContent = '–ü—Ä–æ—Å–º–æ—Ç—Ä';
      previewBtn.addEventListener('click', () => openImageModal(image.image_url));

      const deleteBtn = document.createElement('button');
      deleteBtn.type = 'button';
      deleteBtn.className = 'btn secondary danger';
      deleteBtn.textContent = '–£–¥–∞–ª–∏—Ç—å';
      deleteBtn.addEventListener('click', () => deleteGalleryImage(image.id, type, reloadFn));

      actions.appendChild(previewBtn);
      actions.appendChild(deleteBtn);

      const infoWrapper = document.createElement('div');
      infoWrapper.className = 'image-row-info';
      infoWrapper.appendChild(info);
      infoWrapper.appendChild(meta);

      row.appendChild(thumb);
      row.appendChild(infoWrapper);
      row.appendChild(actions);
      return row;
    }

    function renderImagesList(items, target, type, reloadFn) {
      if (!target) return;
      target.innerHTML = '';
      target.classList.remove('muted');
      if (!items || !items.length) {
        showImageListPlaceholder(target, '–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π');
        return;
      }
      items.forEach((image) => {
        target.appendChild(renderImageRow(image, type, reloadFn));
      });
    }

    async function loadProductImages(productId, target = productImagesList) {
      const reloadFn = () => loadProductImages(productId, target);
      if (!target) return;
      if (!productId) {
        showImageListPlaceholder(target, '–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ç–æ–≤–∞—Ä, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ.');
        return;
      }
      try {
        const data = await apiGet(`/admin/products/${productId}/images`, { user_id: currentUser.telegram_id });
        renderImagesList(data.items || data || [], target, 'product', reloadFn);
      } catch (e) {
        console.error(e);
        showImageListPlaceholder(target, '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Ç–æ–≤–∞—Ä–∞');
      }
    }

    async function loadCourseImages(courseId, target = courseImagesList) {
      const reloadFn = () => loadCourseImages(courseId, target);
      if (!target) return;
      if (!courseId) {
        showImageListPlaceholder(target, '–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ.');
        return;
      }
      try {
        const data = await apiGet(`/admin/masterclasses/${courseId}/images`, { user_id: currentUser.telegram_id });
        renderImagesList(data.items || data || [], target, 'course', reloadFn);
      } catch (e) {
        console.error(e);
        showImageListPlaceholder(target, '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å–∞');
      }
    }

    async function uploadProductGalleryFiles(event, target = productImagesList) {
      const files = Array.from(event.target?.files || []);
      if (!files.length) return;
      if (!productCurrentId) {
        alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ç–æ–≤–∞—Ä.');
        event.target.value = '';
        return;
      }
      const formData = new FormData();
      files.forEach((file) => formData.append('files', file));
      try {
        const res = await fetch(`${API_BASE}/admin/products/${productCurrentId}/images`, {
          method: 'POST',
          body: formData,
        });
        const data = await handleResponse(res);
        renderImagesList(data.items || data || [], target, 'product', () => loadProductImages(productCurrentId, target));
        setStatus('–§–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞ –¥–æ–±–∞–≤–ª–µ–Ω—ã');
      } catch (e) {
        handleError(e, '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞');
      }
      event.target.value = '';
    }

    function startProductInlineEdit(item) {
      if (!item) return;
      productFormState.mode = 'edit';
      productCurrentId = item.id;
      productFormState.currentId = productCurrentId;
      productFormTitle.textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä #${item.id}`;
      if (productSubmitBtn) productSubmitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
      const productImageUrl = item.image_url || item.image || item.images?.[0]?.image_url || '';
      resetFormState(productFormState.formData, productFormDefaults);
      Object.assign(productFormState.formData, {
        category_id: item.category_id ?? '',
        name: item.name || '',
        price: item.price ?? null,
        image_url: productImageUrl,
        short_description: item.short_description || '',
        description: item.description || '',
        wb_url: item.wb_url || '',
        ozon_url: item.ozon_url || '',
        yandex_url: item.yandex_url || '',
        avito_url: item.avito_url || '',
        masterclass_url: item.masterclass_url || '',
        detail_url: item.detail_url || '',
      });
      applyStateToForm(productForm, productFormState.formData);
      if (productCategorySelect && item.category_id) {
        const hasOption = Array.from(productCategorySelect.options || []).some(
          (opt) => String(opt.value) === String(item.category_id)
        );
        if (!hasOption) {
          const opt = document.createElement('option');
          opt.value = item.category_id;
          opt.textContent = item.category_name || `–ö–∞—Ç–µ–≥–æ—Ä–∏—è ${item.category_id}`;
          productCategorySelect.appendChild(opt);
        }
      }
      if (productImageUrlInput) productImageUrlInput.value = productImageUrl || '';
      setProductImagePreview(productImageUrl);
      showImageListPlaceholder(productImagesList, '–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.');
      showSection('product-list');
      loadProductImages(productCurrentId, productImagesList);
      productForm?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function startCourseInlineEdit(item) {
      if (!item) return;
      courseFormState.mode = 'edit';
      masterclassCurrentId = item.id;
      courseFormState.currentId = masterclassCurrentId;
      courseFormTitle.textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å #${item.id}`;
      if (courseSubmitBtn) courseSubmitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
      const courseImageUrl = item.image_url || item.image || item.images?.[0]?.image_url || '';
      resetFormState(courseFormState.formData, courseFormDefaults);
      Object.assign(courseFormState.formData, {
        category_id: item.category_id ?? '',
        name: item.name || '',
        price: item.price ?? null,
        image_url: courseImageUrl,
        short_description: item.short_description || '',
        description: item.description || '',
        masterclass_url: item.masterclass_url || '',
        detail_url: item.detail_url || '',
      });
      applyStateToForm(courseForm, courseFormState.formData);

      if (courseCategorySelect && item.category_id) {
        const hasOption = Array.from(courseCategorySelect.options || []).some(
          (opt) => String(opt.value) === String(item.category_id)
        );
        if (!hasOption) {
          const opt = document.createElement('option');
          opt.value = item.category_id;
          opt.textContent = item.category_name || `–ö–∞—Ç–µ–≥–æ—Ä–∏—è ${item.category_id}`;
          courseCategorySelect.appendChild(opt);
        }
      }

      if (courseImageUrlInput) courseImageUrlInput.value = courseImageUrl || '';
      setCourseImagePreview(courseImageUrl);
      showImageListPlaceholder(courseImagesList, '–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.');
      showSection('course-list');
      loadCourseImages(masterclassCurrentId, courseImagesList);
      courseForm?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    async function uploadCourseGalleryFiles(event, target = courseImagesList) {
      const files = Array.from(event.target?.files || []);
      if (!files.length) return;
      if (!masterclassCurrentId) {
        alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å.');
        event.target.value = '';
        return;
      }
      const formData = new FormData();
      files.forEach((file) => formData.append('files', file));
      try {
        const res = await fetch(`${API_BASE}/admin/masterclasses/${masterclassCurrentId}/images`, {
          method: 'POST',
          body: formData,
        });
        const data = await handleResponse(res);
        renderImagesList(data.items || data || [], target, 'course', () => loadCourseImages(masterclassCurrentId, target));
        setStatus('–§–æ—Ç–æ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å–∞ –¥–æ–±–∞–≤–ª–µ–Ω—ã');
      } catch (e) {
        handleError(e, '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å–∞');
      }
      event.target.value = '';
    }

    async function deleteGalleryImage(imageId, type, reloadFn) {
      if (!currentUser) return;
      const basePath = type === 'product' ? '/admin/products/images/' : '/admin/masterclasses/images/';
      try {
        await fetch(`${API_BASE}${basePath}${imageId}?user_id=${currentUser.telegram_id}`, {
          method: 'DELETE',
        }).then(handleResponse);
        if (reloadFn) {
          await reloadFn();
        } else if (type === 'product') {
          await loadProductImages(productCurrentId, productImagesList);
        } else {
          await loadCourseImages(masterclassCurrentId, courseImagesList);
        }
      } catch (e) {
        handleError(e, '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
      }
    }

    function renderCategories(items, targetTable, onEdit) {
      targetTable.innerHTML = '';
      if (!items || !items.length) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 5;
        cell.textContent = '–ö–∞—Ç–µ–≥–æ—Ä–∏–π –Ω–µ—Ç';
        cell.className = 'muted';
        row.appendChild(cell);
        targetTable.appendChild(row);
        return;
      }

      items.forEach((cat) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>#${cat.id}</td>
          <td>${cat.name}</td>
          <td>${cat.sort_order ?? 0}</td>
          <td>${cat.is_active ? '–î–∞' : '–ù–µ—Ç'}</td>
          <td><button class="btn secondary" type="button" data-edit="${cat.id}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button></td>
        `;
        const editBtn = row.querySelector('button[data-edit]');
        editBtn?.addEventListener('click', () => onEdit?.(cat));
        targetTable.appendChild(row);
      });
    }

    function findProductItemById(id, type) {
      const source = type === 'course' ? courseItems : productItems;
      return source.find((item) => String(item.id) === String(id));
    }

    async function handleProductTableClick(event) {
      const btn = event.target.closest('[data-action]');
      if (!btn) return;
      const { action, id, type } = btn.dataset;
      if (!id) return;
      const productType = type || 'basket';

      if (action === 'edit') {
        const item = findProductItemById(id, productType);
        if (!item) return;
        if (productType === 'basket') {
          startProductInlineEdit(item);
        } else {
          startCourseInlineEdit(item);
        }
        return;
      }

      if (action === 'toggle') {
        try {
          await apiPost(`/admin/products/${id}/toggle`, { user_id: currentUser.telegram_id, type: productType });
          setStatus('–°—Ç–∞—Ç—É—Å —Ç–æ–≤–∞—Ä–∞ –æ–±–Ω–æ–≤–ª—ë–Ω');
          if (productType === 'basket') {
            await loadProducts();
          } else {
            await loadCourses();
          }
        } catch (e) {
          handleError(e, '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å');
        }
      }
    }

    function fillCategoryForm(form, category) {
      if (!form || !category) return;
      form.elements.name.value = category.name || '';
      form.elements.slug.value = category.slug || '';
      form.elements.sort_order.value = category.sort_order ?? 0;
      form.elements.is_active.checked = !!category.is_active;
    }

    function resetCategoryForm(form, titleEl, defaultTitle) {
      form?.reset();
      if (form?.elements?.is_active) form.elements.is_active.checked = true;
      if (titleEl) titleEl.textContent = defaultTitle;
    }

    async function renderProductTable(items, targetTable, type) {
      targetTable.innerHTML = '';
      if (!items || !items.length) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 6;
        cell.textContent = '–ü—É—Å—Ç–æ';
        cell.className = 'muted';
        row.appendChild(cell);
        targetTable.appendChild(row);
        return;
      }

      items.forEach((item) => {
        const row = document.createElement('tr');
        const categoryLabel = item.category_name || '‚Äî';
        const priceLabel = `${item.price || 0} ‚ÇΩ${type === 'course' && (!item.price || item.price === 0) ? ' (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)' : ''}`;
        row.innerHTML = `
          <td>#${item.id}</td>
          <td>${item.name}</td>
          <td>${categoryLabel}</td>
          <td>${priceLabel}</td>
          <td>${item.is_active ? '–î–∞' : '–ù–µ—Ç'}</td>
          <td style="display:flex; gap:6px; flex-wrap:wrap;">
            <button class="btn secondary" type="button" data-action="edit" data-id="${item.id}" data-type="${type}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <button class="btn secondary" type="button" data-action="toggle" data-id="${item.id}" data-type="${type}">${item.is_active ? '–°–∫—Ä—ã—Ç—å' : '–ü–æ–∫–∞–∑–∞—Ç—å'}</button>
          </td>
        `;
        targetTable.appendChild(row);
      });
    }

    async function loadProductCategories() {
      if (!currentUser) return;
      try {
        const data = await apiGet('/admin/product-categories', { user_id: currentUser.telegram_id, type: 'basket' });
        renderCategories(data.items || [], productCategoriesTable, (cat) => {
          editingProductCategoryId = cat.id;
          productCategoryFormTitle.textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é #${cat.id}`;
          fillCategoryForm(productCategoryForm, cat);
        });
      } catch (e) {
        handleError(e, '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤');
      }
    }

    async function loadCourseCategories() {
      if (!currentUser) return;
      try {
        const data = await apiGet('/admin/product-categories', { user_id: currentUser.telegram_id, type: 'course' });
        renderCategories(data.items || [], courseCategoriesTable, (cat) => {
          editingCourseCategoryId = cat.id;
          courseCategoryFormTitle.textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é #${cat.id}`;
          fillCategoryForm(courseCategoryForm, cat);
        });
      } catch (e) {
        handleError(e, '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å–æ–≤');
      }
    }

    async function handleProductCategoryFormSubmit(event) {
      event.preventDefault();
      if (!currentUser) return;
      const form = productCategoryForm;
      const payload = {
        user_id: currentUser.telegram_id,
        name: form.elements.name.value.trim(),
        slug: form.elements.slug.value.trim() || null,
        sort_order: form.elements.sort_order.value ? Number(form.elements.sort_order.value) : 0,
        is_active: form.elements.is_active.checked,
        type: 'basket',
      };

      try {
        if (editingProductCategoryId) {
          await sendJson(`/admin/product-categories/${editingProductCategoryId}`, 'PUT', payload);
        } else {
          await sendJson('/admin/product-categories', 'POST', payload);
        }
        setStatus('–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
        editingProductCategoryId = null;
        resetCategoryForm(productCategoryForm, productCategoryFormTitle, '–°–æ–∑–¥–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é');
        await Promise.all([
          loadProductCategories(),
          loadCategories(productCategorySelect, 'basket'),
          loadCategories(productCategoryFilter, 'basket'),
        ]);
      } catch (e) {
        handleError(e, '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ç–æ–≤–∞—Ä–∞');
      }
    }

    async function handleCourseCategoryFormSubmit(event) {
      event.preventDefault();
      if (!currentUser) return;
      const form = courseCategoryForm;
      const payload = {
        user_id: currentUser.telegram_id,
        name: form.elements.name.value.trim(),
        slug: form.elements.slug.value.trim() || null,
        sort_order: form.elements.sort_order.value ? Number(form.elements.sort_order.value) : 0,
        is_active: form.elements.is_active.checked,
        type: 'course',
      };

      try {
        if (editingCourseCategoryId) {
          await sendJson(`/admin/product-categories/${editingCourseCategoryId}`, 'PUT', payload);
        } else {
          await sendJson('/admin/product-categories', 'POST', payload);
        }
        setStatus('–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
        editingCourseCategoryId = null;
        resetCategoryForm(courseCategoryForm, courseCategoryFormTitle, '–°–æ–∑–¥–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é');
        await Promise.all([
          loadCourseCategories(),
          loadCategories(courseCategorySelect, 'course'),
          loadCategories(courseCategoryFilter, 'course'),
        ]);
      } catch (e) {
        handleError(e, '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å–∞');
      }
    }

    async function loadProducts() {
      if (!currentUser) return;
      try {
        const status = productsStatusFilter.value === 'all' ? undefined : productsStatusFilter.value;
        const data = await apiGet('/admin/products', { user_id: currentUser.telegram_id, type: 'basket', status });
        let items = data.items || [];
        productItems = items;
        const catFilter = productCategoryFilter.value;
        if (catFilter) {
          items = items.filter((i) => String(i.category_id || i.category_slug || '') === String(catFilter));
        }
        renderProductTable(items, productsTable, 'basket');
      } catch (e) {
        handleError(e, '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–≤–∞—Ä—ã');
      }
    }

    async function loadCourses() {
      if (!currentUser) return;
      try {
        const status = coursesStatusFilter.value === 'all' ? undefined : coursesStatusFilter.value;
        const data = await apiGet('/admin/products', { user_id: currentUser.telegram_id, type: 'course', status });
        let items = data.items || [];
        courseItems = items;
        const catFilter = courseCategoryFilter.value;
        if (catFilter) {
          items = items.filter((i) => String(i.category_slug || i.category_id || '') === String(catFilter));
        }
        renderProductTable(items, coursesTable, 'course');
      } catch (e) {
        handleError(e, '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã');
      }
    }

    function toInputDate(value) {
      if (!value) return '';
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return '';
      const offset = date.getTimezoneOffset();
      const local = new Date(date.getTime() - offset * 60000);
      return local.toISOString().slice(0, 16);
    }

    function fromInputDate(value) {
      if (!value) return null;
      const date = new Date(value);
      return Number.isNaN(date.getTime()) ? null : date.toISOString();
    }

    function updatePromoTargetState(scopeSelect, targetInput) {
      if (!scopeSelect || !targetInput) return;
      const needsTarget = ['product', 'category'].includes(scopeSelect.value);
      targetInput.disabled = !needsTarget;
      targetInput.placeholder = needsTarget ? '–ù–∞–ø—Ä–∏–º–µ—Ä, ID —Ç–æ–≤–∞—Ä–∞ –∏–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏' : '–ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏';
      if (!needsTarget) {
        targetInput.value = '';
      }
    }

    function applyPromocodeFilters(items) {
      const statusFilter = promoStatusFilter?.value || 'all';
      if (statusFilter === 'active') return items.filter((p) => p.active);
      if (statusFilter === 'inactive') return items.filter((p) => !p.active);
      return items;
    }

    function findPromocodeById(id) {
      return promocodeItems.find((p) => String(p.id) === String(id));
    }

    async function handlePromoTableClick(event) {
      const btn = event.target.closest('[data-edit], [data-delete], [data-toggle]');
      if (!btn) return;
      const promoId = btn.dataset.edit || btn.dataset.delete || btn.dataset.toggle;
      if (!promoId) return;
      const promo = findPromocodeById(promoId);

      if (btn.dataset.edit) {
        if (promo) openPromocodeEdit(promo);
        return;
      }
      if (btn.dataset.delete) {
        deletePromocode(Number(promoId));
        return;
      }
      if (btn.dataset.toggle && promo) {
        togglePromocodeActive(promo);
      }
    }

    function renderPromocodes(promos) {
      promoTable.innerHTML = '';
      if (!promos || !promos.length) {
        const emptyRow = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 9;
        cell.textContent = '–ü—Ä–æ–º–æ–∫–æ–¥—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç';
        cell.className = 'muted';
        emptyRow.appendChild(cell);
        promoTable.appendChild(emptyRow);
        return;
      }

      const scopeLabels = {
        all: '–í–µ—Å—å –∑–∞–∫–∞–∑',
        basket: '–ö–æ—Ä–∑–∏–Ω–∫–∏',
        course: '–ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã',
        product: '–¢–æ–≤–∞—Ä/–∫—É—Ä—Å',
        category: '–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∫–æ—Ä–∑–∏–Ω–æ–∫',
      };

      promos.forEach((promo) => {
        const row = document.createElement('tr');
        const discountText = promo.discount_type === 'percent' ? `${promo.discount_value}%` : `${promo.discount_value} ‚ÇΩ`;
        const period = [promo.date_start, promo.date_end]
          .filter(Boolean)
          .map((d) => new Date(d).toLocaleString('ru-RU'))
          .join(' ‚Äî ');
        const statusText = promo.active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ –∞–∫—Ç–∏–≤–µ–Ω';
        const usageText = `${promo.used_count || 0}/${promo.max_uses || '‚àû'}`;

        row.innerHTML = `
          <td>#${promo.id}</td>
          <td>${promo.code}</td>
          <td>${promo.discount_type === 'percent' ? '–ü—Ä–æ—Ü–µ–Ω—Ç' : '–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è'}</td>
          <td>${discountText}</td>
          <td>${scopeLabels[promo.scope] || promo.scope}${promo.target_id ? ` #${promo.target_id}` : ''}</td>
          <td>${period || '‚Äî'}</td>
          <td>${statusText}</td>
          <td>${usageText}</td>
          <td style="display:flex; gap:6px; flex-wrap:wrap;">
            <button class="btn secondary" type="button" data-toggle="${promo.id}">${promo.active ? '–í—ã–∫–ª—é—á–∏—Ç—å' : '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'}</button>
            <button class="btn secondary" type="button" data-edit="${promo.id}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <button class="btn secondary" type="button" data-delete="${promo.id}">–£–¥–∞–ª–∏—Ç—å</button>
          </td>
        `;
        promoTable.appendChild(row);
      });
    }

    async function loadPromocodes() {
      if (!currentUser) return;
      try {
        const data = await apiGet('/admin/promocodes', { user_id: currentUser.telegram_id });
        const items = (data.items || []).sort((a, b) => {
          const aDate = a.created_at ? new Date(a.created_at).getTime() : 0;
          const bDate = b.created_at ? new Date(b.created_at).getTime() : 0;
          return bDate !== aDate ? bDate - aDate : (b.id || 0) - (a.id || 0);
        });
        promocodeItems = items;
        renderPromocodes(applyPromocodeFilters(items));
      } catch (e) {
        handleError(e, '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥—ã');
      }
    }

    function openPromocodeEdit(promo) {
      promoCreateState.mode = 'edit';
      promoCurrentId = promo.id;
      promoCreateState.currentId = promoCurrentId;
      promoCreateTitle.textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ #${promo.id}`;
      if (promoSubmitBtn) promoSubmitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
      resetFormState(promoCreateState.formData, promoFormDefaults);
      Object.assign(promoCreateState.formData, {
        code: promo.code || '',
        discount_type: promo.discount_type || 'percent',
        discount_value: promo.discount_value ?? null,
        scope: promo.scope || 'all',
        target_id: promo.target_id ?? '',
        date_start: toInputDate(promo.date_start),
        date_end: toInputDate(promo.date_end),
        max_uses: promo.max_uses ?? '',
        active: promo.active !== false,
        one_per_user: Boolean(promo.one_per_user),
      });
      applyStateToForm(promoCreateForm, promoCreateState.formData);
      updatePromoTargetState(promoCreateScope, promoCreateTarget);
      showSection('promocode-list');
      promoCreateForm?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    async function deletePromocode(id) {
      if (!currentUser || !id) return;
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥?')) return;
      try {
        await sendJson(`/admin/promocodes/${id}?user_id=${currentUser.telegram_id}`, 'DELETE');
        setStatus('–ü—Ä–æ–º–æ–∫–æ–¥ —É–¥–∞–ª—ë–Ω');
        await loadPromocodes();
      } catch (e) {
        handleError(e, '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥');
      }
    }

    async function togglePromocodeActive(promo) {
      if (!currentUser || !promo?.id) return;
      try {
        await sendJson(`/admin/promocodes/${promo.id}`, 'PUT', {
          user_id: currentUser.telegram_id,
          active: !promo.active,
        });
        setStatus(promo.active ? '–ü—Ä–æ–º–æ–∫–æ–¥ –≤—ã–∫–ª—é—á–µ–Ω' : '–ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
        await loadPromocodes();
      } catch (e) {
        handleError(e, '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–º–æ–∫–æ–¥–∞');
      }
    }

    function resetPromoCreateForm() {
      promoCreateState.mode = 'create';
      promoCurrentId = null;
      promoCreateState.currentId = null;
      promoCreateTitle.textContent = '–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥';
      if (promoSubmitBtn) promoSubmitBtn.textContent = '–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥';
      resetFormState(promoCreateState.formData, promoFormDefaults);
      applyStateToForm(promoCreateForm, promoCreateState.formData);
      updatePromoTargetState(promoCreateScope, promoCreateTarget);
    }

    async function submitPromocodeCreate(event) {
      event.preventDefault();
      if (!currentUser) return;

      const payload = {
        user_id: currentUser.telegram_id,
        code: (promoCreateCode.value || '').trim(),
        discount_type: promoCreateDiscountType.value,
        discount_value:
          promoCreateDiscountValue.value === '' ? null : Number(promoCreateDiscountValue.value || 0),
        scope: promoCreateScope.value,
        target_id: promoCreateTarget.value ? Number(promoCreateTarget.value) : null,
        date_start: fromInputDate(promoCreateDateStart.value),
        date_end: fromInputDate(promoCreateDateEnd.value),
        max_uses: promoCreateMaxUses.value ? Number(promoCreateMaxUses.value) : null,
        active: promoCreateActive.checked,
        one_per_user: promoCreateOnePerUser.checked,
      };

      try {
        if (promoCurrentId) {
          await sendJson(`/admin/promocodes/${promoCurrentId}`, 'PUT', payload);
          setStatus('–ü—Ä–æ–º–æ–∫–æ–¥ –æ–±–Ω–æ–≤–ª—ë–Ω');
        } else {
          await sendJson('/admin/promocodes', 'POST', payload);
          setStatus('–ü—Ä–æ–º–æ–∫–æ–¥ —Å–æ–∑–¥–∞–Ω');
        }
        resetPromoCreateForm();
        await loadPromocodes();
        showSection('promocode-list');
      } catch (e) {
        handleError(e, '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥');
      }
    }

    async function handleProductFormSubmit(event) {
      event.preventDefault();
      if (!currentUser) return;
      const payload = serializeForm(productForm);
      payload.user_id = currentUser.telegram_id;
      payload.type = 'basket';
      payload.price = payload.price ? Number(payload.price) : 0;
      payload.image_url = productImageUrlInput?.value.trim() || null;

      try {
        if (productCurrentId) {
          await fetch(`${API_BASE}/admin/products/${productCurrentId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          }).then(handleResponse);
          setStatus('–¢–æ–≤–∞—Ä —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
        } else {
          await apiPost('/admin/products', payload);
          setStatus('–¢–æ–≤–∞—Ä —Å–æ–∑–¥–∞–Ω');
        }
        resetProductCreateForm();
        await loadProducts();
      } catch (e) {
        handleError(e, '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–≤–∞—Ä');
      }
    }

    function resetProductCreateForm() {
      productFormState.mode = 'create';
      productCurrentId = null;
      productFormState.currentId = null;
      productFormTitle.textContent = '–°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä';
      if (productSubmitBtn) productSubmitBtn.textContent = '–°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä';
      resetFormState(productFormState.formData, productFormDefaults);
      applyStateToForm(productForm, productFormState.formData);
      resetProductImageInputs();
      showImageListPlaceholder(productImagesList, '–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ç–æ–≤–∞—Ä, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ.');
    }

    function resetCourseFormState() {
      courseFormState.mode = 'create';
      masterclassCurrentId = null;
      courseFormState.currentId = null;
      courseFormTitle.textContent = '–°–æ–∑–¥–∞—Ç—å –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å';
      if (courseSubmitBtn) courseSubmitBtn.textContent = '–°–æ–∑–¥–∞—Ç—å –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å';
      resetFormState(courseFormState.formData, courseFormDefaults);
      applyStateToForm(courseForm, courseFormState.formData);
      resetCourseImageInputs();
      showImageListPlaceholder(courseImagesList, '–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ.');
    }

    async function handleCourseFormSubmit(event) {
      event.preventDefault();
      if (!currentUser) return;
      const payload = serializeForm(courseForm);
      payload.user_id = currentUser.telegram_id;
      payload.type = 'course';
      payload.price = payload.price ? Number(payload.price) : 0;
      payload.image_url = courseImageUrlInput?.value.trim() || null;

      try {
        if (masterclassCurrentId) {
          await fetch(`${API_BASE}/admin/products/${masterclassCurrentId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          }).then(handleResponse);
          setStatus('–ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
        } else {
          await apiPost('/admin/products', payload);
          setStatus('–ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
        }
        resetCourseFormState();
        await loadCourses();
      } catch (e) {
        handleError(e, '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å');
      }
    }

    bindStateToForm(productForm, productFormState.formData);
    bindStateToForm(courseForm, courseFormState.formData);
    bindStateToForm(promoCreateForm, promoCreateState.formData);

    promoCreateForm?.addEventListener('submit', submitPromocodeCreate);
    promoCreateReset?.addEventListener('click', resetPromoCreateForm);
    promoCreateScope?.addEventListener('change', () => updatePromoTargetState(promoCreateScope, promoCreateTarget));
    productForm.addEventListener('submit', handleProductFormSubmit);
    courseForm.addEventListener('submit', handleCourseFormSubmit);
    productCategoryForm?.addEventListener('submit', handleProductCategoryFormSubmit);
    courseCategoryForm?.addEventListener('submit', handleCourseCategoryFormSubmit);
    productsTable?.addEventListener('click', handleProductTableClick);
    coursesTable?.addEventListener('click', handleProductTableClick);
    promoTable?.addEventListener('click', handlePromoTableClick);
    productCancel.addEventListener('click', () => {
      resetProductCreateForm();
      productForm?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
    courseCancel.addEventListener('click', () => {
      resetCourseFormState();
      courseForm?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
    productReset.addEventListener('click', () => {
      resetProductCreateForm();
      showSection('product-list');
      productForm?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
    courseReset.addEventListener('click', () => {
      resetCourseFormState();
      showSection('course-list');
      courseForm?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
    productCategoryReset?.addEventListener('click', () => {
      editingProductCategoryId = null;
      resetCategoryForm(productCategoryForm, productCategoryFormTitle, '–°–æ–∑–¥–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é');
    });
    courseCategoryReset?.addEventListener('click', () => {
      editingCourseCategoryId = null;
      resetCategoryForm(courseCategoryForm, courseCategoryFormTitle, '–°–æ–∑–¥–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é');
    });

    productImageFileInput?.addEventListener('change', uploadProductImageFile);
    courseImageFileInput?.addEventListener('change', uploadCourseImageFile);
    productGalleryInput?.addEventListener('change', uploadProductGalleryFiles);
    courseGalleryInput?.addEventListener('change', uploadCourseGalleryFiles);
    productImageUrlInput?.addEventListener('input', () => setProductImagePreview(productImageUrlInput.value.trim()));
    courseImageUrlInput?.addEventListener('input', () => setCourseImagePreview(courseImageUrlInput.value.trim()));
    imageModalClose?.addEventListener('click', closeImageModal);
    imageModal?.addEventListener('click', (event) => {
      if (event.target.id === 'image-modal') closeImageModal();
    });
    promoStatusFilter?.addEventListener('change', () => {
      renderPromocodes(applyPromocodeFilters(promocodeItems));
    });

    reviewStatusFilter?.addEventListener('change', loadReviews);
    reviewProductFilter?.addEventListener('change', loadReviews);
    reviewUserFilter?.addEventListener('input', () => {
      const filtered = applyReviewSearchFilter(reviewItems);
      renderReviewsTable(filtered);
    });
    reviewResetBtn?.addEventListener('click', () => {
      reviewStatusFilter.value = 'all';
      reviewProductFilter.value = '';
      reviewUserFilter.value = '';
      loadReviews();
    });
    document.getElementById('review-modal-close')?.addEventListener('click', closeReviewModal);
    document.getElementById('review-modal')?.addEventListener('click', (event) => {
      if (event.target.id === 'review-modal') closeReviewModal();
    });

    productsStatusFilter.addEventListener('change', loadProducts);
    coursesStatusFilter.addEventListener('change', loadCourses);
    productCategoryFilter.addEventListener('change', loadProducts);
    courseCategoryFilter.addEventListener('change', loadCourses);

    async function initApp() {
      console.log('[admin] initApp start');
      try {
        currentUser = await getCurrentUser({ includeNotes: true });
        if (!requireAdmin(currentUser)) return;

        await Promise.all([
          loadCategories(productCategoryFilter, 'basket'),
          loadCategories(productCategorySelect, 'basket'),
          loadCategories(courseCategoryFilter, 'course'),
          loadCategories(courseCategorySelect, 'course'),
        ]);

        await Promise.all([loadProductCategories(), loadCourseCategories()]);

        resetPromoCreateForm();
        await loadOrders();
        await loadProducts();
        await loadCourses();
        await loadPromocodes();
        await loadReviewProducts();
        await loadReviews();
        showSection('orders');
        console.log('[admin] initApp done');
      } catch (e) {
        handleError(e, '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–¥–º–∏–Ω–∫–∏');
      }
    }

    initApp();
  </script>

  <div id="image-modal" class="admin-modal hidden">
    <div class="admin-modal__content image-modal__content">
      <div class="admin-modal__header">
        <h3>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h3>
        <button class="btn secondary" type="button" id="image-modal-close">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="admin-modal__body image-modal__body">
        <img id="image-modal-picture" src="" alt="–ü—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è">
      </div>
    </div>
  </div>

  <div id="review-modal" class="admin-modal hidden">
    <div class="admin-modal__content">
      <div class="admin-modal__header">
        <h3 id="review-modal-title"></h3>
        <button class="btn secondary" type="button" id="review-modal-close">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="admin-modal__body">
        <p id="review-modal-text" class="review-modal-text"></p>
        <div id="review-modal-photos" class="review-modal-gallery"></div>
      </div>
    </div>
  </div>
</body>
</html>
